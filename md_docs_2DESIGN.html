<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inference Engine (Clocher): Design (CPU baseline + INT4 path)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Inference Engine (Clocher)<span id="projectnumber">&#160;0.2</span>
   </div>
   <div id="projectbrief">C11 CPU/GPU inference baseline with strict metrics &amp; harness</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2DESIGN.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Design (CPU baseline + INT4 path)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md16"></a></p>
<p>This document describes the hot path, API boundaries, and precision modes. <br  />
 <b>Last updated:</b> 2025-10-24 21:00:48 UTC</p>
<h1><a class="anchor" id="autotoc_md17"></a>
Process and boundaries</h1>
<ul>
<li>Single binary <code>inference-engine</code>: create → generate → collect metrics → destroy.</li>
<li>CLI prints exactly one JSON line per run so the Python harness can ingest results.</li>
<li>No third‑party runtime dependencies; only <code>pthread</code> and <code>libm</code> (and CUDA for the GPU build).</li>
</ul>
<h1><a class="anchor" id="autotoc_md18"></a>
API surface (high level)</h1>
<ul>
<li><code>ie_engine_create(cfg)</code> → initializes state (weights, buffers, thread‑pool).</li>
<li><code>ie_engine_generate(prompt, max_new, params)</code> → produces tokens and updates metrics rings.</li>
<li><code>ie_engine_metrics(out)</code> → returns latency p50/p95, true TPS, <b>RSS peak</b>, KV hits/misses.</li>
<li><code><a class="el" href="ie__api_8h.html#a8a724f7097b3e19da8d7dd97fba4415e" title="Destroy an engine and free its resources.">ie_engine_destroy()</a></code> → frees all resources.</li>
</ul>
<h1><a class="anchor" id="autotoc_md19"></a>
Hot path layout</h1>
<ul>
<li>GEMV microkernel:<ul>
<li>Generic scalar reference implementation.</li>
<li>AVX2/FMA path with light prefetch and blocked‑K packing.</li>
</ul>
</li>
<li>Activation:<ul>
<li><code>tanh</code> fast path with clamp (accuracy‑bounded), vector helper.</li>
<li>Optional fused bias + activation to reduce memory traffic.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md20"></a>
Precision modes</h1>
<h2><a class="anchor" id="autotoc_md21"></a>
Floating point</h2>
<ul>
<li>FP32 baseline, optional BF16/FP16 round‑trip (accumulate FP32).</li>
</ul>
<h2><a class="anchor" id="autotoc_md22"></a>
INT8 PTQ (reference)</h2>
<ul>
<li>Per‑tensor/per‑row scales (min‑max); (de)quant helpers; task gate in scripts.</li>
</ul>
<h2><a class="anchor" id="autotoc_md23"></a>
<b>NEW — INT4 PTQ (weight‑only)</b></h2>
<ul>
<li><b>Format</b>: weights are <b>nibble‑packed</b> (2 values per byte). Each row (or group) carries a scale (and optional zero‑point if affine).</li>
<li><b>Packing</b>: INT4 packing integrates with the existing <b>pretranspose / blocked‑K</b> pipeline. Packing order: float → (optional) pretranspose → quantize to int4 → pack.</li>
<li><b>Dequantization</b>: fused in the matmul path; scale is broadcast per row (or group) to recover FP32 accumulators.</li>
<li><b>Manifests</b>: a <code>q4_manifest.json</code> enumerates which tensors use INT4 and their scale metadata. <code><a class="el" href="hf__to__iebin_8py.html">scripts/hf_to_iebin.py</a></code> consumes this manifest via <code>--q4-map</code> to emit <code>model.ie.bin</code>/<code>.json</code>.</li>
<li><b>Selection</b>: at runtime choose <code>IE_PRECISION=int4w</code> (or <code>--precision int4w</code>), leaving activations in float. This is <b>bandwidth‑oriented</b> and preserves compute simplicity.</li>
</ul>
<h1><a class="anchor" id="autotoc_md24"></a>
Threading model</h1>
<ul>
<li>Fixed thread‑pool over <code>pthread</code>, contiguous sharding, grainsize control.</li>
<li>Affinity (Linux): <code>IE_TP_USE_AFFINITY=1</code> enables <code>auto|compact|scatter</code>.</li>
<li>NUMA:<ul>
<li><code><a class="el" href="set__numa_8sh.html">scripts/set_numa.sh</a></code> can set OS policy (<code>interleave|node:X|strict</code>).</li>
<li>In‑repo probe reads <code>/sys/devices/system/node/online</code> to annotate reports.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md25"></a>
Layout and caching</h1>
<ul>
<li>Blocked‑K packing with optional on‑disk caching (content‑addressed by shape + block size).</li>
<li>CLI flag <code>--pretranspose</code> controls packing scope (<code>none|woh|wxh|all</code>). INT4 can be cached per layout variant.</li>
</ul>
<h1><a class="anchor" id="autotoc_md26"></a>
Metrics</h1>
<ul>
<li>Per‑token latency ring (p50/p95).</li>
<li>True TPS (<code>generated_tokens / wall_time_s</code>).</li>
<li><b>Peak RSS</b> (Linux <code>/proc/self/status:VmHWM</code> → MiB; fallback <code>getrusage</code>).</li>
<li>KV hits/misses counter stubs aggregated per round.</li>
</ul>
<h1><a class="anchor" id="autotoc_md27"></a>
GPU integration (CUDA path)</h1>
<ul>
<li>Device layer: <code><a class="el" href="ie__device__cuda_8cu.html" title="CUDA backend implementation: device availability + FP32 GEMV kernel.">engine/src/devices/ie_device_cuda.cu</a></code>, kernels in <code><a class="el" href="ie__kernels__cuda_8cu.html" title="CUDA implementations of GEMV/activation/packing kernels + C-ABI launchers.">engine/src/kernels/ie_kernels_cuda.cu</a></code>.</li>
<li>Build: <code>make build-cuda</code> → <code>build/inference-engine.cuda</code>.</li>
<li>INT4 weight‑only support mirrors the CPU path; packing and scales are shared in <code>model.ie.json</code>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
