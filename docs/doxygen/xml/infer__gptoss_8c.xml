<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="infer__gptoss_8c" kind="file" language="C++">
    <compoundname>infer_gptoss.c</compoundname>
    <includes local="no">fcntl.h</includes>
    <includes local="no">limits.h</includes>
    <includes local="no">math.h</includes>
    <includes local="no">stdarg.h</includes>
    <includes local="no">stddef.h</includes>
    <includes local="no">stdint.h</includes>
    <includes local="no">stdio.h</includes>
    <includes local="no">stdlib.h</includes>
    <includes local="no">string.h</includes>
    <includes local="no">sys/mman.h</includes>
    <includes local="no">sys/stat.h</includes>
    <includes local="no">unistd.h</includes>
    <includes refid="ie__device_8h" local="yes">ie_device.h</includes>
    <includes refid="ie__infer_8h" local="yes">ie_infer.h</includes>
    <includes refid="ie__kernels_8h" local="yes">ie_kernels.h</includes>
    <includes refid="ie__kv__cache_8h" local="yes">ie_kv_cache.h</includes>
    <includes refid="ie__kv__instrumentation_8h" local="yes">ie_kv_instrumentation.h</includes>
    <includes refid="tensor__map_8h" local="yes">tensor_map.h</includes>
    <incdepgraph>
      <node id="14">
        <label>ie_device.h</label>
        <link refid="ie__device_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>ie_infer.h</label>
        <link refid="ie__infer_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>ie_io.h</label>
        <link refid="ie__io_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="19">
        <label>ie_kernels.h</label>
        <link refid="ie__kernels_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
      </node>
      <node id="17">
        <label>ie_kv_cache.h</label>
        <link refid="ie__kv__cache_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
      </node>
      <node id="20">
        <label>ie_kv_instrumentation.h</label>
        <link refid="ie__kv__instrumentation_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="18">
        <label>ie_quant_act.h</label>
        <link refid="ie__quant__act_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>tensor_map.h</label>
        <link refid="tensor__map_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>engine/src/runtime/infer_gptoss.c</label>
        <link refid="infer__gptoss_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>fcntl.h</label>
      </node>
      <node id="3">
        <label>limits.h</label>
      </node>
      <node id="4">
        <label>math.h</label>
      </node>
      <node id="5">
        <label>stdarg.h</label>
      </node>
      <node id="6">
        <label>stddef.h</label>
      </node>
      <node id="7">
        <label>stdint.h</label>
      </node>
      <node id="8">
        <label>stdio.h</label>
      </node>
      <node id="9">
        <label>stdlib.h</label>
      </node>
      <node id="10">
        <label>string.h</label>
      </node>
      <node id="11">
        <label>sys/mman.h</label>
      </node>
      <node id="12">
        <label>sys/stat.h</label>
      </node>
      <node id="13">
        <label>unistd.h</label>
      </node>
    </incdepgraph>
    <innerclass refid="structie__moe__w" prot="public">ie_moe_w</innerclass>
    <innerclass refid="structie__gptoss__layer__w" prot="public">ie_gptoss_layer_w</innerclass>
    <innerclass refid="structie__gptoss__infer__impl" prot="public">ie_gptoss_infer_impl</innerclass>
    <innerclass refid="structie__tensor__view" prot="public">ie_tensor_view</innerclass>
    <sectiondef kind="define">
      <memberdef kind="define" id="infer__gptoss_8c_1a3024ccd4a9af5109d24e6c57565d74a1" prot="public" static="no">
        <name>_POSIX_C_SOURCE</name>
        <initializer>200809L</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="33" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="33" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1aa067dccbbe25570a05cbf08d3cfefe71" prot="public" static="no">
        <name>IE_GPTOSS_RMS_EPS_DEFAULT</name>
        <initializer>(1e-5f)</initializer>
        <briefdescription>
<para>Default RMSNorm epsilon (matches common HF defaults). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="61" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="61" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a8c7977554f9c1d9b6cafdf5ca15438c6" prot="public" static="no">
        <name>IE_GPTOSS_ROPE_THETA_DEFAULT</name>
        <initializer>(10000.0f)</initializer>
        <briefdescription>
<para>Default RoPE theta (matches common HF defaults). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="63" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="63" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" prot="public" static="no">
        <name>IE_GPTOSS_MOE_TOPK_DEFAULT</name>
        <initializer>(4u)</initializer>
        <briefdescription>
<para>Default MoE routing top-k (most MoE LLMs use 4). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="65" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="65" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" prot="public" static="no">
        <name>IE_LOGE</name>
        <param><defname>...</defname></param>
        <initializer><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(<ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" kindref="member">IE_LL_ERROR</ref>, __FILE__, __LINE__, __VA_ARGS__)</initializer>
        <briefdescription>
<para>Emit an ERROR-level log line. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="136" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="136" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" prot="public" static="no">
        <name>IE_LOGW</name>
        <param><defname>...</defname></param>
        <initializer><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(<ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" kindref="member">IE_LL_WARN</ref>,  __FILE__, __LINE__, __VA_ARGS__)</initializer>
        <briefdescription>
<para>Emit a WARN-level log line. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="138" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="138" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" prot="public" static="no">
        <name>IE_LOGI</name>
        <param><defname>...</defname></param>
        <initializer><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(<ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" kindref="member">IE_LL_INFO</ref>,  __FILE__, __LINE__, __VA_ARGS__)</initializer>
        <briefdescription>
<para>Emit an INFO-level log line. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="140" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="140" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" prot="public" static="no">
        <name>IE_LOGD</name>
        <param><defname>...</defname></param>
        <initializer><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(<ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" kindref="member">IE_LL_DEBUG</ref>, __FILE__, __LINE__, __VA_ARGS__)</initializer>
        <briefdescription>
<para>Emit a DEBUG-level log line. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="142" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="142" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a25c7e8c3a8c0a5c73b0296bea92d5378" prot="public" static="no">
        <name>IE_LOGT</name>
        <param><defname>...</defname></param>
        <initializer><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(<ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" kindref="member">IE_LL_TRACE</ref>, __FILE__, __LINE__, __VA_ARGS__)</initializer>
        <briefdescription>
<para>Emit a TRACE-level log line. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="144" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="144" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="infer__gptoss_8c_1a54c96bba1e88a7dafb048d8a8918e5c8" prot="public" static="no">
        <name>IE_WEAK</name>
        <briefdescription>
<para>Weak symbol attribute fallback (no-op). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="155" column="9" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="155" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="enum">
      <memberdef kind="enum" id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5" prot="public" static="no" strong="no">
        <type></type>
        <name></name>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a21d08249c32f255fe865e4fdd33563a0" prot="public">
          <name>IE_LL_QUIET</name>
          <initializer>= 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" prot="public">
          <name>IE_LL_ERROR</name>
          <initializer>= 1</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" prot="public">
          <name>IE_LL_WARN</name>
          <initializer>= 2</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" prot="public">
          <name>IE_LL_INFO</name>
          <initializer>= 3</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" prot="public">
          <name>IE_LL_DEBUG</name>
          <initializer>= 4</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" prot="public">
          <name>IE_LL_TRACE</name>
          <initializer>= 5</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <briefdescription>
<para>Internal log levels (higher means more verbose). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="74" column="1" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="74" bodyend="81"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="typedef">
      <memberdef kind="typedef" id="infer__gptoss_8c_1a2bac3f0797bd82aaa2a994091efc0b71" prot="public" static="no">
        <type>struct <ref refid="structie__moe__w" kindref="compound">ie_moe_w</ref></type>
        <definition>typedef struct ie_moe_w ie_moe_w_t</definition>
        <argsstring></argsstring>
        <name>ie_moe_w_t</name>
        <briefdescription>
<para>Per-layer MoE weight views (router + expert matrices). </para>
        </briefdescription>
        <detaileddescription>
<para>Expert matrices are assumed to be stored in &quot;expert-major&quot; order: contiguous blocks/scales/bias for each expert, with strides recorded here. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="241" column="12"/>
      </memberdef>
      <memberdef kind="typedef" id="infer__gptoss_8c_1a3e426421aa66fb663b1f85438878bd5a" prot="public" static="no">
        <type>struct <ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w</ref></type>
        <definition>typedef struct ie_gptoss_layer_w ie_gptoss_layer_w_t</definition>
        <argsstring></argsstring>
        <name>ie_gptoss_layer_w_t</name>
        <briefdescription>
<para>Per-layer weight views for attention + MoE. </para>
        </briefdescription>
        <detaileddescription>
<para>All attention weights are BF16 (HF-style linear layout [out, in]). MoE expert weights are Q4_0-like blocks/scales with optional BF16 bias. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="348" column="21"/>
      </memberdef>
      <memberdef kind="typedef" id="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" prot="public" static="no">
        <type>struct <ref refid="structie__tensor__view" kindref="compound">ie_tensor_view</ref></type>
        <definition>typedef struct ie_tensor_view ie_tensor_view_t</definition>
        <argsstring></argsstring>
        <name>ie_tensor_view_t</name>
        <briefdescription>
<para>A resolved tensor pointer plus its descriptor. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="790" column="18"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="var">
      <memberdef kind="variable" id="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" prot="public" static="yes" mutable="no">
        <type>int</type>
        <definition>int ie_log_level_cached</definition>
        <argsstring></argsstring>
        <name>ie_log_level_cached</name>
        <initializer>= -1</initializer>
        <briefdescription>
<para>Cached log level parsed from IE_LOG_LEVEL (negative means &quot;unset&quot;). </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="84" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="84" bodyend="-1"/>
        <referencedby refid="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" compoundref="infer__gptoss_8c" startline="90" endline="106">ie_log_level</referencedby>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_log_level</definition>
        <argsstring>(void)</argsstring>
        <name>ie_log_level</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Read IE_LOG_LEVEL once and cache the result. </para>
        </briefdescription>
        <detaileddescription>
<para><simplesect kind="return"><para>Cached log level in [0..5]. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="90" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="90" bodyend="106"/>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" compoundref="infer__gptoss_8c" startline="77">IE_LL_WARN</references>
        <references refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" compoundref="infer__gptoss_8c" startline="84">ie_log_level_cached</references>
        <referencedby refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" compoundref="infer__gptoss_8c" startline="115" endline="133">ie_logf</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_logf</definition>
        <argsstring>(int lvl, const char *file, int line, const char *fmt,...)</argsstring>
        <name>ie_logf</name>
        <param>
          <type>int</type>
          <declname>lvl</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>file</declname>
        </param>
        <param>
          <type>int</type>
          <declname>line</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>fmt</declname>
        </param>
        <param>
          <type>...</type>
        </param>
        <briefdescription>
<para>Print a formatted log line if the level is enabled. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>lvl</parametername>
</parameternamelist>
<parameterdescription>
<para>Message level. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>file</parametername>
</parameternamelist>
<parameterdescription>
<para>Source file. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>line</parametername>
</parameternamelist>
<parameterdescription>
<para>Source line. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fmt</parametername>
</parameternamelist>
<parameterdescription>
<para>printf-style format string. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="115" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="115" bodyend="133"/>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" compoundref="infer__gptoss_8c" startline="79">IE_LL_DEBUG</references>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" compoundref="infer__gptoss_8c" startline="76">IE_LL_ERROR</references>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" compoundref="infer__gptoss_8c" startline="78">IE_LL_INFO</references>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" compoundref="infer__gptoss_8c" startline="80">IE_LL_TRACE</references>
        <references refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" compoundref="infer__gptoss_8c" startline="77">IE_LL_WARN</references>
        <references refid="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" compoundref="infer__gptoss_8c" startline="90" endline="106">ie_log_level</references>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_gptoss_infer_destroy</definition>
        <argsstring>(ie_gptoss_infer_t *ctx)</argsstring>
        <name>ie_gptoss_infer_destroy</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <briefdescription>
<para>Destroy an inference context. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>ctx</parametername>
</parameternamelist>
<parameterdescription>
<para>Context handle (may be NULL). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2292" column="6" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2292" bodyend="2335" declfile="engine/src/runtime/infer_gptoss.c" declline="169" declcolumn="6"/>
        <references refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" compoundref="infer__gptoss_8c" startline="430">ie_gptoss_infer_impl::attn_out</references>
        <references refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" compoundref="infer__gptoss_8c" startline="376">ie_gptoss_infer_impl::bin_base</references>
        <references refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" compoundref="infer__gptoss_8c" startline="379">ie_gptoss_infer_impl::bin_size</references>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1aa47d37a36d18e17af565d12559d481c7" compoundref="infer__gptoss_8c" startline="604" endline="607">ie_munmap_ro</references>
        <references refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" compoundref="infer__gptoss_8c" startline="424">ie_gptoss_infer_impl::k</references>
        <references refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" compoundref="infer__gptoss_8c" startline="332">ie_gptoss_layer_w::k_b_f32</references>
        <references refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" compoundref="infer__gptoss_8c" startline="329">ie_gptoss_layer_w::k_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" compoundref="infer__gptoss_8c" startline="409">ie_gptoss_infer_impl::layers</references>
        <references refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" compoundref="infer__gptoss_8c" startline="254">ie_gptoss_layer_w::ln1_w_f32</references>
        <references refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" compoundref="infer__gptoss_8c" startline="260">ie_gptoss_layer_w::ln2_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" compoundref="infer__gptoss_8c" startline="433">ie_gptoss_infer_impl::mlp_gate</references>
        <references refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" compoundref="infer__gptoss_8c" startline="440">ie_gptoss_infer_impl::mlp_up</references>
        <references refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" compoundref="infer__gptoss_8c" startline="347">ie_gptoss_layer_w::moe</references>
        <references refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" compoundref="ie__infer_8h" startline="42">ie_gptoss_hparams::n_layers</references>
        <references refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" compoundref="infer__gptoss_8c" startline="344">ie_gptoss_layer_w::o_b_f32</references>
        <references refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" compoundref="infer__gptoss_8c" startline="341">ie_gptoss_layer_w::o_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" compoundref="infer__gptoss_8c" startline="421">ie_gptoss_infer_impl::q</references>
        <references refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" compoundref="infer__gptoss_8c" startline="326">ie_gptoss_layer_w::q_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" compoundref="infer__gptoss_8c" startline="323">ie_gptoss_layer_w::q_w_f32</references>
        <references refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" compoundref="infer__gptoss_8c" startline="195">ie_moe_w::router_b_f32</references>
        <references refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" compoundref="infer__gptoss_8c" startline="446">ie_gptoss_infer_impl::router_logits</references>
        <references refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" compoundref="infer__gptoss_8c" startline="192">ie_moe_w::router_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" compoundref="infer__gptoss_8c" startline="443">ie_gptoss_infer_impl::scores</references>
        <references refid="tensor__map_8h_1a42d154b3f93b07c41b514e468a61c803" compoundref="tensor__map_8c" startline="650" endline="660">tensor_map_free</references>
        <references refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" compoundref="infer__gptoss_8c" startline="370">ie_gptoss_infer_impl::tmap</references>
        <references refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" compoundref="infer__gptoss_8c" startline="373">ie_gptoss_infer_impl::tmap_path_used</references>
        <references refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" compoundref="infer__gptoss_8c" startline="427">ie_gptoss_infer_impl::v</references>
        <references refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" compoundref="infer__gptoss_8c" startline="338">ie_gptoss_layer_w::v_b_f32</references>
        <references refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" compoundref="infer__gptoss_8c" startline="335">ie_gptoss_layer_w::v_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" compoundref="infer__gptoss_8c" startline="406">ie_gptoss_infer_impl::w_lm_f32</references>
        <references refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" compoundref="infer__gptoss_8c" startline="391">ie_gptoss_infer_impl::w_norm_f32</references>
        <references refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" compoundref="infer__gptoss_8c" startline="412">ie_gptoss_infer_impl::x</references>
        <references refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" compoundref="infer__gptoss_8c" startline="415">ie_gptoss_infer_impl::x1</references>
        <references refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" compoundref="infer__gptoss_8c" startline="418">ie_gptoss_infer_impl::x2</references>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
        <referencedby refid="ie__api_8h_1a5a9a30f05ef6183f6a75811c616b3a0a" compoundref="ie__api_8c" startline="788" endline="816">ie_engine_destroy</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a23c0a7a4138efca538e74eda244f02e4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>size_t</type>
        <definition>static size_t ie_min_size</definition>
        <argsstring>(size_t a, size_t b)</argsstring>
        <name>ie_min_size</name>
        <param>
          <type>size_t</type>
          <declname>a</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>b</declname>
        </param>
        <briefdescription>
<para>Return the minimum of two size_t values. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>a</parametername>
</parameternamelist>
<parameterdescription>
<para>First value. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>b</parametername>
</parameternamelist>
<parameterdescription>
<para>Second value. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>min(a, b). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="495" column="15" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="495" bodyend="495"/>
        <referencedby refid="ie__infer_8h_1a39827a388a0b7dd6d161e99b111c5546" compoundref="infer__gptoss_8c" startline="2337" endline="2363">ie_gptoss_infer_prefill</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a051dcc7bf1e50054f8b124fc1e740288" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t ie_u32_min</definition>
        <argsstring>(uint32_t a, uint32_t b)</argsstring>
        <name>ie_u32_min</name>
        <param>
          <type>uint32_t</type>
          <declname>a</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>b</declname>
        </param>
        <briefdescription>
<para>Return the minimum of two uint32_t values. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>a</parametername>
</parameternamelist>
<parameterdescription>
<para>First value. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>b</parametername>
</parameternamelist>
<parameterdescription>
<para>Second value. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>min(a, b). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="503" column="17" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="503" bodyend="503"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a37a69a9cc6c14a335fdcf1df79093005" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>static char * ie_dirname_alloc</definition>
        <argsstring>(const char *path)</argsstring>
        <name>ie_dirname_alloc</name>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <briefdescription>
<para>Allocate and return the directory portion of a path. </para>
        </briefdescription>
        <detaileddescription>
<para>If no slash is present, returns &quot;.&quot;. If the path is rooted and the only slash is the first character, returns &quot;/&quot;.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>Input path. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Newly allocated directory string (caller frees), or NULL on OOM. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="514" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="514" bodyend="540"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1abaa225eee9cc8e6cf2813fad866a16c1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>static char * ie_path_join_alloc</definition>
        <argsstring>(const char *a, const char *b)</argsstring>
        <name>ie_path_join_alloc</name>
        <param>
          <type>const char *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>b</declname>
        </param>
        <briefdescription>
<para>Join two path components with exactly one slash. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>a</parametername>
</parameternamelist>
<parameterdescription>
<para>Left component. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>b</parametername>
</parameternamelist>
<parameterdescription>
<para>Right component. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Newly allocated joined path (caller frees), or NULL on OOM. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="548" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="548" bodyend="563"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a350055e3279aa56a313cc54048c81b52" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_mmap_ro</definition>
        <argsstring>(const char *path, uint8_t **out_base, size_t *out_size)</argsstring>
        <name>ie_mmap_ro</name>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>uint8_t **</type>
          <declname>out_base</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_size</declname>
        </param>
        <briefdescription>
<para>Memory-map a file read-only. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>path</parametername>
</parameternamelist>
<parameterdescription>
<para>File path. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_base</parametername>
</parameternamelist>
<parameterdescription>
<para>Receives mapped base address. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_size</parametername>
</parameternamelist>
<parameterdescription>
<para>Receives mapped size in bytes. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative error code on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="572" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="572" bodyend="597"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa47d37a36d18e17af565d12559d481c7" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_munmap_ro</definition>
        <argsstring>(uint8_t *base, size_t size)</argsstring>
        <name>ie_munmap_ro</name>
        <param>
          <type>uint8_t *</type>
          <declname>base</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>size</declname>
        </param>
        <briefdescription>
<para>Unmap a previously mapped read-only file. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>base</parametername>
</parameternamelist>
<parameterdescription>
<para>Mapped base address. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>size</parametername>
</parameternamelist>
<parameterdescription>
<para>Mapped size in bytes. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="604" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="604" bodyend="607"/>
        <referencedby refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" compoundref="infer__gptoss_8c" startline="2292" endline="2335">ie_gptoss_infer_destroy</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a2695e784cb752a5747eb95892e2ef6af" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t ie_env_u32_clamped</definition>
        <argsstring>(const char *name, uint32_t def, uint32_t lo, uint32_t hi)</argsstring>
        <name>ie_env_u32_clamped</name>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>def</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>lo</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>hi</declname>
        </param>
        <briefdescription>
<para>Parse an environment variable as uint32, with bounds and default. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Environment variable name. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>def</parametername>
</parameternamelist>
<parameterdescription>
<para>Default if unset or invalid. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>lo</parametername>
</parameternamelist>
<parameterdescription>
<para>Inclusive lower bound. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>hi</parametername>
</parameternamelist>
<parameterdescription>
<para>Inclusive upper bound. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Parsed and clamped value. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="617" column="17" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="617" bodyend="628"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>static float ie_env_f32_clamped</definition>
        <argsstring>(const char *name, float def, float lo, float hi)</argsstring>
        <name>ie_env_f32_clamped</name>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <param>
          <type>float</type>
          <declname>def</declname>
        </param>
        <param>
          <type>float</type>
          <declname>lo</declname>
        </param>
        <param>
          <type>float</type>
          <declname>hi</declname>
        </param>
        <briefdescription>
<para>Parse an environment variable as float, with bounds and default. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Environment variable name. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>def</parametername>
</parameternamelist>
<parameterdescription>
<para>Default if unset or invalid. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>lo</parametername>
</parameternamelist>
<parameterdescription>
<para>Inclusive lower bound. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>hi</parametername>
</parameternamelist>
<parameterdescription>
<para>Inclusive upper bound. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Parsed and clamped value. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="638" column="14" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="638" bodyend="649"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_env_flag</definition>
        <argsstring>(const char *name)</argsstring>
        <name>ie_env_flag</name>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <briefdescription>
<para>Parse an environment variable as boolean. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Environment variable name. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>1 if enabled, 0 otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="656" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="656" bodyend="663"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_alloc_f32_from_bf16</definition>
        <argsstring>(const uint16_t *src, size_t n, float **out)</argsstring>
        <name>ie_alloc_f32_from_bf16</name>
        <param>
          <type>const uint16_t *</type>
          <declname>src</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>float **</type>
          <declname>out</declname>
        </param>
        <briefdescription>
<para>Allocate and convert BF16 weights to FP32. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>src</parametername>
</parameternamelist>
<parameterdescription>
<para>BF16 source buffer. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of elements. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Receives allocated FP32 buffer (or NULL if src/n is empty). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="672" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="672" bodyend="681"/>
        <references refid="ie__kernels_8h_1a782b7a53732be7ae0a2f0eb663e36321" compoundref="gemv__generic_8c" startline="220" endline="223">ie_vec_bf16_to_f32</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" prot="public" static="yes" const="no" explicit="no" inline="yes" virt="non-virtual">
        <type>float</type>
        <definition>static float ie_bf16_to_f32</definition>
        <argsstring>(uint16_t v)</argsstring>
        <name>ie_bf16_to_f32</name>
        <param>
          <type>uint16_t</type>
          <declname>v</declname>
        </param>
        <briefdescription>
<para>Convert a BF16 value to float32. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>v</parametername>
</parameternamelist>
<parameterdescription>
<para>BF16 bits. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>float32 value. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="692" column="21" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="692" bodyend="699"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
        <referencedby refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" compoundref="infer__gptoss_8c" startline="940" endline="953">ie_rmsnorm_cpu_f32_bf16w</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a9acc6f2706c714def21ba7cb496ca00c" prot="public" static="yes" const="no" explicit="no" inline="yes" virt="non-virtual">
        <type>float</type>
        <definition>static float ie_silu_f32</definition>
        <argsstring>(float x)</argsstring>
        <name>ie_silu_f32</name>
        <param>
          <type>float</type>
          <declname>x</declname>
        </param>
        <briefdescription>
<para>SiLU activation function. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Input. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>SiLU(x). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="706" column="21" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="706" bodyend="706"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_debug_nan_enabled_</definition>
        <argsstring>(void)</argsstring>
        <name>ie_debug_nan_enabled_</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="708" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="708" bodyend="715"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_trace_bf16_enabled_</definition>
        <argsstring>(void)</argsstring>
        <name>ie_trace_bf16_enabled_</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="717" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="717" bodyend="724"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_check_finite_f32_</definition>
        <argsstring>(const float *v, size_t n, const char *tag, uint32_t layer, uint32_t pos)</argsstring>
        <name>ie_check_finite_f32_</name>
        <param>
          <type>const float *</type>
          <declname>v</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>tag</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>layer</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>pos</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="726" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="726" bodyend="737"/>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>static float ie_dot_f32</definition>
        <argsstring>(const float *a, const float *b, size_t n)</argsstring>
        <name>ie_dot_f32</name>
        <param>
          <type>const float *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
<para>Dot product of two float32 vectors. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>a</parametername>
</parameternamelist>
<parameterdescription>
<para>Vector A. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>b</parametername>
</parameternamelist>
<parameterdescription>
<para>Vector B. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of elements. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Sum_i a[i] * b[i]. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="750" column="14" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="750" bodyend="754"/>
        <referencedby refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" compoundref="infer__gptoss_8c" startline="1031" endline="1060">ie_attn_causal_gqa_f32</referencedby>
        <referencedby refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" compoundref="infer__gptoss_8c" startline="1000" endline="1029">ie_attn_cpu_causal_f32</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_softmax_inplace_f32</definition>
        <argsstring>(float *x, size_t n)</argsstring>
        <name>ie_softmax_inplace_f32</name>
        <param>
          <type>float *</type>
          <declname>x</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
<para>In-place softmax over an array of float32 values. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Array (modified in-place). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of elements. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="761" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="761" bodyend="776"/>
        <referencedby refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" compoundref="infer__gptoss_8c" startline="1031" endline="1060">ie_attn_causal_gqa_f32</referencedby>
        <referencedby refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" compoundref="infer__gptoss_8c" startline="1000" endline="1029">ie_attn_cpu_causal_f32</referencedby>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa3b82aa04620edd8580f7ecf25a76f5f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const <ref refid="tensor__map_8h_1a1ed0f6ce08b1582103651d4fd14a30f1" kindref="member">tensor_desc_t</ref> *</type>
        <definition>static const tensor_desc_t * ie_w_find</definition>
        <argsstring>(const tensor_map_t *tmap, const char *name)</argsstring>
        <name>ie_w_find</name>
        <param>
          <type>const <ref refid="tensor__map_8h_1a0ae1dced25c800bf85537db1ce9776a7" kindref="member">tensor_map_t</ref> *</type>
          <declname>tmap</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <briefdescription>
<para>Find a tensor descriptor by name in a tensor map. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>tmap</parametername>
</parameternamelist>
<parameterdescription>
<para>Tensor map. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Tensor name. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Descriptor pointer or NULL if not found. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="798" column="28" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="798" bodyend="801"/>
        <references refid="tensor__map_8h_1abe58b80593931ffe5844ee4bcee805c5" compoundref="tensor__map_8c" startline="662" endline="669">tensor_map_find</references>
        <referencedby refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" compoundref="infer__gptoss_8c" startline="810" endline="826">ie_w_get_view</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_w_get_view</definition>
        <argsstring>(const struct ie_gptoss_infer_impl *impl, const char *name, ie_tensor_view_t *out)</argsstring>
        <name>ie_w_get_view</name>
        <param>
          <type>const struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <param>
          <type><ref refid="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" kindref="member">ie_tensor_view_t</ref> *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
<para>Resolve a tensor pointer by name. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>impl</parametername>
</parameternamelist>
<parameterdescription>
<para>Inference implementation. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Tensor name. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output view. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative code on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="810" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="810" bodyend="826"/>
        <references refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" compoundref="infer__gptoss_8c" startline="376">ie_gptoss_infer_impl::bin_base</references>
        <references refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" compoundref="infer__gptoss_8c" startline="379">ie_gptoss_infer_impl::bin_size</references>
        <references refid="infer__gptoss_8c_1aa3b82aa04620edd8580f7ecf25a76f5f" compoundref="infer__gptoss_8c" startline="798" endline="801">ie_w_find</references>
        <references refid="structtensor__desc__s_1a0abe393a370bda31eda8ab11a5f8df37" compoundref="tensor__map_8h" startline="96">tensor_desc_s::offset</references>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <references refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" compoundref="infer__gptoss_8c" startline="370">ie_gptoss_infer_impl::tmap</references>
        <referencedby refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" compoundref="infer__gptoss_8c" startline="836" endline="854">ie_w_get_first_view</referencedby>
        <referencedby refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" compoundref="infer__gptoss_8c" startline="866" endline="899">ie_w_get_layer_fmt_view</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_w_get_first_view</definition>
        <argsstring>(const struct ie_gptoss_infer_impl *impl, const char *const *names, size_t count, ie_tensor_view_t *out)</argsstring>
        <name>ie_w_get_first_view</name>
        <param>
          <type>const struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type>const char *const *</type>
          <declname>names</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>count</declname>
        </param>
        <param>
          <type><ref refid="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" kindref="member">ie_tensor_view_t</ref> *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
<para>Resolve the first tensor found among a list of candidate names. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>impl</parametername>
</parameternamelist>
<parameterdescription>
<para>Inference implementation. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>names</parametername>
</parameternamelist>
<parameterdescription>
<para>Candidate name array. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>count</parametername>
</parameternamelist>
<parameterdescription>
<para>Candidate count. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output view. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative code on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="836" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="836" bodyend="854"/>
        <references refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" compoundref="infer__gptoss_8c" startline="142">IE_LOGD</references>
        <references refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" compoundref="infer__gptoss_8c" startline="810" endline="826">ie_w_get_view</references>
        <references refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" compoundref="tensor__map_8h" startline="189" endline="211">tensor_desc_to_string</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_w_get_layer_fmt_view</definition>
        <argsstring>(const struct ie_gptoss_infer_impl *impl, uint32_t layer, const char *const *fmts, size_t count, ie_tensor_view_t *out, int required)</argsstring>
        <name>ie_w_get_layer_fmt_view</name>
        <param>
          <type>const struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>layer</declname>
        </param>
        <param>
          <type>const char *const *</type>
          <declname>fmts</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>count</declname>
        </param>
        <param>
          <type><ref refid="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" kindref="member">ie_tensor_view_t</ref> *</type>
          <declname>out</declname>
        </param>
        <param>
          <type>int</type>
          <declname>required</declname>
        </param>
        <briefdescription>
<para>Resolve a layer tensor using a list of snprintf formats. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>impl</parametername>
</parameternamelist>
<parameterdescription>
<para>Inference implementation. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>layer</parametername>
</parameternamelist>
<parameterdescription>
<para>Layer index. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>fmts</parametername>
</parameternamelist>
<parameterdescription>
<para>Candidate snprintf formats (must include u for layer). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>count</parametername>
</parameternamelist>
<parameterdescription>
<para>Candidate format count. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output view. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>required</parametername>
</parameternamelist>
<parameterdescription>
<para>If nonzero, missing tensor is an error; otherwise returns success with NULL view. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative code on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="866" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="866" bodyend="899"/>
        <references refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" compoundref="infer__gptoss_8c" startline="142">IE_LOGD</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" compoundref="infer__gptoss_8c" startline="810" endline="826">ie_w_get_view</references>
        <references refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" compoundref="tensor__map_8h" startline="189" endline="211">tensor_desc_to_string</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
        <referencedby refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" compoundref="infer__gptoss_8c" startline="1129" endline="1282">ie_resolve_moe_layer</referencedby>
        <referencedby refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" compoundref="infer__gptoss_8c" startline="1284" endline="1353">ie_resolve_q4_attn_weight</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_require_size_eq</definition>
        <argsstring>(const tensor_desc_t *td, uint64_t want_bytes)</argsstring>
        <name>ie_require_size_eq</name>
        <param>
          <type>const <ref refid="tensor__map_8h_1a1ed0f6ce08b1582103651d4fd14a30f1" kindref="member">tensor_desc_t</ref> *</type>
          <declname>td</declname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>want_bytes</declname>
        </param>
        <briefdescription>
<para>Require exact byte size for a tensor. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>td</parametername>
</parameternamelist>
<parameterdescription>
<para>Tensor descriptor. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>want_bytes</parametername>
</parameternamelist>
<parameterdescription>
<para>Required byte size. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 if sizes match, negative code otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="907" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="907" bodyend="922"/>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="structtensor__desc__s_1a1134b2dbce500003f3b011f3e8a3d090" compoundref="tensor__map_8h" startline="94">tensor_desc_s::name</references>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <references refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" compoundref="tensor__map_8h" startline="189" endline="211">tensor_desc_to_string</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
        <referencedby refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" compoundref="infer__gptoss_8c" startline="1129" endline="1282">ie_resolve_moe_layer</referencedby>
        <referencedby refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" compoundref="infer__gptoss_8c" startline="1284" endline="1353">ie_resolve_q4_attn_weight</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_rmsnorm_cpu_f32</definition>
        <argsstring>(const float *x, const float *w, size_t n, float eps, float *y)</argsstring>
        <name>ie_rmsnorm_cpu_f32</name>
        <param>
          <type>const float *</type>
          <declname>x</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>w</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>float</type>
          <declname>eps</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>y</declname>
        </param>
        <briefdescription>
<para>RMSNorm (FP32) for a single vector. </para>
        </briefdescription>
        <detaileddescription>
<para>Computes: y[i] = x[i] * w[i] / sqrt(mean(x^2) + eps)</para>
<para>This is the reference CPU implementation used by the GPT-OSS orchestration. Implementations may be swapped by the build in the future, but the signature is stable for the runtime.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Input vector (length n). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>w</parametername>
</parameternamelist>
<parameterdescription>
<para>Weight vector (length n). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of elements. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>eps</parametername>
</parameternamelist>
<parameterdescription>
<para>Epsilon added to the mean square before sqrt. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>y</parametername>
</parameternamelist>
<parameterdescription>
<para>Output vector (length n). May alias x for in-place behavior. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative on invalid args.</para>
</simplesect>
RMSNorm (FP32) for a single vector.</para>
<para>This function performs:<itemizedlist>
<listitem><para>mean-square accumulation with a double accumulator for improved stability,</para>
</listitem><listitem><para>a single sqrtf and reciprocal,</para>
</listitem><listitem><para>per-element scaling by the provided weight vector.</para>
</listitem></itemizedlist>
</para>
<para>The function is designed to be allocation-free and deterministic. It does not attempt SIMD vectorization; higher-performance backends may be added later.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Input vector of length <computeroutput>n</computeroutput>. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>w</parametername>
</parameternamelist>
<parameterdescription>
<para>Per-channel scale vector of length <computeroutput>n</computeroutput>. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of elements in <computeroutput>x</computeroutput> and <computeroutput>w</computeroutput>. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>eps</parametername>
</parameternamelist>
<parameterdescription>
<para>Small epsilon added inside the sqrt for numerical stability. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>y</parametername>
</parameternamelist>
<parameterdescription>
<para>Output vector of length <computeroutput>n</computeroutput> (may alias <computeroutput>x</computeroutput>). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, non-zero on invalid arguments. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="928" column="8" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="928" bodyend="938"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_rmsnorm_cpu_f32_bf16w</definition>
        <argsstring>(const float *x, const uint16_t *w_bf16, size_t n, float eps, float *y)</argsstring>
        <name>ie_rmsnorm_cpu_f32_bf16w</name>
        <param>
          <type>const float *</type>
          <declname>x</declname>
        </param>
        <param>
          <type>const uint16_t *</type>
          <declname>w_bf16</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>float</type>
          <declname>eps</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>y</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="940" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="940" bodyend="953"/>
        <references refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" compoundref="infer__gptoss_8c" startline="692" endline="699">ie_bf16_to_f32</references>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_rope_apply_f32</definition>
        <argsstring>(float *q, float *k, size_t heads, size_t head_dim, uint32_t pos, float theta)</argsstring>
        <name>ie_rope_apply_f32</name>
        <param>
          <type>float *</type>
          <declname>q</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>k</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>heads</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>head_dim</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>pos</declname>
        </param>
        <param>
          <type>float</type>
          <declname>theta</declname>
        </param>
        <briefdescription>
<para>Apply Rotary Positional Embedding (RoPE) to Q and K for a single position. </para>
        </briefdescription>
        <detaileddescription>
<para>Apply RoPE to Q and/or K for multiple heads.</para>
<para>This function applies RoPE on the first head_dim elements, interpreted as interleaved pairs (even, odd): (x0, x1) -&gt; (x0*cos - x1*sin, x0*sin + x1*cos)</para>
<para>The caller passes Q and K shaped as [heads, head_dim] flattened.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>q</parametername>
</parameternamelist>
<parameterdescription>
<para>Q buffer, [heads * head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>k</parametername>
</parameternamelist>
<parameterdescription>
<para>K buffer, [heads * head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>heads</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of heads in q/k. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>head_dim</parametername>
</parameternamelist>
<parameterdescription>
<para>Head dimension (must be even for paired rotation). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>pos</parametername>
</parameternamelist>
<parameterdescription>
<para>Sequence position (0-based). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>theta</parametername>
</parameternamelist>
<parameterdescription>
<para>RoPE base (commonly 10000.0f). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative on invalid args. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="955" column="8" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="955" bodyend="994"/>
        <references refid="rope_8c_1ae8c1140c5d28dc4907041cd146b5f083" compoundref="rope_8c" startline="141" endline="169">ie_rope_apply_one_f32</references>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_attn_cpu_causal_f32</definition>
        <argsstring>(const float *Q, const float *K, const float *V, size_t seq_len, size_t n_heads, size_t head_dim, float inv_sqrt_d, float *out, float *scores)</argsstring>
        <name>ie_attn_cpu_causal_f32</name>
        <param>
          <type>const float *</type>
          <declname>Q</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>K</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>V</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>seq_len</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>heads</declname>
          <defname>n_heads</defname>
        </param>
        <param>
          <type>size_t</type>
          <declname>head_dim</declname>
        </param>
        <param>
          <type>float</type>
          <declname>inv_sqrt_d</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>out</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>scratch</declname>
          <defname>scores</defname>
        </param>
        <briefdescription>
<para>Causal self-attention (FP32 reference). </para>
        </briefdescription>
        <detaileddescription>
<para>Computes per-head softmax(QK^T * inv_sqrt_d) V over seq_len tokens.</para>
<para>Layout:<itemizedlist>
<listitem><para>Q and out are [heads, head_dim] flattened (head_dim fastest).</para>
</listitem><listitem><para>K and V are [seq_len, heads, head_dim] flattened (head_dim fastest).</para>
</listitem></itemizedlist>
</para>
<para>scratch must have length &gt;= seq_len (floats) and is reused per head.</para>
<para><simplesect kind="return"><para>0 on success, non-zero on invalid args.</para>
</simplesect>
Causal self-attention (FP32 reference).</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>Q</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to Q slice [heads*head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>K</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to K cache [seq_len*heads*head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>V</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to V cache [seq_len*heads*head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>seq_len</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of cached tokens to attend over (&gt;= 1). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>heads</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of heads (&gt;= 1). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>head_dim</parametername>
</parameternamelist>
<parameterdescription>
<para>Dimension per head (&gt;= 1). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>inv_sqrt_d</parametername>
</parameternamelist>
<parameterdescription>
<para>Scale factor (typically 1/sqrt(head_dim)). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output buffer [heads*head_dim]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>scratch</parametername>
</parameternamelist>
<parameterdescription>
<para>Scratch buffer [seq_len] floats (reused per head). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, non-zero on invalid args. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1000" column="8" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1000" bodyend="1029"/>
        <references refid="attn__cpu_8c_1a4e1a8399e32d077b981110a3c08e8320" compoundref="attn__cpu_8c" startline="32" endline="36">dot_f32</references>
        <references refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" compoundref="infer__gptoss_8c" startline="750" endline="754">ie_dot_f32</references>
        <references refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" compoundref="infer__gptoss_8c" startline="761" endline="776">ie_softmax_inplace_f32</references>
        <references refid="attn__cpu_8c_1ad5555aa8e041b72954b935810045059e" compoundref="attn__cpu_8c" startline="28" endline="30">kv_index</references>
        <references refid="attn__cpu_8c_1a3cc66078411d0c78b7be0b2d1f35e0b7" compoundref="attn__cpu_8c" startline="38" endline="60">softmax_inplace_f32</references>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_attn_causal_gqa_f32</definition>
        <argsstring>(const float *Q, const float *K, const float *V, uint32_t seq_len, uint32_t n_heads, uint32_t n_kv_heads, uint32_t head_dim, float inv_sqrt_d, float *out, float *scores)</argsstring>
        <name>ie_attn_causal_gqa_f32</name>
        <param>
          <type>const float *</type>
          <declname>Q</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>K</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>V</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>seq_len</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>n_heads</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>n_kv_heads</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>head_dim</declname>
        </param>
        <param>
          <type>float</type>
          <declname>inv_sqrt_d</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>out</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>scores</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1031" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1031" bodyend="1060"/>
        <references refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" compoundref="infer__gptoss_8c" startline="750" endline="754">ie_dot_f32</references>
        <references refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" compoundref="infer__gptoss_8c" startline="761" endline="776">ie_softmax_inplace_f32</references>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1adbcf08258315917d586a46d5c2838aca" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_infer_n_experts_from_router</definition>
        <argsstring>(const tensor_desc_t *td_router_w, uint32_t d_model, uint32_t *out_n_experts)</argsstring>
        <name>ie_infer_n_experts_from_router</name>
        <param>
          <type>const <ref refid="tensor__map_8h_1a1ed0f6ce08b1582103651d4fd14a30f1" kindref="member">tensor_desc_t</ref> *</type>
          <declname>td_router_w</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>d_model</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_n_experts</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1066" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1066" bodyend="1080"/>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <referencedby refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" compoundref="infer__gptoss_8c" startline="1129" endline="1282">ie_resolve_moe_layer</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_moe_expected_bytes</definition>
        <argsstring>(uint32_t n_experts, uint32_t rows, uint32_t cols, uint8_t scale_bytes, uint64_t *out_blocks_bytes, uint64_t *out_scales_bytes)</argsstring>
        <name>ie_moe_expected_bytes</name>
        <param>
          <type>uint32_t</type>
          <declname>n_experts</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>rows</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>cols</declname>
        </param>
        <param>
          <type>uint8_t</type>
          <declname>scale_bytes</declname>
        </param>
        <param>
          <type>uint64_t *</type>
          <declname>out_blocks_bytes</declname>
        </param>
        <param>
          <type>uint64_t *</type>
          <declname>out_scales_bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1082" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1082" bodyend="1103"/>
        <referencedby refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" compoundref="infer__gptoss_8c" startline="1129" endline="1282">ie_resolve_moe_layer</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_q4_expected_bytes</definition>
        <argsstring>(uint32_t rows, uint32_t cols, uint8_t scale_bytes, uint64_t *out_blocks_bytes, uint64_t *out_scales_bytes)</argsstring>
        <name>ie_q4_expected_bytes</name>
        <param>
          <type>uint32_t</type>
          <declname>rows</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>cols</declname>
        </param>
        <param>
          <type>uint8_t</type>
          <declname>scale_bytes</declname>
        </param>
        <param>
          <type>uint64_t *</type>
          <declname>out_blocks_bytes</declname>
        </param>
        <param>
          <type>uint64_t *</type>
          <declname>out_scales_bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1105" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1105" bodyend="1118"/>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
        <referencedby refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" compoundref="infer__gptoss_8c" startline="1284" endline="1353">ie_resolve_q4_attn_weight</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_add_bias_f32</definition>
        <argsstring>(float *dst, const float *bias, size_t n)</argsstring>
        <name>ie_add_bias_f32</name>
        <param>
          <type>float *</type>
          <declname>dst</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>bias</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1120" column="13" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1120" bodyend="1123"/>
        <referencedby refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_resolve_moe_layer</definition>
        <argsstring>(struct ie_gptoss_infer_impl *impl, uint32_t l, ie_gptoss_layer_w_t *LW)</argsstring>
        <name>ie_resolve_moe_layer</name>
        <param>
          <type>struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>l</declname>
        </param>
        <param>
          <type><ref refid="infer__gptoss_8c_1a3e426421aa66fb663b1f85438878bd5a" kindref="member">ie_gptoss_layer_w_t</ref> *</type>
          <declname>LW</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1129" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1129" bodyend="1282"/>
        <references refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" compoundref="ie__infer_8h" startline="47">ie_gptoss_hparams::d_ff</references>
        <references refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" compoundref="ie__infer_8h" startline="45">ie_gptoss_hparams::d_model</references>
        <references refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" compoundref="infer__gptoss_8c" startline="789">ie_tensor_view::desc</references>
        <references refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" compoundref="infer__gptoss_8c" startline="222">ie_moe_w::down_bias</references>
        <references refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" compoundref="infer__gptoss_8c" startline="240">ie_moe_w::down_bias_stride</references>
        <references refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" compoundref="infer__gptoss_8c" startline="213">ie_moe_w::down_blocks</references>
        <references refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" compoundref="infer__gptoss_8c" startline="234">ie_moe_w::down_blocks_stride</references>
        <references refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" compoundref="infer__gptoss_8c" startline="219">ie_moe_w::down_scale_bytes</references>
        <references refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" compoundref="infer__gptoss_8c" startline="216">ie_moe_w::down_scales</references>
        <references refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" compoundref="infer__gptoss_8c" startline="237">ie_moe_w::down_scales_stride</references>
        <references refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" compoundref="tensor__map_8h" startline="100">tensor_desc_s::dtype</references>
        <references refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" compoundref="infer__gptoss_8c" startline="210">ie_moe_w::gate_up_bias</references>
        <references refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" compoundref="infer__gptoss_8c" startline="231">ie_moe_w::gate_up_bias_stride</references>
        <references refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" compoundref="infer__gptoss_8c" startline="201">ie_moe_w::gate_up_blocks</references>
        <references refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" compoundref="infer__gptoss_8c" startline="225">ie_moe_w::gate_up_blocks_stride</references>
        <references refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" compoundref="infer__gptoss_8c" startline="207">ie_moe_w::gate_up_scale_bytes</references>
        <references refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" compoundref="infer__gptoss_8c" startline="204">ie_moe_w::gate_up_scales</references>
        <references refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" compoundref="infer__gptoss_8c" startline="228">ie_moe_w::gate_up_scales_stride</references>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1adbcf08258315917d586a46d5c2838aca" compoundref="infer__gptoss_8c" startline="1066" endline="1080">ie_infer_n_experts_from_router</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" compoundref="infer__gptoss_8c" startline="140">IE_LOGI</references>
        <references refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" compoundref="infer__gptoss_8c" startline="1082" endline="1103">ie_moe_expected_bytes</references>
        <references refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" compoundref="infer__gptoss_8c" startline="907" endline="922">ie_require_size_eq</references>
        <references refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" compoundref="infer__gptoss_8c" startline="866" endline="899">ie_w_get_layer_fmt_view</references>
        <references refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" compoundref="infer__gptoss_8c" startline="463">ie_gptoss_infer_impl::max_experts</references>
        <references refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" compoundref="infer__gptoss_8c" startline="347">ie_gptoss_layer_w::moe</references>
        <references refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" compoundref="infer__gptoss_8c" startline="183">ie_moe_w::n_experts</references>
        <references refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" compoundref="infer__gptoss_8c" startline="787">ie_tensor_view::ptr</references>
        <references refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" compoundref="infer__gptoss_8c" startline="189">ie_moe_w::router_b</references>
        <references refid="structie__moe__w_1a902b5265614fc6377af002fa3f2fa625" compoundref="infer__gptoss_8c" startline="198">ie_moe_w::router_transposed</references>
        <references refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" compoundref="infer__gptoss_8c" startline="186">ie_moe_w::router_w</references>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <references refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" compoundref="tensor__map_8h" startline="189" endline="211">tensor_desc_to_string</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" compoundref="tensor__map_8h" startline="50">TENSOR_DTYPE_BF16</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" compoundref="tensor__map_8h" startline="51">TENSOR_DTYPE_U8</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_resolve_q4_attn_weight</definition>
        <argsstring>(struct ie_gptoss_infer_impl *impl, uint32_t l, const char *const blocks_fmts[], const char *const scales_fmts[], uint32_t rows, uint32_t cols, const char *tag, const uint8_t **out_blocks, const uint8_t **out_scales, uint8_t *out_scale_bytes)</argsstring>
        <name>ie_resolve_q4_attn_weight</name>
        <param>
          <type>struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>l</declname>
        </param>
        <param>
          <type>const char *const</type>
          <declname>blocks_fmts</declname>
          <array>[]</array>
        </param>
        <param>
          <type>const char *const</type>
          <declname>scales_fmts</declname>
          <array>[]</array>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>rows</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>cols</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>tag</declname>
        </param>
        <param>
          <type>const uint8_t **</type>
          <declname>out_blocks</declname>
        </param>
        <param>
          <type>const uint8_t **</type>
          <declname>out_scales</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>out_scale_bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1284" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1284" bodyend="1353"/>
        <references refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" compoundref="infer__gptoss_8c" startline="789">ie_tensor_view::desc</references>
        <references refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" compoundref="tensor__map_8h" startline="100">tensor_desc_s::dtype</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" compoundref="infer__gptoss_8c" startline="1105" endline="1118">ie_q4_expected_bytes</references>
        <references refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" compoundref="infer__gptoss_8c" startline="907" endline="922">ie_require_size_eq</references>
        <references refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" compoundref="infer__gptoss_8c" startline="866" endline="899">ie_w_get_layer_fmt_view</references>
        <references refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" compoundref="infer__gptoss_8c" startline="787">ie_tensor_view::ptr</references>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" compoundref="tensor__map_8h" startline="50">TENSOR_DTYPE_BF16</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" compoundref="tensor__map_8h" startline="51">TENSOR_DTYPE_U8</references>
        <referencedby refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ie_forward_one_token</definition>
        <argsstring>(struct ie_gptoss_infer_impl *impl, ie_kv_cache *kv_layers, uint32_t token_id, uint32_t pos, float *out_logits)</argsstring>
        <name>ie_forward_one_token</name>
        <param>
          <type>struct <ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref> *</type>
          <declname>impl</declname>
        </param>
        <param>
          <type><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref> *</type>
          <declname>kv_layers</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>token_id</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>pos</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>out_logits</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1359" column="12" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1359" bodyend="1694"/>
        <references refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" compoundref="infer__gptoss_8c" startline="430">ie_gptoss_infer_impl::attn_out</references>
        <references refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" compoundref="ie__infer_8h" startline="47">ie_gptoss_hparams::d_ff</references>
        <references refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" compoundref="ie__infer_8h" startline="46">ie_gptoss_hparams::d_head</references>
        <references refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" compoundref="ie__infer_8h" startline="45">ie_gptoss_hparams::d_model</references>
        <references refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" compoundref="infer__gptoss_8c" startline="222">ie_moe_w::down_bias</references>
        <references refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" compoundref="infer__gptoss_8c" startline="240">ie_moe_w::down_bias_stride</references>
        <references refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" compoundref="infer__gptoss_8c" startline="213">ie_moe_w::down_blocks</references>
        <references refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" compoundref="infer__gptoss_8c" startline="234">ie_moe_w::down_blocks_stride</references>
        <references refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" compoundref="infer__gptoss_8c" startline="219">ie_moe_w::down_scale_bytes</references>
        <references refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" compoundref="infer__gptoss_8c" startline="216">ie_moe_w::down_scales</references>
        <references refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" compoundref="infer__gptoss_8c" startline="237">ie_moe_w::down_scales_stride</references>
        <references refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" compoundref="infer__gptoss_8c" startline="210">ie_moe_w::gate_up_bias</references>
        <references refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" compoundref="infer__gptoss_8c" startline="231">ie_moe_w::gate_up_bias_stride</references>
        <references refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" compoundref="infer__gptoss_8c" startline="201">ie_moe_w::gate_up_blocks</references>
        <references refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" compoundref="infer__gptoss_8c" startline="225">ie_moe_w::gate_up_blocks_stride</references>
        <references refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" compoundref="infer__gptoss_8c" startline="207">ie_moe_w::gate_up_scale_bytes</references>
        <references refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" compoundref="infer__gptoss_8c" startline="204">ie_moe_w::gate_up_scales</references>
        <references refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" compoundref="infer__gptoss_8c" startline="228">ie_moe_w::gate_up_scales_stride</references>
        <references refid="structie__kv__cache_1a651ffe5e067714a367503a5127bdd61a" compoundref="ie__kv__cache_8h" startline="127">ie_kv_cache::head_dim</references>
        <references refid="structie__kv__cache_1a2e7da98c2fd80c84f468848ad63bb6cb" compoundref="ie__kv__cache_8h" startline="126">ie_kv_cache::heads</references>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" compoundref="infer__gptoss_8c" startline="1120" endline="1123">ie_add_bias_f32</references>
        <references refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" compoundref="infer__gptoss_8c" startline="1031" endline="1060">ie_attn_causal_gqa_f32</references>
        <references refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" compoundref="infer__gptoss_8c" startline="1000" endline="1029">ie_attn_cpu_causal_f32</references>
        <references refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" compoundref="infer__gptoss_8c" startline="692" endline="699">ie_bf16_to_f32</references>
        <references refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" compoundref="infer__gptoss_8c" startline="726" endline="737">ie_check_finite_f32_</references>
        <references refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" compoundref="infer__gptoss_8c" startline="708" endline="715">ie_debug_nan_enabled_</references>
        <references refid="infer__gptoss_8c_1a2695e784cb752a5747eb95892e2ef6af" compoundref="infer__gptoss_8c" startline="617" endline="628">ie_env_u32_clamped</references>
        <references refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" compoundref="gemv__generic_8c" startline="225" endline="245">ie_gemv_bf16_f32</references>
        <references refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" compoundref="gemv__generic_8c" startline="247" endline="252">ie_gemv_f32</references>
        <references refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" compoundref="gemv__q4__generic_8c" startline="228" endline="255">ie_gemv_q4_0_f32</references>
        <references refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" compoundref="infer__gptoss_8c" startline="65">IE_GPTOSS_MOE_TOPK_DEFAULT</references>
        <references refid="ie__kv__instrumentation_8h_1a9897c8f0778487dbf6988f0253a195a3" compoundref="ie__kv__instrumentation_8c" startline="38" endline="41">ie_kv_add_hits</references>
        <references refid="ie__kv__instrumentation_8h_1a12fb475a0e4a167cdc2581321c1ff0a0" compoundref="ie__kv__instrumentation_8c" startline="43" endline="46">ie_kv_add_misses</references>
        <references refid="ie__kv__cache_8h_1a2bb962f9a31709cc159ccb5f8c8f2fe7a4fa6c4868332a5127755fdee56404f54" compoundref="ie__kv__cache_8h" startline="66">IE_KV_STORAGE_F32</references>
        <references refid="ie__kv__cache_8h_1ae4ab616a9e9d6e030e7ba634404f114e" compoundref="kv__cache_8c" startline="501" endline="517">ie_kv_store_token_f32</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" compoundref="infer__gptoss_8c" startline="928" endline="938">ie_rmsnorm_cpu_f32</references>
        <references refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" compoundref="infer__gptoss_8c" startline="940" endline="953">ie_rmsnorm_cpu_f32_bf16w</references>
        <references refid="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" compoundref="infer__gptoss_8c" startline="955" endline="994">ie_rope_apply_f32</references>
        <references refid="infer__gptoss_8c_1a9acc6f2706c714def21ba7cb496ca00c" compoundref="infer__gptoss_8c" startline="706" endline="706">ie_silu_f32</references>
        <references refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" compoundref="infer__gptoss_8c" startline="761" endline="776">ie_softmax_inplace_f32</references>
        <references refid="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" compoundref="infer__gptoss_8c" startline="717" endline="724">ie_trace_bf16_enabled_</references>
        <references refid="infer__gptoss_8c_1a051dcc7bf1e50054f8b124fc1e740288" compoundref="infer__gptoss_8c" startline="503" endline="503">ie_u32_min</references>
        <references refid="structie__kv__cache_1a9e6a8eae8f60ca5906d3009c7bda555a" compoundref="ie__kv__cache_8h" startline="141">ie_kv_cache::K</references>
        <references refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" compoundref="infer__gptoss_8c" startline="424">ie_gptoss_infer_impl::k</references>
        <references refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" compoundref="infer__gptoss_8c" startline="272">ie_gptoss_layer_w::k_b</references>
        <references refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" compoundref="infer__gptoss_8c" startline="332">ie_gptoss_layer_w::k_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" compoundref="infer__gptoss_8c" startline="296">ie_gptoss_layer_w::k_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" compoundref="infer__gptoss_8c" startline="302">ie_gptoss_layer_w::k_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" compoundref="infer__gptoss_8c" startline="299">ie_gptoss_layer_w::k_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" compoundref="infer__gptoss_8c" startline="269">ie_gptoss_layer_w::k_w</references>
        <references refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" compoundref="infer__gptoss_8c" startline="329">ie_gptoss_layer_w::k_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" compoundref="infer__gptoss_8c" startline="409">ie_gptoss_infer_impl::layers</references>
        <references refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" compoundref="infer__gptoss_8c" startline="251">ie_gptoss_layer_w::ln1_w</references>
        <references refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" compoundref="infer__gptoss_8c" startline="254">ie_gptoss_layer_w::ln1_w_f32</references>
        <references refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" compoundref="infer__gptoss_8c" startline="257">ie_gptoss_layer_w::ln2_w</references>
        <references refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" compoundref="infer__gptoss_8c" startline="260">ie_gptoss_layer_w::ln2_w_f32</references>
        <references refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" compoundref="ie__infer_8h" startline="49">ie_gptoss_hparams::max_seq</references>
        <references refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" compoundref="ie__kv__cache_8h" startline="128">ie_kv_cache::max_seq</references>
        <references refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" compoundref="infer__gptoss_8c" startline="433">ie_gptoss_infer_impl::mlp_gate</references>
        <references refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" compoundref="infer__gptoss_8c" startline="440">ie_gptoss_infer_impl::mlp_up</references>
        <references refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" compoundref="infer__gptoss_8c" startline="347">ie_gptoss_layer_w::moe</references>
        <references refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" compoundref="infer__gptoss_8c" startline="470">ie_gptoss_infer_impl::moe_topk</references>
        <references refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" compoundref="infer__gptoss_8c" startline="183">ie_moe_w::n_experts</references>
        <references refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" compoundref="ie__infer_8h" startline="43">ie_gptoss_hparams::n_heads</references>
        <references refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" compoundref="ie__infer_8h" startline="44">ie_gptoss_hparams::n_kv_heads</references>
        <references refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" compoundref="ie__infer_8h" startline="42">ie_gptoss_hparams::n_layers</references>
        <references refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" compoundref="infer__gptoss_8c" startline="284">ie_gptoss_layer_w::o_b</references>
        <references refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" compoundref="infer__gptoss_8c" startline="344">ie_gptoss_layer_w::o_b_f32</references>
        <references refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" compoundref="infer__gptoss_8c" startline="314">ie_gptoss_layer_w::o_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" compoundref="infer__gptoss_8c" startline="320">ie_gptoss_layer_w::o_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" compoundref="infer__gptoss_8c" startline="317">ie_gptoss_layer_w::o_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" compoundref="infer__gptoss_8c" startline="281">ie_gptoss_layer_w::o_w</references>
        <references refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" compoundref="infer__gptoss_8c" startline="341">ie_gptoss_layer_w::o_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" compoundref="infer__gptoss_8c" startline="421">ie_gptoss_infer_impl::q</references>
        <references refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" compoundref="infer__gptoss_8c" startline="266">ie_gptoss_layer_w::q_b</references>
        <references refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" compoundref="infer__gptoss_8c" startline="326">ie_gptoss_layer_w::q_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" compoundref="infer__gptoss_8c" startline="287">ie_gptoss_layer_w::q_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" compoundref="infer__gptoss_8c" startline="293">ie_gptoss_layer_w::q_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" compoundref="infer__gptoss_8c" startline="290">ie_gptoss_layer_w::q_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" compoundref="infer__gptoss_8c" startline="263">ie_gptoss_layer_w::q_w</references>
        <references refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" compoundref="infer__gptoss_8c" startline="323">ie_gptoss_layer_w::q_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" compoundref="infer__gptoss_8c" startline="449">ie_gptoss_infer_impl::rms_eps</references>
        <references refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" compoundref="infer__gptoss_8c" startline="460">ie_gptoss_infer_impl::rope_scale</references>
        <references refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" compoundref="infer__gptoss_8c" startline="452">ie_gptoss_infer_impl::rope_theta</references>
        <references refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" compoundref="infer__gptoss_8c" startline="189">ie_moe_w::router_b</references>
        <references refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" compoundref="infer__gptoss_8c" startline="195">ie_moe_w::router_b_f32</references>
        <references refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" compoundref="infer__gptoss_8c" startline="446">ie_gptoss_infer_impl::router_logits</references>
        <references refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" compoundref="infer__gptoss_8c" startline="186">ie_moe_w::router_w</references>
        <references refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" compoundref="infer__gptoss_8c" startline="192">ie_moe_w::router_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" compoundref="infer__gptoss_8c" startline="443">ie_gptoss_infer_impl::scores</references>
        <references refid="structie__kv__cache_1aee83829eb2a9d19077145b88c0bb43bb" compoundref="ie__kv__cache_8h" startline="131">ie_kv_cache::storage</references>
        <references refid="structie__kv__cache_1aab8e8a472aacd8cfce26a16b79f1995c" compoundref="ie__kv__cache_8h" startline="142">ie_kv_cache::V</references>
        <references refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" compoundref="infer__gptoss_8c" startline="427">ie_gptoss_infer_impl::v</references>
        <references refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" compoundref="infer__gptoss_8c" startline="278">ie_gptoss_layer_w::v_b</references>
        <references refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" compoundref="infer__gptoss_8c" startline="338">ie_gptoss_layer_w::v_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" compoundref="infer__gptoss_8c" startline="305">ie_gptoss_layer_w::v_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" compoundref="infer__gptoss_8c" startline="311">ie_gptoss_layer_w::v_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" compoundref="infer__gptoss_8c" startline="308">ie_gptoss_layer_w::v_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" compoundref="infer__gptoss_8c" startline="275">ie_gptoss_layer_w::v_w</references>
        <references refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" compoundref="infer__gptoss_8c" startline="335">ie_gptoss_layer_w::v_w_f32</references>
        <references refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" compoundref="ie__infer_8h" startline="48">ie_gptoss_hparams::vocab_size</references>
        <references refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" compoundref="infer__gptoss_8c" startline="385">ie_gptoss_infer_impl::w_embed_bf16</references>
        <references refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" compoundref="infer__gptoss_8c" startline="394">ie_gptoss_infer_impl::w_lm_bf16</references>
        <references refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" compoundref="infer__gptoss_8c" startline="406">ie_gptoss_infer_impl::w_lm_f32</references>
        <references refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" compoundref="infer__gptoss_8c" startline="397">ie_gptoss_infer_impl::w_lm_q4_blocks</references>
        <references refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" compoundref="infer__gptoss_8c" startline="403">ie_gptoss_infer_impl::w_lm_q4_scale_bytes</references>
        <references refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" compoundref="infer__gptoss_8c" startline="400">ie_gptoss_infer_impl::w_lm_q4_scales</references>
        <references refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" compoundref="infer__gptoss_8c" startline="388">ie_gptoss_infer_impl::w_norm_bf16</references>
        <references refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" compoundref="infer__gptoss_8c" startline="391">ie_gptoss_infer_impl::w_norm_f32</references>
        <references refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" compoundref="infer__gptoss_8c" startline="412">ie_gptoss_infer_impl::x</references>
        <references refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" compoundref="infer__gptoss_8c" startline="415">ie_gptoss_infer_impl::x1</references>
        <references refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" compoundref="infer__gptoss_8c" startline="418">ie_gptoss_infer_impl::x2</references>
        <referencedby refid="ie__infer_8h_1a39827a388a0b7dd6d161e99b111c5546" compoundref="infer__gptoss_8c" startline="2337" endline="2363">ie_gptoss_infer_prefill</referencedby>
        <referencedby refid="ie__infer_8h_1a52a0e33daf64ca5524b6440cecc8d2f6" compoundref="infer__gptoss_8c" startline="2365" endline="2380">ie_gptoss_infer_step</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a1eb484ef476fc9b7a44d3819959fb307" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_gptoss_infer_create</definition>
        <argsstring>(const ie_device_t *dev_const, const ie_weights_t *w, const ie_gptoss_hparams_t *hp, ie_gptoss_infer_t **out_ctx)</argsstring>
        <name>ie_gptoss_infer_create</name>
        <param>
          <type>const <ref refid="ie__device_8h_1a7c50deaca4d796966353da1769279628" kindref="member">ie_device_t</ref> *</type>
          <declname>dev</declname>
          <defname>dev_const</defname>
        </param>
        <param>
          <type>const <ref refid="ie__io_8h_1af68ad3cdc2eb244fe4feed94372d7806" kindref="member">ie_weights_t</ref> *</type>
          <declname>w</declname>
        </param>
        <param>
          <type>const <ref refid="ie__infer_8h_1a03b52084d74cc0c81a96a02ae842fcc7" kindref="member">ie_gptoss_hparams_t</ref> *</type>
          <declname>hp</declname>
        </param>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> **</type>
          <declname>out_ctx</declname>
        </param>
        <briefdescription>
<para>Create an inference context. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>dev</parametername>
</parameternamelist>
<parameterdescription>
<para>Device backend (CPU/CUDA). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>w</parametername>
</parameternamelist>
<parameterdescription>
<para>Opened weights handle. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>hp</parametername>
</parameternamelist>
<parameterdescription>
<para>Hyperparameters. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_ctx</parametername>
</parameternamelist>
<parameterdescription>
<para>Receives the newly created context on success.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success; non-zero on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="1700" column="5" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="1700" bodyend="2290"/>
        <references refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" compoundref="infer__gptoss_8c" startline="430">ie_gptoss_infer_impl::attn_out</references>
        <references refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" compoundref="infer__gptoss_8c" startline="376">ie_gptoss_infer_impl::bin_base</references>
        <references refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" compoundref="infer__gptoss_8c" startline="379">ie_gptoss_infer_impl::bin_size</references>
        <references refid="structtensor__map__s_1a64c31242ffe43f6fc36b465d1ef75462" compoundref="tensor__map_8h" startline="122">tensor_map_s::count</references>
        <references refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" compoundref="ie__infer_8h" startline="47">ie_gptoss_hparams::d_ff</references>
        <references refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" compoundref="ie__infer_8h" startline="46">ie_gptoss_hparams::d_head</references>
        <references refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" compoundref="ie__infer_8h" startline="45">ie_gptoss_hparams::d_model</references>
        <references refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" compoundref="infer__gptoss_8c" startline="789">ie_tensor_view::desc</references>
        <references refid="structie__gptoss__infer__impl_1a8ca6a5d2971b7df6973a6fa49a19bb8d" compoundref="infer__gptoss_8c" startline="361">ie_gptoss_infer_impl::dev</references>
        <references refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" compoundref="tensor__map_8h" startline="100">tensor_desc_s::dtype</references>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" compoundref="infer__gptoss_8c" startline="672" endline="681">ie_alloc_f32_from_bf16</references>
        <references refid="infer__gptoss_8c_1a37a69a9cc6c14a335fdcf1df79093005" compoundref="infer__gptoss_8c" startline="514" endline="540">ie_dirname_alloc</references>
        <references refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" compoundref="infer__gptoss_8c" startline="638" endline="649">ie_env_f32_clamped</references>
        <references refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" compoundref="infer__gptoss_8c" startline="656" endline="663">ie_env_flag</references>
        <references refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" compoundref="infer__gptoss_8c" startline="2292" endline="2335">ie_gptoss_infer_destroy</references>
        <references refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" compoundref="infer__gptoss_8c" startline="65">IE_GPTOSS_MOE_TOPK_DEFAULT</references>
        <references refid="infer__gptoss_8c_1aa067dccbbe25570a05cbf08d3cfefe71" compoundref="infer__gptoss_8c" startline="61">IE_GPTOSS_RMS_EPS_DEFAULT</references>
        <references refid="infer__gptoss_8c_1a8c7977554f9c1d9b6cafdf5ca15438c6" compoundref="infer__gptoss_8c" startline="63">IE_GPTOSS_ROPE_THETA_DEFAULT</references>
        <references refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" compoundref="infer__gptoss_8c" startline="142">IE_LOGD</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" compoundref="infer__gptoss_8c" startline="140">IE_LOGI</references>
        <references refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" compoundref="infer__gptoss_8c" startline="138">IE_LOGW</references>
        <references refid="infer__gptoss_8c_1a350055e3279aa56a313cc54048c81b52" compoundref="infer__gptoss_8c" startline="572" endline="597">ie_mmap_ro</references>
        <references refid="infer__gptoss_8c_1abaa225eee9cc8e6cf2813fad866a16c1" compoundref="infer__gptoss_8c" startline="548" endline="563">ie_path_join_alloc</references>
        <references refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" compoundref="infer__gptoss_8c" startline="1105" endline="1118">ie_q4_expected_bytes</references>
        <references refid="ie__kernels_8h_1acdd3012fa894dbd82a4156eb09074acd" compoundref="gemv__q4__avx2_8c" startline="76" endline="80">ie_q4_log2_u8_q3_init_avx2</references>
        <references refid="ie__kernels_8h_1a43aede47b7769f5c605ba1687b0336ea" compoundref="gemv__q4__generic_8c" startline="90" endline="94">ie_q4_log2_u8_q3_init_generic</references>
        <references refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" compoundref="infer__gptoss_8c" startline="907" endline="922">ie_require_size_eq</references>
        <references refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" compoundref="infer__gptoss_8c" startline="1129" endline="1282">ie_resolve_moe_layer</references>
        <references refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" compoundref="infer__gptoss_8c" startline="1284" endline="1353">ie_resolve_q4_attn_weight</references>
        <references refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" compoundref="infer__gptoss_8c" startline="836" endline="854">ie_w_get_first_view</references>
        <references refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" compoundref="infer__gptoss_8c" startline="866" endline="899">ie_w_get_layer_fmt_view</references>
        <references refid="structie__weights__s_1a6d4bef9e704edd817ee473eb2685cdd4" compoundref="ie__io_8h" startline="98">ie_weights_s::json_path</references>
        <references refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" compoundref="infer__gptoss_8c" startline="424">ie_gptoss_infer_impl::k</references>
        <references refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" compoundref="infer__gptoss_8c" startline="272">ie_gptoss_layer_w::k_b</references>
        <references refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" compoundref="infer__gptoss_8c" startline="332">ie_gptoss_layer_w::k_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" compoundref="infer__gptoss_8c" startline="296">ie_gptoss_layer_w::k_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" compoundref="infer__gptoss_8c" startline="302">ie_gptoss_layer_w::k_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" compoundref="infer__gptoss_8c" startline="299">ie_gptoss_layer_w::k_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" compoundref="infer__gptoss_8c" startline="269">ie_gptoss_layer_w::k_w</references>
        <references refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" compoundref="infer__gptoss_8c" startline="329">ie_gptoss_layer_w::k_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" compoundref="infer__gptoss_8c" startline="409">ie_gptoss_infer_impl::layers</references>
        <references refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" compoundref="infer__gptoss_8c" startline="251">ie_gptoss_layer_w::ln1_w</references>
        <references refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" compoundref="infer__gptoss_8c" startline="254">ie_gptoss_layer_w::ln1_w_f32</references>
        <references refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" compoundref="infer__gptoss_8c" startline="257">ie_gptoss_layer_w::ln2_w</references>
        <references refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" compoundref="infer__gptoss_8c" startline="260">ie_gptoss_layer_w::ln2_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" compoundref="infer__gptoss_8c" startline="463">ie_gptoss_infer_impl::max_experts</references>
        <references refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" compoundref="ie__infer_8h" startline="49">ie_gptoss_hparams::max_seq</references>
        <references refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" compoundref="infer__gptoss_8c" startline="433">ie_gptoss_infer_impl::mlp_gate</references>
        <references refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" compoundref="infer__gptoss_8c" startline="440">ie_gptoss_infer_impl::mlp_up</references>
        <references refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" compoundref="infer__gptoss_8c" startline="347">ie_gptoss_layer_w::moe</references>
        <references refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" compoundref="infer__gptoss_8c" startline="470">ie_gptoss_infer_impl::moe_topk</references>
        <references refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" compoundref="infer__gptoss_8c" startline="183">ie_moe_w::n_experts</references>
        <references refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" compoundref="ie__infer_8h" startline="43">ie_gptoss_hparams::n_heads</references>
        <references refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" compoundref="ie__infer_8h" startline="44">ie_gptoss_hparams::n_kv_heads</references>
        <references refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" compoundref="ie__infer_8h" startline="42">ie_gptoss_hparams::n_layers</references>
        <references refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" compoundref="infer__gptoss_8c" startline="284">ie_gptoss_layer_w::o_b</references>
        <references refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" compoundref="infer__gptoss_8c" startline="344">ie_gptoss_layer_w::o_b_f32</references>
        <references refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" compoundref="infer__gptoss_8c" startline="314">ie_gptoss_layer_w::o_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" compoundref="infer__gptoss_8c" startline="320">ie_gptoss_layer_w::o_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" compoundref="infer__gptoss_8c" startline="317">ie_gptoss_layer_w::o_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" compoundref="infer__gptoss_8c" startline="281">ie_gptoss_layer_w::o_w</references>
        <references refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" compoundref="infer__gptoss_8c" startline="341">ie_gptoss_layer_w::o_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
        <references refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" compoundref="infer__gptoss_8c" startline="787">ie_tensor_view::ptr</references>
        <references refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" compoundref="infer__gptoss_8c" startline="421">ie_gptoss_infer_impl::q</references>
        <references refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" compoundref="infer__gptoss_8c" startline="266">ie_gptoss_layer_w::q_b</references>
        <references refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" compoundref="infer__gptoss_8c" startline="326">ie_gptoss_layer_w::q_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" compoundref="infer__gptoss_8c" startline="287">ie_gptoss_layer_w::q_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" compoundref="infer__gptoss_8c" startline="293">ie_gptoss_layer_w::q_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" compoundref="infer__gptoss_8c" startline="290">ie_gptoss_layer_w::q_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" compoundref="infer__gptoss_8c" startline="263">ie_gptoss_layer_w::q_w</references>
        <references refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" compoundref="infer__gptoss_8c" startline="323">ie_gptoss_layer_w::q_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" compoundref="infer__gptoss_8c" startline="449">ie_gptoss_infer_impl::rms_eps</references>
        <references refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" compoundref="infer__gptoss_8c" startline="460">ie_gptoss_infer_impl::rope_scale</references>
        <references refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" compoundref="infer__gptoss_8c" startline="452">ie_gptoss_infer_impl::rope_theta</references>
        <references refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" compoundref="infer__gptoss_8c" startline="189">ie_moe_w::router_b</references>
        <references refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" compoundref="infer__gptoss_8c" startline="195">ie_moe_w::router_b_f32</references>
        <references refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" compoundref="infer__gptoss_8c" startline="446">ie_gptoss_infer_impl::router_logits</references>
        <references refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" compoundref="infer__gptoss_8c" startline="186">ie_moe_w::router_w</references>
        <references refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" compoundref="infer__gptoss_8c" startline="192">ie_moe_w::router_w_f32</references>
        <references refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" compoundref="infer__gptoss_8c" startline="443">ie_gptoss_infer_impl::scores</references>
        <references refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" compoundref="tensor__map_8h" startline="98">tensor_desc_s::size_bytes</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" compoundref="tensor__map_8h" startline="50">TENSOR_DTYPE_BF16</references>
        <references refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" compoundref="tensor__map_8h" startline="51">TENSOR_DTYPE_U8</references>
        <references refid="tensor__map_8h_1a42d154b3f93b07c41b514e468a61c803" compoundref="tensor__map_8c" startline="650" endline="660">tensor_map_free</references>
        <references refid="tensor__map_8h_1ac4b913e2710929070b5b073b4b67b24c" compoundref="tensor__map_8c" startline="484" endline="648">tensor_map_load</references>
        <references refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" compoundref="infer__gptoss_8c" startline="370">ie_gptoss_infer_impl::tmap</references>
        <references refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" compoundref="infer__gptoss_8c" startline="373">ie_gptoss_infer_impl::tmap_path_used</references>
        <references refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" compoundref="infer__gptoss_8c" startline="473">ie_gptoss_infer_impl::use_f32_attn</references>
        <references refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" compoundref="infer__gptoss_8c" startline="479">ie_gptoss_infer_impl::use_f32_lm_head</references>
        <references refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" compoundref="infer__gptoss_8c" startline="482">ie_gptoss_infer_impl::use_f32_rmsnorm</references>
        <references refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" compoundref="infer__gptoss_8c" startline="476">ie_gptoss_infer_impl::use_f32_router</references>
        <references refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" compoundref="infer__gptoss_8c" startline="427">ie_gptoss_infer_impl::v</references>
        <references refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" compoundref="infer__gptoss_8c" startline="278">ie_gptoss_layer_w::v_b</references>
        <references refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" compoundref="infer__gptoss_8c" startline="338">ie_gptoss_layer_w::v_b_f32</references>
        <references refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" compoundref="infer__gptoss_8c" startline="305">ie_gptoss_layer_w::v_q4_blocks</references>
        <references refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" compoundref="infer__gptoss_8c" startline="311">ie_gptoss_layer_w::v_q4_scale_bytes</references>
        <references refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" compoundref="infer__gptoss_8c" startline="308">ie_gptoss_layer_w::v_q4_scales</references>
        <references refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" compoundref="infer__gptoss_8c" startline="275">ie_gptoss_layer_w::v_w</references>
        <references refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" compoundref="infer__gptoss_8c" startline="335">ie_gptoss_layer_w::v_w_f32</references>
        <references refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" compoundref="ie__infer_8h" startline="48">ie_gptoss_hparams::vocab_size</references>
        <references refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" compoundref="infer__gptoss_8c" startline="385">ie_gptoss_infer_impl::w_embed_bf16</references>
        <references refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" compoundref="infer__gptoss_8c" startline="394">ie_gptoss_infer_impl::w_lm_bf16</references>
        <references refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" compoundref="infer__gptoss_8c" startline="406">ie_gptoss_infer_impl::w_lm_f32</references>
        <references refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" compoundref="infer__gptoss_8c" startline="397">ie_gptoss_infer_impl::w_lm_q4_blocks</references>
        <references refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" compoundref="infer__gptoss_8c" startline="403">ie_gptoss_infer_impl::w_lm_q4_scale_bytes</references>
        <references refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" compoundref="infer__gptoss_8c" startline="400">ie_gptoss_infer_impl::w_lm_q4_scales</references>
        <references refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" compoundref="infer__gptoss_8c" startline="388">ie_gptoss_infer_impl::w_norm_bf16</references>
        <references refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" compoundref="infer__gptoss_8c" startline="391">ie_gptoss_infer_impl::w_norm_f32</references>
        <references refid="structie__gptoss__infer__impl_1a953824f4ef6444bb2d702afaa61a18c1" compoundref="infer__gptoss_8c" startline="364">ie_gptoss_infer_impl::weights</references>
        <references refid="structie__weights__s_1ab6a61099d0af4a47854d02dc4fef5b8f" compoundref="ie__io_8h" startline="99">ie_weights_s::weights_path</references>
        <references refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" compoundref="infer__gptoss_8c" startline="412">ie_gptoss_infer_impl::x</references>
        <references refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" compoundref="infer__gptoss_8c" startline="415">ie_gptoss_infer_impl::x1</references>
        <references refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" compoundref="infer__gptoss_8c" startline="418">ie_gptoss_infer_impl::x2</references>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a39827a388a0b7dd6d161e99b111c5546" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_gptoss_infer_prefill</definition>
        <argsstring>(ie_gptoss_infer_t *ctx, ie_kv_cache *kv, const uint32_t *prompt, uint32_t n_prompt, float *out_logits)</argsstring>
        <name>ie_gptoss_infer_prefill</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <param>
          <type><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref> *</type>
          <declname>kv</declname>
        </param>
        <param>
          <type>const uint32_t *</type>
          <declname>prompt</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>n_prompt</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>out_logits</declname>
        </param>
        <briefdescription>
<para>Prefill: consume a prompt, update the KV cache, and produce logits. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>ctx</parametername>
</parameternamelist>
<parameterdescription>
<para>Inference context. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>kv</parametername>
</parameternamelist>
<parameterdescription>
<para>Array of KV caches, one per layer. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>prompt</parametername>
</parameternamelist>
<parameterdescription>
<para>Prompt token IDs. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n_prompt</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of prompt tokens. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_logits</parametername>
</parameternamelist>
<parameterdescription>
<para>Output logits for the last position (vocab-sized).</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success; non-zero on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2337" column="5" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2337" bodyend="2363"/>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" compoundref="infer__gptoss_8c" startline="138">IE_LOGW</references>
        <references refid="infer__gptoss_8c_1a23c0a7a4138efca538e74eda244f02e4" compoundref="infer__gptoss_8c" startline="495" endline="495">ie_min_size</references>
        <references refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" compoundref="ie__infer_8h" startline="49">ie_gptoss_hparams::max_seq</references>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
        <referencedby refid="ie__api_8h_1a950ac9a0efe5a4fe068a288e57099c4a" compoundref="ie__api_8c" startline="826" endline="1109">ie_engine_generate_ex</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a52a0e33daf64ca5524b6440cecc8d2f6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_gptoss_infer_step</definition>
        <argsstring>(ie_gptoss_infer_t *ctx, ie_kv_cache *kv, uint32_t token_id, float *out_logits)</argsstring>
        <name>ie_gptoss_infer_step</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <param>
          <type><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref> *</type>
          <declname>kv</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>token_id</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>out_logits</declname>
        </param>
        <briefdescription>
<para>Step: consume one token, update the KV cache, and produce next logits. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>ctx</parametername>
</parameternamelist>
<parameterdescription>
<para>Inference context. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>kv</parametername>
</parameternamelist>
<parameterdescription>
<para>Array of KV caches, one per layer. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>token_id</parametername>
</parameternamelist>
<parameterdescription>
<para>The token to consume. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_logits</parametername>
</parameternamelist>
<parameterdescription>
<para>Output logits for the next token (vocab-sized).</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success; non-zero on failure. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2365" column="5" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2365" bodyend="2380"/>
        <references refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" compoundref="infer__gptoss_8c" startline="1359" endline="1694">ie_forward_one_token</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
        <referencedby refid="ie__api_8h_1a950ac9a0efe5a4fe068a288e57099c4a" compoundref="ie__api_8c" startline="826" endline="1109">ie_engine_generate_ex</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1ad6ba88834d3de780c37646cbb32b6e3a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_gptoss_infer_reset</definition>
        <argsstring>(ie_gptoss_infer_t *ctx)</argsstring>
        <name>ie_gptoss_infer_reset</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2386" column="6" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2386" bodyend="2390"/>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa1f70a529800c149104a8ec815df7624" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_gptoss_infer_seek</definition>
        <argsstring>(ie_gptoss_infer_t *ctx, uint32_t pos)</argsstring>
        <name>ie_gptoss_infer_seek</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>pos</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2392" column="5" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2392" bodyend="2408"/>
        <references refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" compoundref="infer__gptoss_8c" startline="367">ie_gptoss_infer_impl::hp</references>
        <references refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" compoundref="infer__gptoss_8c" startline="136">IE_LOGE</references>
        <references refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" compoundref="infer__gptoss_8c" startline="138">IE_LOGW</references>
        <references refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" compoundref="ie__infer_8h" startline="49">ie_gptoss_hparams::max_seq</references>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
        <referencedby refid="ie__infer_8h_1aa56c26f106493f7ffab8a97805a56821" compoundref="infer__gptoss_8c" startline="2422" endline="2424">ie_gptoss_infer_set_pos</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1ad28e80404996cdcc9b260dc36e0d38d7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>uint32_t ie_gptoss_infer_pos</definition>
        <argsstring>(const ie_gptoss_infer_t *ctx)</argsstring>
        <name>ie_gptoss_infer_pos</name>
        <param>
          <type>const <ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2410" column="10" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2410" bodyend="2414"/>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
        <referencedby refid="ie__infer_8h_1a013879de493fc8d3d8ef05881fb2e12c" compoundref="infer__gptoss_8c" startline="2418" endline="2420">ie_gptoss_infer_get_pos</referencedby>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1a013879de493fc8d3d8ef05881fb2e12c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>uint32_t ie_gptoss_infer_get_pos</definition>
        <argsstring>(const ie_gptoss_infer_t *ctx)</argsstring>
        <name>ie_gptoss_infer_get_pos</name>
        <param>
          <type>const <ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <briefdescription>
<para>Get the current position (number of tokens already consumed). </para>
        </briefdescription>
        <detaileddescription>
<para>Performance notes:<itemizedlist>
<listitem><para>INT4 runs use Q4_0 weight GEMV kernels (runtime-dispatched to AVX2/FMA when available).</para>
</listitem><listitem><para>Per-32-column scales may be stored as BF16 (2 bytes) or FP8(E4M3) (1 byte) depending on artifacts.</para>
</listitem></itemizedlist>
</para>
<para>The runtime maintains a position counter internally. This is used to index into the KV cache (time dimension) and to drive rotary embeddings. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2418" column="10" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2418" bodyend="2420"/>
        <references refid="infer__gptoss_8c_1ad28e80404996cdcc9b260dc36e0d38d7" compoundref="infer__gptoss_8c" startline="2410" endline="2414">ie_gptoss_infer_pos</references>
      </memberdef>
      <memberdef kind="function" id="infer__gptoss_8c_1aa56c26f106493f7ffab8a97805a56821" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_gptoss_infer_set_pos</definition>
        <argsstring>(ie_gptoss_infer_t *ctx, uint32_t pos)</argsstring>
        <name>ie_gptoss_infer_set_pos</name>
        <param>
          <type><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref> *</type>
          <declname>ctx</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>pos</declname>
        </param>
        <briefdescription>
<para>Set the current position. </para>
        </briefdescription>
        <detaileddescription>
<para>Performance notes:<itemizedlist>
<listitem><para>INT4 runs use Q4_0 weight GEMV kernels (runtime-dispatched to AVX2/FMA when available).</para>
</listitem><listitem><para>Per-32-column scales may be stored as BF16 (2 bytes) or FP8(E4M3) (1 byte) depending on artifacts.</para>
</listitem></itemizedlist>
</para>
<para>This exists to enable persistent prompt-prefix reuse: if the KV cache already contains valid K/V entries for positions [0, pos-1], the caller can rewind the runtime position to <computeroutput>pos</computeroutput> and continue generation without recomputing the prefix. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/infer_gptoss.c" line="2422" column="6" bodyfile="engine/src/runtime/infer_gptoss.c" bodystart="2422" bodyend="2424"/>
        <references refid="infer__gptoss_8c_1aa1f70a529800c149104a8ec815df7624" compoundref="infer__gptoss_8c" startline="2392" endline="2408">ie_gptoss_infer_seek</references>
        <references refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" compoundref="infer__gptoss_8c" startline="382">ie_gptoss_infer_impl::pos</references>
      </memberdef>
    </sectiondef>
    <briefdescription>
<para>GPT-OSS inference entrypoints with a CPU-first forward pass. </para>
    </briefdescription>
    <detaileddescription>
<para>This implementation is intentionally &quot;tensor_map-minimal&quot;:<itemizedlist>
<listitem><para>It does NOT require tensor_map.json to carry dtype/shape metadata.</para>
</listitem><listitem><para>It only requires (name, offset, size_bytes).</para>
</listitem></itemizedlist>
</para>
<para>Safety:<itemizedlist>
<listitem><para>We validate tensor sizes against hparams before using them.</para>
</listitem><listitem><para>We infer MoE n_experts from router weight size.</para>
</listitem></itemizedlist>
</para>
<para>Notes:<itemizedlist>
<listitem><para>This is correctness-first and CPU-only for BF16/Q4 paths.</para>
</listitem><listitem><para>Quant assumptions for expert blocks follow a Q4_0-like layout:<itemizedlist>
<listitem><para>cols multiple of 32</para>
</listitem><listitem><para>blocks: 16 bytes per 32 weights (2x4-bit per byte)</para>
</listitem><listitem><para>scales: BF16 per block, or FP8(E4M3) packed as u8 per block</para>
</listitem></itemizedlist>
</para>
</listitem></itemizedlist>
</para>
<para>Logging:<itemizedlist>
<listitem><para>This file prints detailed diagnostics to stderr on failure paths.</para>
</listitem><listitem><para>Set IE_LOG_LEVEL to control verbosity: 0=quiet, 1=error, 2=warn, 3=info, 4=debug, 5=trace</para>
</listitem><listitem><para>Hot-path logging is avoided; errors include rich context (tensor name, expected/actual sizes, layer index, and chosen candidate names). </para>
</listitem></itemizedlist>
</para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>File:<sp/>engine/src/runtime/infer_gptoss.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*/</highlight></codeline>
<codeline lineno="33" refid="infer__gptoss_8c_1a3024ccd4a9af5109d24e6c57565d74a1" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>_POSIX_C_SOURCE<sp/>200809L</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;fcntl.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;limits.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;math.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdarg.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stddef.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdint.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdio.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdlib.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;sys/mman.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;sys/stat.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;unistd.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__device_8h" kindref="compound">ie_device.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__infer_8h" kindref="compound">ie_infer.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__kernels_8h" kindref="compound">ie_kernels.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__kv__cache_8h" kindref="compound">ie_kv_cache.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__kv__instrumentation_8h" kindref="compound">ie_kv_instrumentation.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="tensor__map_8h" kindref="compound">tensor_map.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Configuration<sp/>defaults<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight></codeline>
<codeline lineno="61" refid="infer__gptoss_8c_1aa067dccbbe25570a05cbf08d3cfefe71" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_GPTOSS_RMS_EPS_DEFAULT<sp/>(1e-5f)</highlight></codeline>
<codeline lineno="63" refid="infer__gptoss_8c_1a8c7977554f9c1d9b6cafdf5ca15438c6" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_GPTOSS_ROPE_THETA_DEFAULT<sp/>(10000.0f)</highlight></codeline>
<codeline lineno="65" refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_GPTOSS_MOE_TOPK_DEFAULT<sp/>(4u)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Logging<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="keyword">enum</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="75" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a21d08249c32f255fe865e4fdd33563a0" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a21d08249c32f255fe865e4fdd33563a0" kindref="member">IE_LL_QUIET</ref><sp/>=<sp/>0,</highlight></codeline>
<codeline lineno="76" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" kindref="member">IE_LL_ERROR</ref><sp/>=<sp/>1,</highlight></codeline>
<codeline lineno="77" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" kindref="member">IE_LL_WARN</ref><sp/><sp/>=<sp/>2,</highlight></codeline>
<codeline lineno="78" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" kindref="member">IE_LL_INFO</ref><sp/><sp/>=<sp/>3,</highlight></codeline>
<codeline lineno="79" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" kindref="member">IE_LL_DEBUG</ref><sp/>=<sp/>4,</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" kindref="member">IE_LL_TRACE</ref><sp/>=<sp/>5</highlight></codeline>
<codeline lineno="81" refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" refkind="member"><highlight class="normal">};</highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight></codeline>
<codeline lineno="84" refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" kindref="member">ie_log_level_cached</ref><sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight></codeline>
<codeline lineno="90" refid="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" kindref="member">ie_log_level</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" kindref="member">ie_log_level_cached</ref><sp/>&gt;=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" kindref="member">ie_log_level_cached</ref>;</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(</highlight><highlight class="stringliteral">&quot;IE_LOG_LEVEL&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>lvl<sp/>=<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" kindref="member">IE_LL_WARN</ref>;</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>&amp;&amp;<sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>strtol(s,<sp/>&amp;end,<sp/>10);</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(end<sp/>!=<sp/>s)<sp/>{</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>0)<sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>5)<sp/>v<sp/>=<sp/>5;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>lvl<sp/>=<sp/>(int)v;</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1af6184a7116311ff281a3b926b8ddcb9d" kindref="member">ie_log_level_cached</ref><sp/>=<sp/>lvl;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>lvl;</highlight></codeline>
<codeline lineno="106"><highlight class="normal">}</highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight></codeline>
<codeline lineno="115" refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aaa4f60325fb065bb4c476d596ffff90e" kindref="member">ie_logf</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>lvl,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*file,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>line,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*fmt,<sp/>...)<sp/>{</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a37b2abef0cf4876ab766d3603a3bde0b" kindref="member">ie_log_level</ref>()<sp/>&lt;<sp/>lvl)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;LOG&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lvl<sp/>==<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ac8a2d710d818e9f2e0cc2201976c7117" kindref="member">IE_LL_ERROR</ref>)<sp/>tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;ERR&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lvl<sp/>==<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5ad21b5ed7967f899e0a6cbbe7f62f8c7b" kindref="member">IE_LL_WARN</ref>)<sp/>tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;WRN&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lvl<sp/>==<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a270cc6d2fb976b1fab12d73a31de15f9" kindref="member">IE_LL_INFO</ref>)<sp/>tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;INF&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lvl<sp/>==<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5aa3e7a06f9014639eca4cbd712c53dc7b" kindref="member">IE_LL_DEBUG</ref>)<sp/>tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;DBG&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lvl<sp/>==<sp/><ref refid="infer__gptoss_8c_1a99fb83031ce9923c84392b4e92f956b5a586e259ed3fe5b29aebdee7db8167055" kindref="member">IE_LL_TRACE</ref>)<sp/>tag<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;TRC&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[%s]<sp/>%s:%d:<sp/>&quot;</highlight><highlight class="normal">,<sp/>tag,<sp/>file,<sp/>line);</highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/>va_list<sp/>ap;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/>va_start(ap,<sp/>fmt);</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/>vfprintf(stderr,<sp/>fmt,<sp/>ap);</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/>va_end(ap);</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/>fputc(</highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">,<sp/>stderr);</highlight></codeline>
<codeline lineno="133"><highlight class="normal">}</highlight></codeline>
<codeline lineno="134"><highlight class="normal"></highlight></codeline>
<codeline lineno="136" refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_LOGE(...)<sp/>ie_logf(IE_LL_ERROR,<sp/>__FILE__,<sp/>__LINE__,<sp/>__VA_ARGS__)</highlight></codeline>
<codeline lineno="138" refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_LOGW(...)<sp/>ie_logf(IE_LL_WARN,<sp/><sp/>__FILE__,<sp/>__LINE__,<sp/>__VA_ARGS__)</highlight></codeline>
<codeline lineno="140" refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_LOGI(...)<sp/>ie_logf(IE_LL_INFO,<sp/><sp/>__FILE__,<sp/>__LINE__,<sp/>__VA_ARGS__)</highlight></codeline>
<codeline lineno="142" refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_LOGD(...)<sp/>ie_logf(IE_LL_DEBUG,<sp/>__FILE__,<sp/>__LINE__,<sp/>__VA_ARGS__)</highlight></codeline>
<codeline lineno="144" refid="infer__gptoss_8c_1a25c7e8c3a8c0a5c73b0296bea92d5378" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_LOGT(...)<sp/>ie_logf(IE_LL_TRACE,<sp/>__FILE__,<sp/>__LINE__,<sp/>__VA_ARGS__)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Weak-reference<sp/>helpers<sp/>for<sp/>kernels<sp/>that<sp/>may<sp/>not<sp/>exist<sp/>yet<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(__GNUC__)<sp/>||<sp/>defined(__clang__)</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_WEAK<sp/>__attribute__((weak))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight></codeline>
<codeline lineno="155" refid="infer__gptoss_8c_1a54c96bba1e88a7dafb048d8a8918e5c8" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>IE_WEAK</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Forward<sp/>declarations<sp/>for<sp/>internal<sp/>types<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref>;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Weight<sp/>structs<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="181" refid="structie__moe__w" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__moe__w" kindref="compound">ie_moe_w</ref><sp/>{</highlight></codeline>
<codeline lineno="183" refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" kindref="member">n_experts</ref>;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"></highlight></codeline>
<codeline lineno="186" refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" kindref="member">router_w</ref>;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"></highlight></codeline>
<codeline lineno="189" refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" kindref="member">router_b</ref>;</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="192" refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" kindref="member">router_w_f32</ref>;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"></highlight></codeline>
<codeline lineno="195" refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" kindref="member">router_b_f32</ref>;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"></highlight></codeline>
<codeline lineno="198" refid="structie__moe__w_1a902b5265614fc6377af002fa3f2fa625" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1a902b5265614fc6377af002fa3f2fa625" kindref="member">router_transposed</ref>;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="201" refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" kindref="member">gate_up_blocks</ref>;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="204" refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" kindref="member">gate_up_scales</ref>;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="207" refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" kindref="member">gate_up_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"></highlight></codeline>
<codeline lineno="210" refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" kindref="member">gate_up_bias</ref>;</highlight></codeline>
<codeline lineno="211"><highlight class="normal"></highlight></codeline>
<codeline lineno="213" refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" kindref="member">down_blocks</ref>;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"></highlight></codeline>
<codeline lineno="216" refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" kindref="member">down_scales</ref>;</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="219" refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" kindref="member">down_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="222" refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" kindref="member">down_bias</ref>;</highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight></codeline>
<codeline lineno="225" refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" kindref="member">gate_up_blocks_stride</ref>;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight></codeline>
<codeline lineno="228" refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" kindref="member">gate_up_scales_stride</ref>;</highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight></codeline>
<codeline lineno="231" refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" kindref="member">gate_up_bias_stride</ref>;</highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="234" refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" kindref="member">down_blocks_stride</ref>;</highlight></codeline>
<codeline lineno="235"><highlight class="normal"></highlight></codeline>
<codeline lineno="237" refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" kindref="member">down_scales_stride</ref>;</highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="240" refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" kindref="member">down_bias_stride</ref>;</highlight></codeline>
<codeline lineno="241" refid="infer__gptoss_8c_1a2bac3f0797bd82aaa2a994091efc0b71" refkind="member"><highlight class="normal">}<sp/><ref refid="infer__gptoss_8c_1a2bac3f0797bd82aaa2a994091efc0b71" kindref="member">ie_moe_w_t</ref>;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight></codeline>
<codeline lineno="249" refid="structie__gptoss__layer__w" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w</ref><sp/>{</highlight></codeline>
<codeline lineno="251" refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" kindref="member">ln1_w</ref>;</highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight></codeline>
<codeline lineno="254" refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" kindref="member">ln1_w_f32</ref>;</highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="257" refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" kindref="member">ln2_w</ref>;</highlight></codeline>
<codeline lineno="258"><highlight class="normal"></highlight></codeline>
<codeline lineno="260" refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" kindref="member">ln2_w_f32</ref>;</highlight></codeline>
<codeline lineno="261"><highlight class="normal"></highlight></codeline>
<codeline lineno="263" refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" kindref="member">q_w</ref>;</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="266" refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref>;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="269" refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" kindref="member">k_w</ref>;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"></highlight></codeline>
<codeline lineno="272" refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref>;</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="275" refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" kindref="member">v_w</ref>;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="278" refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref>;</highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="281" refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" kindref="member">o_w</ref>;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"></highlight></codeline>
<codeline lineno="284" refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref>;</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="287" refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" kindref="member">q_q4_blocks</ref>;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"></highlight></codeline>
<codeline lineno="290" refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" kindref="member">q_q4_scales</ref>;</highlight></codeline>
<codeline lineno="291"><highlight class="normal"></highlight></codeline>
<codeline lineno="293" refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" kindref="member">q_q4_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight></codeline>
<codeline lineno="296" refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" kindref="member">k_q4_blocks</ref>;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="299" refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" kindref="member">k_q4_scales</ref>;</highlight></codeline>
<codeline lineno="300"><highlight class="normal"></highlight></codeline>
<codeline lineno="302" refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" kindref="member">k_q4_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"></highlight></codeline>
<codeline lineno="305" refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" kindref="member">v_q4_blocks</ref>;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="308" refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" kindref="member">v_q4_scales</ref>;</highlight></codeline>
<codeline lineno="309"><highlight class="normal"></highlight></codeline>
<codeline lineno="311" refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" kindref="member">v_q4_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight></codeline>
<codeline lineno="314" refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" kindref="member">o_q4_blocks</ref>;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="317" refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" kindref="member">o_q4_scales</ref>;</highlight></codeline>
<codeline lineno="318"><highlight class="normal"></highlight></codeline>
<codeline lineno="320" refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" kindref="member">o_q4_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight></codeline>
<codeline lineno="323" refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>;</highlight></codeline>
<codeline lineno="324"><highlight class="normal"></highlight></codeline>
<codeline lineno="326" refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"></highlight></codeline>
<codeline lineno="329" refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="332" refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>;</highlight></codeline>
<codeline lineno="333"><highlight class="normal"></highlight></codeline>
<codeline lineno="335" refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"></highlight></codeline>
<codeline lineno="338" refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>;</highlight></codeline>
<codeline lineno="339"><highlight class="normal"></highlight></codeline>
<codeline lineno="341" refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>;</highlight></codeline>
<codeline lineno="342"><highlight class="normal"></highlight></codeline>
<codeline lineno="344" refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>;</highlight></codeline>
<codeline lineno="345"><highlight class="normal"></highlight></codeline>
<codeline lineno="347" refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structie__moe__w" kindref="compound">ie_moe_w_t</ref><sp/><ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>;</highlight></codeline>
<codeline lineno="348" refid="infer__gptoss_8c_1a3e426421aa66fb663b1f85438878bd5a" refkind="member"><highlight class="normal">}<sp/><ref refid="infer__gptoss_8c_1a3e426421aa66fb663b1f85438878bd5a" kindref="member">ie_gptoss_layer_w_t</ref>;</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="359" refid="structie__gptoss__infer__impl" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>{</highlight></codeline>
<codeline lineno="361" refid="structie__gptoss__infer__impl_1a8ca6a5d2971b7df6973a6fa49a19bb8d" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structie__device" kindref="compound">ie_device_t</ref><sp/>*<ref refid="structie__gptoss__infer__impl_1a8ca6a5d2971b7df6973a6fa49a19bb8d" kindref="member">dev</ref>;</highlight></codeline>
<codeline lineno="362"><highlight class="normal"></highlight></codeline>
<codeline lineno="364" refid="structie__gptoss__infer__impl_1a953824f4ef6444bb2d702afaa61a18c1" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__weights__s" kindref="compound">ie_weights_t</ref><sp/>*<ref refid="structie__gptoss__infer__impl_1a953824f4ef6444bb2d702afaa61a18c1" kindref="member">weights</ref>;</highlight></codeline>
<codeline lineno="365"><highlight class="normal"></highlight></codeline>
<codeline lineno="367" refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__hparams" kindref="compound">ie_gptoss_hparams_t</ref><sp/>*<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>;</highlight></codeline>
<codeline lineno="368"><highlight class="normal"></highlight></codeline>
<codeline lineno="370" refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structtensor__map__s" kindref="compound">tensor_map_t</ref><sp/><ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>;</highlight></codeline>
<codeline lineno="371"><highlight class="normal"></highlight></codeline>
<codeline lineno="373" refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref>;</highlight></codeline>
<codeline lineno="374"><highlight class="normal"></highlight></codeline>
<codeline lineno="376" refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" kindref="member">bin_base</ref>;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"></highlight></codeline>
<codeline lineno="379" refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" kindref="member">bin_size</ref>;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"></highlight></codeline>
<codeline lineno="382" refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>;</highlight></codeline>
<codeline lineno="383"><highlight class="normal"></highlight></codeline>
<codeline lineno="385" refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" kindref="member">w_embed_bf16</ref>;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"></highlight></codeline>
<codeline lineno="388" refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" kindref="member">w_norm_bf16</ref>;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="391" refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" kindref="member">w_norm_f32</ref>;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="394" refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*<ref refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" kindref="member">w_lm_bf16</ref>;</highlight></codeline>
<codeline lineno="395"><highlight class="normal"></highlight></codeline>
<codeline lineno="397" refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref>;</highlight></codeline>
<codeline lineno="398"><highlight class="normal"></highlight></codeline>
<codeline lineno="400" refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" kindref="member">w_lm_q4_scales</ref>;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="403" refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/><ref refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" kindref="member">w_lm_q4_scale_bytes</ref>;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"></highlight></codeline>
<codeline lineno="406" refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>;</highlight></codeline>
<codeline lineno="407"><highlight class="normal"></highlight></codeline>
<codeline lineno="409" refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>;</highlight></codeline>
<codeline lineno="410"><highlight class="normal"></highlight></codeline>
<codeline lineno="412" refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>;</highlight></codeline>
<codeline lineno="413"><highlight class="normal"></highlight></codeline>
<codeline lineno="415" refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>;</highlight></codeline>
<codeline lineno="416"><highlight class="normal"></highlight></codeline>
<codeline lineno="418" refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>;</highlight></codeline>
<codeline lineno="419"><highlight class="normal"></highlight></codeline>
<codeline lineno="421" refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>;</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="424" refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>;</highlight></codeline>
<codeline lineno="425"><highlight class="normal"></highlight></codeline>
<codeline lineno="427" refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="428"><highlight class="normal"></highlight></codeline>
<codeline lineno="430" refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"></highlight></codeline>
<codeline lineno="433" refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref>;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"></highlight></codeline>
<codeline lineno="440" refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"></highlight></codeline>
<codeline lineno="443" refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref>;</highlight></codeline>
<codeline lineno="444"><highlight class="normal"></highlight></codeline>
<codeline lineno="446" refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>;</highlight></codeline>
<codeline lineno="447"><highlight class="normal"></highlight></codeline>
<codeline lineno="449" refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>;</highlight></codeline>
<codeline lineno="450"><highlight class="normal"></highlight></codeline>
<codeline lineno="452" refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" kindref="member">rope_theta</ref>;</highlight></codeline>
<codeline lineno="453"><highlight class="normal"></highlight></codeline>
<codeline lineno="460" refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" kindref="member">rope_scale</ref>;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"></highlight></codeline>
<codeline lineno="463" refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref>;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="470" refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" kindref="member">moe_topk</ref>;</highlight></codeline>
<codeline lineno="471"><highlight class="normal"></highlight></codeline>
<codeline lineno="473" refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" kindref="member">use_f32_attn</ref>;</highlight></codeline>
<codeline lineno="474"><highlight class="normal"></highlight></codeline>
<codeline lineno="476" refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" kindref="member">use_f32_router</ref>;</highlight></codeline>
<codeline lineno="477"><highlight class="normal"></highlight></codeline>
<codeline lineno="479" refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" kindref="member">use_f32_lm_head</ref>;</highlight></codeline>
<codeline lineno="480"><highlight class="normal"></highlight></codeline>
<codeline lineno="482" refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref>;</highlight></codeline>
<codeline lineno="483"><highlight class="normal">};</highlight></codeline>
<codeline lineno="484"><highlight class="normal"></highlight></codeline>
<codeline lineno="485"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="486"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Small<sp/>helpers<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="487"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="488"><highlight class="normal"></highlight></codeline>
<codeline lineno="495" refid="infer__gptoss_8c_1a23c0a7a4138efca538e74eda244f02e4" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a23c0a7a4138efca538e74eda244f02e4" kindref="member">ie_min_size</ref>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>a,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>b)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(a<sp/>&lt;<sp/>b)<sp/>?<sp/>a<sp/>:<sp/>b;<sp/>}</highlight></codeline>
<codeline lineno="496"><highlight class="normal"></highlight></codeline>
<codeline lineno="503" refid="infer__gptoss_8c_1a051dcc7bf1e50054f8b124fc1e740288" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="infer__gptoss_8c_1a051dcc7bf1e50054f8b124fc1e740288" kindref="member">ie_u32_min</ref>(uint32_t<sp/>a,<sp/>uint32_t<sp/>b)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(a<sp/>&lt;<sp/>b)<sp/>?<sp/>a<sp/>:<sp/>b;<sp/>}</highlight></codeline>
<codeline lineno="504"><highlight class="normal"></highlight></codeline>
<codeline lineno="514" refid="infer__gptoss_8c_1a37a69a9cc6c14a335fdcf1df79093005" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="infer__gptoss_8c_1a37a69a9cc6c14a335fdcf1df79093005" kindref="member">ie_dirname_alloc</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path)<sp/>{</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!path)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="516"><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*slash<sp/>=<sp/>strrchr(path,<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!slash)<sp/>{</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(2);</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/>out[0]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/>out[1]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>out;</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="525"><highlight class="normal"></highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len<sp/>=<sp/>(size_t)(slash<sp/>-<sp/>path);</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(len<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(2);</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/>out[0]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/>out[1]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>out;</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="534"><highlight class="normal"></highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(len<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/>memcpy(out,<sp/>path,<sp/>len);</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/>out[len]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>out;</highlight></codeline>
<codeline lineno="540"><highlight class="normal">}</highlight></codeline>
<codeline lineno="541"><highlight class="normal"></highlight></codeline>
<codeline lineno="548" refid="infer__gptoss_8c_1abaa225eee9cc8e6cf2813fad866a16c1" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="infer__gptoss_8c_1abaa225eee9cc8e6cf2813fad866a16c1" kindref="member">ie_path_join_alloc</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*a,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*b)<sp/>{</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!a<sp/>||<sp/>!b)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>la<sp/>=<sp/>strlen(a);</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>lb<sp/>=<sp/>strlen(b);</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>need_slash<sp/>=<sp/>(la<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>a[la<sp/>-<sp/>1]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="553"><highlight class="normal"></highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(la<sp/>+<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)need_slash<sp/>+<sp/>lb<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="556"><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/>memcpy(out,<sp/>a,<sp/>la);</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>off<sp/>=<sp/>la;</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(need_slash)<sp/>out[off++]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/>memcpy(out<sp/>+<sp/>off,<sp/>b,<sp/>lb);</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/>out[off<sp/>+<sp/>lb]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>out;</highlight></codeline>
<codeline lineno="563"><highlight class="normal">}</highlight></codeline>
<codeline lineno="564"><highlight class="normal"></highlight></codeline>
<codeline lineno="572" refid="infer__gptoss_8c_1a350055e3279aa56a313cc54048c81b52" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a350055e3279aa56a313cc54048c81b52" kindref="member">ie_mmap_ro</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/>uint8_t<sp/>**out_base,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_size)<sp/>{</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!path<sp/>||<sp/>!out_base<sp/>||<sp/>!out_size)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/>*out_base<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/>*out_size<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="576"><highlight class="normal"></highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>fd<sp/>=<sp/>open(path,<sp/>O_RDONLY);</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fd<sp/>&lt;<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">stat<sp/>st;</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fstat(fd,<sp/>&amp;st)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/>close(fd);</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st.st_size<sp/>&lt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/>close(fd);</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="589"><highlight class="normal"></highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>mmap(NULL,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)st.st_size,<sp/>PROT_READ,<sp/>MAP_PRIVATE,<sp/>fd,<sp/>0);</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/>close(fd);</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(p<sp/>==<sp/>MAP_FAILED)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="593"><highlight class="normal"></highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/>*out_base<sp/>=<sp/>(uint8_t<sp/>*)p;</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/>*out_size<sp/>=<sp/>(size_t)st.st_size;</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="597"><highlight class="normal">}</highlight></codeline>
<codeline lineno="598"><highlight class="normal"></highlight></codeline>
<codeline lineno="604" refid="infer__gptoss_8c_1aa47d37a36d18e17af565d12559d481c7" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aa47d37a36d18e17af565d12559d481c7" kindref="member">ie_munmap_ro</ref>(uint8_t<sp/>*base,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>size)<sp/>{</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!base<sp/>||<sp/>size<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/>(void)munmap((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*)base,<sp/>size);</highlight></codeline>
<codeline lineno="607"><highlight class="normal">}</highlight></codeline>
<codeline lineno="608"><highlight class="normal"></highlight></codeline>
<codeline lineno="617" refid="infer__gptoss_8c_1a2695e784cb752a5747eb95892e2ef6af" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="infer__gptoss_8c_1a2695e784cb752a5747eb95892e2ef6af" kindref="member">ie_env_u32_clamped</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,<sp/>uint32_t<sp/>def,<sp/>uint32_t<sp/>lo,<sp/>uint32_t<sp/>hi)<sp/>{</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(name);</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!*s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>def;</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>strtoul(s,<sp/>&amp;end,<sp/>10);</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(end<sp/>==<sp/>s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>def;</highlight></codeline>
<codeline lineno="624"><highlight class="normal"></highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)lo)<sp/>v<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/>long)lo;</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)hi)<sp/>v<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)hi;</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(uint32_t)v;</highlight></codeline>
<codeline lineno="628"><highlight class="normal">}</highlight></codeline>
<codeline lineno="629"><highlight class="normal"></highlight></codeline>
<codeline lineno="638" refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" kindref="member">ie_env_f32_clamped</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>def,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>lo,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>hi)<sp/>{</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(name);</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!*s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>def;</highlight></codeline>
<codeline lineno="641"><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>strtof(s,<sp/>&amp;end);</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(end<sp/>==<sp/>s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>def;</highlight></codeline>
<codeline lineno="645"><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>lo)<sp/>v<sp/>=<sp/>lo;</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>hi)<sp/>v<sp/>=<sp/>hi;</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>v;</highlight></codeline>
<codeline lineno="649"><highlight class="normal">}</highlight></codeline>
<codeline lineno="650"><highlight class="normal"></highlight></codeline>
<codeline lineno="656" refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" kindref="member">ie_env_flag</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name)<sp/>{</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(name);</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!*s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;f&apos;</highlight><highlight class="normal"><sp/>||<sp/>s[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;F&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;n&apos;</highlight><highlight class="normal"><sp/>||<sp/>s[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;N&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="663"><highlight class="normal">}</highlight></codeline>
<codeline lineno="664"><highlight class="normal"></highlight></codeline>
<codeline lineno="672" refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*src,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>**out)<sp/>{</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!src<sp/>||<sp/>n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*buf<sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(n<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><ref refid="ie__kernels_8h_1a782b7a53732be7ae0a2f0eb663e36321" kindref="member">ie_vec_bf16_to_f32</ref>(src,<sp/>buf,<sp/>n);</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>buf;</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="681"><highlight class="normal">}</highlight></codeline>
<codeline lineno="682"><highlight class="normal"></highlight></codeline>
<codeline lineno="683"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="684"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>BF16<sp/>helpers<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="685"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight></codeline>
<codeline lineno="692" refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">inline</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" kindref="member">ie_bf16_to_f32</ref>(uint16_t<sp/>v)<sp/>{</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">union<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>u;</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>f;</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/>}<sp/>t;</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/>t.u<sp/>=<sp/>((uint32_t)v)<sp/>&lt;&lt;<sp/>16;</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>t.f;</highlight></codeline>
<codeline lineno="699"><highlight class="normal">}</highlight></codeline>
<codeline lineno="700"><highlight class="normal"></highlight></codeline>
<codeline lineno="706" refid="infer__gptoss_8c_1a9acc6f2706c714def21ba7cb496ca00c" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">inline</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a9acc6f2706c714def21ba7cb496ca00c" kindref="member">ie_silu_f32</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>x<sp/>/<sp/>(1.0f<sp/>+<sp/>expf(-x));<sp/>}</highlight></codeline>
<codeline lineno="707"><highlight class="normal"></highlight></codeline>
<codeline lineno="708" refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cached<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cached<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(</highlight><highlight class="stringliteral">&quot;IE_DEBUG_NAN&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/>cached<sp/>=<sp/>(s<sp/>&amp;&amp;<sp/>s[0]<sp/>&amp;&amp;<sp/>strcmp(s,<sp/></highlight><highlight class="stringliteral">&quot;0&quot;</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cached;</highlight></codeline>
<codeline lineno="715"><highlight class="normal">}</highlight></codeline>
<codeline lineno="716"><highlight class="normal"></highlight></codeline>
<codeline lineno="717" refid="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" kindref="member">ie_trace_bf16_enabled_</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="718"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cached<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cached<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(</highlight><highlight class="stringliteral">&quot;IE_TRACE_BF16&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/>cached<sp/>=<sp/>(s<sp/>&amp;&amp;<sp/>s[0]<sp/>&amp;&amp;<sp/>strcmp(s,<sp/></highlight><highlight class="stringliteral">&quot;0&quot;</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cached;</highlight></codeline>
<codeline lineno="724"><highlight class="normal">}</highlight></codeline>
<codeline lineno="725"><highlight class="normal"></highlight></codeline>
<codeline lineno="726" refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*v,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tag,</highlight></codeline>
<codeline lineno="727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>layer,<sp/>uint32_t<sp/>pos)<sp/>{</highlight></codeline>
<codeline lineno="728"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!v<sp/>||<sp/>!tag<sp/>||<sp/>n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!isfinite(v[i]))<sp/>{</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;nan:<sp/>%s<sp/>layer=%u<sp/>pos=%u<sp/>idx=%zu<sp/>val=%g&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)layer,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos,<sp/>i,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)v[i]);</highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="737"><highlight class="normal">}</highlight></codeline>
<codeline lineno="738"><highlight class="normal"></highlight></codeline>
<codeline lineno="739"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="740"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Math<sp/>primitives<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="741"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="742"><highlight class="normal"></highlight></codeline>
<codeline lineno="750" refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" kindref="member">ie_dot_f32</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*a,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*b,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>s<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>s<sp/>+=<sp/>a[i]<sp/>*<sp/>b[i];</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>s;</highlight></codeline>
<codeline lineno="754"><highlight class="normal">}</highlight></codeline>
<codeline lineno="755"><highlight class="normal"></highlight></codeline>
<codeline lineno="761" refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" kindref="member">ie_softmax_inplace_f32</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*x,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!x<sp/>||<sp/>n<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="763"><highlight class="normal"></highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>m<sp/>=<sp/>x[0];</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(x[i]<sp/>&gt;<sp/>m)<sp/>m<sp/>=<sp/>x[i];</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>sum<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/>x[i]<sp/>=<sp/>expf(x[i]<sp/>-<sp/>m);</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/>sum<sp/>+=<sp/>x[i];</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="773"><highlight class="normal"></highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>(sum<sp/>&gt;<sp/>0.0f)<sp/>?<sp/>(1.0f<sp/>/<sp/>sum)<sp/>:<sp/>1.0f;</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>x[i]<sp/>*=<sp/>inv;</highlight></codeline>
<codeline lineno="776"><highlight class="normal">}</highlight></codeline>
<codeline lineno="777"><highlight class="normal"></highlight></codeline>
<codeline lineno="778"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="779"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Generic<sp/>weight<sp/>view<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="780"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="781"><highlight class="normal"></highlight></codeline>
<codeline lineno="785" refid="structie__tensor__view" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view</ref><sp/>{</highlight></codeline>
<codeline lineno="787" refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="789" refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__desc__s" kindref="compound">tensor_desc_t</ref><sp/>*<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>;</highlight></codeline>
<codeline lineno="790" refid="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" refkind="member"><highlight class="normal">}<sp/><ref refid="infer__gptoss_8c_1a911beaa129dc2135667807456a2e0441" kindref="member">ie_tensor_view_t</ref>;</highlight></codeline>
<codeline lineno="791"><highlight class="normal"></highlight></codeline>
<codeline lineno="798" refid="infer__gptoss_8c_1aa3b82aa04620edd8580f7ecf25a76f5f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__desc__s" kindref="compound">tensor_desc_t</ref><sp/>*<ref refid="infer__gptoss_8c_1aa3b82aa04620edd8580f7ecf25a76f5f" kindref="member">ie_w_find</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__map__s" kindref="compound">tensor_map_t</ref><sp/>*tmap,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name)<sp/>{</highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tmap<sp/>||<sp/>!name)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tensor__map_8h_1abe58b80593931ffe5844ee4bcee805c5" kindref="member">tensor_map_find</ref>(tmap,<sp/>name);</highlight></codeline>
<codeline lineno="801"><highlight class="normal">}</highlight></codeline>
<codeline lineno="802"><highlight class="normal"></highlight></codeline>
<codeline lineno="810" refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" kindref="member">ie_w_get_view</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,</highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!name<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/>out-&gt;ptr<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/>out-&gt;desc<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="815"><highlight class="normal"></highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__desc__s" kindref="compound">tensor_desc_t</ref><sp/>*td<sp/>=<sp/><ref refid="infer__gptoss_8c_1aa3b82aa04620edd8580f7ecf25a76f5f" kindref="member">ie_w_find</ref>(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>,<sp/>name);</highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!td)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="818"><highlight class="normal"></highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>off<sp/>=<sp/>td-&gt;<ref refid="structtensor__desc__s_1a0abe393a370bda31eda8ab11a5f8df37" kindref="member">offset</ref>;</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>nb<sp/>=<sp/>td-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>;</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint64_t)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" kindref="member">bin_size</ref><sp/>&lt;<sp/>off<sp/>+<sp/>nb)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="822"><highlight class="normal"></highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/>out-&gt;desc<sp/>=<sp/>td;</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/>out-&gt;ptr<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*)(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" kindref="member">bin_base</ref><sp/>+<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)off);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="826"><highlight class="normal">}</highlight></codeline>
<codeline lineno="827"><highlight class="normal"></highlight></codeline>
<codeline lineno="836" refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>*names,</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>count,<sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!names<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/><ref refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" kindref="member">ie_w_get_view</ref>(impl,<sp/>names[i],<sp/>out);</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>td_buf[256];</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;desc<sp/>&amp;&amp;<sp/><ref refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" kindref="member">tensor_desc_to_string</ref>(out-&gt;desc,<sp/>td_buf,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(td_buf))<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;resolved<sp/>tensor:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>td_buf);</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;resolved<sp/>tensor:<sp/>name=%s&quot;</highlight><highlight class="normal">,<sp/>names[i]);</highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/>out-&gt;ptr<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/>out-&gt;desc<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="854"><highlight class="normal">}</highlight></codeline>
<codeline lineno="855"><highlight class="normal"></highlight></codeline>
<codeline lineno="866" refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,<sp/>uint32_t<sp/>layer,</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>*fmts,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>count,<sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>*out,</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>required)<sp/>{</highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!fmts<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/>out-&gt;ptr<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/>out-&gt;desc<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="872"><highlight class="normal"></highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>name[256];</highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>snprintf(name,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(name),<sp/>fmts[i],<sp/>layer);</highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&lt;=<sp/>0<sp/>||<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n<sp/>&gt;=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(name))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a6972c51eeba752f62cecd9ac7050589c" kindref="member">ie_w_get_view</ref>(impl,<sp/>name,<sp/>out)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>td_buf[256];</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;desc<sp/>&amp;&amp;<sp/><ref refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" kindref="member">tensor_desc_to_string</ref>(out-&gt;desc,<sp/>td_buf,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(td_buf))<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;resolved<sp/>layer<sp/>tensor:<sp/>layer=%u<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)layer,<sp/>td_buf);</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;resolved<sp/>layer<sp/>tensor:<sp/>layer=%u<sp/>name=%s&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)layer,<sp/>name);</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="887"><highlight class="normal"></highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!required)<sp/>{</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/>out-&gt;ptr<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/>out-&gt;desc<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="893"><highlight class="normal"></highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;missing<sp/>required<sp/>layer<sp/>tensor:<sp/>layer=%u<sp/>(tried<sp/>%zu<sp/>formats)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)layer,<sp/>count);</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;<sp/><sp/>candidate<sp/>fmt[%zu]=%s&quot;</highlight><highlight class="normal">,<sp/>i,<sp/>fmts[i]);</highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="899"><highlight class="normal">}</highlight></codeline>
<codeline lineno="900"><highlight class="normal"></highlight></codeline>
<codeline lineno="907" refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__desc__s" kindref="compound">tensor_desc_t</ref><sp/>*td,<sp/>uint64_t<sp/>want_bytes)<sp/>{</highlight></codeline>
<codeline lineno="908"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!td)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(td-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>want_bytes)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="910"><highlight class="normal"></highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>td_buf[256];</highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" kindref="member">tensor_desc_to_string</ref>(td,<sp/>td_buf,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(td_buf))<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;tensor<sp/>size<sp/>mismatch:<sp/>want_bytes=%llu<sp/>got:<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)want_bytes,<sp/>td_buf);</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;tensor<sp/>size<sp/>mismatch:<sp/>want_bytes=%llu<sp/>got_bytes=%llu<sp/>name=%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)want_bytes,</highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)td-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>,</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(td-&gt;<ref refid="structtensor__desc__s_1a1134b2dbce500003f3b011f3e8a3d090" kindref="member">name</ref><sp/>?<sp/>td-&gt;<ref refid="structtensor__desc__s_1a1134b2dbce500003f3b011f3e8a3d090" kindref="member">name</ref><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&lt;null&gt;&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="922"><highlight class="normal">}</highlight></codeline>
<codeline lineno="923"><highlight class="normal"></highlight></codeline>
<codeline lineno="924"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="925"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>RMSNorm<sp/>+<sp/>RoPE<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="926"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="927"><highlight class="normal"></highlight></codeline>
<codeline lineno="928" refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" refkind="member"><highlight class="normal"><ref refid="infer__gptoss_8c_1a54c96bba1e88a7dafb048d8a8918e5c8" kindref="member">IE_WEAK</ref><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" kindref="member">ie_rmsnorm_cpu_f32</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*x,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*w,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>eps,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*y)<sp/>{</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!x<sp/>||<sp/>!w<sp/>||<sp/>!y<sp/>||<sp/>n<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="930"><highlight class="normal"></highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>ss<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>ss<sp/>+=<sp/>x[i]<sp/>*<sp/>x[i];</highlight></codeline>
<codeline lineno="933"><highlight class="normal"></highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>1.0f<sp/>/<sp/>sqrtf(ss<sp/>/<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)n<sp/>+<sp/>eps);</highlight></codeline>
<codeline lineno="935"><highlight class="normal"></highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>y[i]<sp/>=<sp/>x[i]<sp/>*<sp/>inv<sp/>*<sp/>w[i];</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="938"><highlight class="normal">}</highlight></codeline>
<codeline lineno="939"><highlight class="normal"></highlight></codeline>
<codeline lineno="940" refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" kindref="member">ie_rmsnorm_cpu_f32_bf16w</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*x,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*w_bf16,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>eps,</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*y)<sp/>{</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!x<sp/>||<sp/>!w_bf16<sp/>||<sp/>!y<sp/>||<sp/>n<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="943"><highlight class="normal"></highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>ss<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>ss<sp/>+=<sp/>x[i]<sp/>*<sp/>x[i];</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>1.0f<sp/>/<sp/>sqrtf(ss<sp/>/<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)n<sp/>+<sp/>eps);</highlight></codeline>
<codeline lineno="947"><highlight class="normal"></highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>wi<sp/>=<sp/><ref refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" kindref="member">ie_bf16_to_f32</ref>(w_bf16[i]);</highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/>y[i]<sp/>=<sp/>x[i]<sp/>*<sp/>inv<sp/>*<sp/>wi;</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="953"><highlight class="normal">}</highlight></codeline>
<codeline lineno="954"><highlight class="normal"></highlight></codeline>
<codeline lineno="955" refid="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" refkind="member"><highlight class="normal"><ref refid="infer__gptoss_8c_1a54c96bba1e88a7dafb048d8a8918e5c8" kindref="member">IE_WEAK</ref><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" kindref="member">ie_rope_apply_f32</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*q,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*k,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>heads,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>head_dim,<sp/>uint32_t<sp/>pos,</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>theta)<sp/>{</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(head_dim<sp/>==<sp/>0u<sp/>||<sp/>(head_dim<sp/>&amp;<sp/>1u)<sp/>!=<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q<sp/>&amp;&amp;<sp/>!k)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="959"><highlight class="normal"></highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>half<sp/>=<sp/>head_dim<sp/>/<sp/>2u;</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>log_theta<sp/>=<sp/>logf(theta);</highlight></codeline>
<codeline lineno="962"><highlight class="normal"></highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>h<sp/>=<sp/>0;<sp/>h<sp/>&lt;<sp/>heads;<sp/>++h)<sp/>{</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*vq<sp/>=<sp/>q<sp/>?<sp/>(q<sp/>+<sp/>h<sp/>*<sp/>head_dim)<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*vk<sp/>=<sp/>k<sp/>?<sp/>(k<sp/>+<sp/>h<sp/>*<sp/>head_dim)<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="966"><highlight class="normal"></highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>half;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>exponent<sp/>=<sp/>-2.0f<sp/>*<sp/>(float)i<sp/>/<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)head_dim;</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv_freq<sp/>=<sp/>expf(log_theta<sp/>*<sp/>exponent);</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>ang<sp/>=<sp/>(float)pos<sp/>*<sp/>inv_freq;</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>cosf(ang);</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>s<sp/>=<sp/>sinf(ang);</highlight></codeline>
<codeline lineno="973"><highlight class="normal"></highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i0<sp/>=<sp/>2u<sp/>*<sp/>i;</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i1<sp/>=<sp/>i0<sp/>+<sp/>1u;</highlight></codeline>
<codeline lineno="976"><highlight class="normal"></highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vq)<sp/>{</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x0<sp/>=<sp/>vq[i0];</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x1<sp/>=<sp/>vq[i1];</highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vq[i0]<sp/>=<sp/>x0<sp/>*<sp/>c<sp/>-<sp/>x1<sp/>*<sp/>s;</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vq[i1]<sp/>=<sp/>x0<sp/>*<sp/>s<sp/>+<sp/>x1<sp/>*<sp/>c;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="983"><highlight class="normal"></highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vk)<sp/>{</highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x0<sp/>=<sp/>vk[i0];</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x1<sp/>=<sp/>vk[i1];</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vk[i0]<sp/>=<sp/>x0<sp/>*<sp/>c<sp/>-<sp/>x1<sp/>*<sp/>s;</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vk[i1]<sp/>=<sp/>x0<sp/>*<sp/>s<sp/>+<sp/>x1<sp/>*<sp/>c;</highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="991"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="992"><highlight class="normal"></highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="994"><highlight class="normal">}</highlight></codeline>
<codeline lineno="995"><highlight class="normal"></highlight></codeline>
<codeline lineno="996"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Attention<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="998"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="999"><highlight class="normal"></highlight></codeline>
<codeline lineno="1000" refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" refkind="member"><highlight class="normal"><ref refid="infer__gptoss_8c_1a54c96bba1e88a7dafb048d8a8918e5c8" kindref="member">IE_WEAK</ref><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" kindref="member">ie_attn_cpu_causal_f32</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Q,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*K,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*V,</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>seq_len,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n_heads,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>head_dim,</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv_sqrt_d,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*out,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*scores)<sp/>{</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!Q<sp/>||<sp/>!K<sp/>||<sp/>!V<sp/>||<sp/>!out<sp/>||<sp/>!scores)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(seq_len<sp/>==<sp/>0u<sp/>||<sp/>n_heads<sp/>==<sp/>0u<sp/>||<sp/>head_dim<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"></highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>h<sp/>=<sp/>0;<sp/>h<sp/>&lt;<sp/>n_heads;<sp/>++h)<sp/>{</highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Qh<sp/>=<sp/>Q<sp/>+<sp/>h<sp/>*<sp/>head_dim;</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"></highlight></codeline>
<codeline lineno="1009"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>t<sp/>=<sp/>0;<sp/>t<sp/>&lt;<sp/>seq_len;<sp/>++t)<sp/>{</highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>base<sp/>=<sp/>(t<sp/>*<sp/>n_heads<sp/>+<sp/>h)<sp/>*<sp/>head_dim;</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Kh<sp/>=<sp/>K<sp/>+<sp/>base;</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>scores[t]<sp/>=<sp/><ref refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" kindref="member">ie_dot_f32</ref>(Qh,<sp/>Kh,<sp/>head_dim)<sp/>*<sp/>inv_sqrt_d;</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"></highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" kindref="member">ie_softmax_inplace_f32</ref>(scores,<sp/>seq_len);</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Oh<sp/>=<sp/>out<sp/>+<sp/>h<sp/>*<sp/>head_dim;</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d<sp/>=<sp/>0;<sp/>d<sp/>&lt;<sp/>head_dim;<sp/>++d)<sp/>Oh[d]<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"></highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>t<sp/>=<sp/>0;<sp/>t<sp/>&lt;<sp/>seq_len;<sp/>++t)<sp/>{</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>w<sp/>=<sp/>scores[t];</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>base<sp/>=<sp/>(t<sp/>*<sp/>n_heads<sp/>+<sp/>h)<sp/>*<sp/>head_dim;</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Vh<sp/>=<sp/>V<sp/>+<sp/>base;</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d<sp/>=<sp/>0;<sp/>d<sp/>&lt;<sp/>head_dim;<sp/>++d)<sp/>Oh[d]<sp/>+=<sp/>w<sp/>*<sp/>Vh[d];</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"></highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1029"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"></highlight></codeline>
<codeline lineno="1031" refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" kindref="member">ie_attn_causal_gqa_f32</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Q,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*K,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*V,<sp/>uint32_t<sp/>seq_len,</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>n_heads,<sp/>uint32_t<sp/>n_kv_heads,<sp/>uint32_t<sp/>head_dim,</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv_sqrt_d,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*out,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*scores)<sp/>{</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>group_size<sp/>=<sp/>(n_kv_heads<sp/>&gt;<sp/>0)<sp/>?<sp/>(n_heads<sp/>/<sp/>n_kv_heads)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"></highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>hq<sp/>=<sp/>0;<sp/>hq<sp/>&lt;<sp/>n_heads;<sp/>++hq)<sp/>{</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>hk<sp/>=<sp/>(group_size<sp/>&gt;<sp/>0)<sp/>?<sp/>(hq<sp/>/<sp/>group_size)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Qh<sp/>=<sp/>Q<sp/>+<sp/>(size_t)hq<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)head_dim;</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"></highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>t<sp/>=<sp/>0;<sp/>t<sp/>&lt;<sp/>seq_len;<sp/>++t)<sp/>{</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>base<sp/>=</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>((size_t)t<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_kv_heads<sp/>+<sp/>(size_t)hk)<sp/>*<sp/>(size_t)head_dim;</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Kh<sp/>=<sp/>K<sp/>+<sp/>base;</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>scores[t]<sp/>=<sp/><ref refid="infer__gptoss_8c_1a4ec378d62ae987997040f8a823587612" kindref="member">ie_dot_f32</ref>(Qh,<sp/>Kh,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)head_dim)<sp/>*<sp/>inv_sqrt_d;</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"></highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" kindref="member">ie_softmax_inplace_f32</ref>(scores,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)seq_len);</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"></highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Oh<sp/>=<sp/>out<sp/>+<sp/>(size_t)hq<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)head_dim;</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>d<sp/>=<sp/>0;<sp/>d<sp/>&lt;<sp/>head_dim;<sp/>++d)<sp/>Oh[d]<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"></highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>t<sp/>=<sp/>0;<sp/>t<sp/>&lt;<sp/>seq_len;<sp/>++t)<sp/>{</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>w<sp/>=<sp/>scores[t];</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>base<sp/>=</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>((size_t)t<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_kv_heads<sp/>+<sp/>(size_t)hk)<sp/>*<sp/>(size_t)head_dim;</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Vh<sp/>=<sp/>V<sp/>+<sp/>base;</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>d<sp/>=<sp/>0;<sp/>d<sp/>&lt;<sp/>head_dim;<sp/>++d)<sp/>Oh[d]<sp/>+=<sp/>w<sp/>*<sp/>Vh[d];</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1060"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"></highlight></codeline>
<codeline lineno="1062"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1063"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>MoE<sp/>size<sp/>helpers<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1064"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1065"><highlight class="normal"></highlight></codeline>
<codeline lineno="1066" refid="infer__gptoss_8c_1adbcf08258315917d586a46d5c2838aca" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1adbcf08258315917d586a46d5c2838aca" kindref="member">ie_infer_n_experts_from_router</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structtensor__desc__s" kindref="compound">tensor_desc_t</ref><sp/>*td_router_w,<sp/>uint32_t<sp/>d_model,</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*out_n_experts)<sp/>{</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!td_router_w<sp/>||<sp/>!out_n_experts<sp/>||<sp/>d_model<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"></highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>bytes<sp/>=<sp/>td_router_w-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>;</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>denom<sp/>=<sp/>(uint64_t)d_model<sp/>*<sp/>2u;</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(denom<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((bytes<sp/>%<sp/>denom)<sp/>!=<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>n<sp/>=<sp/>bytes<sp/>/<sp/>denom;</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0u<sp/>||<sp/>n<sp/>&gt;<sp/>65535u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/>*out_n_experts<sp/>=<sp/>(uint32_t)n;</highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1080"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"></highlight></codeline>
<codeline lineno="1082" refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(uint32_t<sp/>n_experts,<sp/>uint32_t<sp/>rows,<sp/>uint32_t<sp/>cols,</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>scale_bytes,</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>*out_blocks_bytes,<sp/>uint64_t<sp/>*out_scales_bytes)<sp/>{</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out_blocks_bytes<sp/>||<sp/>!out_scales_bytes)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_experts<sp/>==<sp/>0u<sp/>||<sp/>rows<sp/>==<sp/>0u<sp/>||<sp/>cols<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cols<sp/>%<sp/>32u)<sp/>!=<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(scale_bytes<sp/>==<sp/>1u<sp/>||<sp/>scale_bytes<sp/>==<sp/>2u))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1089"><highlight class="normal"></highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>qk<sp/>=<sp/>32u;</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>qs_bytes<sp/>=<sp/>16u;</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>nb<sp/>=<sp/>(uint64_t)cols<sp/>/<sp/>qk;</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"></highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>blocks_per_row_bytes<sp/>=<sp/>nb<sp/>*<sp/>qs_bytes;</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>scales_per_row_bytes<sp/>=<sp/>nb<sp/>*<sp/>(uint64_t)scale_bytes;</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"></highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>one_blocks<sp/>=<sp/>(uint64_t)rows<sp/>*<sp/>blocks_per_row_bytes;</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>one_scales<sp/>=<sp/>(uint64_t)rows<sp/>*<sp/>scales_per_row_bytes;</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"></highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/>*out_blocks_bytes<sp/>=<sp/>one_blocks<sp/>*<sp/>(uint64_t)n_experts;</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/>*out_scales_bytes<sp/>=<sp/>one_scales<sp/>*<sp/>(uint64_t)n_experts;</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1103"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"></highlight></codeline>
<codeline lineno="1105" refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(uint32_t<sp/>rows,<sp/>uint32_t<sp/>cols,<sp/>uint8_t<sp/>scale_bytes,</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>*out_blocks_bytes,<sp/>uint64_t<sp/>*out_scales_bytes)<sp/>{</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out_blocks_bytes<sp/>||<sp/>!out_scales_bytes)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rows<sp/>==<sp/>0u<sp/>||<sp/>cols<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cols<sp/>%<sp/>32u)<sp/>!=<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(scale_bytes<sp/>==<sp/>1u<sp/>||<sp/>scale_bytes<sp/>==<sp/>2u))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"></highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>blocks_per_row_bytes<sp/>=<sp/>((uint64_t)cols<sp/>/<sp/>32u)<sp/>*<sp/>16u;</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>scales_per_row_bytes<sp/>=<sp/>((uint64_t)cols<sp/>/<sp/>32u)<sp/>*<sp/>(uint64_t)scale_bytes;</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"></highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/>*out_blocks_bytes<sp/>=<sp/>(uint64_t)rows<sp/>*<sp/>blocks_per_row_bytes;</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/>*out_scales_bytes<sp/>=<sp/>(uint64_t)rows<sp/>*<sp/>scales_per_row_bytes;</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1118"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"></highlight></codeline>
<codeline lineno="1120" refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" kindref="member">ie_add_bias_f32</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*dst,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*bias,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!dst<sp/>||<sp/>!bias)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>dst[i]<sp/>+=<sp/>bias[i];</highlight></codeline>
<codeline lineno="1123"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"></highlight></codeline>
<codeline lineno="1125"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1126"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Resolve<sp/>MoE<sp/>tensors<sp/>for<sp/>one<sp/>layer<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1127"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1128"><highlight class="normal"></highlight></codeline>
<codeline lineno="1129" refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" kindref="member">ie_resolve_moe_layer</ref>(</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,<sp/>uint32_t<sp/>l,</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*LW)<sp/>{</highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!LW<sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"></highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_model<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" kindref="member">d_model</ref>;</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_ff<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" kindref="member">d_ff</ref>;</highlight></codeline>
<codeline lineno="1135"><highlight class="normal"></highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_router_w,<sp/>v_router_b;</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_gu_blocks,<sp/>v_gu_scales,<sp/>v_gu_bias;</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_dn_blocks,<sp/>v_dn_scales,<sp/>v_dn_bias;</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"></highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>router_w_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.router.weight&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>router_b_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.router.bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"></highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>gu_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.gate_up_proj_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>gu_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.gate_up_proj_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>gu_bias_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.gate_up_proj_bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"></highlight></codeline>
<codeline lineno="1147"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>dn_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.down_proj_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>dn_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.down_proj_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1149"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>dn_bias_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.mlp.experts.down_proj_bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"></highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>router_w_fmts,<sp/>1,<sp/>&amp;v_router_w,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>missing<sp/>router.weight<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/>(void)<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>router_b_fmts,<sp/>1,<sp/>&amp;v_router_b,<sp/>0);</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"></highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!v_router_w.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1158"><highlight class="normal"></highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/>uint32_t<sp/>n_experts<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1adbcf08258315917d586a46d5c2838aca" kindref="member">ie_infer_n_experts_from_router</ref>(v_router_w.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>d_model,<sp/>&amp;n_experts)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>td_buf[256];</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/>(void)<ref refid="tensor__map_8h_1ad887f000c7ecd66c30fb2d5cad14376d" kindref="member">tensor_desc_to_string</ref>(v_router_w.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>td_buf,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(td_buf));</highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>failed<sp/>to<sp/>infer<sp/>n_experts<sp/>from<sp/>router.weight<sp/>layer=%u<sp/>d_model=%u<sp/>td=%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model,<sp/>td_buf);</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"></highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_router_b.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_router_b.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>(uint64_t)n_experts<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>router.bias<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>n_experts=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_experts);</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"></highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>gu_blocks_fmts,<sp/>1,<sp/>&amp;v_gu_blocks,<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-6;</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>gu_scales_fmts,<sp/>1,<sp/>&amp;v_gu_scales,<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-7;</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/>(void)<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>gu_bias_fmts,<sp/>1,<sp/>&amp;v_gu_bias,<sp/>0);</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"></highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>dn_blocks_fmts,<sp/>1,<sp/>&amp;v_dn_blocks,<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-8;</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>dn_scales_fmts,<sp/>1,<sp/>&amp;v_dn_scales,<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-9;</highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/>(void)<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>dn_bias_fmts,<sp/>1,<sp/>&amp;v_dn_bias,<sp/>0);</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"></highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!v_gu_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref><sp/>||<sp/>!v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref><sp/>||<sp/>!v_dn_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref><sp/>||<sp/>!v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>missing<sp/>required<sp/>expert<sp/>tensors<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"></highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/>uint8_t<sp/>gu_scale_bytes<sp/>=<sp/>0u;</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" kindref="member">TENSOR_DTYPE_BF16</ref>)<sp/>gu_scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" kindref="member">TENSOR_DTYPE_U8</ref>)<sp/>gu_scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1191"><highlight class="normal"></highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(gu_scale_bytes<sp/>==<sp/>0u)<sp/>{</highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>tmp_blocks<sp/>=<sp/>0,<sp/>tmp_scales_1<sp/>=<sp/>0,<sp/>tmp_scales_2<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>2u<sp/>*<sp/>d_ff,<sp/>d_model,<sp/>1u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>2u<sp/>*<sp/>d_ff,<sp/>d_model,<sp/>2u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_2)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"></highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_1)<sp/>gu_scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_2)<sp/>gu_scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>cannot<sp/>infer<sp/>gate_up<sp/>scale_bytes<sp/>layer=%u<sp/>size_bytes=%llu<sp/>(want<sp/>%llu<sp/>or<sp/>%llu)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>,</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)tmp_scales_1,</highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)tmp_scales_2);</highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"></highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/>uint8_t<sp/>dn_scale_bytes<sp/>=<sp/>0u;</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" kindref="member">TENSOR_DTYPE_BF16</ref>)<sp/>dn_scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" kindref="member">TENSOR_DTYPE_U8</ref>)<sp/>dn_scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"></highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dn_scale_bytes<sp/>==<sp/>0u)<sp/>{</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>tmp_blocks<sp/>=<sp/>0,<sp/>tmp_scales_1<sp/>=<sp/>0,<sp/>tmp_scales_2<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>d_model,<sp/>d_ff,<sp/>1u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>d_model,<sp/>d_ff,<sp/>2u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_2)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"></highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_1)<sp/>dn_scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_2)<sp/>dn_scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>cannot<sp/>infer<sp/>down<sp/>scale_bytes<sp/>layer=%u<sp/>size_bytes=%llu<sp/>(want<sp/>%llu<sp/>or<sp/>%llu)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>,</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)tmp_scales_1,</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)tmp_scales_2);</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"></highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/>uint64_t<sp/>want_gu_blocks<sp/>=<sp/>0,<sp/>want_gu_scales<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>2u<sp/>*<sp/>d_ff,<sp/>d_model,<sp/>gu_scale_bytes,<sp/>&amp;want_gu_blocks,<sp/>&amp;want_gu_scales)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1233"><highlight class="normal"></highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/>uint64_t<sp/>want_dn_blocks<sp/>=<sp/>0,<sp/>want_dn_scales<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3205791678738d4a18ca6625cd494617" kindref="member">ie_moe_expected_bytes</ref>(n_experts,<sp/>d_model,<sp/>d_ff,<sp/>dn_scale_bytes,<sp/>&amp;want_dn_blocks,<sp/>&amp;want_dn_scales)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"></highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_gu_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_gu_blocks)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_gu_scales)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-14;</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_dn_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_dn_blocks)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-15;</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_dn_scales)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-16;</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"></highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_gu_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_gu_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint64_t)n_experts<sp/>*<sp/>(uint64_t)(2u<sp/>*<sp/>d_ff)<sp/>*<sp/>2u)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-17;</highlight></codeline>
<codeline lineno="1247"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_dn_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_dn_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>(uint64_t)n_experts<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-18;</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"></highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" kindref="member">n_experts</ref><sp/>=<sp/>n_experts;</highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" kindref="member">router_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)v_router_w.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" kindref="member">router_b</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)v_router_b.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a902b5265614fc6377af002fa3f2fa625" kindref="member">router_transposed</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"></highlight></codeline>
<codeline lineno="1258"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" kindref="member">gate_up_blocks</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_gu_blocks.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" kindref="member">gate_up_scales</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_gu_scales.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" kindref="member">gate_up_scale_bytes</ref><sp/>=<sp/>gu_scale_bytes;</highlight></codeline>
<codeline lineno="1261"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" kindref="member">gate_up_bias</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)v_gu_bias.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1262"><highlight class="normal"></highlight></codeline>
<codeline lineno="1263"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" kindref="member">down_blocks</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_dn_blocks.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1264"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" kindref="member">down_scales</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_dn_scales.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" kindref="member">down_scale_bytes</ref><sp/>=<sp/>dn_scale_bytes;</highlight></codeline>
<codeline lineno="1266"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" kindref="member">down_bias</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)v_dn_bias.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"></highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" kindref="member">gate_up_blocks_stride</ref><sp/>=<sp/>(size_t)(v_gu_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts);</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" kindref="member">gate_up_scales_stride</ref><sp/>=<sp/>(size_t)(v_gu_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts);</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" kindref="member">gate_up_bias_stride</ref><sp/>=<sp/>v_gu_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref><sp/>?<sp/>(size_t)(v_gu_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts)<sp/>:<sp/>0u;</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"></highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" kindref="member">down_blocks_stride</ref><sp/>=<sp/>(size_t)(v_dn_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts);</highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" kindref="member">down_scales_stride</ref><sp/>=<sp/>(size_t)(v_dn_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts);</highlight></codeline>
<codeline lineno="1274"><highlight class="normal"><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" kindref="member">down_bias_stride</ref><sp/>=<sp/>v_dn_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref><sp/>?<sp/>(size_t)(v_dn_bias.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>/<sp/>n_experts)<sp/>:<sp/>0u;</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"></highlight></codeline>
<codeline lineno="1276"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>&lt;<sp/>n_experts)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>=<sp/>n_experts;</highlight></codeline>
<codeline lineno="1277"><highlight class="normal"></highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;moe:<sp/>layer=%u<sp/>n_experts=%u<sp/>gu_scale_bytes=%u<sp/>dn_scale_bytes=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_experts,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)gu_scale_bytes,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)dn_scale_bytes);</highlight></codeline>
<codeline lineno="1280"><highlight class="normal"></highlight></codeline>
<codeline lineno="1281"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1282"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1283"><highlight class="normal"></highlight></codeline>
<codeline lineno="1284" refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" kindref="member">ie_resolve_q4_attn_weight</ref>(</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>l,</highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>blocks_fmts[],</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>scales_fmts[],</highlight></codeline>
<codeline lineno="1288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>rows,</highlight></codeline>
<codeline lineno="1289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>cols,</highlight></codeline>
<codeline lineno="1290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tag,</highlight></codeline>
<codeline lineno="1291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>**out_blocks,</highlight></codeline>
<codeline lineno="1292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>**out_scales,</highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>*out_scale_bytes)<sp/>{</highlight></codeline>
<codeline lineno="1294"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!blocks_fmts<sp/>||<sp/>!scales_fmts<sp/>||<sp/>!out_blocks<sp/>||<sp/>!out_scales<sp/>||<sp/>!out_scale_bytes)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1295"><highlight class="normal"></highlight></codeline>
<codeline lineno="1296"><highlight class="normal"><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_blocks,<sp/>v_scales;</highlight></codeline>
<codeline lineno="1297"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>have_blocks<sp/>=</highlight></codeline>
<codeline lineno="1298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>blocks_fmts,<sp/>1,<sp/>&amp;v_blocks,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>v_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>);</highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>have_scales<sp/>=</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>scales_fmts,<sp/>1,<sp/>&amp;v_scales,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>);</highlight></codeline>
<codeline lineno="1301"><highlight class="normal"></highlight></codeline>
<codeline lineno="1302"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!have_blocks<sp/>&amp;&amp;<sp/>!have_scales)<sp/>{</highlight></codeline>
<codeline lineno="1303"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_blocks<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1304"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_scales<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_scale_bytes<sp/>=<sp/>0u;</highlight></codeline>
<codeline lineno="1306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1307"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1308"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!have_blocks<sp/>||<sp/>!have_scales)<sp/>{</highlight></codeline>
<codeline lineno="1309"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q4<sp/>%s<sp/>missing<sp/>blocks/scales<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1312"><highlight class="normal"></highlight></codeline>
<codeline lineno="1313"><highlight class="normal"><sp/><sp/>uint8_t<sp/>scale_bytes<sp/>=<sp/>0u;</highlight></codeline>
<codeline lineno="1314"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" kindref="member">TENSOR_DTYPE_BF16</ref>)<sp/>scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" kindref="member">TENSOR_DTYPE_U8</ref>)<sp/>scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"></highlight></codeline>
<codeline lineno="1317"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(scale_bytes<sp/>==<sp/>0u)<sp/>{</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>tmp_blocks<sp/>=<sp/>0,<sp/>tmp_scales_1<sp/>=<sp/>0,<sp/>tmp_scales_2<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(rows,<sp/>cols,<sp/>1u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_1)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(rows,<sp/>cols,<sp/>2u,<sp/>&amp;tmp_blocks,<sp/>&amp;tmp_scales_2)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q4<sp/>%s<sp/>bad<sp/>dims<sp/>layer=%u<sp/>rows=%u<sp/>cols=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)rows,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)cols);</highlight></codeline>
<codeline lineno="1323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1324"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_1)<sp/>scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>tmp_scales_2)<sp/>scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q4<sp/>%s<sp/>cannot<sp/>infer<sp/>scale_bytes<sp/>layer=%u<sp/>size_bytes=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref>);</highlight></codeline>
<codeline lineno="1330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1331"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1332"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1333"><highlight class="normal"></highlight></codeline>
<codeline lineno="1334"><highlight class="normal"><sp/><sp/>uint64_t<sp/>want_blocks<sp/>=<sp/>0,<sp/>want_scales<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1335"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(rows,<sp/>cols,<sp/>scale_bytes,<sp/>&amp;want_blocks,<sp/>&amp;want_scales)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1336"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q4<sp/>%s<sp/>bad<sp/>dims<sp/>layer=%u<sp/>rows=%u<sp/>cols=%u<sp/>scale_bytes=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)rows,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)cols,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)scale_bytes);</highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1340"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_blocks)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="1341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_scales)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1342"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q4<sp/>%s<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want_blocks=%llu<sp/>want_scales=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tag,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,</highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)want_blocks,</highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)want_scales);</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-6;</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1348"><highlight class="normal"></highlight></codeline>
<codeline lineno="1349"><highlight class="normal"><sp/><sp/>*out_blocks<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_blocks.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1350"><highlight class="normal"><sp/><sp/>*out_scales<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_scales.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1351"><highlight class="normal"><sp/><sp/>*out_scale_bytes<sp/>=<sp/>scale_bytes;</highlight></codeline>
<codeline lineno="1352"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="1353"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1354"><highlight class="normal"></highlight></codeline>
<codeline lineno="1355"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1356"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Forward<sp/>pass<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1357"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1358"><highlight class="normal"></highlight></codeline>
<codeline lineno="1359" refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" kindref="member">ie_forward_one_token</ref>(</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl,<sp/><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*kv_layers,</highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>token_id,<sp/>uint32_t<sp/>pos,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*out_logits)<sp/>{</highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bf16_trace_done<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl<sp/>||<sp/>!kv_layers<sp/>||<sp/>!out_logits)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1363"><highlight class="normal"></highlight></codeline>
<codeline lineno="1364"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__hparams" kindref="compound">ie_gptoss_hparams_t</ref><sp/>*hp<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>;</highlight></codeline>
<codeline lineno="1365"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!hp)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1366"><highlight class="normal"></highlight></codeline>
<codeline lineno="1367"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_model<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" kindref="member">d_model</ref>;</highlight></codeline>
<codeline lineno="1368"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_head<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" kindref="member">d_head</ref>;</highlight></codeline>
<codeline lineno="1369"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_heads<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" kindref="member">n_heads</ref>;</highlight></codeline>
<codeline lineno="1370"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_kv_heads<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" kindref="member">n_kv_heads</ref>;</highlight></codeline>
<codeline lineno="1371"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>vocab<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="1372"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_layers<sp/>=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" kindref="member">n_layers</ref>;</highlight></codeline>
<codeline lineno="1373"><highlight class="normal"></highlight></codeline>
<codeline lineno="1374"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl-&gt;<ref refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" kindref="member">w_embed_bf16</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" kindref="member">w_norm_bf16</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" kindref="member">w_lm_bf16</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1375"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(token_id<sp/>&gt;=<sp/>vocab)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1376"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pos<sp/>&gt;=<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((d_head<sp/>&amp;<sp/>1u)<sp/>!=<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-6;</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"></highlight></codeline>
<codeline lineno="1379"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1380"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*emb<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" kindref="member">w_embed_bf16</ref><sp/>+<sp/>(size_t)token_id<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model;</highlight></codeline>
<codeline lineno="1381"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_model;<sp/>++i)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>[i]<sp/>=<sp/><ref refid="infer__gptoss_8c_1aa4a664e8ce1c9eb29d9ef97174588567" kindref="member">ie_bf16_to_f32</ref>(emb[i]);</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1383"><highlight class="normal"></highlight></codeline>
<codeline lineno="1384"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv_sqrt_d<sp/>=<sp/>1.0f<sp/>/<sp/>sqrtf((</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)d_head);</highlight></codeline>
<codeline lineno="1385"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>q_dim<sp/>=<sp/>(size_t)n_heads<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head;</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>kv_dim<sp/>=<sp/>(size_t)n_kv_heads<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head;</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ff<sp/>=<sp/>(size_t)hp-&gt;<ref refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" kindref="member">d_ff</ref>;</highlight></codeline>
<codeline lineno="1388"><highlight class="normal"></highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>rope_theta_eff<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" kindref="member">rope_theta</ref><sp/>*<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" kindref="member">rope_scale</ref>;</highlight></codeline>
<codeline lineno="1390"><highlight class="normal"></highlight></codeline>
<codeline lineno="1391"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>l<sp/>=<sp/>0;<sp/>l<sp/>&lt;<sp/>n_layers;<sp/>++l)<sp/>{</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*W<sp/>=<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>[l];</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*kv<sp/>=<sp/>&amp;kv_layers[l];</highlight></codeline>
<codeline lineno="1394"><highlight class="normal"></highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(kv-&gt;<ref refid="structie__kv__cache_1aee83829eb2a9d19077145b88c0bb43bb" kindref="member">storage</ref><sp/>!=<sp/><ref refid="ie__kv__cache_8h_1a2bb962f9a31709cc159ccb5f8c8f2fe7a4fa6c4868332a5127755fdee56404f54" kindref="member">IE_KV_STORAGE_F32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>storage<sp/>mismatch:<sp/>layer=%u<sp/>storage=%d<sp/>(want<sp/>%d)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)kv-&gt;<ref refid="structie__kv__cache_1aee83829eb2a9d19077145b88c0bb43bb" kindref="member">storage</ref>,<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)<ref refid="ie__kv__cache_8h_1a2bb962f9a31709cc159ccb5f8c8f2fe7a4fa6c4868332a5127755fdee56404f54" kindref="member">IE_KV_STORAGE_F32</ref>);</highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-7;</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint32_t)kv-&gt;<ref refid="structie__kv__cache_1a2e7da98c2fd80c84f468848ad63bb6cb" kindref="member">heads</ref><sp/>!=<sp/>n_kv_heads)<sp/>{</highlight></codeline>
<codeline lineno="1401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>heads<sp/>mismatch:<sp/>layer=%u<sp/>heads=%zu<sp/>want=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv-&gt;<ref refid="structie__kv__cache_1a2e7da98c2fd80c84f468848ad63bb6cb" kindref="member">heads</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_kv_heads);</highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-8;</highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint32_t)kv-&gt;<ref refid="structie__kv__cache_1a651ffe5e067714a367503a5127bdd61a" kindref="member">head_dim</ref><sp/>!=<sp/>d_head)<sp/>{</highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>head_dim<sp/>mismatch:<sp/>layer=%u<sp/>head_dim=%zu<sp/>want=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv-&gt;<ref refid="structie__kv__cache_1a651ffe5e067714a367503a5127bdd61a" kindref="member">head_dim</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_head);</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-9;</highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"></highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Allow<sp/>KV<sp/>max_seq<sp/>to<sp/>be<sp/>smaller<sp/>than<sp/>hp-&gt;max_seq:<sp/>normal<sp/>short-context<sp/>inference.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint32_t)kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref><sp/>==<sp/>0u)<sp/>{</highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>max_seq<sp/>invalid:<sp/>layer=%u<sp/>max_seq=%zu&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1415"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint32_t)kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref><sp/>&gt;<sp/>hp-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>max_seq<sp/>exceeds<sp/>model<sp/>max_seq:<sp/>layer=%u<sp/>max_seq=%zu<sp/>hp_seq=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)hp-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="1419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1420"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pos<sp/>&gt;=<sp/>(uint32_t)kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>max_seq<sp/>too<sp/>small<sp/>for<sp/>pos:<sp/>layer=%u<sp/>pos=%u<sp/>max_seq=%zu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos,<sp/>kv-&gt;<ref refid="structie__kv__cache_1a4cbe1fc1959314c75e9d61f9c24d5671" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="1424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"></highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" kindref="member">ln1_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" kindref="member">ie_rmsnorm_cpu_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" kindref="member">ln1_w_f32</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;rmsnorm1<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" kindref="member">ie_rmsnorm_cpu_f32_bf16w</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" kindref="member">ln1_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;rmsnorm1<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/></highlight><highlight class="stringliteral">&quot;rmsnorm1&quot;</highlight><highlight class="normal">,<sp/>l,<sp/>pos)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-90;</highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1440"><highlight class="normal"></highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>trace_on<sp/>=<sp/><ref refid="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" kindref="member">ie_trace_bf16_enabled_</ref>()<sp/>&amp;&amp;<sp/>!bf16_trace_done;</highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on<sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" kindref="member">q_q4_blocks</ref><sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>layer=%u<sp/>op=q<sp/>rows=%zu<sp/>cols=%zu\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>q_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" kindref="member">q_q4_blocks</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" kindref="member">q_q4_scales</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" kindref="member">q_q4_blocks</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" kindref="member">q_q4_scales</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" kindref="member">q_q4_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>q_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!W-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>)<sp/><ref refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" kindref="member">ie_add_bias_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>,<sp/>q_dim);</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>q_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>,<sp/>1);</highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" kindref="member">q_w</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>q_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1456"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on<sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" kindref="member">k_q4_blocks</ref><sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>layer=%u<sp/>op=k<sp/>rows=%zu<sp/>cols=%zu\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" kindref="member">k_q4_blocks</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" kindref="member">k_q4_scales</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" kindref="member">k_q4_blocks</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" kindref="member">k_q4_scales</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" kindref="member">k_q4_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!W-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>)<sp/><ref refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" kindref="member">ie_add_bias_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>,<sp/>kv_dim);</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>,<sp/>1);</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" kindref="member">k_w</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on<sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" kindref="member">v_q4_blocks</ref><sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>layer=%u<sp/>op=v<sp/>rows=%zu<sp/>cols=%zu\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" kindref="member">v_q4_blocks</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" kindref="member">v_q4_scales</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" kindref="member">v_q4_blocks</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" kindref="member">v_q4_scales</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" kindref="member">v_q4_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-14;</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!W-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>)<sp/><ref refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" kindref="member">ie_add_bias_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>,<sp/>kv_dim);</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>,<sp/>1);</highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" kindref="member">v_w</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>kv_dim,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-14;</highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1487"><highlight class="normal"></highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" kindref="member">ie_rope_apply_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>NULL,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_heads,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head,<sp/>pos,<sp/>rope_theta_eff)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-15;</highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1af89b1384a30307fe173f81fa75cac73f" kindref="member">ie_rope_apply_f32</ref>(NULL,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_kv_heads,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head,<sp/>pos,<sp/>rope_theta_eff)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-16;</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"></highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kv__cache_8h_1ae4ab616a9e9d6e030e7ba634404f114e" kindref="member">ie_kv_store_token_f32</ref>(kv,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)pos,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;kv<sp/>store<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-17;</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"></highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>KV<sp/>reuse<sp/>instrumentation:<sp/>per<sp/>layer,<sp/>this<sp/>token<sp/>attends<sp/>over<sp/>(pos)<sp/>cached<sp/>tokens.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kv__instrumentation_8h_1a9897c8f0778487dbf6988f0253a195a3" kindref="member">ie_kv_add_hits</ref>((uint64_t)pos);</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kv__instrumentation_8h_1a12fb475a0e4a167cdc2581321c1ff0a0" kindref="member">ie_kv_add_misses</ref>(1u);</highlight></codeline>
<codeline lineno="1500"><highlight class="normal"></highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Kbase<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)kv-&gt;<ref refid="structie__kv__cache_1a9e6a8eae8f60ca5906d3009c7bda555a" kindref="member">K</ref>;</highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*Vbase<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)kv-&gt;<ref refid="structie__kv__cache_1aab8e8a472aacd8cfce26a16b79f1995c" kindref="member">V</ref>;</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"></highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_kv_heads<sp/>==<sp/>n_heads)<sp/>{</highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1af9b0b6203292cfb594b862b7faf8dccd" kindref="member">ie_attn_cpu_causal_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>Kbase,<sp/>Vbase,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)(pos<sp/>+<sp/>1u),</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_heads,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head,<sp/>inv_sqrt_d,</highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;attn<sp/>kernel<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-18;</highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a11d8d796ad2d2838d96e04e2efe07057" kindref="member">ie_attn_causal_gqa_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>,<sp/>Kbase,<sp/>Vbase,<sp/>pos<sp/>+<sp/>1u,<sp/>n_heads,<sp/>n_kv_heads,<sp/>d_head,</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inv_sqrt_d,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref>);</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"></highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on<sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" kindref="member">o_q4_blocks</ref><sp/>&amp;&amp;<sp/>!W-&gt;<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>layer=%u<sp/>op=o<sp/>rows=%zu<sp/>cols=%zu\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>q_dim);</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" kindref="member">o_q4_blocks</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" kindref="member">o_q4_scales</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" kindref="member">o_q4_blocks</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" kindref="member">o_q4_scales</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" kindref="member">o_q4_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>q_dim,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-19;</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!W-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref><sp/>&amp;&amp;<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>)<sp/><ref refid="infer__gptoss_8c_1a905d555203ed5a79fb4c750bd30b102b" kindref="member">ie_add_bias_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>q_dim,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>,<sp/>1);</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(W-&gt;<ref refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" kindref="member">o_w</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>q_dim,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-19;</highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_model;<sp/>++i)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>[i]<sp/>+=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>[i];</highlight></codeline>
<codeline lineno="1533"><highlight class="normal"></highlight></codeline>
<codeline lineno="1534"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(W-&gt;<ref refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" kindref="member">ln2_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" kindref="member">ie_rmsnorm_cpu_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" kindref="member">ln2_w_f32</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;rmsnorm2<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-20;</highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" kindref="member">ie_rmsnorm_cpu_f32_bf16w</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>W-&gt;<ref refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" kindref="member">ln2_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;rmsnorm2<sp/>failed:<sp/>layer=%u<sp/>pos=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos);</highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-20;</highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"></highlight></codeline>
<codeline lineno="1544"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__moe__w" kindref="compound">ie_moe_w_t</ref><sp/>*M<sp/>=<sp/>&amp;W-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>;</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_exp<sp/>=<sp/>M-&gt;<ref refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" kindref="member">n_experts</ref>;</highlight></codeline>
<codeline lineno="1547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_exp<sp/>==<sp/>0u<sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-21;</highlight></codeline>
<codeline lineno="1548"><highlight class="normal"></highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on)<sp/>{</highlight></codeline>
<codeline lineno="1550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>layer=%u<sp/>op=router<sp/>rows=%u<sp/>cols=%u\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_exp,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(M-&gt;<ref refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" kindref="member">router_w_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(M-&gt;<ref refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" kindref="member">router_w_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>,</highlight></codeline>
<codeline lineno="1555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_exp,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>M-&gt;<ref refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" kindref="member">router_b_f32</ref>,<sp/>1);</highlight></codeline>
<codeline lineno="1556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(M-&gt;<ref refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" kindref="member">router_w</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>,</highlight></codeline>
<codeline lineno="1557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_exp,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>M-&gt;<ref refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" kindref="member">router_b</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;router<sp/>gemv<sp/>failed:<sp/>layer=%u<sp/>pos=%u<sp/>n_experts=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_exp);</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-22;</highlight></codeline>
<codeline lineno="1561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_exp,<sp/></highlight><highlight class="stringliteral">&quot;router_logits&quot;</highlight><highlight class="normal">,<sp/>l,<sp/>pos)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-90;</highlight></codeline>
<codeline lineno="1565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"></highlight></codeline>
<codeline lineno="1567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>topk<sp/>=<sp/><ref refid="infer__gptoss_8c_1a051dcc7bf1e50054f8b124fc1e740288" kindref="member">ie_u32_min</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" kindref="member">moe_topk</ref>,<sp/>n_exp);</highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(topk<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-23;</highlight></codeline>
<codeline lineno="1569"><highlight class="normal"></highlight></codeline>
<codeline lineno="1570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>idx[<ref refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" kindref="member">IE_GPTOSS_MOE_TOPK_DEFAULT</ref>]<sp/>=<sp/>{0,<sp/>0,<sp/>0,<sp/>0};</highlight></codeline>
<codeline lineno="1571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>val[<ref refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" kindref="member">IE_GPTOSS_MOE_TOPK_DEFAULT</ref>]<sp/>=<sp/>{-INFINITY,<sp/>-INFINITY,<sp/>-INFINITY,<sp/>-INFINITY};</highlight></codeline>
<codeline lineno="1572"><highlight class="normal"></highlight></codeline>
<codeline lineno="1573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>e<sp/>=<sp/>0;<sp/>e<sp/>&lt;<sp/>n_exp;<sp/>++e)<sp/>{</highlight></codeline>
<codeline lineno="1574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>[e];</highlight></codeline>
<codeline lineno="1575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>k<sp/>=<sp/>0;<sp/>k<sp/>&lt;<sp/>topk;<sp/>++k)<sp/>{</highlight></codeline>
<codeline lineno="1576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>val[k])<sp/>{</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>j<sp/>=<sp/>topk<sp/>-<sp/>1u;<sp/>j<sp/>&gt;<sp/>k;<sp/>--j)<sp/>{</highlight></codeline>
<codeline lineno="1578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>val[j]<sp/>=<sp/>val[j<sp/>-<sp/>1u];</highlight></codeline>
<codeline lineno="1579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx[j]<sp/>=<sp/>idx[j<sp/>-<sp/>1u];</highlight></codeline>
<codeline lineno="1580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>val[k]<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="1582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx[k]<sp/>=<sp/>e;</highlight></codeline>
<codeline lineno="1583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1587"><highlight class="normal"></highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a6d4741dbac2daecf63f28b89811d5567" kindref="member">ie_softmax_inplace_f32</ref>(val,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)topk);</highlight></codeline>
<codeline lineno="1589"><highlight class="normal"></highlight></codeline>
<codeline lineno="1590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_model;<sp/>++i)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>[i]<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="1591"><highlight class="normal"></highlight></codeline>
<codeline lineno="1592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>sel<sp/>=<sp/>0;<sp/>sel<sp/>&lt;<sp/>topk;<sp/>++sel)<sp/>{</highlight></codeline>
<codeline lineno="1593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>ex<sp/>=<sp/>idx[sel];</highlight></codeline>
<codeline lineno="1594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>p<sp/>=<sp/>val[sel];</highlight></codeline>
<codeline lineno="1595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(p<sp/>&gt;<sp/>0.0f))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1596"><highlight class="normal"></highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*gu_b<sp/>=<sp/>M-&gt;<ref refid="structie__moe__w_1ac342edbd637e95d3cb1455eb3ab6e4fa" kindref="member">gate_up_blocks</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1aab0006d81c32639e68b803a63d309ad8" kindref="member">gate_up_blocks_stride</ref>;</highlight></codeline>
<codeline lineno="1598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*gu_s<sp/>=<sp/>M-&gt;<ref refid="structie__moe__w_1afb788b20012dca1cc60c3d4cde282f0f" kindref="member">gate_up_scales</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1acc80b94ca61c46f14af4957d135061c9" kindref="member">gate_up_scales_stride</ref>;</highlight></codeline>
<codeline lineno="1599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*gu_bias<sp/>=</highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>M-&gt;<ref refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" kindref="member">gate_up_bias</ref><sp/>?<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)M-&gt;<ref refid="structie__moe__w_1a48d44ff6c7dd114d5179badb47a2111c" kindref="member">gate_up_bias</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1aed670044a310aa88922734904561d1ca" kindref="member">gate_up_bias_stride</ref>)</highlight></codeline>
<codeline lineno="1601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="1602"><highlight class="normal"></highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*dn_b<sp/>=<sp/>M-&gt;<ref refid="structie__moe__w_1ac3e7d419474f096e52bbf2cefbc890de" kindref="member">down_blocks</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1a61797babc96301910449ee0283425bf2" kindref="member">down_blocks_stride</ref>;</highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*dn_s<sp/>=<sp/>M-&gt;<ref refid="structie__moe__w_1a158ec2ec3781945bb6634567bf46d750" kindref="member">down_scales</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1aa6f40ef12c7647bcc6d7df24823298d4" kindref="member">down_scales_stride</ref>;</highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*dn_bias<sp/>=</highlight></codeline>
<codeline lineno="1606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>M-&gt;<ref refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" kindref="member">down_bias</ref><sp/>?<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)M-&gt;<ref refid="structie__moe__w_1acb4f701157eb0b895f95c3abaa20dc8e" kindref="member">down_bias</ref><sp/>+<sp/>ex<sp/>*<sp/>M-&gt;<ref refid="structie__moe__w_1afa78277acddfae9c53bd0e04169818ae" kindref="member">down_bias_stride</ref>)<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="1607"><highlight class="normal"></highlight></codeline>
<codeline lineno="1608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(gu_b,<sp/>gu_s,<sp/>M-&gt;<ref refid="structie__moe__w_1aeb7b8ff9547a56f2e1dc43ecc0baa620" kindref="member">gate_up_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>,</highlight></codeline>
<codeline lineno="1610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>2u<sp/>*<sp/>d_ff,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>gu_bias)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe<sp/>gate_up<sp/>gemv<sp/>failed:<sp/>layer=%u<sp/>pos=%u<sp/>ex=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)ex);</highlight></codeline>
<codeline lineno="1613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-24;</highlight></codeline>
<codeline lineno="1614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>,<sp/>2u<sp/>*<sp/>d_ff,<sp/></highlight><highlight class="stringliteral">&quot;mlp_up&quot;</highlight><highlight class="normal">,<sp/>l,<sp/>pos)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-90;</highlight></codeline>
<codeline lineno="1618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1619"><highlight class="normal"></highlight></codeline>
<codeline lineno="1620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_ff;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>g<sp/>=<sp/><ref refid="infer__gptoss_8c_1a9acc6f2706c714def21ba7cb496ca00c" kindref="member">ie_silu_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>[i]);</highlight></codeline>
<codeline lineno="1622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>u<sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>[d_ff<sp/>+<sp/>i];</highlight></codeline>
<codeline lineno="1623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref>[i]<sp/>=<sp/>g<sp/>*<sp/>u;</highlight></codeline>
<codeline lineno="1624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref>,<sp/>d_ff,<sp/></highlight><highlight class="stringliteral">&quot;mlp_gate&quot;</highlight><highlight class="normal">,<sp/>l,<sp/>pos)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-90;</highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"></highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(dn_b,<sp/>dn_s,<sp/>M-&gt;<ref refid="structie__moe__w_1aa5db0bd110bf0fa91435f3ee92f8f96c" kindref="member">down_scale_bytes</ref>,</highlight></codeline>
<codeline lineno="1631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,</highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>d_ff,<sp/>dn_bias)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;moe<sp/>down<sp/>gemv<sp/>failed:<sp/>layer=%u<sp/>pos=%u<sp/>ex=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)pos,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)ex);</highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-25;</highlight></codeline>
<codeline lineno="1636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3306d923bdde532a40877b41dd2adf4b" kindref="member">ie_debug_nan_enabled_</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a92f31d747ea57d982a6e44e4a2a4ac87" kindref="member">ie_check_finite_f32_</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/></highlight><highlight class="stringliteral">&quot;mlp_down&quot;</highlight><highlight class="normal">,<sp/>l,<sp/>pos)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-90;</highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"></highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_model;<sp/>++i)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>[i]<sp/>+=<sp/>p<sp/>*<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>[i];</highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1645"><highlight class="normal"></highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>d_model;<sp/>++i)<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>[i]<sp/>+=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>[i];</highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1648"><highlight class="normal"></highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" kindref="member">w_norm_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1650"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad94dd48c2c8a005182431732e18431d3" kindref="member">ie_rmsnorm_cpu_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" kindref="member">w_norm_f32</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-26;</highlight></codeline>
<codeline lineno="1652"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ab311c13b481bdf4c6d71b59d8f630a49" kindref="member">ie_rmsnorm_cpu_f32_bf16w</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" kindref="member">w_norm_bf16</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-26;</highlight></codeline>
<codeline lineno="1654"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1655"><highlight class="normal"></highlight></codeline>
<codeline lineno="1656"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1657"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>trace_on<sp/>=<sp/><ref refid="infer__gptoss_8c_1a4551a668d13fc1103dd1859236a5942f" kindref="member">ie_trace_bf16_enabled_</ref>()<sp/>&amp;&amp;<sp/>!bf16_trace_done;</highlight></codeline>
<codeline lineno="1658"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(trace_on<sp/>&amp;&amp;<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref><sp/>&amp;&amp;<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[TRACE]<sp/>bf16<sp/>gemv:<sp/>op=lm_head<sp/>rows=%u<sp/>cols=%u\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>bf16_trace_done<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="1662"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1663"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1664"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref><sp/>&amp;&amp;<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" kindref="member">w_lm_q4_scales</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1665"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1af0b48eb5cf241e9c033953abff9974ad" kindref="member">ie_gemv_q4_0_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" kindref="member">w_lm_q4_scales</ref>,</highlight></codeline>
<codeline lineno="1666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" kindref="member">w_lm_q4_scale_bytes</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>out_logits,</highlight></codeline>
<codeline lineno="1667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>NULL)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="1669"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__kernels_8h_1a4e112b3396ed21919f404631c1d4d7fb" kindref="member">ie_gemv_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>out_logits,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>NULL,<sp/>0);</highlight></codeline>
<codeline lineno="1671"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kernels_8h_1a9af71dd562560ec249ffd6cf70013282" kindref="member">ie_gemv_bf16_f32</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" kindref="member">w_lm_bf16</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>,<sp/>out_logits,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>NULL)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="1674"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1675"><highlight class="normal"></highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(getenv(</highlight><highlight class="stringliteral">&quot;IE_DEBUG_TOPK&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>K<sp/>=<sp/><ref refid="infer__gptoss_8c_1a2695e784cb752a5747eb95892e2ef6af" kindref="member">ie_env_u32_clamped</ref>(</highlight><highlight class="stringliteral">&quot;IE_DEBUG_TOPK&quot;</highlight><highlight class="normal">,<sp/>10u,<sp/>1u,<sp/>100u);</highlight></codeline>
<codeline lineno="1678"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>K;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>maxv<sp/>=<sp/>-INFINITY;</highlight></codeline>
<codeline lineno="1680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxi<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="1681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>vocab;<sp/>++j)<sp/>{</highlight></codeline>
<codeline lineno="1682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out_logits[j]<sp/>&gt;<sp/>maxv)<sp/>{</highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>maxv<sp/>=<sp/>out_logits[j];</highlight></codeline>
<codeline lineno="1684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>maxi<sp/>=<sp/>(int)j;</highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(maxi<sp/>&lt;<sp/>0)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[DBG]<sp/>top%u<sp/>id=%d<sp/>val=%g\n&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)i,<sp/>maxi,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)maxv);</highlight></codeline>
<codeline lineno="1689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>out_logits[(uint32_t)maxi]<sp/>=<sp/>-INFINITY;</highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"></highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1694"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1695"><highlight class="normal"></highlight></codeline>
<codeline lineno="1696"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1697"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Public<sp/>API<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1698"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1699"><highlight class="normal"></highlight></codeline>
<codeline lineno="1700" refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a1eb484ef476fc9b7a44d3819959fb307" kindref="member">ie_gptoss_infer_create</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__device" kindref="compound">ie_device_t</ref><sp/>*dev_const,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__weights__s" kindref="compound">ie_weights_t</ref><sp/>*w,</highlight></codeline>
<codeline lineno="1701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__gptoss__hparams" kindref="compound">ie_gptoss_hparams_t</ref><sp/>*hp,<sp/><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>**out_ctx)<sp/>{</highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out_ctx)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1703"><highlight class="normal"><sp/><sp/>*out_ctx<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!w<sp/>||<sp/>!hp)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1705"><highlight class="normal"></highlight></codeline>
<codeline lineno="1706"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(w-&gt;<ref refid="structie__weights__s_1a6d4bef9e704edd817ee473eb2685cdd4" kindref="member">json_path</ref>[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1707"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>w-&gt;json_path&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1708"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1709"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1710"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(w-&gt;<ref refid="structie__weights__s_1ab6a61099d0af4a47854d02dc4fef5b8f" kindref="member">weights_path</ref>[0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1711"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>w-&gt;weights_path&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1712"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1714"><highlight class="normal"></highlight></codeline>
<codeline lineno="1715"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>json_path=%s&quot;</highlight><highlight class="normal">,<sp/>w-&gt;<ref refid="structie__weights__s_1a6d4bef9e704edd817ee473eb2685cdd4" kindref="member">json_path</ref>);</highlight></codeline>
<codeline lineno="1716"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>weights_path=%s&quot;</highlight><highlight class="normal">,<sp/>w-&gt;<ref refid="structie__weights__s_1ab6a61099d0af4a47854d02dc4fef5b8f" kindref="member">weights_path</ref>);</highlight></codeline>
<codeline lineno="1717"><highlight class="normal"></highlight></codeline>
<codeline lineno="1718"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)calloc(1,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*impl));</highlight></codeline>
<codeline lineno="1719"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="1720"><highlight class="normal"></highlight></codeline>
<codeline lineno="1721"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a8ca6a5d2971b7df6973a6fa49a19bb8d" kindref="member">dev</ref><sp/>=<sp/>(<ref refid="structie__device" kindref="compound">ie_device_t</ref><sp/>*)dev_const;</highlight></codeline>
<codeline lineno="1722"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a953824f4ef6444bb2d702afaa61a18c1" kindref="member">weights</ref><sp/>=<sp/>w;</highlight></codeline>
<codeline lineno="1723"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref><sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>;</highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1725"><highlight class="normal"></highlight></codeline>
<codeline lineno="1726"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="1727"><highlight class="comment"><sp/><sp/><sp/>*<sp/>NOTE:<sp/>ie_gptoss_hparams_t<sp/>does<sp/>not<sp/>carry<sp/>RoPE/RMS<sp/>fields<sp/>in<sp/>this<sp/>codebase.</highlight></codeline>
<codeline lineno="1728"><highlight class="comment"><sp/><sp/><sp/>*<sp/>Keep<sp/>runtime<sp/>parameters<sp/>internal<sp/>and<sp/>configurable<sp/>via<sp/>environment<sp/>variables.</highlight></codeline>
<codeline lineno="1729"><highlight class="comment"><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1730"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" kindref="member">ie_env_f32_clamped</ref>(</highlight><highlight class="stringliteral">&quot;IE_RMS_EPS&quot;</highlight><highlight class="normal">,<sp/><ref refid="infer__gptoss_8c_1aa067dccbbe25570a05cbf08d3cfefe71" kindref="member">IE_GPTOSS_RMS_EPS_DEFAULT</ref>,<sp/>1.0e-8f,<sp/>1.0e-2f);</highlight></codeline>
<codeline lineno="1731"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" kindref="member">rope_theta</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" kindref="member">ie_env_f32_clamped</ref>(</highlight><highlight class="stringliteral">&quot;IE_ROPE_THETA&quot;</highlight><highlight class="normal">,<sp/><ref refid="infer__gptoss_8c_1a8c7977554f9c1d9b6cafdf5ca15438c6" kindref="member">IE_GPTOSS_ROPE_THETA_DEFAULT</ref>,<sp/>1.0f,<sp/>1.0e8f);</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" kindref="member">rope_scale</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a1c0f75a66e8ff81db43f3cbbd176d335" kindref="member">ie_env_f32_clamped</ref>(</highlight><highlight class="stringliteral">&quot;IE_ROPE_SCALE&quot;</highlight><highlight class="normal">,<sp/>1.0f,<sp/>0.125f,<sp/>128.0f);</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"></highlight></codeline>
<codeline lineno="1734"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" kindref="member">use_f32_attn</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" kindref="member">ie_env_flag</ref>(</highlight><highlight class="stringliteral">&quot;IE_F32_ATTN&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1735"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" kindref="member">use_f32_router</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" kindref="member">ie_env_flag</ref>(</highlight><highlight class="stringliteral">&quot;IE_F32_ROUTER&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1736"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" kindref="member">use_f32_lm_head</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" kindref="member">ie_env_flag</ref>(</highlight><highlight class="stringliteral">&quot;IE_F32_LM_HEAD&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1737"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a87c4545ac0ad2b6ad2fd70a090b63146" kindref="member">ie_env_flag</ref>(</highlight><highlight class="stringliteral">&quot;IE_F32_RMSNORM&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1738"><highlight class="normal"></highlight></codeline>
<codeline lineno="1739"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>f32_cache<sp/>attn=%d<sp/>router=%d<sp/>lm_head=%d<sp/>rmsnorm=%d&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" kindref="member">use_f32_attn</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" kindref="member">use_f32_router</ref>,</highlight></codeline>
<codeline lineno="1741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" kindref="member">use_f32_lm_head</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref>);</highlight></codeline>
<codeline lineno="1742"><highlight class="normal"></highlight></codeline>
<codeline lineno="1743"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Initialize<sp/>Q4<sp/>LUTs<sp/>up<sp/>front<sp/>to<sp/>avoid<sp/>pthread_once<sp/>in<sp/>hot<sp/>path.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1744"><highlight class="normal"><sp/><sp/><ref refid="ie__kernels_8h_1a43aede47b7769f5c605ba1687b0336ea" kindref="member">ie_q4_log2_u8_q3_init_generic</ref>();</highlight></codeline>
<codeline lineno="1745"><highlight class="normal"><sp/><sp/><ref refid="ie__kernels_8h_1acdd3012fa894dbd82a4156eb09074acd" kindref="member">ie_q4_log2_u8_q3_init_avx2</ref>();</highlight></codeline>
<codeline lineno="1746"><highlight class="normal"></highlight></codeline>
<codeline lineno="1747"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Step<sp/>B:<sp/>match<sp/>model<sp/>routing<sp/>behavior<sp/>(top-4<sp/>experts).<sp/>Do<sp/>not<sp/>allow<sp/>overrides<sp/>here.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1748"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" kindref="member">moe_topk</ref><sp/>=<sp/><ref refid="infer__gptoss_8c_1a370e1f97ca11e6f4e360e7752264b186" kindref="member">IE_GPTOSS_MOE_TOPK_DEFAULT</ref>;</highlight></codeline>
<codeline lineno="1749"><highlight class="normal"></highlight></codeline>
<codeline lineno="1750"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1751"><highlight class="normal"></highlight></codeline>
<codeline lineno="1752"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*model_dir<sp/>=<sp/><ref refid="infer__gptoss_8c_1a37a69a9cc6c14a335fdcf1df79093005" kindref="member">ie_dirname_alloc</ref>(w-&gt;<ref refid="structie__weights__s_1a6d4bef9e704edd817ee473eb2685cdd4" kindref="member">json_path</ref>);</highlight></codeline>
<codeline lineno="1753"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!model_dir)<sp/>{</highlight></codeline>
<codeline lineno="1754"><highlight class="normal"><sp/><sp/><sp/><sp/>free(impl);</highlight></codeline>
<codeline lineno="1755"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="1756"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1757"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>inferred<sp/>model_dir=%s&quot;</highlight><highlight class="normal">,<sp/>model_dir);</highlight></codeline>
<codeline lineno="1758"><highlight class="normal"></highlight></codeline>
<codeline lineno="1759"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>tmap_rel[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.ie.compat.json&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;tensor_map.json&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;dedup_out/tensor_map.json&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;hf/original/tensor_map.json&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1764"><highlight class="normal"><sp/><sp/>};</highlight></codeline>
<codeline lineno="1765"><highlight class="normal"></highlight></codeline>
<codeline lineno="1766"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tmap_path<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1767"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tmap_ok<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="1768"><highlight class="normal"><sp/><sp/>memset(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>));</highlight></codeline>
<codeline lineno="1769"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1770"><highlight class="normal"></highlight></codeline>
<codeline lineno="1771"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>(</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmap_rel)<sp/>/<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmap_rel[0]));<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1772"><highlight class="normal"><sp/><sp/><sp/><sp/>free(tmap_path);</highlight></codeline>
<codeline lineno="1773"><highlight class="normal"><sp/><sp/><sp/><sp/>tmap_path<sp/>=<sp/><ref refid="infer__gptoss_8c_1abaa225eee9cc8e6cf2813fad866a16c1" kindref="member">ie_path_join_alloc</ref>(model_dir,<sp/>tmap_rel[i]);</highlight></codeline>
<codeline lineno="1774"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tmap_path)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1775"><highlight class="normal"></highlight></codeline>
<codeline lineno="1776"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>trying<sp/>tensor_map=%s&quot;</highlight><highlight class="normal">,<sp/>tmap_path);</highlight></codeline>
<codeline lineno="1777"><highlight class="normal"></highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tensor__map_8h_1ac4b913e2710929070b5b073b4b67b24c" kindref="member">tensor_map_load</ref>(tmap_path,<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>tmap_ok<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref><sp/>=<sp/>tmap_path;</highlight></codeline>
<codeline lineno="1781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>tmap_path<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>loaded<sp/>tensor_map=%s<sp/>(count=%u)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>.<ref refid="structtensor__map__s_1a64c31242ffe43f6fc36b465d1ef75462" kindref="member">count</ref>);</highlight></codeline>
<codeline lineno="1784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1785"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1786"><highlight class="normal"></highlight></codeline>
<codeline lineno="1787"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" kindref="member">IE_LOGW</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>load<sp/>tensor_map=%s&quot;</highlight><highlight class="normal">,<sp/>tmap_path);</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"></highlight></codeline>
<codeline lineno="1789"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="tensor__map_8h_1a42d154b3f93b07c41b514e468a61c803" kindref="member">tensor_map_free</ref>(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>);</highlight></codeline>
<codeline lineno="1790"><highlight class="normal"><sp/><sp/><sp/><sp/>memset(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>));</highlight></codeline>
<codeline lineno="1791"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1792"><highlight class="normal"></highlight></codeline>
<codeline lineno="1793"><highlight class="normal"><sp/><sp/>free(tmap_path);</highlight></codeline>
<codeline lineno="1794"><highlight class="normal"></highlight></codeline>
<codeline lineno="1795"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tmap_ok<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1796"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>load<sp/>tensor_map.json<sp/>(model_dir=%s)&quot;</highlight><highlight class="normal">,<sp/>model_dir);</highlight></codeline>
<codeline lineno="1797"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>tried:<sp/>%s/tensor_map.json&quot;</highlight><highlight class="normal">,<sp/>model_dir);</highlight></codeline>
<codeline lineno="1798"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>tried:<sp/>%s/dedup_out/tensor_map.json&quot;</highlight><highlight class="normal">,<sp/>model_dir);</highlight></codeline>
<codeline lineno="1799"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>tried:<sp/>%s/hf/original/tensor_map.json&quot;</highlight><highlight class="normal">,<sp/>model_dir);</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"><sp/><sp/><sp/><sp/>free(model_dir);</highlight></codeline>
<codeline lineno="1801"><highlight class="normal"><sp/><sp/><sp/><sp/>free(impl);</highlight></codeline>
<codeline lineno="1802"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="1803"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1804"><highlight class="normal"></highlight></codeline>
<codeline lineno="1805"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1806"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_mm<sp/>=<sp/><ref refid="infer__gptoss_8c_1a350055e3279aa56a313cc54048c81b52" kindref="member">ie_mmap_ro</ref>(w-&gt;<ref refid="structie__weights__s_1ab6a61099d0af4a47854d02dc4fef5b8f" kindref="member">weights_path</ref>,<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" kindref="member">bin_base</ref>,<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" kindref="member">bin_size</ref>);</highlight></codeline>
<codeline lineno="1807"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_mm<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>mmap<sp/>weights<sp/>file:<sp/>path=%s<sp/>rc=%d&quot;</highlight><highlight class="normal">,<sp/>w-&gt;<ref refid="structie__weights__s_1ab6a61099d0af4a47854d02dc4fef5b8f" kindref="member">weights_path</ref>,<sp/>rc_mm);</highlight></codeline>
<codeline lineno="1809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tensor__map_8h_1a42d154b3f93b07c41b514e468a61c803" kindref="member">tensor_map_free</ref>(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>);</highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref>);</highlight></codeline>
<codeline lineno="1811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(model_dir);</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(impl);</highlight></codeline>
<codeline lineno="1813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-6;</highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>mapped<sp/>model.ie.bin<sp/>size_bytes=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" kindref="member">bin_size</ref>);</highlight></codeline>
<codeline lineno="1817"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1818"><highlight class="normal"></highlight></codeline>
<codeline lineno="1819"><highlight class="normal"><sp/><sp/>free(model_dir);</highlight></codeline>
<codeline lineno="1820"><highlight class="normal"></highlight></codeline>
<codeline lineno="1821"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_model<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a33df15e8279a7c66842c295db4d955ee" kindref="member">d_model</ref>;</highlight></codeline>
<codeline lineno="1822"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>vocab<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="1823"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_layers<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" kindref="member">n_layers</ref>;</highlight></codeline>
<codeline lineno="1824"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_head<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" kindref="member">d_head</ref>;</highlight></codeline>
<codeline lineno="1825"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_heads<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" kindref="member">n_heads</ref>;</highlight></codeline>
<codeline lineno="1826"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_kv_heads<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" kindref="member">n_kv_heads</ref>;</highlight></codeline>
<codeline lineno="1827"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>d_ff<sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a6586576d1feb432bf7083cc3f35702d5" kindref="member">d_ff</ref>;</highlight></codeline>
<codeline lineno="1828"><highlight class="normal"></highlight></codeline>
<codeline lineno="1829"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>hp<sp/>n_layers=%u<sp/>d_model=%u<sp/>d_head=%u<sp/>n_heads=%u<sp/>n_kv_heads=%u<sp/>d_ff=%u<sp/>vocab=%u<sp/>max_seq=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_layers,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_head,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_heads,</highlight></codeline>
<codeline lineno="1831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_kv_heads,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_ff,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"></highlight></codeline>
<codeline lineno="1833"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>rms_eps=%g<sp/>rope_theta=%g<sp/>rope_scale=%g<sp/>moe_topk=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1aab7ccece9357add888de500276e6a7d8" kindref="member">rms_eps</ref>,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1a14d223f0cbcbc67ead7082ef8438c24e" kindref="member">rope_theta</ref>,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1a38da79c5b3bb483db0acf70695917622" kindref="member">rope_scale</ref>,</highlight></codeline>
<codeline lineno="1835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1a8eed3d5e94697e0786f18ad904d26f37" kindref="member">moe_topk</ref>);</highlight></codeline>
<codeline lineno="1836"><highlight class="normal"></highlight></codeline>
<codeline lineno="1837"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="1839"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>embed_candidates[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.embed_tokens.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;transformer.wte.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;tok_embeddings.weight&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1843"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(impl,<sp/>embed_candidates,<sp/>3,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>embedding<sp/>tensor<sp/>(tried<sp/>common<sp/>candidates)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-7;</highlight></codeline>
<codeline lineno="1848"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)vocab<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>embedding<sp/>size<sp/>check<sp/>failed:<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)vocab<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-8;</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1855"><highlight class="normal"><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aaec6e899b6c58e36c16f7ea1f3eb34c7" kindref="member">w_embed_bf16</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="1856"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1857"><highlight class="normal"></highlight></codeline>
<codeline lineno="1858"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1859"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="1860"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>norm_candidates[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.norm.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;transformer.ln_f.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;norm.weight&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1864"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(impl,<sp/>norm_candidates,<sp/>3,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>final<sp/>norm<sp/>tensor<sp/>(tried<sp/>common<sp/>candidates)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-9;</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>final<sp/>norm<sp/>size<sp/>check<sp/>failed:<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="1873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1875"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1876"><highlight class="normal"><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" kindref="member">w_norm_bf16</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="1877"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2c3b4271566db7daa37b8341f0f69525" kindref="member">w_norm_bf16</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" kindref="member">w_norm_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>final<sp/>norm<sp/>f32&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="1882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1884"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1885"><highlight class="normal"></highlight></codeline>
<codeline lineno="1886"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="1887"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="1888"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>lm_candidates[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;lm_head.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.lm_head.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;transformer.lm_head.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.embed_tokens.weight&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1893"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1894"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(impl,<sp/>lm_candidates,<sp/>4,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>lm_head<sp/>tensor<sp/>(tried<sp/>common<sp/>candidates)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="1898"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1899"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)vocab<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>lm_head<sp/>size<sp/>check<sp/>failed:<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)vocab<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="1902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1904"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1905"><highlight class="normal"><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" kindref="member">w_lm_bf16</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="1906"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_q4_blocks;</highlight></codeline>
<codeline lineno="1908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/>v_q4_scales;</highlight></codeline>
<codeline lineno="1909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q4_blocks_candidates[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;lm_head.weight_blocks&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.lm_head.weight_blocks&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;transformer.lm_head.weight_blocks&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.embed_tokens.weight_blocks&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q4_scales_candidates[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;lm_head.weight_scales&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.lm_head.weight_scales&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;transformer.lm_head.weight_scales&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.embed_tokens.weight_scales&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>has_blocks<sp/>=<sp/>(<ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(impl,<sp/>q4_blocks_candidates,<sp/>4,<sp/>&amp;v_q4_blocks)<sp/>==<sp/>0<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v_q4_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>);</highlight></codeline>
<codeline lineno="1923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>has_scales<sp/>=<sp/>(<ref refid="infer__gptoss_8c_1ad423f271afd9a40793ef26f1713c53b2" kindref="member">ie_w_get_first_view</ref>(impl,<sp/>q4_scales_candidates,<sp/>4,<sp/>&amp;v_q4_scales)<sp/>==<sp/>0<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>);</highlight></codeline>
<codeline lineno="1925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(has_blocks<sp/>&amp;&amp;<sp/>has_scales)<sp/>{</highlight></codeline>
<codeline lineno="1926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>scale_bytes<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a205d1b0175039c386b1f907101942387" kindref="member">TENSOR_DTYPE_BF16</ref>)<sp/>scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1ab88eba5b794240beb885009efb7cd5ec" kindref="member">dtype</ref><sp/>==<sp/><ref refid="tensor__map_8h_1a2a2857711e062d6fafb189e11c772e60a28cbf2aeff36d35b8a7d954fb0ca333b" kindref="member">TENSOR_DTYPE_U8</ref>)<sp/>scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>want_blocks<sp/>=<sp/>0,<sp/>want_scales_1<sp/>=<sp/>0,<sp/>want_scales_2<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(vocab,<sp/>d_model,<sp/>1u,<sp/>&amp;want_blocks,<sp/>&amp;want_scales_1)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="1932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(vocab,<sp/>d_model,<sp/>2u,<sp/>&amp;want_blocks,<sp/>&amp;want_scales_2)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>lm_head<sp/>q4<sp/>expected<sp/>size<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>want_scales_1)<sp/>scale_bytes<sp/>=<sp/>1u;</highlight></codeline>
<codeline lineno="1938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>-&gt;<ref refid="structtensor__desc__s_1a151674f0f1ad60320437f028593d8b26" kindref="member">size_bytes</ref><sp/>==<sp/>want_scales_2)<sp/>scale_bytes<sp/>=<sp/>2u;</highlight></codeline>
<codeline lineno="1939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(scale_bytes<sp/>!=<sp/>0u)<sp/>{</highlight></codeline>
<codeline lineno="1941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>want_blocks<sp/>=<sp/>0,<sp/>want_scales<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1abd40e5153167a03d6db59527d903bbb9" kindref="member">ie_q4_expected_bytes</ref>(vocab,<sp/>d_model,<sp/>scale_bytes,<sp/>&amp;want_blocks,<sp/>&amp;want_scales)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="1943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_q4_blocks.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_blocks)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="1944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(v_q4_scales.<ref refid="structie__tensor__view_1a37d1f0148c97303e4198383a1440c729" kindref="member">desc</ref>,<sp/>want_scales)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>lm_head<sp/>q4<sp/>size<sp/>mismatch&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_q4_blocks.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a9607816adb1b92e74663ea91dabd4cba" kindref="member">w_lm_q4_scales</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)v_q4_scales.<ref refid="structie__tensor__view_1a547c6f0d1fde0ba4b8ec943c3ddf92a6" kindref="member">ptr</ref>;</highlight></codeline>
<codeline lineno="1951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab768d3158975aeafc585c4f66dd8f872" kindref="member">w_lm_q4_scale_bytes</ref><sp/>=<sp/>scale_bytes;</highlight></codeline>
<codeline lineno="1952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>lm_head<sp/>q4<sp/>enabled<sp/>(scale_bytes=%u)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)scale_bytes);</highlight></codeline>
<codeline lineno="1953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1955"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1956"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1ac72573496e92c229f823fa54b5c9a5" kindref="member">use_f32_lm_head</ref><sp/>&amp;&amp;<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1add1b8b08eb8f38ec42c81dba808abe07" kindref="member">w_lm_q4_blocks</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>n64<sp/>=<sp/>(uint64_t)vocab<sp/>*<sp/>(uint64_t)d_model;</highlight></codeline>
<codeline lineno="1958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n64<sp/>&gt;<sp/>(uint64_t)SIZE_MAX)<sp/>{</highlight></codeline>
<codeline lineno="1959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>lm_head<sp/>f32<sp/>size<sp/>overflow<sp/>(vocab=%u<sp/>d_model=%u)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)vocab,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="1961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1acfb8bdccbe39b8242e928ac4ef3ac0f8" kindref="member">w_lm_bf16</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n64,<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>lm_head<sp/>f32&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="1968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1969"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1970"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1971"><highlight class="normal"></highlight></codeline>
<codeline lineno="1972"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref><sp/>=<sp/>(<ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*)calloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_layers,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>));</highlight></codeline>
<codeline lineno="1973"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1974"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>layer<sp/>table<sp/>(n_layers=%u)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_layers);</highlight></codeline>
<codeline lineno="1975"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1976"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="1977"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1978"><highlight class="normal"></highlight></codeline>
<codeline lineno="1979"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>q_dim<sp/>=<sp/>(uint64_t)n_heads<sp/>*<sp/>(uint64_t)d_head;</highlight></codeline>
<codeline lineno="1980"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>kv_dim<sp/>=<sp/>(uint64_t)n_kv_heads<sp/>*<sp/>(uint64_t)d_head;</highlight></codeline>
<codeline lineno="1981"><highlight class="normal"></highlight></codeline>
<codeline lineno="1982"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SIZE_MAX<sp/>&lt;<sp/>UINT64_MAX</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1983"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(q_dim<sp/>&gt;<sp/>(uint64_t)SIZE_MAX<sp/>||<sp/>kv_dim<sp/>&gt;<sp/>(uint64_t)SIZE_MAX)<sp/>{</highlight></codeline>
<codeline lineno="1984"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>attn<sp/>dim<sp/>overflow<sp/>for<sp/>size_t<sp/>(q_dim=%llu<sp/>kv_dim=%llu)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)q_dim,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)kv_dim);</highlight></codeline>
<codeline lineno="1986"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="1987"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="1988"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1989"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1990"><highlight class="normal"></highlight></codeline>
<codeline lineno="1991"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>l<sp/>=<sp/>0;<sp/>l<sp/>&lt;<sp/>n_layers;<sp/>++l)<sp/>{</highlight></codeline>
<codeline lineno="1992"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*LW<sp/>=<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>[l];</highlight></codeline>
<codeline lineno="1993"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structie__tensor__view" kindref="compound">ie_tensor_view_t</ref><sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="1994"><highlight class="normal"></highlight></codeline>
<codeline lineno="1995"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a25d7d75667e464264e5435e8ed9b0ee0" kindref="member">IE_LOGD</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>resolving<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="1996"><highlight class="normal"></highlight></codeline>
<codeline lineno="1997"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ln1_fmts[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.layers.%u.input_layernorm.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.layers.%u.attention_norm.weight&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2000"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="2001"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>ln1_fmts,<sp/>2,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>ln1<sp/>for<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-14;</highlight></codeline>
<codeline lineno="2005"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2006"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>ln1<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-15;</highlight></codeline>
<codeline lineno="2011"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2012"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" kindref="member">ln1_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2013"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1a4b74b8af64e225448e79c57ae58f87b8" kindref="member">ln1_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" kindref="member">ln1_w_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>ln1<sp/>f32<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-15;</highlight></codeline>
<codeline lineno="2018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2019"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2020"><highlight class="normal"></highlight></codeline>
<codeline lineno="2021"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q_w_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.q_proj.weight&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2022"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q_b_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.q_proj.bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2023"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>q_w_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>q_proj.weight<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-16;</highlight></codeline>
<codeline lineno="2027"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2028"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>q_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q_proj.weight<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(q_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-17;</highlight></codeline>
<codeline lineno="2033"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2034"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" kindref="member">q_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2035"><highlight class="normal"></highlight></codeline>
<codeline lineno="2036"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>q_b_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc)<sp/>{</highlight></codeline>
<codeline lineno="2037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>q_dim<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>q_proj.bias<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(q_dim<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-18;</highlight></codeline>
<codeline lineno="2042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2044"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2046"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2047"><highlight class="normal"></highlight></codeline>
<codeline lineno="2048"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>k_w_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.k_proj.weight&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2049"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>k_b_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.k_proj.bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2050"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>k_w_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>k_proj.weight<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-19;</highlight></codeline>
<codeline lineno="2054"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2055"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>kv_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>k_proj.weight<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(kv_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-20;</highlight></codeline>
<codeline lineno="2060"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2061"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" kindref="member">k_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2062"><highlight class="normal"></highlight></codeline>
<codeline lineno="2063"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>k_b_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc)<sp/>{</highlight></codeline>
<codeline lineno="2064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>kv_dim<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>k_proj.bias<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(kv_dim<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-21;</highlight></codeline>
<codeline lineno="2069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2071"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2073"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2074"><highlight class="normal"></highlight></codeline>
<codeline lineno="2075"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>v_w_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.v_proj.weight&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2076"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>v_b_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.v_proj.bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2077"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>v_w_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>v_proj.weight<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-22;</highlight></codeline>
<codeline lineno="2081"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2082"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>kv_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>v_proj.weight<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(kv_dim<sp/>*<sp/>(uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-23;</highlight></codeline>
<codeline lineno="2087"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2088"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" kindref="member">v_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2089"><highlight class="normal"></highlight></codeline>
<codeline lineno="2090"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>v_b_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc)<sp/>{</highlight></codeline>
<codeline lineno="2091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>kv_dim<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>v_proj.bias<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)(kv_dim<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-24;</highlight></codeline>
<codeline lineno="2096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2098"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2100"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2101"><highlight class="normal"></highlight></codeline>
<codeline lineno="2102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>o_w_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.o_proj.weight&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>o_b_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.o_proj.bias&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>o_w_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>o_proj.weight<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-25;</highlight></codeline>
<codeline lineno="2108"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)d_model<sp/>*<sp/>q_dim<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>o_proj.weight<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)d_model<sp/>*<sp/>q_dim<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-26;</highlight></codeline>
<codeline lineno="2114"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2115"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" kindref="member">o_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2116"><highlight class="normal"></highlight></codeline>
<codeline lineno="2117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>o_b_fmts,<sp/>1,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>0)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/><ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc)<sp/>{</highlight></codeline>
<codeline lineno="2118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>o_proj.bias<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2125"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="2127"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2128"><highlight class="normal"></highlight></codeline>
<codeline lineno="2129"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q_q4_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.q_proj.weight_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>q_q4_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.q_proj.weight_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2131"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_q4<sp/>=<sp/><ref refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" kindref="member">ie_resolve_q4_attn_weight</ref>(</highlight></codeline>
<codeline lineno="2133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl,<sp/>l,<sp/>q_q4_blocks_fmts,<sp/>q_q4_scales_fmts,</highlight></codeline>
<codeline lineno="2134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint32_t)q_dim,<sp/>d_model,<sp/></highlight><highlight class="stringliteral">&quot;q&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a9d69d9340e494ccd298bea6b6fe977a6" kindref="member">q_q4_blocks</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1acb572d83191111a560e3e1bdf88df435" kindref="member">q_q4_scales</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a536e806dccb045d51c5bb9a49ce8ace2" kindref="member">q_q4_scale_bytes</ref>);</highlight></codeline>
<codeline lineno="2136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_q4<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>invalid<sp/>q_proj<sp/>q4<sp/>tensors<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2141"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>k_q4_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.k_proj.weight_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>k_q4_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.k_proj.weight_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2144"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_q4<sp/>=<sp/><ref refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" kindref="member">ie_resolve_q4_attn_weight</ref>(</highlight></codeline>
<codeline lineno="2146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl,<sp/>l,<sp/>k_q4_blocks_fmts,<sp/>k_q4_scales_fmts,</highlight></codeline>
<codeline lineno="2147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint32_t)kv_dim,<sp/>d_model,<sp/></highlight><highlight class="stringliteral">&quot;k&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a5e8a04de6a82a5dd52b3e71ff9412bba" kindref="member">k_q4_blocks</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1ad1e0e892bc3b305daa1662743b715a55" kindref="member">k_q4_scales</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a4127438bb8717fe83232ead6e173aa20" kindref="member">k_q4_scale_bytes</ref>);</highlight></codeline>
<codeline lineno="2149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_q4<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>invalid<sp/>k_proj<sp/>q4<sp/>tensors<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2154"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>v_q4_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.v_proj.weight_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>v_q4_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.v_proj.weight_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2157"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_q4<sp/>=<sp/><ref refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" kindref="member">ie_resolve_q4_attn_weight</ref>(</highlight></codeline>
<codeline lineno="2159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl,<sp/>l,<sp/>v_q4_blocks_fmts,<sp/>v_q4_scales_fmts,</highlight></codeline>
<codeline lineno="2160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint32_t)kv_dim,<sp/>d_model,<sp/></highlight><highlight class="stringliteral">&quot;v&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a4c790a1b4f1ba8633971157bb595017d" kindref="member">v_q4_blocks</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1af137c38ff7919e27f49aa7a40df11eff" kindref="member">v_q4_scales</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a415ab5365b48c3bd25e52c3552f3ed8b" kindref="member">v_q4_scale_bytes</ref>);</highlight></codeline>
<codeline lineno="2162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_q4<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>invalid<sp/>v_proj<sp/>q4<sp/>tensors<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2167"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>o_q4_blocks_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.o_proj.weight_blocks&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>o_q4_scales_fmts[]<sp/>=<sp/>{</highlight><highlight class="stringliteral">&quot;model.layers.%u.self_attn.o_proj.weight_scales&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2170"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_q4<sp/>=<sp/><ref refid="infer__gptoss_8c_1a14338f2f3682cd43756b99fbd0f6276f" kindref="member">ie_resolve_q4_attn_weight</ref>(</highlight></codeline>
<codeline lineno="2172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>impl,<sp/>l,<sp/>o_q4_blocks_fmts,<sp/>o_q4_scales_fmts,</highlight></codeline>
<codeline lineno="2173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>d_model,<sp/>(uint32_t)q_dim,<sp/></highlight><highlight class="stringliteral">&quot;o&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1ab328c1b11f1ec0d2e66346767b46d274" kindref="member">o_q4_blocks</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a39000adb93e5849e63564c682e92ce6a" kindref="member">o_q4_scales</ref>,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1aab2cec76003fdb629d93ae15c044cbbc" kindref="member">o_q4_scale_bytes</ref>);</highlight></codeline>
<codeline lineno="2175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_q4<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>invalid<sp/>o_proj<sp/>q4<sp/>tensors<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2180"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2181"><highlight class="normal"></highlight></codeline>
<codeline lineno="2182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1acaaa8a5c2d5e5ef845448e9113c498b4" kindref="member">use_f32_attn</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>q_dim_sz<sp/>=<sp/>(size_t)q_dim;</highlight></codeline>
<codeline lineno="2184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>kv_dim_sz<sp/>=<sp/>(size_t)kv_dim;</highlight></codeline>
<codeline lineno="2185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_model_sz<sp/>=<sp/>(size_t)d_model;</highlight></codeline>
<codeline lineno="2186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>q_w_n64<sp/>=<sp/>q_dim<sp/>*<sp/>(uint64_t)d_model;</highlight></codeline>
<codeline lineno="2187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>kv_w_n64<sp/>=<sp/>kv_dim<sp/>*<sp/>(uint64_t)d_model;</highlight></codeline>
<codeline lineno="2188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>o_w_n64<sp/>=<sp/>(uint64_t)d_model<sp/>*<sp/>q_dim;</highlight></codeline>
<codeline lineno="2189"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>SIZE_MAX<sp/>&lt;<sp/>UINT64_MAX</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(q_w_n64<sp/>&gt;<sp/>(uint64_t)SIZE_MAX<sp/>||<sp/>kv_w_n64<sp/>&gt;<sp/>(uint64_t)SIZE_MAX<sp/>||<sp/>o_w_n64<sp/>&gt;<sp/>(uint64_t)SIZE_MAX)<sp/>{</highlight></codeline>
<codeline lineno="2191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>f32<sp/>attn<sp/>weight<sp/>size<sp/>overflow<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2195"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1a691eb1c7f905d69f4fb8855fdd5e8c4e" kindref="member">q_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)q_w_n64,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1a97a18f26db95148ce169b1f22b568d54" kindref="member">q_b</ref>,<sp/>q_dim_sz,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1a4512f011c6bf41d156df4f52f5a2ac47" kindref="member">k_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)kv_w_n64,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb4367d4d05a2c1a2682e77772210016" kindref="member">k_b</ref>,<sp/>kv_dim_sz,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aca63675ed8ce389c46c718b5e4f57194" kindref="member">v_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)kv_w_n64,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aeb7e1fdc6c25c49a94821421b25712c9" kindref="member">v_b</ref>,<sp/>kv_dim_sz,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1ad3c5de40b3b6778cab48953b2a7e83c4" kindref="member">o_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)o_w_n64,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aa2187deb639e07a22912f64afe397517" kindref="member">o_b</ref>,<sp/>d_model_sz,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>f32<sp/>attn<sp/>weights<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-27;</highlight></codeline>
<codeline lineno="2207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2208"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2209"><highlight class="normal"></highlight></codeline>
<codeline lineno="2210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ln2_fmts[]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="2211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.layers.%u.post_attention_layernorm.weight&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;model.layers.%u.ffn_norm.weight&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2213"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="2214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a26eda7ad261ffb2c83af5263e669d7f4" kindref="member">ie_w_get_layer_fmt_view</ref>(impl,<sp/>l,<sp/>ln2_fmts,<sp/>2,<sp/>&amp;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>,<sp/>1)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>missing<sp/>ln2<sp/>for<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-28;</highlight></codeline>
<codeline lineno="2218"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc<sp/>||<sp/><ref refid="infer__gptoss_8c_1aa440579c3d300ca57afa938bf7e71d16" kindref="member">ie_require_size_eq</ref>(<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.desc,<sp/>(uint64_t)d_model<sp/>*<sp/>2u)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>ln2<sp/>size<sp/>mismatch<sp/>layer=%u<sp/>want=%llu&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal">)((uint64_t)d_model<sp/>*<sp/>2u));</highlight></codeline>
<codeline lineno="2222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-29;</highlight></codeline>
<codeline lineno="2224"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2225"><highlight class="normal"><sp/><sp/><sp/><sp/>LW-&gt;<ref refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" kindref="member">ln2_w</ref><sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint16_t<sp/>*)<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>.ptr;</highlight></codeline>
<codeline lineno="2226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a33291b7d0eb069eea45018cdd25f4d79" kindref="member">use_f32_rmsnorm</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1af185073982bda0e6a266c83d23a39710" kindref="member">ln2_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_model,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" kindref="member">ln2_w_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>ln2<sp/>f32<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-29;</highlight></codeline>
<codeline lineno="2231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2232"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2233"><highlight class="normal"></highlight></codeline>
<codeline lineno="2234"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc_moe<sp/>=<sp/><ref refid="infer__gptoss_8c_1a65b986649509502cd00b8fe4117ced96" kindref="member">ie_resolve_moe_layer</ref>(impl,<sp/>l,<sp/>LW);</highlight></codeline>
<codeline lineno="2236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc_moe<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>moe<sp/>resolve<sp/>failed:<sp/>layer=%u<sp/>rc=%d<sp/>d_model=%u<sp/>d_ff=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>rc_moe,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_ff);</highlight></codeline>
<codeline lineno="2239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-30;</highlight></codeline>
<codeline lineno="2241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2242"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2243"><highlight class="normal"></highlight></codeline>
<codeline lineno="2244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a51c6d6c7e3fc6be9f155f168d490c0f3" kindref="member">use_f32_router</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>n_exp<sp/>=<sp/>(uint64_t)LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" kindref="member">n_experts</ref>;</highlight></codeline>
<codeline lineno="2246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>router_n64<sp/>=<sp/>n_exp<sp/>*<sp/>(uint64_t)d_model;</highlight></codeline>
<codeline lineno="2247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_exp<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>router_n64<sp/>&lt;=<sp/>(uint64_t)SIZE_MAX)<sp/>{</highlight></codeline>
<codeline lineno="2248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ab2ca5c95fd5b9f3485eff47ee24866e6" kindref="member">router_w</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)router_n64,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" kindref="member">router_w_f32</ref>)<sp/>!=<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="2249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a3f5367f4da6656ff7ce2107ed7b9f8d2" kindref="member">ie_alloc_f32_from_bf16</ref>(LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1a8d84460c8a45f16199aba98b41e63c6d" kindref="member">router_b</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_exp,<sp/>&amp;LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" kindref="member">router_b_f32</ref>)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>failed<sp/>to<sp/>allocate<sp/>f32<sp/>router<sp/>weights<sp/>layer=%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l);</highlight></codeline>
<codeline lineno="2251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-30;</highlight></codeline>
<codeline lineno="2253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_exp<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>f32<sp/>router<sp/>size<sp/>overflow<sp/>layer=%u<sp/>n_exp=%u<sp/>d_model=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)l,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ae4e14fb1b78c75306e0b893ad5ba58e7" kindref="member">n_experts</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)d_model);</highlight></codeline>
<codeline lineno="2257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-30;</highlight></codeline>
<codeline lineno="2259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2260"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2261"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2262"><highlight class="normal"></highlight></codeline>
<codeline lineno="2263"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_model_sz<sp/>=<sp/>(size_t)d_model;</highlight></codeline>
<codeline lineno="2264"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>q_dim_sz<sp/>=<sp/>(size_t)n_heads<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head;</highlight></codeline>
<codeline lineno="2265"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>kv_dim_sz<sp/>=<sp/>(size_t)n_kv_heads<sp/>*<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)d_head;</highlight></codeline>
<codeline lineno="2266"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ff_sz<sp/>=<sp/>(size_t)d_ff;</highlight></codeline>
<codeline lineno="2267"><highlight class="normal"></highlight></codeline>
<codeline lineno="2268"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(d_model_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2269"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(d_model_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2270"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(d_model_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2271"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(q_dim_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2272"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(kv_dim_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2273"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(kv_dim_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2274"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(q_dim_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2275"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(d_ff_sz<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2276"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc((2u<sp/>*<sp/>d_ff_sz)<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(float));</highlight></codeline>
<codeline lineno="2277"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref><sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(float));</highlight></codeline>
<codeline lineno="2278"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref><sp/>=<sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>&gt;<sp/>0u)<sp/>?<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">))<sp/>:<sp/>NULL;</highlight></codeline>
<codeline lineno="2279"><highlight class="normal"></highlight></codeline>
<codeline lineno="2280"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref><sp/>||</highlight></codeline>
<codeline lineno="2281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref><sp/>||<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref><sp/>||<sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref><sp/>&gt;<sp/>0u<sp/>&amp;&amp;<sp/>!impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2282"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>activation<sp/>allocation<sp/>failed<sp/>(max_experts=%u)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ae745592b0c8a0ee98531cc5401b67c5f" kindref="member">max_experts</ref>);</highlight></codeline>
<codeline lineno="2283"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>((<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl);</highlight></codeline>
<codeline lineno="2284"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-31;</highlight></codeline>
<codeline lineno="2285"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2286"><highlight class="normal"></highlight></codeline>
<codeline lineno="2287"><highlight class="normal"><sp/><sp/><ref refid="infer__gptoss_8c_1a46f4f4758bcdd1a5bfc129dcba781f97" kindref="member">IE_LOGI</ref>(</highlight><highlight class="stringliteral">&quot;create:<sp/>success&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2288"><highlight class="normal"><sp/><sp/>*out_ctx<sp/>=<sp/>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*)impl;</highlight></codeline>
<codeline lineno="2289"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="2290"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2291"><highlight class="normal"></highlight></codeline>
<codeline lineno="2292" refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx)<sp/>{</highlight></codeline>
<codeline lineno="2293"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2294"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2295"><highlight class="normal"></highlight></codeline>
<codeline lineno="2296"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" kindref="member">bin_base</ref>)<sp/><ref refid="infer__gptoss_8c_1aa47d37a36d18e17af565d12559d481c7" kindref="member">ie_munmap_ro</ref>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7844437d3d4171ddcb32725d307a099e" kindref="member">bin_base</ref>,<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad8643d59520e4c9d75690cd97b027313" kindref="member">bin_size</ref>);</highlight></codeline>
<codeline lineno="2297"><highlight class="normal"><sp/><sp/><ref refid="tensor__map_8h_1a42d154b3f93b07c41b514e468a61c803" kindref="member">tensor_map_free</ref>(&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1ab46077e99cd23b29fa2383ac0f0c47e4" kindref="member">tmap</ref>);</highlight></codeline>
<codeline lineno="2298"><highlight class="normal"></highlight></codeline>
<codeline lineno="2299"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>l<sp/>=<sp/>0;<sp/>l<sp/>&lt;<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" kindref="member">n_layers</ref>;<sp/>++l)<sp/>{</highlight></codeline>
<codeline lineno="2301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__gptoss__layer__w" kindref="compound">ie_gptoss_layer_w_t</ref><sp/>*LW<sp/>=<sp/>&amp;impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>[l];</highlight></codeline>
<codeline lineno="2302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1aa2df1bd36f9b2fcb4838479b0a81fe88" kindref="member">ln1_w_f32</ref>);</highlight></codeline>
<codeline lineno="2303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1a6a2f0cfd0cd1b652bc5c28ae6efb910d" kindref="member">ln2_w_f32</ref>);</highlight></codeline>
<codeline lineno="2304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1a3f7cf0e166cbb60a4a812ae53595d649" kindref="member">q_w_f32</ref>);</highlight></codeline>
<codeline lineno="2305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1a192654f5bec87d72bf49c29d0f3b6aa1" kindref="member">q_b_f32</ref>);</highlight></codeline>
<codeline lineno="2306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1ad532cb8d422984fc31a26652b1919968" kindref="member">k_w_f32</ref>);</highlight></codeline>
<codeline lineno="2307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1aa617625a9c0bd053c03279e3b8679838" kindref="member">k_b_f32</ref>);</highlight></codeline>
<codeline lineno="2308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1ab495efc8aef50fa200ffe263a8f01c72" kindref="member">v_w_f32</ref>);</highlight></codeline>
<codeline lineno="2309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1a56153607f4acdd0d6c5b53281689870a" kindref="member">v_b_f32</ref>);</highlight></codeline>
<codeline lineno="2310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1ad3e13b939c097a8b1a0c160444a06312" kindref="member">o_w_f32</ref>);</highlight></codeline>
<codeline lineno="2311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1a07a99bd07be9d8f6ac2ddb399366ff2b" kindref="member">o_b_f32</ref>);</highlight></codeline>
<codeline lineno="2312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1abb610a83bd464735d94abdc476b44164" kindref="member">router_w_f32</ref>);</highlight></codeline>
<codeline lineno="2313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(LW-&gt;<ref refid="structie__gptoss__layer__w_1aae520882d9b59db90f21ef65716781f1" kindref="member">moe</ref>.<ref refid="structie__moe__w_1ab69b9d763534ede338161510eef7181e" kindref="member">router_b_f32</ref>);</highlight></codeline>
<codeline lineno="2314"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2315"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2316"><highlight class="normal"></highlight></codeline>
<codeline lineno="2317"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa471ec7871e52a92a0aa0eb5bdd775a0" kindref="member">w_norm_f32</ref>);</highlight></codeline>
<codeline lineno="2318"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aa1540536aab16b878145631fb3cc7edf" kindref="member">w_lm_f32</ref>);</highlight></codeline>
<codeline lineno="2319"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1acabccef1c456c6559c518c8ced7d3cfc" kindref="member">tmap_path_used</ref>);</highlight></codeline>
<codeline lineno="2320"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a5e81f560ecc09f33ecf12b4bc424d53b" kindref="member">layers</ref>);</highlight></codeline>
<codeline lineno="2321"><highlight class="normal"></highlight></codeline>
<codeline lineno="2322"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a040ca639c3c18d54bee2646f6b6d6453" kindref="member">x</ref>);</highlight></codeline>
<codeline lineno="2323"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a53defbeb826b3de466872d93b4b0e8cd" kindref="member">x1</ref>);</highlight></codeline>
<codeline lineno="2324"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a253bdd3a85be86d23279e92dcb9ac554" kindref="member">x2</ref>);</highlight></codeline>
<codeline lineno="2325"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a1016bdf91f09b91b189fba39e8b8334b" kindref="member">q</ref>);</highlight></codeline>
<codeline lineno="2326"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a18b9482375bf21c205aa4e5387588ac6" kindref="member">k</ref>);</highlight></codeline>
<codeline lineno="2327"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aefbcf878da60af7e3a8216ea110abee4" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="2328"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4101a831368541ae19b63ec4f7c26ae9" kindref="member">attn_out</ref>);</highlight></codeline>
<codeline lineno="2329"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a7eee5c5a685473963bd81c3cd17d34b4" kindref="member">mlp_gate</ref>);</highlight></codeline>
<codeline lineno="2330"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a2b67f8673d9015705eed557e18ed324a" kindref="member">mlp_up</ref>);</highlight></codeline>
<codeline lineno="2331"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1aba529a26308f8b6c5f62f434da0c810a" kindref="member">scores</ref>);</highlight></codeline>
<codeline lineno="2332"><highlight class="normal"><sp/><sp/>free(impl-&gt;<ref refid="structie__gptoss__infer__impl_1a4f3e6a77d41f9a49530e3f92be4da6d0" kindref="member">router_logits</ref>);</highlight></codeline>
<codeline lineno="2333"><highlight class="normal"></highlight></codeline>
<codeline lineno="2334"><highlight class="normal"><sp/><sp/>free(impl);</highlight></codeline>
<codeline lineno="2335"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2336"><highlight class="normal"></highlight></codeline>
<codeline lineno="2337" refid="ie__infer_8h_1a39827a388a0b7dd6d161e99b111c5546" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a39827a388a0b7dd6d161e99b111c5546" kindref="member">ie_gptoss_infer_prefill</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx,<sp/><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*kv,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>*prompt,</highlight></codeline>
<codeline lineno="2338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>n_prompt,<sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*out_logits)<sp/>{</highlight></codeline>
<codeline lineno="2339"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx<sp/>||<sp/>!kv<sp/>||<sp/>(!prompt<sp/>&amp;&amp;<sp/>n_prompt<sp/>&gt;<sp/>0)<sp/>||<sp/>!out_logits)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="2340"><highlight class="normal"></highlight></codeline>
<codeline lineno="2341"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2342"><highlight class="normal"></highlight></codeline>
<codeline lineno="2343"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2344"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_prompt<sp/>==<sp/>0u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="2345"><highlight class="normal"></highlight></codeline>
<codeline lineno="2346"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>limit<sp/>=<sp/>(uint32_t)<ref refid="infer__gptoss_8c_1a23c0a7a4138efca538e74eda244f02e4" kindref="member">ie_min_size</ref>((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_prompt,<sp/>(size_t)impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="2347"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(limit<sp/>!=<sp/>n_prompt)<sp/>{</highlight></codeline>
<codeline lineno="2348"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" kindref="member">IE_LOGW</ref>(</highlight><highlight class="stringliteral">&quot;prefill:<sp/>prompt<sp/>truncated<sp/>from<sp/>%u<sp/>to<sp/>%u<sp/>due<sp/>to<sp/>max_seq=%u&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)n_prompt,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)limit,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="2350"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2351"><highlight class="normal"></highlight></codeline>
<codeline lineno="2352"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>limit;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="2353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/><ref refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" kindref="member">ie_forward_one_token</ref>(impl,<sp/>kv,<sp/>prompt[i],<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>,<sp/>out_logits);</highlight></codeline>
<codeline lineno="2354"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;prefill:<sp/>failed<sp/>at<sp/>i=%u<sp/>token=%u<sp/>pos=%u<sp/>rc=%d&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)i,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)prompt[i],<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>,<sp/>rc);</highlight></codeline>
<codeline lineno="2357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="2358"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2359"><highlight class="normal"><sp/><sp/><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>+=<sp/>1u;</highlight></codeline>
<codeline lineno="2360"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2361"><highlight class="normal"></highlight></codeline>
<codeline lineno="2362"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="2363"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2364"><highlight class="normal"></highlight></codeline>
<codeline lineno="2365" refid="ie__infer_8h_1a52a0e33daf64ca5524b6440cecc8d2f6" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1a52a0e33daf64ca5524b6440cecc8d2f6" kindref="member">ie_gptoss_infer_step</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx,<sp/><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*kv,<sp/>uint32_t<sp/>token_id,</highlight></codeline>
<codeline lineno="2366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*out_logits)<sp/>{</highlight></codeline>
<codeline lineno="2367"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx<sp/>||<sp/>!kv<sp/>||<sp/>!out_logits)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="2368"><highlight class="normal"></highlight></codeline>
<codeline lineno="2369"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2370"><highlight class="normal"></highlight></codeline>
<codeline lineno="2371"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>;</highlight></codeline>
<codeline lineno="2372"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/><ref refid="infer__gptoss_8c_1a463151430d9b4dce6eae9210c3c598f0" kindref="member">ie_forward_one_token</ref>(impl,<sp/>kv,<sp/>token_id,<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>,<sp/>out_logits);</highlight></codeline>
<codeline lineno="2373"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2374"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;step:<sp/>failed<sp/>token=%u<sp/>pos=%u<sp/>rc=%d&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)token_id,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>,<sp/>rc);</highlight></codeline>
<codeline lineno="2375"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="2376"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2377"><highlight class="normal"></highlight></codeline>
<codeline lineno="2378"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>+<sp/>1u;</highlight></codeline>
<codeline lineno="2379"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="2380"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2381"><highlight class="normal"></highlight></codeline>
<codeline lineno="2382"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2383"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Cursor<sp/>control<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2384"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>-------------------------------------------------------------------------<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2385"><highlight class="normal"></highlight></codeline>
<codeline lineno="2386" refid="infer__gptoss_8c_1ad6ba88834d3de780c37646cbb32b6e3a" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1ad6ba88834d3de780c37646cbb32b6e3a" kindref="member">ie_gptoss_infer_reset</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx)<sp/>{</highlight></codeline>
<codeline lineno="2387"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2388"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2389"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2390"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2391"><highlight class="normal"></highlight></codeline>
<codeline lineno="2392" refid="infer__gptoss_8c_1aa1f70a529800c149104a8ec815df7624" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aa1f70a529800c149104a8ec815df7624" kindref="member">ie_gptoss_infer_seek</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx,<sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2393"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="2394"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2395"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="2396"><highlight class="normal"></highlight></codeline>
<codeline lineno="2397"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>&gt;<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2398"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1a7a7598633174002445d1c3aa0ea887f2" kindref="member">IE_LOGE</ref>(</highlight><highlight class="stringliteral">&quot;seek:<sp/>invalid<sp/>pos=%u<sp/>(max_seq=%u)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>);</highlight></codeline>
<codeline lineno="2399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="2400"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2401"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>==<sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1acbb75373de61b386cfcf11decab10749" kindref="member">hp</ref>-&gt;<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2402"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="infer__gptoss_8c_1ac3ab74b12e3f93d9f56d2b96dd6f9fef" kindref="member">IE_LOGW</ref>(</highlight><highlight class="stringliteral">&quot;seek:<sp/>pos==max_seq<sp/>(%u);<sp/>next<sp/>step/prefill<sp/>will<sp/>fail<sp/>if<sp/>it<sp/>writes<sp/>at<sp/>this<sp/>position&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>);</highlight></codeline>
<codeline lineno="2404"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="2405"><highlight class="normal"></highlight></codeline>
<codeline lineno="2406"><highlight class="normal"><sp/><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref><sp/>=<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>;</highlight></codeline>
<codeline lineno="2407"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="2408"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2409"><highlight class="normal"></highlight></codeline>
<codeline lineno="2410" refid="infer__gptoss_8c_1ad28e80404996cdcc9b260dc36e0d38d7" refkind="member"><highlight class="normal">uint32_t<sp/><ref refid="infer__gptoss_8c_1ad28e80404996cdcc9b260dc36e0d38d7" kindref="member">ie_gptoss_infer_pos</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx)<sp/>{</highlight></codeline>
<codeline lineno="2411"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ctx)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0u;</highlight></codeline>
<codeline lineno="2412"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*impl<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__gptoss__infer__impl" kindref="compound">ie_gptoss_infer_impl</ref><sp/>*)ctx;</highlight></codeline>
<codeline lineno="2413"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>impl-&gt;<ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>;</highlight></codeline>
<codeline lineno="2414"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2415"><highlight class="normal"></highlight></codeline>
<codeline lineno="2416"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Backward-compatible<sp/>aliases<sp/>(if<sp/>older<sp/>call-sites<sp/>exist).<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2417"><highlight class="normal"></highlight></codeline>
<codeline lineno="2418" refid="ie__infer_8h_1a013879de493fc8d3d8ef05881fb2e12c" refkind="member"><highlight class="normal">uint32_t<sp/><ref refid="infer__gptoss_8c_1a013879de493fc8d3d8ef05881fb2e12c" kindref="member">ie_gptoss_infer_get_pos</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx)<sp/>{</highlight></codeline>
<codeline lineno="2419"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1ad28e80404996cdcc9b260dc36e0d38d7" kindref="member">ie_gptoss_infer_pos</ref>(ctx);</highlight></codeline>
<codeline lineno="2420"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2421"><highlight class="normal"></highlight></codeline>
<codeline lineno="2422" refid="ie__infer_8h_1aa56c26f106493f7ffab8a97805a56821" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="infer__gptoss_8c_1aa56c26f106493f7ffab8a97805a56821" kindref="member">ie_gptoss_infer_set_pos</ref>(<ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*ctx,<sp/>uint32_t<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2423"><highlight class="normal"><sp/><sp/>(void)<ref refid="infer__gptoss_8c_1aa1f70a529800c149104a8ec815df7624" kindref="member">ie_gptoss_infer_seek</ref>(ctx,<sp/><ref refid="structie__gptoss__infer__impl_1ad73002e9bf6484de132ba3604712d436" kindref="member">pos</ref>);</highlight></codeline>
<codeline lineno="2424"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="engine/src/runtime/infer_gptoss.c"/>
  </compounddef>
</doxygen>
