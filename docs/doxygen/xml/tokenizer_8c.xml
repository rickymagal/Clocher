<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="tokenizer_8c" kind="file" language="C++">
    <compoundname>tokenizer.c</compoundname>
    <includes local="no">ctype.h</includes>
    <includes local="no">errno.h</includes>
    <includes local="no">inttypes.h</includes>
    <includes local="no">stdint.h</includes>
    <includes local="no">stdio.h</includes>
    <includes local="no">stdlib.h</includes>
    <includes local="no">string.h</includes>
    <includes refid="ie__io_8h" local="yes">ie_io.h</includes>
    <includes refid="util__logging_8h" local="yes">util_logging.h</includes>
    <incdepgraph>
      <node id="9">
        <label>ie_io.h</label>
        <link refid="ie__io_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
      </node>
      <node id="11">
        <label>util_logging.h</label>
        <link refid="util__logging_8h"/>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>engine/src/io/tokenizer.c</label>
        <link refid="tokenizer_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>ctype.h</label>
      </node>
      <node id="3">
        <label>errno.h</label>
      </node>
      <node id="4">
        <label>inttypes.h</label>
      </node>
      <node id="12">
        <label>stdarg.h</label>
      </node>
      <node id="10">
        <label>stddef.h</label>
      </node>
      <node id="5">
        <label>stdint.h</label>
      </node>
      <node id="6">
        <label>stdio.h</label>
      </node>
      <node id="7">
        <label>stdlib.h</label>
      </node>
      <node id="8">
        <label>string.h</label>
      </node>
    </incdepgraph>
    <sectiondef kind="define">
      <memberdef kind="define" id="tokenizer_8c_1a3024ccd4a9af5109d24e6c57565d74a1" prot="public" static="no">
        <name>_POSIX_C_SOURCE</name>
        <initializer>200809L</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="36" column="9" bodyfile="engine/src/io/tokenizer.c" bodystart="36" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int tok_env_flag_</definition>
        <argsstring>(const char *name, int default_value)</argsstring>
        <name>tok_env_flag_</name>
        <param>
          <type>const char *</type>
          <declname>name</declname>
        </param>
        <param>
          <type>int</type>
          <declname>default_value</declname>
        </param>
        <briefdescription>
<para>Read a boolean environment variable as 0/1. </para>
        </briefdescription>
        <detaileddescription>
<para>Accepted spellings (case-sensitive variants included):<itemizedlist>
<listitem><para>false: &quot;0&quot;, &quot;false&quot;, &quot;FALSE&quot;, &quot;no&quot;, &quot;NO&quot;, &quot;off&quot;, &quot;OFF&quot;</para>
</listitem><listitem><para>true: &quot;1&quot;, &quot;true&quot;, &quot;TRUE&quot;, &quot;yes&quot;, &quot;YES&quot;, &quot;on&quot;, &quot;ON&quot;</para>
</listitem></itemizedlist>
</para>
<para>Any other non-empty value is treated as true.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>name</parametername>
</parameternamelist>
<parameterdescription>
<para>Environment variable name (must not be NULL). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>default_value</parametername>
</parameternamelist>
<parameterdescription>
<para>Value used when variable is unset or empty. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 or 1. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="68" column="12" bodyfile="engine/src/io/tokenizer.c" bodystart="68" bodyend="81"/>
        <referencedby refid="ie__io_8h_1a68bc61261a64b4fe8bd566fc7d399a2e" compoundref="tokenizer_8c" startline="357" endline="414">ie_tok_decode</referencedby>
        <referencedby refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" compoundref="tokenizer_8c" startline="266" endline="337">ie_tok_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int is_space_byte_</definition>
        <argsstring>(unsigned char c)</argsstring>
        <name>is_space_byte_</name>
        <param>
          <type>unsigned char</type>
          <declname>c</declname>
        </param>
        <briefdescription>
<para>Return 1 if <computeroutput>c</computeroutput> is ASCII whitespace, 0 otherwise. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>c</parametername>
</parameternamelist>
<parameterdescription>
<para>Character byte (unsigned). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>1 if whitespace, 0 otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="89" column="12" bodyfile="engine/src/io/tokenizer.c" bodystart="89" bodyend="91"/>
        <referencedby refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" compoundref="tokenizer_8c" startline="266" endline="337">ie_tok_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1a5f45335764cbb4aecfbd2fea264cf1d5" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t fnv1a_32_</definition>
        <argsstring>(const void *ptr, size_t len)</argsstring>
        <name>fnv1a_32_</name>
        <param>
          <type>const void *</type>
          <declname>ptr</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>len</declname>
        </param>
        <briefdescription>
<para>Compute 32-bit FNV-1a hash for a memory region. </para>
        </briefdescription>
        <detaileddescription>
<para>The returned value occupies the full 32-bit range. Callers typically clamp to a positive ID space for portability across signed/unsigned paths.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>ptr</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to the input bytes. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>len</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of bytes. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>32-bit FNV-1a hash. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="104" column="17" bodyfile="engine/src/io/tokenizer.c" bodystart="104" bodyend="112"/>
        <referencedby refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" compoundref="tokenizer_8c" startline="266" endline="337">ie_tok_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1a9795df9525cac512228dfcc901d51c00" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t clamp_to_pos31_</definition>
        <argsstring>(uint32_t x)</argsstring>
        <name>clamp_to_pos31_</name>
        <param>
          <type>uint32_t</type>
          <declname>x</declname>
        </param>
        <briefdescription>
<para>Clamp an unsigned 32-bit value into a positive 31-bit ID space. </para>
        </briefdescription>
        <detaileddescription>
<para>Ensures the returned value is in the range [1, 0x7FFFFFFF].</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Arbitrary 32-bit value. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Value in the range [1, 0x7FFFFFFF]. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="123" column="17" bodyfile="engine/src/io/tokenizer.c" bodystart="123" bodyend="126"/>
        <referencedby refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" compoundref="tokenizer_8c" startline="266" endline="337">ie_tok_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void tok_log_preview_</definition>
        <argsstring>(const char *label, const char *s)</argsstring>
        <name>tok_log_preview_</name>
        <param>
          <type>const char *</type>
          <declname>label</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
<para>Log a short, safe preview of a string for diagnostics. </para>
        </briefdescription>
        <detaileddescription>
<para>Logs at most 96 bytes, replacing newlines/tabs with spaces.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>label</parametername>
</parameternamelist>
<parameterdescription>
<para>Label for the log line (may be NULL). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>s</parametername>
</parameternamelist>
<parameterdescription>
<para>String to preview (may be NULL). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="137" column="13" bodyfile="engine/src/io/tokenizer.c" bodystart="137" bodyend="154"/>
        <references refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" compoundref="util__logging_8c" startline="27" endline="32">ie_log_info</references>
        <referencedby refid="ie__io_8h_1a68bc61261a64b4fe8bd566fc7d399a2e" compoundref="tokenizer_8c" startline="357" endline="414">ie_tok_decode</referencedby>
        <referencedby refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" compoundref="tokenizer_8c" startline="266" endline="337">ie_tok_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1adbe33a7f4e53bcb709d56dc753c9148b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_vocab_load</definition>
        <argsstring>(const char *vocab_path, ie_vocab_t *out)</argsstring>
        <name>ie_vocab_load</name>
        <param>
          <type>const char *</type>
          <declname>vocab_path</declname>
        </param>
        <param>
          <type><ref refid="ie__io_8h_1a8bdd12fff1489e034fcb2e8f7f29039a" kindref="member">ie_vocab_t</ref> *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
<para>Load a vocabulary file or default to a stub. </para>
        </briefdescription>
        <detaileddescription>
<para>Load a vocabulary file or fall back to a stub.</para>
<para>This implementation does not parse a full tokenizer model. It only attempts a best-effort scan for a JSON-like field <computeroutput>&quot;vocabSize&quot;: &lt;int&gt;</computeroutput> in the first few KB of the file.</para>
<para>If the file is missing/unreadable/unparsable, a deterministic stub value is returned to keep tests stable.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>vocab_path</parametername>
</parameternamelist>
<parameterdescription>
<para>Path to a vocabulary file (may be NULL or empty). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output vocabulary (must not be NULL). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<parameterlist kind="retval"><parameteritem>
<parameternamelist>
<parametername>0</parametername>
</parameternamelist>
<parameterdescription>
<para>Success (including stub fallback). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>-1</parametername>
</parameternamelist>
<parameterdescription>
<para>Invalid arguments. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="176" column="5" bodyfile="engine/src/io/tokenizer.c" bodystart="176" bodyend="228"/>
        <references refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" compoundref="util__logging_8c" startline="41" endline="46">ie_log_error</references>
        <references refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" compoundref="util__logging_8c" startline="27" endline="32">ie_log_info</references>
        <referencedby refid="test__tokenizer_8c_1a840291bc02cba5474a4cb46a9b9566fe" compoundref="test__tokenizer_8c" startline="24" endline="59">main</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1a1a76c23fd3fdf25bdae9ee6e9103cf83" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_vocab_free</definition>
        <argsstring>(ie_vocab_t *v)</argsstring>
        <name>ie_vocab_free</name>
        <param>
          <type><ref refid="ie__io_8h_1a8bdd12fff1489e034fcb2e8f7f29039a" kindref="member">ie_vocab_t</ref> *</type>
          <declname>v</declname>
        </param>
        <briefdescription>
<para>Free vocabulary resources. </para>
        </briefdescription>
        <detaileddescription>
<para>Release vocabulary resources.</para>
<para>This tokenizer implementation does not allocate dynamic resources for the vocab. This function is kept for API symmetry and future expansion.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>v</parametername>
</parameternamelist>
<parameterdescription>
<para>Vocabulary handle (may be NULL). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="239" column="6" bodyfile="engine/src/io/tokenizer.c" bodystart="239" bodyend="241"/>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1a2b9cb342eb062867f93fb786548003f7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_tok_encode</definition>
        <argsstring>(const ie_vocab_t *v, const char *text, uint32_t *ids, uint32_t *out_count)</argsstring>
        <name>ie_tok_encode</name>
        <param>
          <type>const <ref refid="ie__io_8h_1a8bdd12fff1489e034fcb2e8f7f29039a" kindref="member">ie_vocab_t</ref> *</type>
          <declname>v</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>text</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>ids</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_count</declname>
        </param>
        <briefdescription>
<para>Encode UTF-8 text with whitespace tokenization and hashed IDs. </para>
        </briefdescription>
        <detaileddescription>
<para>Encode UTF-8 text into token IDs (stub implementation).</para>
<para>Tokenization rule: split on one or more ASCII whitespace characters. Empty tokens are never produced.</para>
<para>Size-only mode:<itemizedlist>
<listitem><para>Pass <computeroutput>ids</computeroutput> == NULL to receive the required token count in <computeroutput>out_count</computeroutput>.</para>
</listitem></itemizedlist>
</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>v</parametername>
</parameternamelist>
<parameterdescription>
<para>Loaded vocabulary descriptor (unused by this implementation). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>text</parametername>
</parameternamelist>
<parameterdescription>
<para>NUL-terminated UTF-8 string (must not be NULL). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>ids</parametername>
</parameternamelist>
<parameterdescription>
<para>Output buffer (or NULL for size query). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_count</parametername>
</parameternamelist>
<parameterdescription>
<para>In: capacity of <computeroutput>ids</computeroutput> when <computeroutput>ids</computeroutput> != NULL. Out: number of tokens written (or needed when <computeroutput>ids</computeroutput> == NULL). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<parameterlist kind="retval"><parameteritem>
<parameternamelist>
<parametername>0</parametername>
</parameternamelist>
<parameterdescription>
<para>Success. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>-1</parametername>
</parameternamelist>
<parameterdescription>
<para>Invalid arguments. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>-2</parametername>
</parameternamelist>
<parameterdescription>
<para>Insufficient capacity when <computeroutput>ids</computeroutput> != NULL. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="266" column="5" bodyfile="engine/src/io/tokenizer.c" bodystart="266" bodyend="337"/>
        <references refid="tokenizer_8c_1a9795df9525cac512228dfcc901d51c00" compoundref="tokenizer_8c" startline="123" endline="126">clamp_to_pos31_</references>
        <references refid="tokenizer_8c_1a5f45335764cbb4aecfbd2fea264cf1d5" compoundref="tokenizer_8c" startline="104" endline="112">fnv1a_32_</references>
        <references refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" compoundref="util__logging_8c" startline="41" endline="46">ie_log_error</references>
        <references refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" compoundref="util__logging_8c" startline="27" endline="32">ie_log_info</references>
        <references refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" compoundref="tokenizer_8c" startline="89" endline="91">is_space_byte_</references>
        <references refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" compoundref="tokenizer_8c" startline="68" endline="81">tok_env_flag_</references>
        <references refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" compoundref="tokenizer_8c" startline="137" endline="154">tok_log_preview_</references>
        <referencedby refid="test__tokenizer_8c_1a840291bc02cba5474a4cb46a9b9566fe" compoundref="test__tokenizer_8c" startline="24" endline="59">main</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer_8c_1a68bc61261a64b4fe8bd566fc7d399a2e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_tok_decode</definition>
        <argsstring>(const ie_vocab_t *v, const uint32_t *ids, uint32_t count, char *out, size_t out_sz)</argsstring>
        <name>ie_tok_decode</name>
        <param>
          <type>const <ref refid="ie__io_8h_1a8bdd12fff1489e034fcb2e8f7f29039a" kindref="member">ie_vocab_t</ref> *</type>
          <declname>v</declname>
        </param>
        <param>
          <type>const uint32_t *</type>
          <declname>ids</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>count</declname>
        </param>
        <param>
          <type>char *</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>out_sz</declname>
        </param>
        <briefdescription>
<para>Decode token IDs to a deterministic placeholder string. </para>
        </briefdescription>
        <detaileddescription>
<para>Decode token IDs into a printable placeholder string.</para>
<para>Output format:<itemizedlist>
<listitem><para>&quot;T&lt;ID0&gt; T&lt;ID1&gt; ... T&lt;IDn&gt;&quot; (space-separated)</para>
</listitem></itemizedlist>
</para>
<para>This is intended for unit tests and harness debugging, not for real model text.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>v</parametername>
</parameternamelist>
<parameterdescription>
<para>Loaded vocabulary descriptor (unused by this implementation). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>ids</parametername>
</parameternamelist>
<parameterdescription>
<para>Array of token IDs (may be NULL when <computeroutput>count</computeroutput> == 0). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>count</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of IDs. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output buffer (must not be NULL). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_sz</parametername>
</parameternamelist>
<parameterdescription>
<para>Capacity of <computeroutput>out</computeroutput> in bytes (must be &gt; 0). </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<parameterlist kind="retval"><parameteritem>
<parameternamelist>
<parametername>0</parametername>
</parameternamelist>
<parameterdescription>
<para>Success. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>-1</parametername>
</parameternamelist>
<parameterdescription>
<para>Invalid arguments. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>-2</parametername>
</parameternamelist>
<parameterdescription>
<para>Output buffer too small or formatting truncated. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer.c" line="357" column="5" bodyfile="engine/src/io/tokenizer.c" bodystart="357" bodyend="414"/>
        <references refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" compoundref="util__logging_8c" startline="41" endline="46">ie_log_error</references>
        <references refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" compoundref="util__logging_8c" startline="27" endline="32">ie_log_info</references>
        <references refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" compoundref="tokenizer_8c" startline="68" endline="81">tok_env_flag_</references>
        <references refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" compoundref="tokenizer_8c" startline="137" endline="154">tok_log_preview_</references>
        <referencedby refid="test__tokenizer_8c_1a840291bc02cba5474a4cb46a9b9566fe" compoundref="test__tokenizer_8c" startline="24" endline="59">main</referencedby>
      </memberdef>
    </sectiondef>
    <briefdescription>
<para>Minimal, dependency-free tokenizer used by tests and the CLI harness. </para>
    </briefdescription>
    <detaileddescription>
<para>This module provides the small tokenizer/vocabulary API declared in ie_io.h:<itemizedlist>
<listitem><para><ref refid="ie__io_8h_1adbe33a7f4e53bcb709d56dc753c9148b" kindref="member">ie_vocab_load</ref> : Load a vocabulary descriptor (best-effort).</para>
</listitem><listitem><para><ref refid="ie__io_8h_1a1a76c23fd3fdf25bdae9ee6e9103cf83" kindref="member">ie_vocab_free</ref> : Release vocabulary resources (no-op here).</para>
</listitem><listitem><para><ref refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" kindref="member">ie_tok_encode</ref> : Encode a UTF-8 string into token IDs.</para>
</listitem><listitem><para><ref refid="ie__io_8h_1a68bc61261a64b4fe8bd566fc7d399a2e" kindref="member">ie_tok_decode</ref> : Convert token IDs back into a deterministic textual form.</para>
</listitem></itemizedlist>
</para>
<para>Important: This is intentionally NOT a real BPE/WordPiece tokenizer. It exists to keep unit tests deterministic and to allow a lightweight harness without external tokenizer artifacts. Production inference must use the model&apos;s real tokenizer.</para>
<para>Tokenization model:<itemizedlist>
<listitem><para>Split on ASCII whitespace (isspace()).</para>
</listitem><listitem><para>Each token is mapped to a stable 31-bit positive integer using FNV-1a.</para>
</listitem></itemizedlist>
</para>
<para>Size-query behavior:<itemizedlist>
<listitem><para>Encoding supports a size-only pass by calling <ref refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" kindref="member">ie_tok_encode</ref> with <computeroutput>ids</computeroutput> == NULL. The required number of tokens is returned via <computeroutput>out_count</computeroutput>.</para>
</listitem></itemizedlist>
</para>
<para>Logging:<itemizedlist>
<listitem><para>INFO logs for vocabulary load decisions.</para>
</listitem><listitem><para>ERROR logs for invalid args and capacity issues.</para>
</listitem><listitem><para>Optional per-call verbose logs controlled by IE_TOKENIZER_VERBOSE=1. </para>
</listitem></itemizedlist>
</para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>File:<sp/>engine/src/io/tokenizer.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*/</highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>_POSIX_C_SOURCE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36" refid="tokenizer_8c_1a3024ccd4a9af5109d24e6c57565d74a1" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>_POSIX_C_SOURCE<sp/>200809L</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ctype.h&gt;</highlight><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>isspace<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;errno.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;inttypes.h&gt;</highlight><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>PRIu32<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdint.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdio.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdlib.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__io_8h" kindref="compound">ie_io.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="util__logging_8h" kindref="compound">util_logging.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Internal<sp/>helpers<sp/>(file-local)<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="68" refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" kindref="member">tok_env_flag_</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*name,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>default_value)<sp/>{</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*v<sp/>=<sp/>getenv(name);</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!v<sp/>||<sp/>!*v)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>default_value;</highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;0&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;false&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;FALSE&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;no&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;NO&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;off&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;OFF&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;1&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;true&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;TRUE&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;yes&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;YES&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;on&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0<sp/>||<sp/>strcmp(v,<sp/></highlight><highlight class="stringliteral">&quot;ON&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="81"><highlight class="normal">}</highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight></codeline>
<codeline lineno="89" refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" kindref="member">is_space_byte_</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c)<sp/>{</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>isspace((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)c)<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="91"><highlight class="normal">}</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="104" refid="tokenizer_8c_1a5f45335764cbb4aecfbd2fea264cf1d5" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="tokenizer_8c_1a5f45335764cbb4aecfbd2fea264cf1d5" kindref="member">fnv1a_32_</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*ptr,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)ptr;</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/>uint32_t<sp/>h<sp/>=<sp/>2166136261u;<sp/></highlight><highlight class="comment">/*<sp/>offset<sp/>basis<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>len;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>^=<sp/>(uint32_t)p[i];</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>*=<sp/>16777619u;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>FNV<sp/>prime<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>h;</highlight></codeline>
<codeline lineno="112"><highlight class="normal">}</highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight></codeline>
<codeline lineno="123" refid="tokenizer_8c_1a9795df9525cac512228dfcc901d51c00" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="tokenizer_8c_1a9795df9525cac512228dfcc901d51c00" kindref="member">clamp_to_pos31_</ref>(uint32_t<sp/>x)<sp/>{</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/>uint32_t<sp/>y<sp/>=<sp/>x<sp/>&amp;<sp/>0x7FFFFFFFu;</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(y<sp/>==<sp/>0u)<sp/>?<sp/>1u<sp/>:<sp/>y;</highlight></codeline>
<codeline lineno="126"><highlight class="normal">}</highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight></codeline>
<codeline lineno="137" refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" kindref="member">tok_log_preview_</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*label,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!label)<sp/>label<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;text&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s)<sp/>{</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>(null)&quot;</highlight><highlight class="normal">,<sp/>label);</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tmp[128];</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>s[n]<sp/>&amp;&amp;<sp/>n<sp/>+<sp/>1<sp/>&lt;<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmp)<sp/>&amp;&amp;<sp/>n<sp/>&lt;<sp/>96;<sp/>++n)<sp/>{</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>ch<sp/>=<sp/>s[n];</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ch<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal"><sp/>||<sp/>ch<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\r&apos;</highlight><highlight class="normal"><sp/>||<sp/>ch<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal">)<sp/>ch<sp/>=<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/>tmp[n]<sp/>=<sp/>ch;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/>tmp[n]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>bytes=%zu<sp/>preview=\&quot;%s%s\&quot;&quot;</highlight><highlight class="normal">,<sp/>label,<sp/>strlen(s),<sp/>tmp,<sp/>(s[n]<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;...&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="154"><highlight class="normal">}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Public<sp/>API:<sp/>Vocabulary<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight></codeline>
<codeline lineno="176" refid="ie__io_8h_1adbe33a7f4e53bcb709d56dc753c9148b" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1adbe33a7f4e53bcb709d56dc753c9148b" kindref="member">ie_vocab_load</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*vocab_path,<sp/><ref refid="structie__vocab__s" kindref="compound">ie_vocab_t</ref><sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out)<sp/>{</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>bad<sp/>args<sp/>(out=NULL)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Default<sp/>stub<sp/>value<sp/>if<sp/>anything<sp/>goes<sp/>wrong.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/>out-&gt;vocab_size<sp/>=<sp/>50000;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vocab_path<sp/>||<sp/>!*vocab_path)<sp/>{</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>no<sp/>path<sp/>provided;<sp/>using<sp/>stub<sp/>vocab_size=%d&quot;</highlight><highlight class="normal">,<sp/>out-&gt;vocab_size);</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="189"><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/>FILE<sp/>*f<sp/>=<sp/>fopen(vocab_path,<sp/></highlight><highlight class="stringliteral">&quot;rb&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!f)<sp/>{</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>cannot<sp/>open<sp/>\&quot;%s\&quot;<sp/>(errno=%d:<sp/>%s);<sp/>using<sp/>stub<sp/>vocab_size=%d&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vocab_path,</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>errno,</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>strerror(errno),</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out-&gt;vocab_size);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Read<sp/>a<sp/>small<sp/>prefix<sp/>to<sp/>try<sp/>and<sp/>find<sp/>&quot;vocabSize&quot;.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>buf[4096];</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>fread(buf,<sp/>1,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(buf)<sp/>-<sp/>1,<sp/>f);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/>fclose(f);</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/>buf[n]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Very<sp/>relaxed<sp/>scan<sp/>for<sp/>a<sp/>number<sp/>after<sp/>&quot;vocabSize&quot;.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*key<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;vocabSize&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*hit<sp/>=<sp/>strstr(buf,<sp/>key);</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hit)<sp/>{</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>hit<sp/>+<sp/>(int)strlen(key);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p<sp/>&amp;&amp;<sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal"><sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal"><sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\&apos;&apos;</highlight><highlight class="normal"><sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">))<sp/>++p;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>val<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sscanf(p,<sp/></highlight><highlight class="stringliteral">&quot;%ld&quot;</highlight><highlight class="normal">,<sp/>&amp;val)<sp/>==<sp/>1<sp/>&amp;&amp;<sp/>val<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>val<sp/>&lt;<sp/>100000000L)<sp/>{</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>out-&gt;vocab_size<sp/>=<sp/>(int)val;</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>parsed<sp/>vocab_size=%d<sp/>from<sp/>\&quot;%s\&quot;&quot;</highlight><highlight class="normal">,<sp/>out-&gt;vocab_size,<sp/>vocab_path);</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="219"><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>found<sp/>key<sp/>\&quot;%s\&quot;<sp/>but<sp/>failed<sp/>to<sp/>parse<sp/>number;<sp/>using<sp/>stub<sp/>vocab_size=%d&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key,</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out-&gt;vocab_size);</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="225"><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_vocab_load:<sp/>key<sp/>\&quot;%s\&quot;<sp/>not<sp/>found;<sp/>using<sp/>stub<sp/>vocab_size=%d&quot;</highlight><highlight class="normal">,<sp/>key,<sp/>out-&gt;vocab_size);</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="228"><highlight class="normal">}</highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight></codeline>
<codeline lineno="239" refid="ie__io_8h_1a1a76c23fd3fdf25bdae9ee6e9103cf83" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1a1a76c23fd3fdf25bdae9ee6e9103cf83" kindref="member">ie_vocab_free</ref>(<ref refid="structie__vocab__s" kindref="compound">ie_vocab_t</ref><sp/>*v)<sp/>{</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/>(void)v;</highlight></codeline>
<codeline lineno="241"><highlight class="normal">}</highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight></codeline>
<codeline lineno="243"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Public<sp/>API:<sp/>Encode/Decode<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight></codeline>
<codeline lineno="266" refid="ie__io_8h_1a2b9cb342eb062867f93fb786548003f7" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1a2b9cb342eb062867f93fb786548003f7" kindref="member">ie_tok_encode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__vocab__s" kindref="compound">ie_vocab_t</ref><sp/>*v,</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*text,</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*ids,</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*out_count)<sp/>{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/>(void)v;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!text<sp/>||<sp/>!out_count)<sp/>{</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_encode:<sp/>bad<sp/>args<sp/>(text=%p<sp/>out_count=%p)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*)text,<sp/>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*)out_count);</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="275"><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>verbose<sp/>=<sp/><ref refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" kindref="member">tok_env_flag_</ref>(</highlight><highlight class="stringliteral">&quot;IE_TOKENIZER_VERBOSE&quot;</highlight><highlight class="normal">,<sp/>0);</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(verbose)<sp/><ref refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" kindref="member">tok_log_preview_</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_encode<sp/>input&quot;</highlight><highlight class="normal">,<sp/>text);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)text;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>L<sp/>=<sp/>strlen(text);</highlight></codeline>
<codeline lineno="281"><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/>uint32_t<sp/>needed<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>First<sp/>pass:<sp/>count<sp/>tokens.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L)<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L<sp/>&amp;&amp;<sp/><ref refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" kindref="member">is_space_byte_</ref>(s[i]))<sp/>++i;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;=<sp/>L)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L<sp/>&amp;&amp;<sp/>!<ref refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" kindref="member">is_space_byte_</ref>(s[i]))<sp/>++i;</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;<sp/>start)<sp/>++needed;</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ids)<sp/>{</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_count<sp/>=<sp/>needed;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(verbose)<sp/>{</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_encode:<sp/>size-query<sp/>result<sp/>needed=%&quot;</highlight><highlight class="normal"><sp/>PRIu32,<sp/>needed);</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="303"><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Second<sp/>pass:<sp/>produce<sp/>IDs;<sp/>respect<sp/>capacity<sp/>in<sp/>*out_count.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>cap<sp/>=<sp/>*out_count;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/>uint32_t<sp/>wrote<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L<sp/>&amp;&amp;<sp/>wrote<sp/>&lt;<sp/>cap)<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L<sp/>&amp;&amp;<sp/><ref refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" kindref="member">is_space_byte_</ref>(s[i]))<sp/>++i;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;=<sp/>L)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>L<sp/>&amp;&amp;<sp/>!<ref refid="tokenizer_8c_1aca4f0da2226b5ed16e71e5524f84e0d8" kindref="member">is_space_byte_</ref>(s[i]))<sp/>++i;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>tok_len<sp/>=<sp/>i<sp/>-<sp/>start;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tok_len<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>h<sp/>=<sp/><ref refid="tokenizer_8c_1a5f45335764cbb4aecfbd2fea264cf1d5" kindref="member">fnv1a_32_</ref>(s<sp/>+<sp/>start,<sp/>tok_len);</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>ids[wrote++]<sp/>=<sp/><ref refid="tokenizer_8c_1a9795df9525cac512228dfcc901d51c00" kindref="member">clamp_to_pos31_</ref>(h);</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/>*out_count<sp/>=<sp/>wrote;</highlight></codeline>
<codeline lineno="324"><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(wrote<sp/>!=<sp/>needed)<sp/>{</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_encode:<sp/>insufficient<sp/>capacity<sp/>(needed=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;<sp/>cap=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;<sp/>wrote=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>needed,</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cap,</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>wrote);</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="332"><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(verbose)<sp/>{</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_encode:<sp/>ok<sp/>(tokens=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;)&quot;</highlight><highlight class="normal">,<sp/>wrote);</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="337"><highlight class="normal">}</highlight></codeline>
<codeline lineno="338"><highlight class="normal"></highlight></codeline>
<codeline lineno="357" refid="ie__io_8h_1a68bc61261a64b4fe8bd566fc7d399a2e" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer_8c_1a68bc61261a64b4fe8bd566fc7d399a2e" kindref="member">ie_tok_decode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__vocab__s" kindref="compound">ie_vocab_t</ref><sp/>*v,</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>*ids,</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>count,</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out,</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>out_sz)<sp/>{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/>(void)v;</highlight></codeline>
<codeline lineno="363"><highlight class="normal"></highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out<sp/>||<sp/>out_sz<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode:<sp/>bad<sp/>args<sp/>(out=%p<sp/>out_sz=%zu)&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*)out,<sp/>out_sz);</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="368"><highlight class="normal"></highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>verbose<sp/>=<sp/><ref refid="tokenizer_8c_1a863ec1870637861eb15fa5ac24cfaf2a" kindref="member">tok_env_flag_</ref>(</highlight><highlight class="stringliteral">&quot;IE_TOKENIZER_VERBOSE&quot;</highlight><highlight class="normal">,<sp/>0);</highlight></codeline>
<codeline lineno="370"><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Handle<sp/>empty<sp/>sequence.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ids<sp/>||<sp/>count<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/>out[0]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(verbose)<sp/><ref refid="util__logging_8h_1a7bff220c76442d1372d81e26f77c2921" kindref="member">ie_log_info</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode:<sp/>empty<sp/>input&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="377"><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Conservative<sp/>sizing:<sp/>worst<sp/>case<sp/>&quot;T4294967295<sp/>&quot;<sp/>per<sp/>token<sp/>+<sp/>NUL.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>worst_per<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="stringliteral">&quot;T4294967295<sp/>&quot;</highlight><highlight class="normal">)<sp/>-<sp/>1;<sp/></highlight><highlight class="comment">/*<sp/>12<sp/>bytes<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>worst<sp/>=<sp/>(size_t)count<sp/>*<sp/>worst_per<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="381"><highlight class="normal"></highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out_sz<sp/>&lt;<sp/>worst)<sp/>{</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode:<sp/>output<sp/>buffer<sp/>too<sp/>small<sp/>(count=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;<sp/>out_sz=%zu<sp/>need_at_least=%zu)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>count,</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out_sz,</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>worst);</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>out;</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>rem<sp/>=<sp/>out_sz;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>(i<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>?<sp/>snprintf(p,<sp/>rem,<sp/></highlight><highlight class="stringliteral">&quot;T%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)ids[i])</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>snprintf(p,<sp/>rem,<sp/></highlight><highlight class="stringliteral">&quot;<sp/>T%u&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)ids[i]);</highlight></codeline>
<codeline lineno="397"><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&lt;<sp/>0<sp/>||<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n<sp/>&gt;=<sp/>rem)<sp/>{</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode:<sp/>snprintf<sp/>failed/truncated<sp/>(i=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;<sp/>rem=%zu<sp/>n=%d)&quot;</highlight><highlight class="normal">,<sp/>i,<sp/>rem,<sp/>n);</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/>p<sp/>+=<sp/>(size_t)n;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/>rem<sp/>-=<sp/>(size_t)n;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rem<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="util__logging_8h_1aea21466075cc03977bc4fcde5130d6a4" kindref="member">ie_log_error</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode:<sp/>no<sp/>space<sp/>for<sp/>NUL<sp/>terminator<sp/>(count=%&quot;</highlight><highlight class="normal"><sp/>PRIu32<sp/></highlight><highlight class="stringliteral">&quot;<sp/>out_sz=%zu)&quot;</highlight><highlight class="normal">,<sp/>count,<sp/>out_sz);</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/>*p<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(verbose)<sp/><ref refid="tokenizer_8c_1ad024cfc5e6543de537bba2d31c18e817" kindref="member">tok_log_preview_</ref>(</highlight><highlight class="stringliteral">&quot;ie_tok_decode<sp/>output&quot;</highlight><highlight class="normal">,<sp/>out);</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="414"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="engine/src/io/tokenizer.c"/>
  </compounddef>
</doxygen>
