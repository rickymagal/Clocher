<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="sampling_8c" kind="file" language="C++">
    <compoundname>sampling.c</compoundname>
    <includes refid="ie__sampling_8h" local="yes">ie_sampling.h</includes>
    <includes local="no">errno.h</includes>
    <includes local="no">math.h</includes>
    <includes local="no">stddef.h</includes>
    <includes local="no">stdint.h</includes>
    <includes local="no">stdio.h</includes>
    <includes local="no">stdlib.h</includes>
    <includes local="no">string.h</includes>
    <incdepgraph>
      <node id="2">
        <label>ie_sampling.h</label>
        <link refid="ie__sampling_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>engine/src/runtime/sampling.c</label>
        <link refid="sampling_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>errno.h</label>
      </node>
      <node id="6">
        <label>math.h</label>
      </node>
      <node id="3">
        <label>stddef.h</label>
      </node>
      <node id="4">
        <label>stdint.h</label>
      </node>
      <node id="7">
        <label>stdio.h</label>
      </node>
      <node id="8">
        <label>stdlib.h</label>
      </node>
      <node id="9">
        <label>string.h</label>
      </node>
    </incdepgraph>
    <sectiondef kind="func">
      <memberdef kind="function" id="sampling_8c_1a70529f2480bd5d2a5e03d1b37ade6109" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int sampling_trace_enabled</definition>
        <argsstring>(void)</argsstring>
        <name>sampling_trace_enabled</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Check whether sampling tracing is enabled via environment variable. </para>
        </briefdescription>
        <detaileddescription>
<para>Tracing is enabled if IE_TRACE_SAMPLING is set and not equal to &quot;0&quot;. The value is cached after the first call.</para>
<para><simplesect kind="return"><para>1 if tracing is enabled; 0 otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="53" column="12" bodyfile="engine/src/runtime/sampling.c" bodystart="53" bodyend="62"/>
        <referencedby refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" compoundref="sampling_8c" startline="98" endline="105">sampling_trace_allow</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a8201d83a54b1f8473017cc7191a1d12a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>static uint64_t sampling_trace_limit</definition>
        <argsstring>(void)</argsstring>
        <name>sampling_trace_limit</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Return the trace call limit set by IE_TRACE_SAMPLING_N. </para>
        </briefdescription>
        <detaileddescription>
<para>If IE_TRACE_SAMPLING_N is unset or parses to 0, tracing is unlimited. The value is cached after the first call.</para>
<para><simplesect kind="return"><para>Maximum number of trace events to emit; 0 means unlimited. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="73" column="17" bodyfile="engine/src/runtime/sampling.c" bodystart="73" bodyend="87"/>
        <referencedby refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" compoundref="sampling_8c" startline="98" endline="105">sampling_trace_allow</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int sampling_trace_allow</definition>
        <argsstring>(void)</argsstring>
        <name>sampling_trace_allow</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
<para>Decide whether the current call should emit trace output. </para>
        </briefdescription>
        <detaileddescription>
<para>This function enforces IE_TRACE_SAMPLING_N if present. Calls are counted from the first invocation of this function in the process.</para>
<para><simplesect kind="return"><para>1 if tracing should be emitted for this call; 0 otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="98" column="12" bodyfile="engine/src/runtime/sampling.c" bodystart="98" bodyend="105"/>
        <references refid="sampling_8c_1a70529f2480bd5d2a5e03d1b37ade6109" compoundref="sampling_8c" startline="53" endline="62">sampling_trace_enabled</references>
        <references refid="sampling_8c_1a8201d83a54b1f8473017cc7191a1d12a" compoundref="sampling_8c" startline="73" endline="87">sampling_trace_limit</references>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a6229e9351f1f2f36bc74d15ff8ba8c3f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char * kind_name</definition>
        <argsstring>(ie_sample_kind_t k)</argsstring>
        <name>kind_name</name>
        <param>
          <type><ref refid="ie__sampling_8h_1a52498f36637698c96c3c63ce0df2330d" kindref="member">ie_sample_kind_t</ref></type>
          <declname>k</declname>
        </param>
        <briefdescription>
<para>Convert sampler kind enum into a human-readable string. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>k</parametername>
</parameternamelist>
<parameterdescription>
<para>Sampling kind. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Static string for logging. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="113" column="19" bodyfile="engine/src/runtime/sampling.c" bodystart="113" bodyend="120"/>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" compoundref="ie__sampling_8h" startline="37">IE_SAMPLE_GREEDY</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" compoundref="ie__sampling_8h" startline="38">IE_SAMPLE_TOPK</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" compoundref="ie__sampling_8h" startline="39">IE_SAMPLE_TOPP</references>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a2bab94d0c686c57c4437867f4c18583f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_rng_init</definition>
        <argsstring>(ie_rng_t *rng, uint64_t seed)</argsstring>
        <name>ie_rng_init</name>
        <param>
          <type><ref refid="ie__sampling_8h_1a448eca2b20b00f0f24c060e64e1330d5" kindref="member">ie_rng_t</ref> *</type>
          <declname>rng</declname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>seed</declname>
        </param>
        <briefdescription>
<para>Initialize RNG state. </para>
        </briefdescription>
        <detaileddescription>
<para>Initialize RNG with a seed (must be non-zero; 0 is remapped).</para>
<para>Uses xorshift64* for cheap non-cryptographic randomness. If seed is 0, a fixed non-zero seed is used to avoid the zero lock state.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG state (output). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>seed</parametername>
</parameternamelist>
<parameterdescription>
<para>Seed value. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="136" column="6" bodyfile="engine/src/runtime/sampling.c" bodystart="136" bodyend="139"/>
        <references refid="structie__rng__s_1adb3410752f1624ac33219a99633c11e4" compoundref="ie__sampling_8h" startline="66">ie_rng_s::s</references>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a00d17b124843413528d9014ab2b1c77d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>static uint64_t xorshift64star</definition>
        <argsstring>(uint64_t *s)</argsstring>
        <name>xorshift64star</name>
        <param>
          <type>uint64_t *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
<para>xorshift64* core step. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>s</parametername>
</parameternamelist>
<parameterdescription>
<para>Pointer to 64-bit RNG state. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Next 64-bit random value. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="147" column="17" bodyfile="engine/src/runtime/sampling.c" bodystart="147" bodyend="154"/>
        <referencedby refid="ie__sampling_8h_1a3b2d1ee37a4dc2a7c3db788735286c7d" compoundref="sampling_8c" startline="162" endline="165">ie_rng_u32</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a3b2d1ee37a4dc2a7c3db788735286c7d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>uint32_t ie_rng_u32</definition>
        <argsstring>(ie_rng_t *rng)</argsstring>
        <name>ie_rng_u32</name>
        <param>
          <type><ref refid="ie__sampling_8h_1a448eca2b20b00f0f24c060e64e1330d5" kindref="member">ie_rng_t</ref> *</type>
          <declname>rng</declname>
        </param>
        <briefdescription>
<para>Generate a 32-bit random integer. </para>
        </briefdescription>
        <detaileddescription>
<para>Return a random uint32.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG state. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Random 32-bit value (0 on NULL rng). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="162" column="10" bodyfile="engine/src/runtime/sampling.c" bodystart="162" bodyend="165"/>
        <references refid="structie__rng__s_1adb3410752f1624ac33219a99633c11e4" compoundref="ie__sampling_8h" startline="66">ie_rng_s::s</references>
        <references refid="sampling_8c_1a00d17b124843413528d9014ab2b1c77d" compoundref="sampling_8c" startline="147" endline="154">xorshift64star</references>
        <referencedby refid="ie__sampling_8h_1a0260d37f005432429e6806bfec44a606" compoundref="sampling_8c" startline="176" endline="180">ie_rng_f32</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a0260d37f005432429e6806bfec44a606" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>float ie_rng_f32</definition>
        <argsstring>(ie_rng_t *rng)</argsstring>
        <name>ie_rng_f32</name>
        <param>
          <type><ref refid="ie__sampling_8h_1a448eca2b20b00f0f24c060e64e1330d5" kindref="member">ie_rng_t</ref> *</type>
          <declname>rng</declname>
        </param>
        <briefdescription>
<para>Generate a float in [0, 1). </para>
        </briefdescription>
        <detaileddescription>
<para>Return a random float in [0, 1).</para>
<para>Produces 24 bits of mantissa using the high bits of a 32-bit random value.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG state. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Random float in [0,1). If rng is NULL, returns 0. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="176" column="7" bodyfile="engine/src/runtime/sampling.c" bodystart="176" bodyend="180"/>
        <references refid="sampling_8c_1a3b2d1ee37a4dc2a7c3db788735286c7d" compoundref="sampling_8c" startline="162" endline="165">ie_rng_u32</references>
        <referencedby refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" compoundref="sampling_8c" startline="284" endline="295">sample_from_probs</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a4073977e022fb98b2a9ef367de4e1601" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int cfg_sanitize</definition>
        <argsstring>(const ie_sample_cfg_t *cfg, ie_sample_cfg_t *out)</argsstring>
        <name>cfg_sanitize</name>
        <param>
          <type>const <ref refid="ie__sampling_8h_1a69ef33c311c065f6caa2738715c6fc76" kindref="member">ie_sample_cfg_t</ref> *</type>
          <declname>cfg</declname>
        </param>
        <param>
          <type><ref refid="ie__sampling_8h_1a69ef33c311c065f6caa2738715c6fc76" kindref="member">ie_sample_cfg_t</ref> *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
<para>Validate and sanitize a sampling configuration. </para>
        </briefdescription>
        <detaileddescription>
<para>Ensures temperature is positive, clamps top-p into (0,1], and normalizes top-k to at least 1.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>cfg</parametername>
</parameternamelist>
<parameterdescription>
<para>Input config. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>Output config. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success; non-zero on invalid args. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="197" column="12" bodyfile="engine/src/runtime/sampling.c" bodystart="197" bodyend="210"/>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" compoundref="ie__sampling_8h" startline="38">IE_SAMPLE_TOPK</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" compoundref="ie__sampling_8h" startline="39">IE_SAMPLE_TOPP</references>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t argmax_logits</definition>
        <argsstring>(const float *logits, size_t n, int disallow0)</argsstring>
        <name>argmax_logits</name>
        <param>
          <type>const float *</type>
          <declname>logits</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>int</type>
          <declname>disallow0</declname>
        </param>
        <briefdescription>
<para>Return the argmax index for a logits array. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>logits</parametername>
</parameternamelist>
<parameterdescription>
<para>Logits array. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of logits. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>disallow0</parametername>
</parameternamelist>
<parameterdescription>
<para>If non-zero, token id 0 is excluded from consideration. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Index of the maximum logit (or 0 if no valid index exists). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="220" column="17" bodyfile="engine/src/runtime/sampling.c" bodystart="220" bodyend="239"/>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>float</type>
        <definition>static float safe_exp</definition>
        <argsstring>(float x)</argsstring>
        <name>safe_exp</name>
        <param>
          <type>float</type>
          <declname>x</declname>
        </param>
        <briefdescription>
<para>Wrapper around expf for clarity and potential later clamping. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>x</parametername>
</parameternamelist>
<parameterdescription>
<para>Input. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>expf(x). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="247" column="14" bodyfile="engine/src/runtime/sampling.c" bodystart="247" bodyend="249"/>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a1584537ca7c8337f38aae35204cceded" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void softmax_inplace</definition>
        <argsstring>(float *p, size_t n)</argsstring>
        <name>softmax_inplace</name>
        <param>
          <type>float *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
<para>Normalize an array of non-negative values in-place so they sum to 1. </para>
        </briefdescription>
        <detaileddescription>
<para>If the sum is non-positive, the distribution is replaced by uniform.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>p</parametername>
</parameternamelist>
<parameterdescription>
<para>Array of weights/probabilities. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Length of array. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="260" column="13" bodyfile="engine/src/runtime/sampling.c" bodystart="260" bodyend="270"/>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t sample_from_probs</definition>
        <argsstring>(const float *p, const uint32_t *idx, size_t n, ie_rng_t *rng)</argsstring>
        <name>sample_from_probs</name>
        <param>
          <type>const float *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>const uint32_t *</type>
          <declname>idx</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type><ref refid="ie__sampling_8h_1a448eca2b20b00f0f24c060e64e1330d5" kindref="member">ie_rng_t</ref> *</type>
          <declname>rng</declname>
        </param>
        <briefdescription>
<para>Sample an index from a probability distribution. </para>
        </briefdescription>
        <detaileddescription>
<para>Uses a linear scan over the CDF.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>p</parametername>
</parameternamelist>
<parameterdescription>
<para>Probability values (must sum to ~1). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>idx</parametername>
</parameternamelist>
<parameterdescription>
<para>Optional index remap array. If non-NULL, returns idx[i]. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of probabilities. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG state. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Sampled id (or last element if numerical drift leaves r &gt;= cdf). </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="284" column="17" bodyfile="engine/src/runtime/sampling.c" bodystart="284" bodyend="295"/>
        <references refid="sampling_8c_1a0260d37f005432429e6806bfec44a606" compoundref="sampling_8c" startline="176" endline="180">ie_rng_f32</references>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a661598ee23a4d0b4029da20362f4e7c3" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void sort_desc_by_prob</definition>
        <argsstring>(uint32_t *idx, const float *prob, size_t n)</argsstring>
        <name>sort_desc_by_prob</name>
        <param>
          <type>uint32_t *</type>
          <declname>idx</declname>
        </param>
        <param>
          <type>const float *</type>
          <declname>prob</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
<para>Sort indices in descending order by probability. </para>
        </briefdescription>
        <detaileddescription>
<para>Stable insertion sort using prob[key] as the key.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>idx</parametername>
</parameternamelist>
<parameterdescription>
<para>Indices to sort in-place. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>prob</parametername>
</parameternamelist>
<parameterdescription>
<para>Probability array indexed by token id. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>n</parametername>
</parameternamelist>
<parameterdescription>
<para>Number of indices. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="307" column="13" bodyfile="engine/src/runtime/sampling.c" bodystart="307" bodyend="320"/>
        <referencedby refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</referencedby>
      </memberdef>
      <memberdef kind="function" id="sampling_8c_1a9287af318bfd9b7a269293f9fb3705f4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_sample_next</definition>
        <argsstring>(const float *logits, size_t vocab_size, const ie_sample_cfg_t *cfg_in, ie_rng_t *rng, uint32_t *idx_scratch, float *prob_scratch, size_t scratch_cap, uint32_t *out_id)</argsstring>
        <name>ie_sample_next</name>
        <param>
          <type>const float *</type>
          <declname>logits</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>vocab_size</declname>
        </param>
        <param>
          <type>const <ref refid="ie__sampling_8h_1a69ef33c311c065f6caa2738715c6fc76" kindref="member">ie_sample_cfg_t</ref> *</type>
          <declname>cfg</declname>
          <defname>cfg_in</defname>
        </param>
        <param>
          <type><ref refid="ie__sampling_8h_1a448eca2b20b00f0f24c060e64e1330d5" kindref="member">ie_rng_t</ref> *</type>
          <declname>rng</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>idx_scratch</declname>
        </param>
        <param>
          <type>float *</type>
          <declname>prob_scratch</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>scratch_cap</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_id</declname>
        </param>
        <briefdescription>
<para>Choose next token id from logits using the given configuration. </para>
        </briefdescription>
        <detaileddescription>
<para>This function may require scratch buffers for indices and probabilities. The caller provides them to avoid allocations.</para>
<para>Scratch requirements:<itemizedlist>
<listitem><para>idx_scratch: capacity &gt;= vocab_size (used for partial selection / sorting).</para>
</listitem><listitem><para>prob_scratch: capacity &gt;= vocab_size (used for softmax over candidate set).</para>
</listitem></itemizedlist>
</para>
<para>If you only use greedy mode, scratch may be NULL.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>logits</parametername>
</parameternamelist>
<parameterdescription>
<para>Input logits array of length vocab_size. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>vocab_size</parametername>
</parameternamelist>
<parameterdescription>
<para>Vocabulary size. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>cfg</parametername>
</parameternamelist>
<parameterdescription>
<para>Sampling config. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG state (used for stochastic sampling). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>idx_scratch</parametername>
</parameternamelist>
<parameterdescription>
<para>Scratch indices array (uint32_t). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>prob_scratch</parametername>
</parameternamelist>
<parameterdescription>
<para>Scratch probabilities array (float). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>scratch_cap</parametername>
</parameternamelist>
<parameterdescription>
<para>Capacity of idx_scratch and prob_scratch. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_id</parametername>
</parameternamelist>
<parameterdescription>
<para>Output token id. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, negative on error. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/sampling.c" line="326" column="5" bodyfile="engine/src/runtime/sampling.c" bodystart="326" bodyend="500"/>
        <references refid="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" compoundref="sampling_8c" startline="220" endline="239">argmax_logits</references>
        <references refid="sampling_8c_1a4073977e022fb98b2a9ef367de4e1601" compoundref="sampling_8c" startline="197" endline="210">cfg_sanitize</references>
        <references refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" compoundref="ie__sampling_8h" startline="57">ie_sample_cfg_s::disallow_token0</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" compoundref="ie__sampling_8h" startline="37">IE_SAMPLE_GREEDY</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" compoundref="ie__sampling_8h" startline="38">IE_SAMPLE_TOPK</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" compoundref="ie__sampling_8h" startline="39">IE_SAMPLE_TOPP</references>
        <references refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" compoundref="ie__sampling_8h" startline="45">ie_sample_cfg_s::kind</references>
        <references refid="sampling_8c_1a6229e9351f1f2f36bc74d15ff8ba8c3f" compoundref="sampling_8c" startline="113" endline="120">kind_name</references>
        <references refid="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" compoundref="sampling_8c" startline="247" endline="249">safe_exp</references>
        <references refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" compoundref="sampling_8c" startline="284" endline="295">sample_from_probs</references>
        <references refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" compoundref="sampling_8c" startline="98" endline="105">sampling_trace_allow</references>
        <references refid="sampling_8c_1a1584537ca7c8337f38aae35204cceded" compoundref="sampling_8c" startline="260" endline="270">softmax_inplace</references>
        <references refid="sampling_8c_1a661598ee23a4d0b4029da20362f4e7c3" compoundref="sampling_8c" startline="307" endline="320">sort_desc_by_prob</references>
        <references refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" compoundref="ie__sampling_8h" startline="48">ie_sample_cfg_s::temperature</references>
        <references refid="structie__sample__cfg__s_1a42a99f4e9a2514a58dd34aac41cc7ffd" compoundref="ie__sampling_8h" startline="51">ie_sample_cfg_s::top_k</references>
        <references refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" compoundref="ie__sampling_8h" startline="54">ie_sample_cfg_s::top_p</references>
        <referencedby refid="ie__api_8h_1a950ac9a0efe5a4fe068a288e57099c4a" compoundref="ie__api_8c" startline="826" endline="1109">ie_engine_generate_ex</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
    </sectiondef>
    <briefdescription>
<para>Token sampling utilities for next-token selection from logits. </para>
    </briefdescription>
    <detaileddescription>
<para>This module provides a small, self-contained sampler used by the runtime to select the next token id from a vector of logits.</para>
<para>Implemented sampling modes:<itemizedlist>
<listitem><para>Greedy (argmax): selects the maximum-logit token.</para>
</listitem><listitem><para>Top-k: keeps the best k logits via an insertion-style selection, applies a numerically-stable softmax over the selected subset, and samples.</para>
</listitem><listitem><para>Top-p (nucleus): applies temperature softmax over the full vocabulary, sorts by probability descending, takes the smallest prefix whose cumulative probability is &gt;= p, renormalizes, and samples.</para>
</listitem></itemizedlist>
</para>
<para>Correctness policy:<itemizedlist>
<listitem><para>This is correctness-first. Expensive operations (full sort in top-p) can be optimized later if needed.</para>
</listitem></itemizedlist>
</para>
<para>Tracing:<itemizedlist>
<listitem><para>Set IE_TRACE_SAMPLING=1 to trace sampling decisions.</para>
</listitem><listitem><para>Optional: IE_TRACE_SAMPLING_N limits logs to the first N calls (0 = unlimited). </para>
</listitem></itemizedlist>
</para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>File:<sp/>engine/src/runtime/sampling.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*/</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__sampling_8h" kindref="compound">ie_sampling.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;errno.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;math.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stddef.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdint.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdio.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdlib.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="41"><highlight class="comment"><sp/>*<sp/>Tracing<sp/>helpers</highlight></codeline>
<codeline lineno="42"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight></codeline>
<codeline lineno="53" refid="sampling_8c_1a70529f2480bd5d2a5e03d1b37ade6109" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a70529f2480bd5d2a5e03d1b37ade6109" kindref="member">sampling_trace_enabled</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>inited<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>enabled<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!inited)<sp/>{</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(</highlight><highlight class="stringliteral">&quot;IE_TRACE_SAMPLING&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>enabled<sp/>=<sp/>(s<sp/>&amp;&amp;<sp/>s[0]<sp/>&amp;&amp;<sp/>strcmp(s,<sp/></highlight><highlight class="stringliteral">&quot;0&quot;</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/>inited<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>enabled;</highlight></codeline>
<codeline lineno="62"><highlight class="normal">}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="73" refid="sampling_8c_1a8201d83a54b1f8473017cc7191a1d12a" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/><ref refid="sampling_8c_1a8201d83a54b1f8473017cc7191a1d12a" kindref="member">sampling_trace_limit</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>inited<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/>lim<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!inited)<sp/>{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>getenv(</highlight><highlight class="stringliteral">&quot;IE_TRACE_SAMPLING_N&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>&amp;&amp;<sp/>s[0])<sp/>{</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>errno<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>strtoull(s,<sp/>&amp;end,<sp/>10);</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(end<sp/>!=<sp/>s<sp/>&amp;&amp;<sp/>errno<sp/>==<sp/>0)<sp/>lim<sp/>=<sp/>(uint64_t)v;</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/>inited<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>lim;</highlight></codeline>
<codeline lineno="87"><highlight class="normal">}</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight></codeline>
<codeline lineno="98" refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="sampling_8c_1a70529f2480bd5d2a5e03d1b37ade6109" kindref="member">sampling_trace_enabled</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/>calls<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/>calls++;</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>lim<sp/>=<sp/><ref refid="sampling_8c_1a8201d83a54b1f8473017cc7191a1d12a" kindref="member">sampling_trace_limit</ref>();</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lim<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>calls<sp/>&lt;=<sp/>lim;</highlight></codeline>
<codeline lineno="105"><highlight class="normal">}</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="113" refid="sampling_8c_1a6229e9351f1f2f36bc74d15ff8ba8c3f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="sampling_8c_1a6229e9351f1f2f36bc74d15ff8ba8c3f" kindref="member">kind_name</ref>(<ref refid="ie__sampling_8h_1a52498f36637698c96c3c63ce0df2330d" kindref="member">ie_sample_kind_t</ref><sp/>k)<sp/>{</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(k)<sp/>{</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" kindref="member">IE_SAMPLE_GREEDY</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;greedy&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" kindref="member">IE_SAMPLE_TOPK</ref>:<sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;topk&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" kindref="member">IE_SAMPLE_TOPP</ref>:<sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;topp&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="120"><highlight class="normal">}</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="123"><highlight class="comment"><sp/>*<sp/>RNG<sp/>(xorshift64*)</highlight></codeline>
<codeline lineno="124"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight></codeline>
<codeline lineno="136" refid="ie__sampling_8h_1a2bab94d0c686c57c4437867f4c18583f" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a2bab94d0c686c57c4437867f4c18583f" kindref="member">ie_rng_init</ref>(<ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>*rng,<sp/>uint64_t<sp/>seed)<sp/>{</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rng)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/>rng-&gt;<ref refid="structie__rng__s_1adb3410752f1624ac33219a99633c11e4" kindref="member">s</ref><sp/>=<sp/>(seed<sp/>==<sp/>0)<sp/>?<sp/>0x9E3779B97F4A7C15ull<sp/>:<sp/>seed;</highlight></codeline>
<codeline lineno="139"><highlight class="normal">}</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="147" refid="sampling_8c_1a00d17b124843413528d9014ab2b1c77d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/><ref refid="sampling_8c_1a00d17b124843413528d9014ab2b1c77d" kindref="member">xorshift64star</ref>(uint64_t<sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/>uint64_t<sp/>x<sp/>=<sp/>*s;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/>x<sp/>^=<sp/>x<sp/>&gt;&gt;<sp/>12;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/>x<sp/>^=<sp/>x<sp/>&lt;&lt;<sp/>25;</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/>x<sp/>^=<sp/>x<sp/>&gt;&gt;<sp/>27;</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/>*s<sp/>=<sp/>x;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>x<sp/>*<sp/>2685821657736338717ull;</highlight></codeline>
<codeline lineno="154"><highlight class="normal">}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="162" refid="ie__sampling_8h_1a3b2d1ee37a4dc2a7c3db788735286c7d" refkind="member"><highlight class="normal">uint32_t<sp/><ref refid="sampling_8c_1a3b2d1ee37a4dc2a7c3db788735286c7d" kindref="member">ie_rng_u32</ref>(<ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>*rng)<sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rng)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(uint32_t)(<ref refid="sampling_8c_1a00d17b124843413528d9014ab2b1c77d" kindref="member">xorshift64star</ref>(&amp;rng-&gt;<ref refid="structie__rng__s_1adb3410752f1624ac33219a99633c11e4" kindref="member">s</ref>)<sp/>&gt;&gt;<sp/>32);</highlight></codeline>
<codeline lineno="165"><highlight class="normal">}</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="176" refid="ie__sampling_8h_1a0260d37f005432429e6806bfec44a606" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a0260d37f005432429e6806bfec44a606" kindref="member">ie_rng_f32</ref>(<ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>*rng)<sp/>{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/>uint32_t<sp/>x<sp/>=<sp/><ref refid="sampling_8c_1a3b2d1ee37a4dc2a7c3db788735286c7d" kindref="member">ie_rng_u32</ref>(rng);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/>uint32_t<sp/>m<sp/>=<sp/>x<sp/>&gt;&gt;<sp/>8;<sp/></highlight><highlight class="comment">/*<sp/>24<sp/>bits<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">)m<sp/>/<sp/>(float)(1u<sp/>&lt;&lt;<sp/>24);</highlight></codeline>
<codeline lineno="180"><highlight class="normal">}</highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="183"><highlight class="comment"><sp/>*<sp/>Helpers</highlight></codeline>
<codeline lineno="184"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight></codeline>
<codeline lineno="197" refid="sampling_8c_1a4073977e022fb98b2a9ef367de4e1601" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a4073977e022fb98b2a9ef367de4e1601" kindref="member">cfg_sanitize</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>*cfg,<sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!cfg<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>*cfg;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;temperature<sp/>&lt;=<sp/>0.0f)<sp/>out-&gt;temperature<sp/>=<sp/>1.0f;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;kind<sp/>==<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" kindref="member">IE_SAMPLE_TOPK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;top_k<sp/>==<sp/>0)<sp/>out-&gt;top_k<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;kind<sp/>==<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" kindref="member">IE_SAMPLE_TOPP</ref>)<sp/>{</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;top_p<sp/>&lt;=<sp/>0.0f)<sp/>out-&gt;top_p<sp/>=<sp/>0.9f;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out-&gt;top_p<sp/>&gt;<sp/>1.0f)<sp/>out-&gt;top_p<sp/>=<sp/>1.0f;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="210"><highlight class="normal">}</highlight></codeline>
<codeline lineno="211"><highlight class="normal"></highlight></codeline>
<codeline lineno="220" refid="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" kindref="member">argmax_logits</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*logits,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>disallow0)<sp/>{</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/>uint32_t<sp/>best_i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>best_v<sp/>=<sp/>-INFINITY;</highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(disallow0<sp/>&amp;&amp;<sp/>n<sp/>&gt;<sp/>0)<sp/>start<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(start<sp/>&gt;=<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="227"><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/>best_i<sp/>=<sp/>(uint32_t)start;</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/>best_v<sp/>=<sp/>logits[start];</highlight></codeline>
<codeline lineno="230"><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>start<sp/>+<sp/>1;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>logits[i];</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>best_v)<sp/>{</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>best_v<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>best_i<sp/>=<sp/>(uint32_t)i;</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>best_i;</highlight></codeline>
<codeline lineno="239"><highlight class="normal">}</highlight></codeline>
<codeline lineno="240"><highlight class="normal"></highlight></codeline>
<codeline lineno="247" refid="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" kindref="member">safe_exp</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>x)<sp/>{</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>expf(x);</highlight></codeline>
<codeline lineno="249"><highlight class="normal">}</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="260" refid="sampling_8c_1a1584537ca7c8337f38aae35204cceded" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a1584537ca7c8337f38aae35204cceded" kindref="member">softmax_inplace</ref>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*p,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>sum<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>sum<sp/>+=<sp/>p[i];</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sum<sp/>&lt;=<sp/>0.0f)<sp/>{</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>(n<sp/>?<sp/>(1.0f<sp/>/<sp/>(float)n)<sp/>:<sp/>0.0f);</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>p[i]<sp/>=<sp/>inv;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>1.0f<sp/>/<sp/>sum;</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>p[i]<sp/>*=<sp/>inv;</highlight></codeline>
<codeline lineno="270"><highlight class="normal">}</highlight></codeline>
<codeline lineno="271"><highlight class="normal"></highlight></codeline>
<codeline lineno="284" refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" kindref="member">sample_from_probs</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*p,</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>*idx,</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>*rng)<sp/>{</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>r<sp/>=<sp/><ref refid="sampling_8c_1a0260d37f005432429e6806bfec44a606" kindref="member">ie_rng_f32</ref>(rng);</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>c<sp/>+=<sp/>p[i];</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(r<sp/>&lt;<sp/>c)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>idx<sp/>?<sp/>idx[i]<sp/>:<sp/>(uint32_t)i;</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>idx<sp/>?<sp/>idx[n<sp/>-<sp/>1]<sp/>:<sp/>(uint32_t)(n<sp/>-<sp/>1);</highlight></codeline>
<codeline lineno="295"><highlight class="normal">}</highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight></codeline>
<codeline lineno="307" refid="sampling_8c_1a661598ee23a4d0b4029da20362f4e7c3" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a661598ee23a4d0b4029da20362f4e7c3" kindref="member">sort_desc_by_prob</ref>(uint32_t<sp/>*idx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*prob,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>key<sp/>=<sp/>idx[i];</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>pv<sp/>=<sp/>prob[key];</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(j<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>prev<sp/>=<sp/>idx[j<sp/>-<sp/>1];</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prob[prev]<sp/>&gt;=<sp/>pv)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx[j]<sp/>=<sp/>prev;</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--j;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/>idx[j]<sp/>=<sp/>key;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="320"><highlight class="normal">}</highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="323"><highlight class="comment"><sp/>*<sp/>Public<sp/>API</highlight></codeline>
<codeline lineno="324"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"></highlight></codeline>
<codeline lineno="326" refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="sampling_8c_1a9287af318bfd9b7a269293f9fb3705f4" kindref="member">ie_sample_next</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*logits,</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>vocab_size,</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>*cfg_in,</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>*rng,</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*idx_scratch,</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*prob_scratch,</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>scratch_cap,</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*out_id)<sp/>{</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!logits<sp/>||<sp/>vocab_size<sp/>==<sp/>0<sp/>||<sp/>!cfg_in<sp/>||<sp/>!out_id)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>cfg;</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a4073977e022fb98b2a9ef367de4e1601" kindref="member">cfg_sanitize</ref>(cfg_in,<sp/>&amp;cfg)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="338"><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>{</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>fprintf(stderr,</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>kind=%s<sp/>temp=%.6g<sp/>top_k=%u<sp/>top_p=%.6g<sp/>disallow0=%d<sp/>vocab=%zu\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sampling_8c_1a6229e9351f1f2f36bc74d15ff8ba8c3f" kindref="member">kind_name</ref>(cfg.<ref refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" kindref="member">kind</ref>),</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)cfg.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref>,</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)cfg.<ref refid="structie__sample__cfg__s_1a42a99f4e9a2514a58dd34aac41cc7ffd" kindref="member">top_k</ref>,</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)cfg.<ref refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" kindref="member">top_p</ref>,</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref>,</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vocab_size);</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" kindref="member">kind</ref><sp/>==<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" kindref="member">IE_SAMPLE_GREEDY</ref>)<sp/>{</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/><ref refid="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" kindref="member">argmax_logits</ref>(logits,<sp/>vocab_size,<sp/>cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref>);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>{</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>greedy<sp/>-&gt;<sp/>id=%u<sp/>logit=%.6g\n&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)logits[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="358"><highlight class="normal"></highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!idx_scratch<sp/>||<sp/>!prob_scratch<sp/>||<sp/>scratch_cap<sp/>&lt;<sp/>vocab_size)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rng)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="361"><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" kindref="member">kind</ref><sp/>==<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646ab4e9a5e6b4a83a598f8c39f00066f03d" kindref="member">IE_SAMPLE_TOPK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>k<sp/>=<sp/>cfg.<ref refid="structie__sample__cfg__s_1a42a99f4e9a2514a58dd34aac41cc7ffd" kindref="member">top_k</ref>;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(k<sp/>&gt;<sp/>(uint32_t)vocab_size)<sp/>k<sp/>=<sp/>(uint32_t)vocab_size;</highlight></codeline>
<codeline lineno="365"><highlight class="normal"></highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>sel_n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size<sp/>&amp;&amp;<sp/>sel_n<sp/>&lt;<sp/>k;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>&amp;&amp;<sp/>i<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[sel_n++]<sp/>=<sp/>(uint32_t)i;</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sel_n<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>topk<sp/>-&gt;<sp/>empty<sp/>selection,<sp/>id=0\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="376"><highlight class="normal"></highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Keep<sp/>selection<sp/>sorted<sp/>ascending<sp/>by<sp/>logit<sp/>so<sp/>idx_scratch[0]<sp/>is<sp/>the<sp/>current<sp/>worst.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>sel_n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>key<sp/>=<sp/>idx_scratch[i];</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>logits[key];</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>j<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(j<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>prev<sp/>=<sp/>idx_scratch[j<sp/>-<sp/>1];</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(logits[prev]<sp/>&lt;=<sp/>v)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[j]<sp/>=<sp/>prev;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--j;</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[j]<sp/>=<sp/>key;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="390"><highlight class="normal"></highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>&amp;&amp;<sp/>i<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>logits[i];</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>worst<sp/>=<sp/>idx_scratch[0];</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;=<sp/>logits[worst])<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[0]<sp/>=<sp/>(uint32_t)i;</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>j<sp/>=<sp/>1;<sp/>j<sp/>&lt;<sp/>sel_n;<sp/>++j)<sp/>{</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>a<sp/>=<sp/>idx_scratch[j<sp/>-<sp/>1];</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>b<sp/>=<sp/>idx_scratch[j];</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(logits[a]<sp/>&lt;=<sp/>logits[b])<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[j<sp/>-<sp/>1]<sp/>=<sp/>b;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[j]<sp/>=<sp/>a;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="406"><highlight class="normal"></highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>maxl<sp/>=<sp/>-INFINITY;</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sel_n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>logits[idx_scratch[i]]<sp/>/<sp/>cfg.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref>;</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>maxl)<sp/>maxl<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sel_n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>(logits[idx_scratch[i]]<sp/>/<sp/>cfg.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref>)<sp/>-<sp/>maxl;</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>prob_scratch[i]<sp/>=<sp/><ref refid="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" kindref="member">safe_exp</ref>(v);</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sampling_8c_1a1584537ca7c8337f38aae35204cceded" kindref="member">softmax_inplace</ref>(prob_scratch,<sp/>sel_n);</highlight></codeline>
<codeline lineno="417"><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/><ref refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" kindref="member">sample_from_probs</ref>(prob_scratch,<sp/>idx_scratch,<sp/>sel_n,<sp/>rng);</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>{</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>topk(k=%u<sp/>sel=%u)<sp/>-&gt;<sp/>id=%u<sp/>logit=%.6g\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)k,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)sel_n,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)logits[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="427"><highlight class="normal"></highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" kindref="member">kind</ref><sp/>==<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" kindref="member">IE_SAMPLE_TOPP</ref>)<sp/>{</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>maxl<sp/>=<sp/>-INFINITY;</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>&amp;&amp;<sp/>i<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>logits[i]<sp/>/<sp/>cfg.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref>;</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>maxl)<sp/>maxl<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>sum<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>&amp;&amp;<sp/>i<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prob_scratch[i]<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>(logits[i]<sp/>/<sp/>cfg.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref>)<sp/>-<sp/>maxl;</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>e<sp/>=<sp/><ref refid="sampling_8c_1a41cae7a59e74c1f5f32ec9fb49ae04bd" kindref="member">safe_exp</ref>(v);</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>prob_scratch[i]<sp/>=<sp/>e;</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>sum<sp/>+=<sp/>e;</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sum<sp/>&lt;=<sp/>0.0f)<sp/>{</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/><ref refid="sampling_8c_1a776b68b53dd397766e7683515bf4cc18" kindref="member">argmax_logits</ref>(logits,<sp/>vocab_size,<sp/>cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref>);</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>{</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>topp<sp/>-&gt;<sp/>degenerate<sp/>sum,<sp/>fallback<sp/>greedy<sp/>id=%u\n&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>1.0f<sp/>/<sp/>sum;</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size;<sp/>++i)<sp/>prob_scratch[i]<sp/>*=<sp/>inv;</highlight></codeline>
<codeline lineno="457"><highlight class="normal"></highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nidx<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>vocab_size;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>&amp;&amp;<sp/>i<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch[nidx++]<sp/>=<sp/>(uint32_t)i;</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sampling_8c_1a661598ee23a4d0b4029da20362f4e7c3" kindref="member">sort_desc_by_prob</ref>(idx_scratch,<sp/>prob_scratch,<sp/>nidx);</highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>cum<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cut<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>cut<sp/>&lt;<sp/>nidx;<sp/>++cut)<sp/>{</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>cum<sp/>+=<sp/>prob_scratch[idx_scratch[cut]];</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cum<sp/>&gt;=<sp/>cfg.<ref refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" kindref="member">top_p</ref>)<sp/>{</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++cut;</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cut<sp/>==<sp/>0)<sp/>cut<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cut<sp/>&gt;<sp/>nidx)<sp/>cut<sp/>=<sp/>nidx;</highlight></codeline>
<codeline lineno="476"><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>local_sum<sp/>=<sp/>0.0f;</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>cut;<sp/>++i)<sp/>local_sum<sp/>+=<sp/>prob_scratch[idx_scratch[i]];</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(local_sum<sp/>&lt;=<sp/>0.0f)<sp/>{</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>idx_scratch[0];</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>topp<sp/>-&gt;<sp/>degenerate<sp/>local_sum,<sp/>id=%u\n&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)*out_id);</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>linv<sp/>=<sp/>1.0f<sp/>/<sp/>local_sum;</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>cut;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>prob_scratch[i]<sp/>=<sp/>prob_scratch[idx_scratch[i]]<sp/>*<sp/>linv;</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="488"><highlight class="normal"></highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/><ref refid="sampling_8c_1aaf8e1b44450a7dcc300cef34104a7027" kindref="member">sample_from_probs</ref>(prob_scratch,<sp/>idx_scratch,<sp/>cut,<sp/>rng);</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="491"><highlight class="normal"></highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sampling_8c_1a3168b2367b9d5e3aaea486b13c7e77a4" kindref="member">sampling_trace_allow</ref>())<sp/>{</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;[sampling]<sp/>topp(p=%.6g<sp/>cut=%zu<sp/>cum=%.6g)<sp/>-&gt;<sp/>id=%u<sp/>logit=%.6g\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)cfg.<ref refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" kindref="member">top_p</ref>,<sp/>cut,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)cum,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)logits[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">]);</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="498"><highlight class="normal"></highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="500"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="engine/src/runtime/sampling.c"/>
  </compounddef>
</doxygen>
