<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="generate__gptoss_8c" kind="file" language="C++">
    <compoundname>generate_gptoss.c</compoundname>
    <includes refid="generate__gptoss_8h" local="yes">generate_gptoss.h</includes>
    <includes local="no">stdlib.h</includes>
    <includes local="no">string.h</includes>
    <includes refid="gptoss__hparams_8h" local="yes">gptoss_hparams.h</includes>
    <includes refid="ie__kv__cache_8h" local="yes">ie_kv_cache.h</includes>
    <includes refid="ie__sampling_8h" local="yes">ie_sampling.h</includes>
    <includes refid="ie__tokenizer__gptoss_8h" local="yes">ie_tokenizer_gptoss.h</includes>
    <incdepgraph>
      <node id="2">
        <label>generate_gptoss.h</label>
        <link refid="generate__gptoss_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="14">
        <label>gptoss_hparams.h</label>
        <link refid="gptoss__hparams_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>ie_device.h</label>
        <link refid="ie__device_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="6">
        <label>ie_infer.h</label>
        <link refid="ie__infer_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="7">
        <label>ie_io.h</label>
        <link refid="ie__io_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="8">
        <label>ie_kv_cache.h</label>
        <link refid="ie__kv__cache_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
      </node>
      <node id="9">
        <label>ie_quant_act.h</label>
        <link refid="ie__quant__act_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>ie_sampling.h</label>
        <link refid="ie__sampling_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="11">
        <label>ie_tokenizer_gptoss.h</label>
        <link refid="ie__tokenizer__gptoss_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>engine/src/runtime/generate_gptoss.c</label>
        <link refid="generate__gptoss_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>stddef.h</label>
      </node>
      <node id="4">
        <label>stdint.h</label>
      </node>
      <node id="12">
        <label>stdlib.h</label>
      </node>
      <node id="13">
        <label>string.h</label>
      </node>
    </incdepgraph>
    <sectiondef kind="func">
      <memberdef kind="function" id="generate__gptoss_8c_1aa39e9f771b76d28a0c53b6d123396ce8" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="ie__sampling_8h_1a69ef33c311c065f6caa2738715c6fc76" kindref="member">ie_sample_cfg_t</ref></type>
        <definition>ie_sample_cfg_t ie_default_sample_cfg</definition>
        <argsstring>(void)</argsstring>
        <name>ie_default_sample_cfg</name>
        <param>
          <type>void</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/generate_gptoss.c" line="20" column="17" bodyfile="engine/src/runtime/generate_gptoss.c" bodystart="20" bodyend="29"/>
        <references refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" compoundref="ie__sampling_8h" startline="57">ie_sample_cfg_s::disallow_token0</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" compoundref="ie__sampling_8h" startline="39">IE_SAMPLE_TOPP</references>
        <references refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" compoundref="ie__sampling_8h" startline="45">ie_sample_cfg_s::kind</references>
        <references refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" compoundref="ie__sampling_8h" startline="48">ie_sample_cfg_s::temperature</references>
        <references refid="structie__sample__cfg__s_1a42a99f4e9a2514a58dd34aac41cc7ffd" compoundref="ie__sampling_8h" startline="51">ie_sample_cfg_s::top_k</references>
        <references refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" compoundref="ie__sampling_8h" startline="54">ie_sample_cfg_s::top_p</references>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void ie_free_ptr</definition>
        <argsstring>(void **p)</argsstring>
        <name>ie_free_ptr</name>
        <param>
          <type>void **</type>
          <declname>p</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/generate_gptoss.c" line="31" column="13" bodyfile="engine/src/runtime/generate_gptoss.c" bodystart="31" bodyend="36"/>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
      <memberdef kind="function" id="generate__gptoss_8c_1a69606d6441b5c86670cfcc955721a308" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_generate_gptoss</definition>
        <argsstring>(const ie_device_t *dev, const ie_weights_t *weights, const char *model_dir, const ie_tok_gptoss_t *tok, const char *prompt, uint32_t max_new, const ie_sample_cfg_t *cfg, uint64_t seed, int *out_ids, uint32_t *out_count)</argsstring>
        <name>ie_generate_gptoss</name>
        <param>
          <type>const <ref refid="ie__device_8h_1a7c50deaca4d796966353da1769279628" kindref="member">ie_device_t</ref> *</type>
          <declname>dev</declname>
        </param>
        <param>
          <type>const <ref refid="ie__io_8h_1af68ad3cdc2eb244fe4feed94372d7806" kindref="member">ie_weights_t</ref> *</type>
          <declname>w</declname>
          <defname>weights</defname>
        </param>
        <param>
          <type>const char *</type>
          <declname>model_dir</declname>
        </param>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>prompt</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>max_new</declname>
        </param>
        <param>
          <type>const <ref refid="ie__sampling_8h_1a69ef33c311c065f6caa2738715c6fc76" kindref="member">ie_sample_cfg_t</ref> *</type>
          <declname>sample_cfg</declname>
          <defname>cfg</defname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>seed</declname>
        </param>
        <param>
          <type>int *</type>
          <declname>out_tokens</declname>
          <defname>out_ids</defname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_n_tokens</declname>
          <defname>out_count</defname>
        </param>
        <briefdescription>
<para>Generate up to <computeroutput>max_new</computeroutput> tokens for a prompt string using GPT-OSS. </para>
        </briefdescription>
        <detaileddescription>
<para>This function performs: 1) Load minimal hyperparameters from <computeroutput>model_dir/config.json</computeroutput>. 2) Encode <computeroutput>prompt</computeroutput> into token IDs using <computeroutput>tok</computeroutput>. 3) Create an inference context via <ref refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" kindref="member">ie_gptoss_infer_create()</ref>. 4) Allocate a KV cache sized from hyperparameters. 5) Run prefill over the prompt, then step+sample to generate new tokens.</para>
<para>The generation loop is:<itemizedlist>
<listitem><para>logits = prefill(prompt)</para>
</listitem><listitem><para>repeat max_new: next = sample(logits) out_tokens[i] = next logits = step(next)</para>
</listitem></itemizedlist>
</para>
<para>Requirements:<itemizedlist>
<listitem><para><computeroutput>tok</computeroutput> must be a valid tokenizer handle capable of encoding the prompt.</para>
</listitem><listitem><para>Real inference must exist in ie_gptoss_infer_prefill/step.</para>
</listitem></itemizedlist>
</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>dev</parametername>
</parameternamelist>
<parameterdescription>
<para>Device backend handle (required). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>w</parametername>
</parameternamelist>
<parameterdescription>
<para>Loaded weights handle (required). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>model_dir</parametername>
</parameternamelist>
<parameterdescription>
<para>Model directory containing config.json (required). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>tok</parametername>
</parameternamelist>
<parameterdescription>
<para>Tokenizer handle opened from tokenizer.json (required). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>prompt</parametername>
</parameternamelist>
<parameterdescription>
<para>UTF-8 prompt string (non-NULL; may be empty). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>max_new</parametername>
</parameternamelist>
<parameterdescription>
<para>Maximum number of tokens to generate. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>sample_cfg</parametername>
</parameternamelist>
<parameterdescription>
<para>Sampling configuration (may be NULL for defaults). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>seed</parametername>
</parameternamelist>
<parameterdescription>
<para>RNG seed (0 is remapped to a non-zero value). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_tokens</parametername>
</parameternamelist>
<parameterdescription>
<para>Output buffer (length at least <computeroutput>max_new</computeroutput> when <computeroutput>max_new</computeroutput> &gt; 0). </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out_n_tokens</parametername>
</parameternamelist>
<parameterdescription>
<para>Receives number of generated tokens. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Status code from <ref refid="generate__gptoss_8h_1a39f1bd92283c342330bb64fc42d6c9d9" kindref="member">ie_generate_gptoss_status_t</ref>. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/runtime/generate_gptoss.c" line="38" column="5" bodyfile="engine/src/runtime/generate_gptoss.c" bodystart="38" bodyend="213"/>
        <references refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" compoundref="ie__infer_8h" startline="46">ie_gptoss_hparams::d_head</references>
        <references refid="structie__kv__opts_1ad52668c7f2e5bdc7adb8171947232077" compoundref="ie__kv__cache_8h" startline="112">ie_kv_opts::fp8_format</references>
        <references refid="gptoss__hparams_8h_1a551745dee25fc47e05d76c79791885a0" compoundref="gptoss__hparams_8c" startline="789" endline="798">gptoss_hparams_load</references>
        <references refid="structie__kv__opts_1acea5bf28709f714eb88a85719fa58f9f" compoundref="ie__kv__cache_8h" startline="94">ie_kv_opts::group_size</references>
        <references refid="structie__kv__opts_1a8b9255f78606b76462a20157c24c2bda" compoundref="ie__kv__cache_8h" startline="80">ie_kv_opts::head_dim</references>
        <references refid="structie__kv__opts_1a60291f6cf5954a7d16fdaf981ddf9e7a" compoundref="ie__kv__cache_8h" startline="78">ie_kv_opts::heads</references>
        <references refid="generate__gptoss_8c_1aa39e9f771b76d28a0c53b6d123396ce8" compoundref="generate__gptoss_8c" startline="20" endline="29">ie_default_sample_cfg</references>
        <references refid="ie__quant__act_8h_1a67a1bdaa8281d1c69b6b76ecba79c52ca67cfe56fcb473bed9a2f92388f2fc347" compoundref="ie__quant__act_8h" startline="28">IE_FP8_E4M3</references>
        <references refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" compoundref="generate__gptoss_8c" startline="31" endline="36">ie_free_ptr</references>
        <references refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" compoundref="infer__gptoss_8c" startline="1700" endline="2290">ie_gptoss_infer_create</references>
        <references refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" compoundref="infer__gptoss_8c" startline="2292" endline="2335">ie_gptoss_infer_destroy</references>
        <references refid="ie__infer_8h_1a39827a388a0b7dd6d161e99b111c5546" compoundref="infer__gptoss_8c" startline="2337" endline="2363">ie_gptoss_infer_prefill</references>
        <references refid="ie__infer_8h_1a52a0e33daf64ca5524b6440cecc8d2f6" compoundref="infer__gptoss_8c" startline="2365" endline="2380">ie_gptoss_infer_step</references>
        <references refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" compoundref="kv__cache_8c" startline="483" endline="490">ie_kv_free_layers</references>
        <references refid="ie__kv__cache_8h_1ab44456fc4842c15b2091f0a059e06584" compoundref="kv__cache_8c" startline="411" endline="453">ie_kv_init_layers</references>
        <references refid="ie__kv__cache_8h_1a2bb962f9a31709cc159ccb5f8c8f2fe7a4fa6c4868332a5127755fdee56404f54" compoundref="ie__kv__cache_8h" startline="66">IE_KV_STORAGE_F32</references>
        <references refid="ie__sampling_8h_1a2bab94d0c686c57c4437867f4c18583f" compoundref="sampling_8c" startline="136" endline="139">ie_rng_init</references>
        <references refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" compoundref="ie__sampling_8h" startline="37">IE_SAMPLE_GREEDY</references>
        <references refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" compoundref="sampling_8c" startline="326" endline="500">ie_sample_next</references>
        <references refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</references>
        <references refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" compoundref="ie__infer_8h" startline="49">ie_gptoss_hparams::max_seq</references>
        <references refid="structie__kv__opts_1ad9dcb92aedeedbeddfbde834d4395421" compoundref="ie__kv__cache_8h" startline="82">ie_kv_opts::max_seq</references>
        <references refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" compoundref="ie__infer_8h" startline="43">ie_gptoss_hparams::n_heads</references>
        <references refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" compoundref="ie__infer_8h" startline="44">ie_gptoss_hparams::n_kv_heads</references>
        <references refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" compoundref="ie__infer_8h" startline="42">ie_gptoss_hparams::n_layers</references>
        <references refid="structie__kv__opts_1ac4e52133d322b3da023a242cab67fb7f" compoundref="ie__kv__cache_8h" startline="85">ie_kv_opts::storage</references>
        <references refid="structie__kv__opts_1ab68941f4eda9ed79513f35321c3e3ee1" compoundref="ie__kv__cache_8h" startline="104">ie_kv_opts::symmetric</references>
        <references refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" compoundref="ie__infer_8h" startline="48">ie_gptoss_hparams::vocab_size</references>
      </memberdef>
    </sectiondef>
    <briefdescription>
<para>Convenience token generation wrapper for the GPT-OSS forward pass. </para>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>File:<sp/>engine/src/runtime/generate_gptoss.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*/</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="generate__gptoss_8h" kindref="compound">generate_gptoss.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdlib.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="gptoss__hparams_8h" kindref="compound">gptoss_hparams.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__kv__cache_8h" kindref="compound">ie_kv_cache.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__sampling_8h" kindref="compound">ie_sampling.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__tokenizer__gptoss_8h" kindref="compound">ie_tokenizer_gptoss.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20" refid="generate__gptoss_8c_1aa39e9f771b76d28a0c53b6d123396ce8" refkind="member"><highlight class="normal"><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/><ref refid="generate__gptoss_8c_1aa39e9f771b76d28a0c53b6d123396ce8" kindref="member">ie_default_sample_cfg</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>c;</highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/>memset(&amp;c,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(c));</highlight></codeline>
<codeline lineno="23"><highlight class="normal"><sp/><sp/>c.<ref refid="structie__sample__cfg__s_1a2321436097d66e220ae325700ef29a2a" kindref="member">kind</ref><sp/>=<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646afadedf0e7e6e0143704a56c75be9a02b" kindref="member">IE_SAMPLE_TOPP</ref>;</highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/>c.<ref refid="structie__sample__cfg__s_1aaf70bc926e9df01a892510cfaf614b45" kindref="member">temperature</ref><sp/>=<sp/>1.0f;</highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/>c.<ref refid="structie__sample__cfg__s_1a42a99f4e9a2514a58dd34aac41cc7ffd" kindref="member">top_k</ref><sp/>=<sp/>40u;</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/>c.<ref refid="structie__sample__cfg__s_1aef0de38cb7fe0c32693bb498134aa504" kindref="member">top_p</ref><sp/>=<sp/>0.95f;</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/>c.<ref refid="structie__sample__cfg__s_1a4dbc31cfcd9414be62086964bf31d0ec" kindref="member">disallow_token0</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>c;</highlight></codeline>
<codeline lineno="29"><highlight class="normal">}</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight></codeline>
<codeline lineno="31" refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**p)<sp/>{</highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(p<sp/>&amp;&amp;<sp/>*p)<sp/>{</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/>free(*p);</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/>*p<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="36"><highlight class="normal">}</highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight></codeline>
<codeline lineno="38" refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="generate__gptoss_8c_1a69606d6441b5c86670cfcc955721a308" kindref="member">ie_generate_gptoss</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__device" kindref="compound">ie_device_t</ref><sp/>*dev,</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__weights__s" kindref="compound">ie_weights_t</ref><sp/>*weights,</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*model_dir,</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*prompt,</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>max_new,</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>*cfg,</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>seed,</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>*out_ids,</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*out_count)</highlight></codeline>
<codeline lineno="48"><highlight class="normal">{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out_count)<sp/>*out_count<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!dev<sp/>||<sp/>!weights<sp/>||<sp/>!model_dir<sp/>||<sp/>!tok<sp/>||<sp/>!prompt<sp/>||<sp/>!out_ids<sp/>||<sp/>!out_count)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(max_new<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><ref refid="structie__gptoss__hparams" kindref="compound">ie_gptoss_hparams_t</ref><sp/>hp;</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/>memset(&amp;hp,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(hp));</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="gptoss__hparams_8h_1a551745dee25fc47e05d76c79791885a0" kindref="member">gptoss_hparams_load</ref>(model_dir,<sp/>&amp;hp)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-2;</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Encode<sp/>the<sp/>prompt.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/>uint32_t<sp/>prompt_n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" kindref="member">ie_tok_gptoss_encode</ref>(tok,<sp/>prompt,<sp/>NULL,<sp/>&amp;prompt_n)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-3;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prompt_n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-4;</highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/>uint32_t<sp/>*prompt_ids<sp/>=<sp/>(uint32_t<sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)prompt_n<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(uint32_t));</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!prompt_ids)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-5;</highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>tmp<sp/>=<sp/>prompt_n;</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" kindref="member">ie_tok_gptoss_encode</ref>(tok,<sp/>prompt,<sp/>prompt_ids,<sp/>&amp;tmp)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-6;</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/>prompt_n<sp/>=<sp/>tmp;</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prompt_n<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-7;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>Create<sp/>inference<sp/>context.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><ref refid="ie__infer_8h_1ae16ad2f170ebb9e079cb3f6d9dc99daf" kindref="member">ie_gptoss_infer_t</ref><sp/>*inf<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__infer_8h_1a569ac499d7bce188c1e21fa9377b9bae" kindref="member">ie_gptoss_infer_create</ref>(dev,<sp/>weights,<sp/>&amp;hp,<sp/>&amp;inf)<sp/>!=<sp/>0<sp/>||<sp/>!inf)<sp/>{</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-8;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>KV<sp/>cache:<sp/>one<sp/>layer<sp/>object<sp/>per<sp/>transformer<sp/>layer.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>n_layers<sp/>=<sp/>(hp.<ref refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" kindref="member">n_layers</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>(uint32_t)hp.<ref refid="structie__gptoss__hparams_1a9f7592ff0ef97a90e4bf510d7323c1e2" kindref="member">n_layers</ref><sp/>:<sp/>0u;</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n_layers<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-9;</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*kv<sp/>=<sp/>(<ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref><sp/>*)calloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n_layers,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="structie__kv__cache" kindref="compound">ie_kv_cache</ref>));</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!kv)<sp/>{</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-10;</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><ref refid="structie__kv__opts" kindref="compound">ie_kv_opts</ref><sp/>kv_opts;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/>memset(&amp;kv_opts,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(kv_opts));</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1ad9dcb92aedeedbeddfbde834d4395421" kindref="member">max_seq</ref><sp/>=<sp/>(uint32_t)((hp.<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>hp.<ref refid="structie__gptoss__hparams_1aab0c01be581031776f5fa61bbb10de24" kindref="member">max_seq</ref><sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1a60291f6cf5954a7d16fdaf981ddf9e7a" kindref="member">heads</ref><sp/>=<sp/>(uint32_t)((hp.<ref refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" kindref="member">n_kv_heads</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>hp.<ref refid="structie__gptoss__hparams_1a89acca54a15e45183b174270c137d5ca" kindref="member">n_kv_heads</ref><sp/>:<sp/>hp.<ref refid="structie__gptoss__hparams_1a5176af7af6c6d8a4c516f7ec1e6be202" kindref="member">n_heads</ref>);</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1a8b9255f78606b76462a20157c24c2bda" kindref="member">head_dim</ref><sp/>=<sp/>(uint32_t)((hp.<ref refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" kindref="member">d_head</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>hp.<ref refid="structie__gptoss__hparams_1aa4bcfd3715e6fbd18bf3bbad86e017da" kindref="member">d_head</ref><sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1ac4e52133d322b3da023a242cab67fb7f" kindref="member">storage</ref><sp/>=<sp/><ref refid="ie__kv__cache_8h_1a2bb962f9a31709cc159ccb5f8c8f2fe7a4fa6c4868332a5127755fdee56404f54" kindref="member">IE_KV_STORAGE_F32</ref>;</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1acea5bf28709f714eb88a85719fa58f9f" kindref="member">group_size</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1ab68941f4eda9ed79513f35321c3e3ee1" kindref="member">symmetric</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/>kv_opts.<ref refid="structie__kv__opts_1ad52668c7f2e5bdc7adb8171947232077" kindref="member">fp8_format</ref><sp/>=<sp/><ref refid="ie__quant__act_8h_1a67a1bdaa8281d1c69b6b76ecba79c52ca67cfe56fcb473bed9a2f92388f2fc347" kindref="member">IE_FP8_E4M3</ref>;</highlight></codeline>
<codeline lineno="111"><highlight class="normal"></highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__kv__cache_8h_1ab44456fc4842c15b2091f0a059e06584" kindref="member">ie_kv_init_layers</ref>(kv,<sp/>n_layers,<sp/>&amp;kv_opts)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-11;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>vocab<sp/>=<sp/>(size_t)((hp.<ref refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" kindref="member">vocab_size</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>hp.<ref refid="structie__gptoss__hparams_1a92d6a3ba26bf70874cd58b8aebfe688c" kindref="member">vocab_size</ref><sp/>:<sp/>0);</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vocab<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-12;</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*logits<sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(vocab<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!logits)<sp/>{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-13;</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="137"><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__infer_8h_1a39827a388a0b7dd6d161e99b111c5546" kindref="member">ie_gptoss_infer_prefill</ref>(inf,<sp/>kv,<sp/>prompt_ids,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)prompt_n,<sp/>logits)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;logits);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-14;</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><ref refid="structie__rng__s" kindref="compound">ie_rng_t</ref><sp/>rng;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><ref refid="ie__sampling_8h_1a2bab94d0c686c57c4437867f4c18583f" kindref="member">ie_rng_init</ref>(&amp;rng,<sp/>(seed<sp/>==<sp/>0)<sp/>?<sp/>1u<sp/>:<sp/>seed);</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><ref refid="structie__sample__cfg__s" kindref="compound">ie_sample_cfg_t</ref><sp/>local_cfg;</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cfg)<sp/>{</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/>local_cfg<sp/>=<sp/>*cfg;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/>local_cfg<sp/>=<sp/><ref refid="generate__gptoss_8c_1aa39e9f771b76d28a0c53b6d123396ce8" kindref="member">ie_default_sample_cfg</ref>();</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/>uint32_t<sp/>*idx_scratch<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*prob_scratch<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(local_cfg.kind<sp/>!=<sp/><ref refid="ie__sampling_8h_1abf8ae91c0890e964abdfa5b739eb0646abf8a031706d18e2e447fdf23fbcf56b1" kindref="member">IE_SAMPLE_GREEDY</ref>)<sp/>{</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/>idx_scratch<sp/>=<sp/>(uint32_t<sp/>*)malloc(vocab<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(uint32_t));</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/>prob_scratch<sp/>=<sp/>(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>*)malloc(vocab<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">float</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!idx_scratch<sp/>||<sp/>!prob_scratch)<sp/>{</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prob_scratch);</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;idx_scratch);</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;logits);</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-15;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/>uint32_t<sp/>produced<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>max_new;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>next_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__sampling_8h_1a8c38dab715a10a71aa4e5a049199f73c" kindref="member">ie_sample_next</ref>(logits,</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vocab,</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;local_cfg,</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;rng,</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx_scratch,</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prob_scratch,</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vocab,</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;next_id)<sp/>!=<sp/>0)</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>rc<sp/>=<sp/>-16;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/>out_ids[produced]<sp/>=<sp/>(int)next_id;</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/>produced++;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="ie__infer_8h_1a52a0e33daf64ca5524b6440cecc8d2f6" kindref="member">ie_gptoss_infer_step</ref>(inf,<sp/>kv,<sp/>next_id,<sp/>logits)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>rc<sp/>=<sp/>-17;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/>*out_count<sp/>=<sp/>produced;</highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prob_scratch);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;idx_scratch);</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;logits);</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><ref refid="ie__kv__cache_8h_1a555aaa1e797b4ef229ad911a7a6ee8b5" kindref="member">ie_kv_free_layers</ref>(kv,<sp/>n_layers);</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;kv);</highlight></codeline>
<codeline lineno="208"><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><ref refid="ie__infer_8h_1a89e8a91978217f16a8c9ef4adae46048" kindref="member">ie_gptoss_infer_destroy</ref>(inf);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><ref refid="generate__gptoss_8c_1a4d9929d191c8a96c98738ebd878ca63e" kindref="member">ie_free_ptr</ref>((</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>**)&amp;prompt_ids);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"></highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="213"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="engine/src/runtime/generate_gptoss.c"/>
  </compounddef>
</doxygen>
