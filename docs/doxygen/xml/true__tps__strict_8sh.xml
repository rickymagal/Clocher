<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="true__tps__strict_8sh" kind="file" language="C++">
    <compoundname>true_tps_strict.sh</compoundname>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline><highlight class="normal">#!/usr/bin/env<sp/>bash</highlight></codeline>
<codeline><highlight class="normal">set<sp/>-euo<sp/>pipefail</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">#<sp/>Required<sp/>env:</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>ENGINE_BIN,<sp/>DEVICE,<sp/>MODEL_DIR,<sp/>PROMPTS</highlight></codeline>
<codeline><highlight class="normal">#<sp/>Optional<sp/>env<sp/>(with<sp/>defaults):</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>THREADS,<sp/>PRECISION,<sp/>BATCH,<sp/>PREFETCH,<sp/>PRETRANSPOSE,<sp/>AFFINITY,<sp/>MAX_NEW</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>IE_REQUIRE_MODEL,<sp/>IE_BYTES_PER_TOKEN,<sp/>IE_STRIDE_BYTES,<sp/>IE_VERIFY_TOUCH</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>IE_DEDUP,<sp/>IE_DEDUP_STRICT,<sp/>IE_DEDUP_POLICY,<sp/>IE_DEDUP_CACHE_MB</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>RUNS,<sp/>ROUNDS</highlight></codeline>
<codeline><highlight class="normal">#</highlight></codeline>
<codeline><highlight class="normal">#<sp/>Output:</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/>JSONL<sp/>to<sp/>stdout:</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/><sp/><sp/>-<sp/>RUNS<sp/>per-run<sp/>JSON<sp/>objects<sp/>(engine<sp/>JSON<sp/>+<sp/>injected<sp/>metrics)</highlight></codeline>
<codeline><highlight class="normal">#<sp/><sp/><sp/><sp/><sp/>-<sp/>1<sp/>final<sp/>summary<sp/>JSON<sp/>object</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">:<sp/>&quot;${ENGINE_BIN:?set<sp/>ENGINE_BIN=/abs/path/to/engine}&quot;</highlight></codeline>
<codeline><highlight class="normal">:<sp/>&quot;${DEVICE:?set<sp/>DEVICE=cpu|cuda}&quot;</highlight></codeline>
<codeline><highlight class="normal">:<sp/>&quot;${MODEL_DIR:?set<sp/>MODEL_DIR=/abs/path/to/model}&quot;</highlight></codeline>
<codeline><highlight class="normal">:<sp/>&quot;${PROMPTS:?set<sp/>PROMPTS=/abs/path/to/prompts.txt}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">THREADS=&quot;${THREADS:-$(nproc)}&quot;</highlight></codeline>
<codeline><highlight class="normal">PRECISION=&quot;${PRECISION:-fp32}&quot;</highlight></codeline>
<codeline><highlight class="normal">BATCH=&quot;${BATCH:-1}&quot;</highlight></codeline>
<codeline><highlight class="normal">PREFETCH=&quot;${PREFETCH:-auto}&quot;</highlight></codeline>
<codeline><highlight class="normal">PRETRANSPOSE=&quot;${PRETRANSPOSE:-all}&quot;</highlight></codeline>
<codeline><highlight class="normal">AFFINITY=&quot;${AFFINITY:-auto}&quot;</highlight></codeline>
<codeline><highlight class="normal">MAX_NEW=&quot;${MAX_NEW:-128}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">IE_REQUIRE_MODEL=&quot;${IE_REQUIRE_MODEL:-1}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_BYTES_PER_TOKEN=&quot;${IE_BYTES_PER_TOKEN:-67108864}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_STRIDE_BYTES=&quot;${IE_STRIDE_BYTES:-256}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_VERIFY_TOUCH=&quot;${IE_VERIFY_TOUCH:-1}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">IE_DEDUP=&quot;${IE_DEDUP:-0}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_DEDUP_STRICT=&quot;${IE_DEDUP_STRICT:-0}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_DEDUP_POLICY=&quot;${IE_DEDUP_POLICY:-lossless}&quot;</highlight></codeline>
<codeline><highlight class="normal">IE_DEDUP_CACHE_MB=&quot;${IE_DEDUP_CACHE_MB:-0}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">RUNS=&quot;${RUNS:-3}&quot;</highlight></codeline>
<codeline><highlight class="normal">ROUNDS=&quot;${ROUNDS:-1}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">case<sp/>&quot;${PRECISION}&quot;<sp/>in</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fp32|bf16|int8|int4)<sp/>CLI_PREC=&quot;${PRECISION}&quot;<sp/>;;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>int4w)<sp/>CLI_PREC=&quot;int4&quot;<sp/>;;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>*)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>CLI_PREC=&quot;fp32&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;WARN:<sp/>unknown<sp/>PRECISION<sp/>&apos;${PRECISION}&apos;,<sp/>defaulting<sp/>CLI<sp/>to<sp/>fp32&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>;;</highlight></codeline>
<codeline><highlight class="normal">esac</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">export<sp/>IE_REQUIRE_MODEL<sp/>IE_BYTES_PER_TOKEN<sp/>IE_STRIDE_BYTES<sp/>IE_VERIFY_TOUCH</highlight></codeline>
<codeline><highlight class="normal">export<sp/>IE_DEDUP<sp/>IE_DEDUP_STRICT<sp/>IE_DEDUP_POLICY<sp/>IE_DEDUP_CACHE_MB</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">_tmpdir=&quot;$(mktemp<sp/>-d)&quot;</highlight></codeline>
<codeline><highlight class="normal">cleanup()<sp/>{<sp/>rm<sp/>-rf<sp/>&quot;${_tmpdir}&quot;;<sp/>}</highlight></codeline>
<codeline><highlight class="normal">trap<sp/>cleanup<sp/>EXIT</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">page_size_bytes=&quot;$(getconf<sp/>PAGESIZE<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>4096)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">read_vmstat_swaps()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>awk<sp/>&apos;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$1==&quot;pswpin&quot;<sp/><sp/>{in=$2}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$1==&quot;pswpout&quot;<sp/>{out=$2}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>END<sp/>{<sp/>if(in==&quot;&quot;)<sp/>in=0;<sp/>if(out==&quot;&quot;)<sp/>out=0;<sp/>print<sp/>in,<sp/>out<sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&apos;<sp/>/proc/vmstat<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>&quot;0<sp/>0&quot;</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">stat_bytes_or_empty()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>p=&quot;$1&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>-e<sp/>&quot;${p}&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>stat<sp/>-c<sp/>&apos;%s&apos;<sp/>&quot;${p}&quot;<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>&quot;&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>else</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">#<sp/>---------------------------------</highlight></codeline>
<codeline><highlight class="normal">#<sp/>CUDA<sp/>guard</highlight></codeline>
<codeline><highlight class="normal">#<sp/>---------------------------------</highlight></codeline>
<codeline><highlight class="normal">CUDA_GUARD=&quot;${CUDA_GUARD:-1}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">cuda_guard_preflight()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${DEVICE}&quot;<sp/>!=<sp/>&quot;cuda&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${CUDA_GUARD}&quot;<sp/>==<sp/>&quot;0&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>WARN:<sp/>CUDA_GUARD=0;<sp/>skipping<sp/>CUDA<sp/>validity<sp/>guard&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>!<sp/>command<sp/>-v<sp/>nvidia-smi<sp/>&gt;/dev/null<sp/>2&gt;&amp;1;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>ERROR:<sp/>DEVICE=cuda<sp/>but<sp/>nvidia-smi<sp/>is<sp/>not<sp/>available.&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>exit<sp/>97</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>!<sp/>nvidia-smi<sp/>-L<sp/>&gt;/dev/null<sp/>2&gt;&amp;1;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>ERROR:<sp/>DEVICE=cuda<sp/>but<sp/>nvidia-smi<sp/>cannot<sp/>see<sp/>a<sp/>GPU/driver.&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>exit<sp/>98</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>command<sp/>-v<sp/>strace<sp/>&gt;/dev/null<sp/>2&gt;&amp;1;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>local<sp/>trace=&quot;${_tmpdir}/cuda_preflight.trace&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>local<sp/>out=&quot;${_tmpdir}/cuda_preflight.out&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>local<sp/>pf_max_new=8</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>local<sp/>pf_rounds=1</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>set<sp/>+e</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>strace<sp/>-f<sp/>-e<sp/>trace=openat,ioctl<sp/>-o<sp/>&quot;${trace}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&quot;${ENGINE_BIN}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--device<sp/>cuda<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--model-dir<sp/>&quot;${MODEL_DIR}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--prompts-file<sp/>&quot;${PROMPTS}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--threads<sp/>1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--precision<sp/>&quot;${CLI_PREC}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--batch<sp/>1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--prefetch<sp/>&quot;${PREFETCH}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--pretranspose<sp/>&quot;${PRETRANSPOSE}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--affinity<sp/>&quot;${AFFINITY}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--max-new<sp/>&quot;${pf_max_new}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--rounds<sp/>&quot;${pf_rounds}&quot;<sp/>&gt;<sp/>&quot;${out}&quot;<sp/>2&gt;&amp;1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>local<sp/>rc=$?</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>set<sp/>-e</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>grep<sp/>-Eq<sp/>&apos;(/dev/nvidia|nvidiactl|nvidia-uvm|libcuda\.so)&apos;<sp/>&quot;${trace}&quot;;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>CUDA<sp/>guard:<sp/>NVIDIA<sp/>driver<sp/>activity<sp/>detected<sp/>(OK)&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>ERROR:<sp/>DEVICE=cuda<sp/>but<sp/>preflight<sp/>shows<sp/>NO<sp/>NVIDIA<sp/>driver<sp/>activity.&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>DEBUG:<sp/>trace=${trace}<sp/>out=${out}<sp/>rc=${rc}&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>exit<sp/>99</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>echo<sp/>&quot;[strict]<sp/>WARN:<sp/>strace<sp/>not<sp/>available;<sp/>skipping<sp/>strong<sp/>CUDA<sp/>guard&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">#<sp/>---------------------------------</highlight></codeline>
<codeline><highlight class="normal">#<sp/>CPU<sp/>guard<sp/>(portable):<sp/>verify<sp/>open(model.ie.bin)<sp/>+<sp/>mmap/read(fd)</highlight></codeline>
<codeline><highlight class="normal">#<sp/>---------------------------------</highlight></codeline>
<codeline><highlight class="normal">STRICT_CPU_GUARD=&quot;${STRICT_CPU_GUARD:-1}&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">cpu_guard_preflight()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${DEVICE}&quot;<sp/>!=<sp/>&quot;cpu&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${STRICT_CPU_GUARD}&quot;<sp/>==<sp/>&quot;0&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>WARN:<sp/>STRICT_CPU_GUARD=0;<sp/>skipping<sp/>CPU<sp/>preflight&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>!<sp/>command<sp/>-v<sp/>strace<sp/>&gt;/dev/null<sp/>2&gt;&amp;1;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>WARN:<sp/>strace<sp/>not<sp/>available;<sp/>skipping<sp/>CPU<sp/>preflight&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>trace=&quot;${_tmpdir}/cpu_preflight.trace&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>out=&quot;${_tmpdir}/cpu_preflight.out&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>set<sp/>+e</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>strace<sp/>-f<sp/>-e<sp/>trace=openat,mmap,read<sp/>-o<sp/>&quot;${trace}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;${ENGINE_BIN}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--device<sp/>cpu<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--model-dir<sp/>&quot;${MODEL_DIR}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--prompts-file<sp/>&quot;${PROMPTS}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--threads<sp/>1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--precision<sp/>&quot;${CLI_PREC}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--batch<sp/>1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--prefetch<sp/>&quot;${PREFETCH}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--pretranspose<sp/>&quot;${PRETRANSPOSE}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--affinity<sp/>&quot;${AFFINITY}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--max-new<sp/>1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>--rounds<sp/>1<sp/>&gt;<sp/>&quot;${out}&quot;<sp/>2&gt;&amp;1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>rc=$?</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>set<sp/>-e</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>#<sp/>Extract<sp/>FD(s)<sp/>from:<sp/>openat(...<sp/>&quot;model.ie.bin&quot;<sp/>...)<sp/>=<sp/>&lt;fd&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>#<sp/>POSIX<sp/>awk<sp/>only<sp/>(no<sp/>match(...,<sp/>...,<sp/>arr)).</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>fds</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fds=&quot;$(awk<sp/>&apos;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>/openat\(/<sp/>&amp;&amp;<sp/>/model\.ie\.bin&quot;/<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>n=split($0,<sp/>parts,<sp/>&quot;=&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(n<sp/>&lt;<sp/>2)<sp/>next</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fd=parts[n]</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>gsub(/^[[:space:]]+/,<sp/>&quot;&quot;,<sp/>fd)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>gsub(/[[:space:]]+$/,<sp/>&quot;&quot;,<sp/>fd)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(fd<sp/>~<sp/>/^[0-9]+$/)<sp/>print<sp/>fd</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&apos;<sp/>&quot;${trace}&quot;<sp/>|<sp/>sort<sp/>-n<sp/>|<sp/>uniq<sp/>|<sp/>tr<sp/>&apos;\n&apos;<sp/>&apos;<sp/>&apos;)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>-z<sp/>&quot;${fds//<sp/>}&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>ERROR:<sp/>CPU<sp/>preflight<sp/>did<sp/>not<sp/>open<sp/>model.ie.bin<sp/>(trace=${trace},<sp/>out=${out},<sp/>rc=${rc})&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>exit<sp/>91</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>ok=0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>for<sp/>fd<sp/>in<sp/>${fds};<sp/>do</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>grep<sp/>-Eq<sp/>&quot;mmap\\(.*,[[:space:]]*${fd}[[:space:]]*,[[:space:]]*[0-9]+&quot;<sp/>&quot;${trace}&quot;<sp/>||<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>grep<sp/>-Eq<sp/>&quot;read\\(${fd},&quot;<sp/>&quot;${trace}&quot;;<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>ok=1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>break</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>done</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${ok}&quot;<sp/>!=<sp/>&quot;1&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>ERROR:<sp/>CPU<sp/>preflight<sp/>opened<sp/>model.ie.bin<sp/>but<sp/>did<sp/>not<sp/>mmap/read<sp/>it<sp/>(fds=${fds})&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>echo<sp/>&quot;[strict]<sp/>DEBUG:<sp/>trace=${trace}<sp/>out=${out}<sp/>rc=${rc}&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>exit<sp/>92</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>echo<sp/>&quot;[strict]<sp/>CPU<sp/>preflight:<sp/>model.ie.bin<sp/>mmap/read<sp/>detected<sp/>(OK)&quot;<sp/>&gt;&amp;2</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>0</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">cuda_guard_preflight</highlight></codeline>
<codeline><highlight class="normal">cpu_guard_preflight</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">run_one()<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>run_idx=&quot;$1&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>out_raw=&quot;${_tmpdir}/run_${run_idx}.raw.txt&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>out_time=&quot;${_tmpdir}/run_${run_idx}.time.txt&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>sw_in0<sp/>sw_out0</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>read<sp/>-r<sp/>sw_in0<sp/>sw_out0<sp/>&lt;<sp/>&lt;(read_vmstat_swaps)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>(</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>cd<sp/>&quot;${MODEL_DIR}&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>/usr/bin/time<sp/>-v<sp/>-o<sp/>&quot;${out_time}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>&quot;${ENGINE_BIN}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--device<sp/>&quot;${DEVICE}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--model-dir<sp/>&quot;.&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--prompts-file<sp/>&quot;${PROMPTS}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--threads<sp/>&quot;${THREADS}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--precision<sp/>&quot;${CLI_PREC}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--batch<sp/>&quot;${BATCH}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--prefetch<sp/>&quot;${PREFETCH}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--pretranspose<sp/>&quot;${PRETRANSPOSE}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--affinity<sp/>&quot;${AFFINITY}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--max-new<sp/>&quot;${MAX_NEW}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--rounds<sp/>&quot;${ROUNDS}&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>)<sp/>&gt;<sp/>&quot;${out_raw}&quot;<sp/>2&gt;&amp;1</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>sw_in1<sp/>sw_out1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>read<sp/>-r<sp/>sw_in1<sp/>sw_out1<sp/>&lt;<sp/>&lt;(read_vmstat_swaps)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>sw_in_pages=&quot;$((sw_in1<sp/>-<sp/>sw_in0))&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>sw_out_pages=&quot;$((sw_out1<sp/>-<sp/>sw_out0))&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${sw_in_pages}&quot;<sp/>-lt<sp/>0<sp/>]];<sp/>then<sp/>sw_in_pages=0;<sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>&quot;${sw_out_pages}&quot;<sp/>-lt<sp/>0<sp/>]];<sp/>then<sp/>sw_out_pages=0;<sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>swap_in_mb<sp/>swap_out_mb</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>swap_in_mb=&quot;$(python3<sp/>-<sp/>&lt;&lt;PY</highlight></codeline>
<codeline><highlight class="normal">pages=${sw_in_pages}</highlight></codeline>
<codeline><highlight class="normal">psz=${page_size_bytes}</highlight></codeline>
<codeline><highlight class="normal">print((pages*psz)/1_000_000.0)</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">)&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>swap_out_mb=&quot;$(python3<sp/>-<sp/>&lt;&lt;PY</highlight></codeline>
<codeline><highlight class="normal">pages=${sw_out_pages}</highlight></codeline>
<codeline><highlight class="normal">psz=${page_size_bytes}</highlight></codeline>
<codeline><highlight class="normal">print((pages*psz)/1_000_000.0)</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>maxrss_kb<sp/>minflt<sp/>majflt</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>maxrss_kb=&quot;$(awk<sp/>-F:<sp/>&apos;/Maximum<sp/>resident<sp/>set<sp/>size/<sp/>{gsub(/^[<sp/>\t]+/,&quot;&quot;,$2);<sp/>print<sp/>$2;<sp/>exit}&apos;<sp/>&quot;${out_time}&quot;<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>0)&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>minflt=&quot;$(awk<sp/>-F:<sp/>&apos;/Minor<sp/>\(reclaiming<sp/>a<sp/>frame\)<sp/>page<sp/>faults/<sp/>{gsub(/^[<sp/>\t]+/,&quot;&quot;,$2);<sp/>print<sp/>$2;<sp/>exit}&apos;<sp/>&quot;${out_time}&quot;<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>0)&quot;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>majflt=&quot;$(awk<sp/>-F:<sp/>&apos;/Major<sp/>\(requiring<sp/>I\/O\)<sp/>page<sp/>faults/<sp/>{gsub(/^[<sp/>\t]+/,&quot;&quot;,$2);<sp/>print<sp/>$2;<sp/>exit}&apos;<sp/>&quot;${out_time}&quot;<sp/>2&gt;/dev/null<sp/>||<sp/>echo<sp/>0)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>-z<sp/>&quot;${maxrss_kb}&quot;<sp/>]];<sp/>then<sp/>maxrss_kb=0;<sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>-z<sp/>&quot;${minflt}&quot;<sp/>]];<sp/>then<sp/>minflt=0;<sp/>fi</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>if<sp/>[[<sp/>-z<sp/>&quot;${majflt}&quot;<sp/>]];<sp/>then<sp/>majflt=0;<sp/>fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>local<sp/>rss_peak_mb</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>rss_peak_mb=&quot;$(python3<sp/>-<sp/>&lt;&lt;PY</highlight></codeline>
<codeline><highlight class="normal">kb=${maxrss_kb}</highlight></codeline>
<codeline><highlight class="normal">print(kb/1024.0)</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>python3<sp/>-<sp/>&quot;${out_raw}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;${rss_peak_mb}&quot;<sp/>&quot;${minflt}&quot;<sp/>&quot;${majflt}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;${swap_in_mb}&quot;<sp/>&quot;${swap_out_mb}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;${MODEL_DIR}&quot;<sp/>&quot;${ENGINE_BIN}&quot;<sp/>&quot;${DEVICE}&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;${IE_DEDUP}&quot;<sp/>&quot;${IE_DEDUP_STRICT}&quot;<sp/>&quot;${IE_DEDUP_POLICY}&quot;<sp/>&quot;${IE_DEDUP_CACHE_MB}&quot;<sp/>&lt;&lt;&apos;PY&apos;</highlight></codeline>
<codeline><highlight class="normal">import<sp/>sys,<sp/>json</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">raw_path=sys.argv[1]</highlight></codeline>
<codeline><highlight class="normal">rss_peak=float(sys.argv[2])</highlight></codeline>
<codeline><highlight class="normal">minflt=int(float(sys.argv[3]))</highlight></codeline>
<codeline><highlight class="normal">majflt=int(float(sys.argv[4]))</highlight></codeline>
<codeline><highlight class="normal">swap_in=float(sys.argv[5])</highlight></codeline>
<codeline><highlight class="normal">swap_out=float(sys.argv[6])</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">model_dir=sys.argv[7]</highlight></codeline>
<codeline><highlight class="normal">engine_bin=sys.argv[8]</highlight></codeline>
<codeline><highlight class="normal">device=sys.argv[9]</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">ie_dedup=int(float(sys.argv[10]))</highlight></codeline>
<codeline><highlight class="normal">ie_dedup_strict=int(float(sys.argv[11]))</highlight></codeline>
<codeline><highlight class="normal">ie_dedup_policy=sys.argv[12]</highlight></codeline>
<codeline><highlight class="normal">ie_dedup_cache_mb=int(float(sys.argv[13]))</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">last=None</highlight></codeline>
<codeline><highlight class="normal">with<sp/>open(raw_path,&quot;r&quot;,encoding=&quot;utf-8&quot;,errors=&quot;ignore&quot;)<sp/>as<sp/>f:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>for<sp/>line<sp/>in<sp/>f:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>line=line.strip()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>line:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>(line.startswith(&quot;{&quot;)<sp/>and<sp/>line.endswith(&quot;}&quot;)):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>try:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj=json.loads(line)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>except<sp/>Exception:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>&quot;tokens_generated&quot;<sp/>in<sp/>obj<sp/>and<sp/>&quot;wall_time_s&quot;<sp/>in<sp/>obj<sp/>and<sp/>&quot;tps_true&quot;<sp/>in<sp/>obj:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last=obj</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">if<sp/>last<sp/>is<sp/>None:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>tail=[]</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>try:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>with<sp/>open(raw_path,&quot;r&quot;,encoding=&quot;utf-8&quot;,errors=&quot;ignore&quot;)<sp/>as<sp/>f:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tail=f.readlines()[-200:]</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>except<sp/>Exception:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tail=[]</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(&quot;ERROR:<sp/>no<sp/>JSON<sp/>object<sp/>found<sp/>in<sp/>engine<sp/>output\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(&quot;----<sp/>context<sp/>----\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(f&quot;cwd(model_dir)={model_dir}\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(f&quot;engine_bin={engine_bin}\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(f&quot;device={device}\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(&quot;----<sp/>raw<sp/>tail<sp/>(last<sp/>200<sp/>lines)<sp/>----\n&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>sys.stderr.write(&quot;&quot;.join(tail))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>raise<sp/>SystemExit(1)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">last[&quot;rss_peak_mb&quot;]=rss_peak</highlight></codeline>
<codeline><highlight class="normal">last[&quot;minflt&quot;]=minflt</highlight></codeline>
<codeline><highlight class="normal">last[&quot;majflt&quot;]=majflt</highlight></codeline>
<codeline><highlight class="normal">last[&quot;swap_in_mb&quot;]=swap_in</highlight></codeline>
<codeline><highlight class="normal">last[&quot;swap_out_mb&quot;]=swap_out</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">last.setdefault(&quot;pss_peak_mb&quot;,<sp/>0.0)</highlight></codeline>
<codeline><highlight class="normal">last.setdefault(&quot;vms_peak_mb&quot;,<sp/>0.0)</highlight></codeline>
<codeline><highlight class="normal">last.setdefault(&quot;rss_floor_mb&quot;,<sp/>0.0)</highlight></codeline>
<codeline><highlight class="normal">last.setdefault(&quot;rss_delta_mb&quot;,<sp/>0.0)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">last[&quot;ie_dedup&quot;]=ie_dedup</highlight></codeline>
<codeline><highlight class="normal">last[&quot;ie_dedup_strict&quot;]=ie_dedup_strict</highlight></codeline>
<codeline><highlight class="normal">last[&quot;ie_dedup_policy&quot;]=ie_dedup_policy</highlight></codeline>
<codeline><highlight class="normal">last[&quot;ie_dedup_cache_mb&quot;]=ie_dedup_cache_mb</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">print(json.dumps(last,<sp/>separators=(&quot;,&quot;,&quot;:&quot;)))</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">for<sp/>i<sp/>in<sp/>$(seq<sp/>1<sp/>&quot;${RUNS}&quot;);<sp/>do</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>run_one<sp/>&quot;${i}&quot;</highlight></codeline>
<codeline><highlight class="normal">done</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">model_ie_bin_bytes=&quot;$(stat_bytes_or_empty<sp/>&quot;${MODEL_DIR}/model.ie.bin&quot;)&quot;</highlight></codeline>
<codeline><highlight class="normal">dedup_defaults_bytes=&quot;$(stat_bytes_or_empty<sp/>&quot;${MODEL_DIR}/model.defaults.bin&quot;)&quot;</highlight></codeline>
<codeline><highlight class="normal">dedup_masks_bytes=&quot;$(stat_bytes_or_empty<sp/>&quot;${MODEL_DIR}/model.masks.bin&quot;)&quot;</highlight></codeline>
<codeline><highlight class="normal">dedup_exceptions_bytes=&quot;$(stat_bytes_or_empty<sp/>&quot;${MODEL_DIR}/model.exceptions.bin&quot;)&quot;</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">dedup_total_bytes=&quot;&quot;</highlight></codeline>
<codeline><highlight class="normal">if<sp/>[[<sp/>-n<sp/>&quot;${dedup_defaults_bytes}&quot;<sp/>||<sp/>-n<sp/>&quot;${dedup_masks_bytes}&quot;<sp/>||<sp/>-n<sp/>&quot;${dedup_exceptions_bytes}&quot;<sp/>]];<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>dedup_total_bytes=&quot;$(python3<sp/>-<sp/>&lt;&lt;PY</highlight></codeline>
<codeline><highlight class="normal">d=${dedup_defaults_bytes:-0}</highlight></codeline>
<codeline><highlight class="normal">m=${dedup_masks_bytes:-0}</highlight></codeline>
<codeline><highlight class="normal">e=${dedup_exceptions_bytes:-0}</highlight></codeline>
<codeline><highlight class="normal">print(int(d)+int(m)+int(e))</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">)&quot;</highlight></codeline>
<codeline><highlight class="normal">fi</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">python3<sp/>-<sp/>&lt;&lt;PY</highlight></codeline>
<codeline><highlight class="normal">import<sp/>json,<sp/>os,<sp/>time</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">def<sp/>i(env,<sp/>default=&quot;0&quot;):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>s=os.environ.get(env,<sp/>default)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>try:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>int(s)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>except<sp/>Exception:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>int(default)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">def<sp/>s(env,<sp/>default=&quot;&quot;):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>os.environ.get(env,<sp/>default)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">def<sp/>opt_int_from_shell(x):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>try:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>int(x)<sp/>if<sp/>x<sp/>!=<sp/>&quot;&quot;<sp/>else<sp/>None</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>except<sp/>Exception:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>None</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">summary<sp/>=<sp/>{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;timestamp&quot;:<sp/>time.strftime(&quot;%Y-%m-%d<sp/>%H:%M:%S&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;threads&quot;:<sp/>i(&quot;THREADS&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;precision&quot;:<sp/>s(&quot;PRECISION&quot;,<sp/>&quot;fp32&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;model_dir&quot;:<sp/>s(&quot;MODEL_DIR&quot;,<sp/>&quot;&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;prompts&quot;:<sp/>s(&quot;PROMPTS&quot;,<sp/>&quot;&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;runs&quot;:<sp/>i(&quot;RUNS&quot;,<sp/>&quot;3&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;rounds&quot;:<sp/>i(&quot;ROUNDS&quot;,<sp/>&quot;1&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;device&quot;:<sp/>s(&quot;DEVICE&quot;,<sp/>&quot;&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;engine_bin&quot;:<sp/>s(&quot;ENGINE_BIN&quot;,<sp/>&quot;&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;batch&quot;:<sp/>i(&quot;BATCH&quot;,<sp/>&quot;1&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;max_new&quot;:<sp/>i(&quot;MAX_NEW&quot;,<sp/>&quot;128&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;affinity&quot;:<sp/>s(&quot;AFFINITY&quot;,<sp/>&quot;auto&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;pretranspose&quot;:<sp/>s(&quot;PRETRANSPOSE&quot;,<sp/>&quot;all&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;prefetch&quot;:<sp/>s(&quot;PREFETCH&quot;,<sp/>&quot;auto&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_require_model&quot;:<sp/>i(&quot;IE_REQUIRE_MODEL&quot;,<sp/>&quot;1&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_bytes_per_token&quot;:<sp/>i(&quot;IE_BYTES_PER_TOKEN&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_stride_bytes&quot;:<sp/>i(&quot;IE_STRIDE_BYTES&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_verify_touch&quot;:<sp/>i(&quot;IE_VERIFY_TOUCH&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_dedup&quot;:<sp/>i(&quot;IE_DEDUP&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_dedup_strict&quot;:<sp/>i(&quot;IE_DEDUP_STRICT&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_dedup_policy&quot;:<sp/>s(&quot;IE_DEDUP_POLICY&quot;,<sp/>&quot;lossless&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;ie_dedup_cache_mb&quot;:<sp/>i(&quot;IE_DEDUP_CACHE_MB&quot;,<sp/>&quot;0&quot;),</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;model_ie_bin_bytes&quot;:<sp/>opt_int_from_shell(&quot;${model_ie_bin_bytes}&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;dedup_defaults_bytes&quot;:<sp/>opt_int_from_shell(&quot;${dedup_defaults_bytes}&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;dedup_masks_bytes&quot;:<sp/>opt_int_from_shell(&quot;${dedup_masks_bytes}&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;dedup_exceptions_bytes&quot;:<sp/>opt_int_from_shell(&quot;${dedup_exceptions_bytes}&quot;),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>&quot;dedup_total_bytes&quot;:<sp/>opt_int_from_shell(&quot;${dedup_total_bytes}&quot;),</highlight></codeline>
<codeline><highlight class="normal">}</highlight></codeline>
<codeline><highlight class="normal">print(json.dumps(summary,<sp/>separators=(&quot;,&quot;,&quot;:&quot;)))</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
    </programlisting>
    <location file="scripts/true_tps_strict.sh"/>
  </compounddef>
</doxygen>
