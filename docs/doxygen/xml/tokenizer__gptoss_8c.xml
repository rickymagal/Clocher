<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="tokenizer__gptoss_8c" kind="file" language="C++">
    <compoundname>tokenizer_gptoss.c</compoundname>
    <includes refid="ie__tokenizer__gptoss_8h" local="yes">ie_tokenizer_gptoss.h</includes>
    <includes local="no">ctype.h</includes>
    <includes local="no">errno.h</includes>
    <includes local="no">limits.h</includes>
    <includes local="no">stdint.h</includes>
    <includes local="no">stdio.h</includes>
    <includes local="no">stdlib.h</includes>
    <includes local="no">string.h</includes>
    <incdepgraph>
      <node id="2">
        <label>ie_tokenizer_gptoss.h</label>
        <link refid="ie__tokenizer__gptoss_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>engine/src/io/tokenizer_gptoss.c</label>
        <link refid="tokenizer__gptoss_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>ctype.h</label>
      </node>
      <node id="6">
        <label>errno.h</label>
      </node>
      <node id="7">
        <label>limits.h</label>
      </node>
      <node id="3">
        <label>stddef.h</label>
      </node>
      <node id="4">
        <label>stdint.h</label>
      </node>
      <node id="8">
        <label>stdio.h</label>
      </node>
      <node id="9">
        <label>stdlib.h</label>
      </node>
      <node id="10">
        <label>string.h</label>
      </node>
    </incdepgraph>
    <innerclass refid="structstrid__ent__s" prot="public">strid_ent_s</innerclass>
    <innerclass refid="structpairrank__ent__s" prot="public">pairrank_ent_s</innerclass>
    <innerclass refid="structbytesid__ent__s" prot="public">bytesid_ent_s</innerclass>
    <innerclass refid="structintern__ent__s" prot="public">intern_ent_s</innerclass>
    <innerclass refid="structintern__s" prot="public">intern_s</innerclass>
    <innerclass refid="structbyteunicode__s" prot="public">byteunicode_s</innerclass>
    <innerclass refid="structu32buf__s" prot="public">u32buf_s</innerclass>
    <innerclass refid="structstrbuf__s" prot="public">strbuf_s</innerclass>
    <innerclass refid="structbytearena__s" prot="public">bytearena_s</innerclass>
    <innerclass refid="structbytes__view__s" prot="public">bytes_view_s</innerclass>
    <innerclass refid="structie__tok__gptoss__s" prot="public">ie_tok_gptoss_s</innerclass>
    <innerclass refid="structttpiece__s" prot="public">ttpiece_s</innerclass>
    <sectiondef kind="enum">
      <memberdef kind="enum" id="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0" prot="public" static="no" strong="no">
        <type></type>
        <name>ie_tok_mode_e</name>
        <enumvalue id="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" prot="public">
          <name>IE_TOK_MODE_GPT2</name>
          <initializer>= 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" prot="public">
          <name>IE_TOK_MODE_TIKTOKEN</name>
          <initializer>= 1</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="784" column="1" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="784" bodyend="787"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="typedef">
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" prot="public" static="no">
        <type>struct <ref refid="structstrid__ent__s" kindref="compound">strid_ent_s</ref></type>
        <definition>typedef struct strid_ent_s strid_ent_t</definition>
        <argsstring></argsstring>
        <name>strid_ent_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="359" column="13"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" prot="public" static="no">
        <type>struct <ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_s</ref></type>
        <definition>typedef struct pairrank_ent_s pairrank_ent_t</definition>
        <argsstring></argsstring>
        <name>pairrank_ent_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="365" column="16"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" prot="public" static="no">
        <type>struct <ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_s</ref></type>
        <definition>typedef struct bytesid_ent_s bytesid_ent_t</definition>
        <argsstring></argsstring>
        <name>bytesid_ent_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="457" column="15"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1aa7766b67a47b1eafd83f27a64a475feb" prot="public" static="no">
        <type>struct <ref refid="structintern__ent__s" kindref="compound">intern_ent_s</ref></type>
        <definition>typedef struct intern_ent_s intern_ent_t</definition>
        <argsstring></argsstring>
        <name>intern_ent_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="540" column="14"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" prot="public" static="no">
        <type>struct <ref refid="structintern__s" kindref="compound">intern_s</ref></type>
        <definition>typedef struct intern_s intern_t</definition>
        <argsstring></argsstring>
        <name>intern_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="549" column="10"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" prot="public" static="no">
        <type>struct <ref refid="structbyteunicode__s" kindref="compound">byteunicode_s</ref></type>
        <definition>typedef struct byteunicode_s byteunicode_t</definition>
        <argsstring></argsstring>
        <name>byteunicode_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="633" column="15"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" prot="public" static="no">
        <type>struct <ref refid="structu32buf__s" kindref="compound">u32buf_s</ref></type>
        <definition>typedef struct u32buf_s u32buf_t</definition>
        <argsstring></argsstring>
        <name>u32buf_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="672" column="10"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" prot="public" static="no">
        <type>struct <ref refid="structstrbuf__s" kindref="compound">strbuf_s</ref></type>
        <definition>typedef struct strbuf_s strbuf_t</definition>
        <argsstring></argsstring>
        <name>strbuf_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="691" column="10"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" prot="public" static="no">
        <type>struct <ref refid="structbytearena__s" kindref="compound">bytearena_s</ref></type>
        <definition>typedef struct bytearena_s bytearena_t</definition>
        <argsstring></argsstring>
        <name>bytearena_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="731" column="13"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a358edfb70ec3436f50e909b5874b906c" prot="public" static="no">
        <type>enum <ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0" kindref="member">ie_tok_mode_e</ref></type>
        <definition>typedef enum ie_tok_mode_e ie_tok_mode_t</definition>
        <argsstring></argsstring>
        <name>ie_tok_mode_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="787" column="15"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a3711041218ffb2a4002ae5aeb3e47f6a" prot="public" static="no">
        <type>struct <ref refid="structbytes__view__s" kindref="compound">bytes_view_s</ref></type>
        <definition>typedef struct bytes_view_s bytes_view_t</definition>
        <argsstring></argsstring>
        <name>bytes_view_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="792" column="14"/>
      </memberdef>
      <memberdef kind="typedef" id="tokenizer__gptoss_8c_1a17df6e83da40ef362b2839e4da8c3692" prot="public" static="no">
        <type>struct <ref refid="structttpiece__s" kindref="compound">ttpiece_s</ref></type>
        <definition>typedef struct ttpiece_s ttpiece_t</definition>
        <argsstring></argsstring>
        <name>ttpiece_t</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1667" column="11"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>static uint64_t fnv1a64</definition>
        <argsstring>(const void *data, size_t n)</argsstring>
        <name>fnv1a64</name>
        <param>
          <type>const void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="33" column="17" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="33" bodyend="41"/>
        <referencedby refid="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" compoundref="tokenizer__gptoss_8c" startline="492" endline="503">bytesid_map_get</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" compoundref="tokenizer__gptoss_8c" startline="468" endline="490">bytesid_map_put</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" compoundref="tokenizer__gptoss_8c" startline="401" endline="412">strid_map_get</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" compoundref="tokenizer__gptoss_8c" startline="382" endline="399">strid_map_put</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a2e1ab240e638d9d6bb9f6ffd8451d8ef" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint64_t</type>
        <definition>static uint64_t fnv1a64_two</definition>
        <argsstring>(const void *a, size_t an, const void *b, size_t bn)</argsstring>
        <name>fnv1a64_two</name>
        <param>
          <type>const void *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>an</declname>
        </param>
        <param>
          <type>const void *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>bn</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="43" column="17" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="43" bodyend="56"/>
        <referencedby refid="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" compoundref="tokenizer__gptoss_8c" startline="505" endline="529">bytesid_map_get_concat</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>static uint32_t fnv1a32</definition>
        <argsstring>(const void *data, size_t n)</argsstring>
        <name>fnv1a32</name>
        <param>
          <type>const void *</type>
          <declname>data</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="58" column="17" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="58" bodyend="66"/>
        <referencedby refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" compoundref="tokenizer__gptoss_8c" startline="589" endline="600">intern_get</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" compoundref="tokenizer__gptoss_8c" startline="602" endline="623">intern_get_or_add</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void *</type>
        <definition>static void * xcalloc</definition>
        <argsstring>(size_t n, size_t sz)</argsstring>
        <name>xcalloc</name>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>sz</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="68" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="68" bodyend="72"/>
        <referencedby refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" compoundref="tokenizer__gptoss_8c" startline="459" endline="466">bytesid_map_init</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" compoundref="tokenizer__gptoss_8c" startline="551" endline="563">intern_init</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" compoundref="tokenizer__gptoss_8c" startline="414" endline="421">pairrank_map_init</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" compoundref="tokenizer__gptoss_8c" startline="373" endline="380">strid_map_init</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void *</type>
        <definition>static void * xrealloc</definition>
        <argsstring>(void *p, size_t n)</argsstring>
        <name>xrealloc</name>
        <param>
          <type>void *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="74" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="74" bodyend="77"/>
        <referencedby refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" compoundref="tokenizer__gptoss_8c" startline="674" endline="685">u32buf_push</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>char *</type>
        <definition>static char * xstrdup_n</definition>
        <argsstring>(const char *s, size_t n)</argsstring>
        <name>xstrdup_n</name>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="79" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="79" bodyend="85"/>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" compoundref="tokenizer__gptoss_8c" startline="1478" endline="1550">pretokenize_basic</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" compoundref="tokenizer__gptoss_8c" startline="1029" endline="1086">scan_merge_entry</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a84e8a603fef81b42cc1913caf9216f13" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int read_all_bytes</definition>
        <argsstring>(const char *path, char **out_buf, size_t *out_len)</argsstring>
        <name>read_all_bytes</name>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>char **</type>
          <declname>out_buf</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_len</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="87" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="87" bodyend="110"/>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aa12e2f8ade90f9aefa8f1562d02965b8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int path_ends_with</definition>
        <argsstring>(const char *path, const char *suf)</argsstring>
        <name>path_ends_with</name>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>suf</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="112" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="112" bodyend="118"/>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int utf8_next_cp</definition>
        <argsstring>(const char *s, size_t n, size_t *io_i, uint32_t *out_cp)</argsstring>
        <name>utf8_next_cp</name>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>io_i</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_cp</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="124" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="124" bodyend="149"/>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>size_t</type>
        <definition>static size_t utf8_put_cp</definition>
        <argsstring>(char *dst, size_t cap, uint32_t cp)</argsstring>
        <name>utf8_put_cp</name>
        <param>
          <type>char *</type>
          <declname>dst</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>cp</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="151" column="15" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="151" bodyend="176"/>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" compoundref="tokenizer__gptoss_8c" startline="212" endline="251">json_unescape_inplace</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" compoundref="tokenizer__gptoss_8c" startline="1465" endline="1476">to_bytelevel_unicode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char * skip_ws</definition>
        <argsstring>(const char *p)</argsstring>
        <name>skip_ws</name>
        <param>
          <type>const char *</type>
          <declname>p</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="182" column="19" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="182" bodyend="185"/>
        <referencedby refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" compoundref="tokenizer__gptoss_8c" startline="269" endline="284">find_key_in_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" compoundref="tokenizer__gptoss_8c" startline="253" endline="267">scan_json_int</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" compoundref="tokenizer__gptoss_8c" startline="1029" endline="1086">scan_merge_entry</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" compoundref="tokenizer__gptoss_8c" startline="286" endline="348">skip_json_value</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int scan_json_string</definition>
        <argsstring>(const char **pp, char **out_s, size_t *out_n)</argsstring>
        <name>scan_json_string</name>
        <param>
          <type>const char **</type>
          <declname>pp</declname>
        </param>
        <param>
          <type>char **</type>
          <declname>out_s</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="187" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="187" bodyend="210"/>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <references refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" compoundref="tokenizer__gptoss_8c" startline="79" endline="85">xstrdup_n</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" compoundref="tokenizer__gptoss_8c" startline="1029" endline="1086">scan_merge_entry</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" compoundref="tokenizer__gptoss_8c" startline="286" endline="348">skip_json_value</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int json_unescape_inplace</definition>
        <argsstring>(char *s)</argsstring>
        <name>json_unescape_inplace</name>
        <param>
          <type>char *</type>
          <declname>s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="212" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="212" bodyend="251"/>
        <references refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" compoundref="tokenizer__gptoss_8c" startline="151" endline="176">utf8_put_cp</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" compoundref="tokenizer__gptoss_8c" startline="1029" endline="1086">scan_merge_entry</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int scan_json_int</definition>
        <argsstring>(const char **pp, int *out_val)</argsstring>
        <name>scan_json_int</name>
        <param>
          <type>const char **</type>
          <declname>pp</declname>
        </param>
        <param>
          <type>int *</type>
          <declname>out_val</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="253" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="253" bodyend="267"/>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char * find_key_in_object</definition>
        <argsstring>(const char *json, const char *key)</argsstring>
        <name>find_key_in_object</name>
        <param>
          <type>const char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>key</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="269" column="19" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="269" bodyend="284"/>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int skip_json_value</definition>
        <argsstring>(const char **pp)</argsstring>
        <name>skip_json_value</name>
        <param>
          <type>const char **</type>
          <declname>pp</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="286" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="286" bodyend="348"/>
        <references refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</references>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>size_t</type>
        <definition>static size_t next_pow2</definition>
        <argsstring>(size_t x)</argsstring>
        <name>next_pow2</name>
        <param>
          <type>size_t</type>
          <declname>x</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="367" column="15" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="367" bodyend="371"/>
        <referencedby refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" compoundref="tokenizer__gptoss_8c" startline="459" endline="466">bytesid_map_init</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" compoundref="tokenizer__gptoss_8c" startline="551" endline="563">intern_init</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" compoundref="tokenizer__gptoss_8c" startline="414" endline="421">pairrank_map_init</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" compoundref="tokenizer__gptoss_8c" startline="373" endline="380">strid_map_init</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int strid_map_init</definition>
        <argsstring>(strid_ent_t **out, size_t *out_cap, size_t want)</argsstring>
        <name>strid_map_init</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" kindref="member">strid_ent_t</ref> **</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_cap</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>want</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="373" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="373" bodyend="380"/>
        <references refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" compoundref="tokenizer__gptoss_8c" startline="367" endline="371">next_pow2</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" compoundref="tokenizer__gptoss_8c" startline="876" endline="891">rebuild_tok_to_id</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int strid_map_put</definition>
        <argsstring>(strid_ent_t *m, size_t cap, const char *k, uint32_t v)</argsstring>
        <name>strid_map_put</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" kindref="member">strid_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>k</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>v</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="382" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="382" bodyend="399"/>
        <references refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" compoundref="tokenizer__gptoss_8c" startline="33" endline="41">fnv1a64</references>
        <references refid="structstrid__ent__s_1a5f3df0b00441dac3055759e3a4bcf374" compoundref="tokenizer__gptoss_8c" startline="355">strid_ent_s::h</references>
        <references refid="structstrid__ent__s_1a0b543267355bc6923c4002d3c6c89085" compoundref="tokenizer__gptoss_8c" startline="356">strid_ent_s::k</references>
        <references refid="structstrid__ent__s_1ae945d8681c6f020855d30510af9d353a" compoundref="tokenizer__gptoss_8c" startline="358">strid_ent_s::used</references>
        <references refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" compoundref="tokenizer__gptoss_8c" startline="357">strid_ent_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" compoundref="tokenizer__gptoss_8c" startline="876" endline="891">rebuild_tok_to_id</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int strid_map_get</definition>
        <argsstring>(const strid_ent_t *m, size_t cap, const char *k, uint32_t *out_v)</argsstring>
        <name>strid_map_get</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" kindref="member">strid_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>k</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_v</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="401" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="401" bodyend="412"/>
        <references refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" compoundref="tokenizer__gptoss_8c" startline="33" endline="41">fnv1a64</references>
        <references refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" compoundref="tokenizer__gptoss_8c" startline="357">strid_ent_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int pairrank_map_init</definition>
        <argsstring>(pairrank_ent_t **out, size_t *out_cap, size_t want)</argsstring>
        <name>pairrank_map_init</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" kindref="member">pairrank_ent_t</ref> **</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_cap</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>want</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="414" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="414" bodyend="421"/>
        <references refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" compoundref="tokenizer__gptoss_8c" startline="367" endline="371">next_pow2</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int pairrank_map_put</definition>
        <argsstring>(pairrank_ent_t *m, size_t cap, uint64_t key, uint32_t rank)</argsstring>
        <name>pairrank_map_put</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" kindref="member">pairrank_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>key</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>rank</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="423" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="423" bodyend="433"/>
        <references refid="structpairrank__ent__s_1acea1c2054af374964f786a022e55574b" compoundref="tokenizer__gptoss_8c" startline="362">pairrank_ent_s::key</references>
        <references refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" compoundref="tokenizer__gptoss_8c" startline="363">pairrank_ent_s::rank</references>
        <references refid="structpairrank__ent__s_1a8f3db1a245bdd15b98cd40208f238cb9" compoundref="tokenizer__gptoss_8c" startline="364">pairrank_ent_s::used</references>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a569d2debd0e21610e58723b64b065a8d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int pairrank_map_get</definition>
        <argsstring>(const pairrank_ent_t *m, size_t cap, uint64_t key, uint32_t *out_rank)</argsstring>
        <name>pairrank_map_get</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" kindref="member">pairrank_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>key</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_rank</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="435" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="435" bodyend="445"/>
        <references refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" compoundref="tokenizer__gptoss_8c" startline="363">pairrank_ent_s::rank</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bytesid_map_init</definition>
        <argsstring>(bytesid_ent_t **out, size_t *out_cap, size_t want)</argsstring>
        <name>bytesid_map_init</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" kindref="member">bytesid_ent_t</ref> **</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_cap</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>want</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="459" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="459" bodyend="466"/>
        <references refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" compoundref="tokenizer__gptoss_8c" startline="367" endline="371">next_pow2</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bytesid_map_put</definition>
        <argsstring>(bytesid_ent_t *m, size_t cap, const uint8_t *p, uint32_t n, uint32_t v)</argsstring>
        <name>bytesid_map_put</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" kindref="member">bytesid_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>v</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="468" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="468" bodyend="490"/>
        <references refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" compoundref="tokenizer__gptoss_8c" startline="33" endline="41">fnv1a64</references>
        <references refid="structbytesid__ent__s_1ad53717b7ddfcdd5562570805b8b3a711" compoundref="tokenizer__gptoss_8c" startline="452">bytesid_ent_s::h</references>
        <references refid="structbytesid__ent__s_1a482da673ac3595aee9fe7388fb22499e" compoundref="tokenizer__gptoss_8c" startline="454">bytesid_ent_s::n</references>
        <references refid="structbytesid__ent__s_1a03ff56c76f4b153f09067bac401de6ee" compoundref="tokenizer__gptoss_8c" startline="453">bytesid_ent_s::p</references>
        <references refid="structbytesid__ent__s_1ac8b34aad1cb571742c43c014cf731aea" compoundref="tokenizer__gptoss_8c" startline="456">bytesid_ent_s::used</references>
        <references refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" compoundref="tokenizer__gptoss_8c" startline="455">bytesid_ent_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bytesid_map_get</definition>
        <argsstring>(const bytesid_ent_t *m, size_t cap, const uint8_t *p, uint32_t n, uint32_t *out_v)</argsstring>
        <name>bytesid_map_get</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" kindref="member">bytesid_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>p</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_v</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="492" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="492" bodyend="503"/>
        <references refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" compoundref="tokenizer__gptoss_8c" startline="33" endline="41">fnv1a64</references>
        <references refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" compoundref="tokenizer__gptoss_8c" startline="455">bytesid_ent_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bytesid_map_get_concat</definition>
        <argsstring>(const bytesid_ent_t *m, size_t cap, const uint8_t *a, uint32_t an, const uint8_t *b, uint32_t bn, uint32_t *out_v)</argsstring>
        <name>bytesid_map_get_concat</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" kindref="member">bytesid_ent_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>cap</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>an</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>bn</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_v</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="505" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="505" bodyend="529"/>
        <references refid="tokenizer__gptoss_8c_1a2e1ab240e638d9d6bb9f6ffd8451d8ef" compoundref="tokenizer__gptoss_8c" startline="43" endline="56">fnv1a64_two</references>
        <references refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" compoundref="tokenizer__gptoss_8c" startline="455">bytesid_ent_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" compoundref="tokenizer__gptoss_8c" startline="1669" endline="1734">tt_bpe_encode_segment</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int intern_init</definition>
        <argsstring>(intern_t *in, size_t want_syms, size_t arena_hint)</argsstring>
        <name>intern_init</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref> *</type>
          <declname>in</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>want_syms</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>arena_hint</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="551" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="551" bodyend="563"/>
        <references refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" compoundref="tokenizer__gptoss_8c" startline="545">intern_s::arena</references>
        <references refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" compoundref="tokenizer__gptoss_8c" startline="546">intern_s::arena_sz</references>
        <references refid="structintern__s_1aad00748399fd7074aa910c96593d1519" compoundref="tokenizer__gptoss_8c" startline="547">intern_s::arena_used</references>
        <references refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" compoundref="tokenizer__gptoss_8c" startline="544">intern_s::cap</references>
        <references refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" compoundref="tokenizer__gptoss_8c" startline="543">intern_s::m</references>
        <references refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" compoundref="tokenizer__gptoss_8c" startline="548">intern_s::next_id</references>
        <references refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" compoundref="tokenizer__gptoss_8c" startline="367" endline="371">next_pow2</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a118bc90519292f54b3513029942a3867" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void intern_free</definition>
        <argsstring>(intern_t *in)</argsstring>
        <name>intern_free</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref> *</type>
          <declname>in</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="565" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="565" bodyend="570"/>
        <references refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" compoundref="tokenizer__gptoss_8c" startline="545">intern_s::arena</references>
        <references refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" compoundref="tokenizer__gptoss_8c" startline="543">intern_s::m</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ad4b875bec514bb9c1de945944e1596de" compoundref="tokenizer__gptoss_8c" startline="1795" endline="1811">ie_tok_gptoss_close</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a7149c5ac8540bb92b6357a38aa2bd404" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>const char *</type>
        <definition>static const char * intern_store</definition>
        <argsstring>(intern_t *in, const char *s, size_t n)</argsstring>
        <name>intern_store</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref> *</type>
          <declname>in</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="572" column="19" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="572" bodyend="587"/>
        <references refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" compoundref="tokenizer__gptoss_8c" startline="545">intern_s::arena</references>
        <references refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" compoundref="tokenizer__gptoss_8c" startline="546">intern_s::arena_sz</references>
        <references refid="structintern__s_1aad00748399fd7074aa910c96593d1519" compoundref="tokenizer__gptoss_8c" startline="547">intern_s::arena_used</references>
        <referencedby refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" compoundref="tokenizer__gptoss_8c" startline="602" endline="623">intern_get_or_add</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int intern_get</definition>
        <argsstring>(const intern_t *in, const char *s, uint32_t *out_id)</argsstring>
        <name>intern_get</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref> *</type>
          <declname>in</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="589" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="589" bodyend="600"/>
        <references refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" compoundref="tokenizer__gptoss_8c" startline="544">intern_s::cap</references>
        <references refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" compoundref="tokenizer__gptoss_8c" startline="58" endline="66">fnv1a32</references>
        <references refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" compoundref="tokenizer__gptoss_8c" startline="536">intern_ent_s::h</references>
        <references refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" compoundref="tokenizer__gptoss_8c" startline="538">intern_ent_s::id</references>
        <references refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" compoundref="tokenizer__gptoss_8c" startline="543">intern_s::m</references>
        <references refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" compoundref="tokenizer__gptoss_8c" startline="537">intern_ent_s::s</references>
        <references refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" compoundref="tokenizer__gptoss_8c" startline="539">intern_ent_s::used</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int intern_get_or_add</definition>
        <argsstring>(intern_t *in, const char *s, uint32_t *out_id)</argsstring>
        <name>intern_get_or_add</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref> *</type>
          <declname>in</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out_id</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="602" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="602" bodyend="623"/>
        <references refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" compoundref="tokenizer__gptoss_8c" startline="544">intern_s::cap</references>
        <references refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" compoundref="tokenizer__gptoss_8c" startline="58" endline="66">fnv1a32</references>
        <references refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" compoundref="tokenizer__gptoss_8c" startline="536">intern_ent_s::h</references>
        <references refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" compoundref="tokenizer__gptoss_8c" startline="538">intern_ent_s::id</references>
        <references refid="tokenizer__gptoss_8c_1a7149c5ac8540bb92b6357a38aa2bd404" compoundref="tokenizer__gptoss_8c" startline="572" endline="587">intern_store</references>
        <references refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" compoundref="tokenizer__gptoss_8c" startline="543">intern_s::m</references>
        <references refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" compoundref="tokenizer__gptoss_8c" startline="548">intern_s::next_id</references>
        <references refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" compoundref="tokenizer__gptoss_8c" startline="537">intern_ent_s::s</references>
        <references refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" compoundref="tokenizer__gptoss_8c" startline="539">intern_ent_s::used</references>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ad4c1b8d22b27793678d951b45034176d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void byteunicode_init</definition>
        <argsstring>(byteunicode_t *m)</argsstring>
        <name>byteunicode_init</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" kindref="member">byteunicode_t</ref> *</type>
          <declname>m</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="635" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="635" bodyend="656"/>
        <references refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" compoundref="tokenizer__gptoss_8c" startline="630">byteunicode_s::byte_to_cp</references>
        <references refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" compoundref="tokenizer__gptoss_8c" startline="631">byteunicode_s::cp_to_byte</references>
        <references refid="structbyteunicode__s_1ab59da0198a7ba098340763a6387be857" compoundref="tokenizer__gptoss_8c" startline="632">byteunicode_s::cp_to_byte_cap</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a501bba302f86962f8c5332144c6271a8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int byteunicode_cp_to_byte</definition>
        <argsstring>(const byteunicode_t *m, uint32_t cp, uint8_t *out_b)</argsstring>
        <name>byteunicode_cp_to_byte</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" kindref="member">byteunicode_t</ref> *</type>
          <declname>m</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>cp</declname>
        </param>
        <param>
          <type>uint8_t *</type>
          <declname>out_b</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="658" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="658" bodyend="662"/>
        <references refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" compoundref="tokenizer__gptoss_8c" startline="631">byteunicode_s::cp_to_byte</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int u32buf_push</definition>
        <argsstring>(u32buf_t *b, uint32_t x)</argsstring>
        <name>u32buf_push</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" kindref="member">u32buf_t</ref> *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>x</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="674" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="674" bodyend="685"/>
        <references refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" compoundref="tokenizer__gptoss_8c" startline="671">u32buf_s::cap</references>
        <references refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" compoundref="tokenizer__gptoss_8c" startline="670">u32buf_s::n</references>
        <references refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" compoundref="tokenizer__gptoss_8c" startline="669">u32buf_s::v</references>
        <references refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" compoundref="tokenizer__gptoss_8c" startline="74" endline="77">xrealloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" compoundref="tokenizer__gptoss_8c" startline="1669" endline="1734">tt_bpe_encode_segment</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int strbuf_reserve</definition>
        <argsstring>(strbuf_t *b, size_t add)</argsstring>
        <name>strbuf_reserve</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" kindref="member">strbuf_t</ref> *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>add</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="693" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="693" bodyend="703"/>
        <references refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" compoundref="tokenizer__gptoss_8c" startline="690">strbuf_s::cap</references>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <references refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" compoundref="tokenizer__gptoss_8c" startline="74" endline="77">xrealloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" compoundref="tokenizer__gptoss_8c" startline="1478" endline="1550">pretokenize_basic</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" compoundref="tokenizer__gptoss_8c" startline="705" endline="711">strbuf_append_bytes</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int strbuf_append_bytes</definition>
        <argsstring>(strbuf_t *b, const char *s, size_t n)</argsstring>
        <name>strbuf_append_bytes</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" kindref="member">strbuf_t</ref> *</type>
          <declname>b</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="705" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="705" bodyend="711"/>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" compoundref="tokenizer__gptoss_8c" startline="1478" endline="1550">pretokenize_basic</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" compoundref="tokenizer__gptoss_8c" startline="1465" endline="1476">to_bytelevel_unicode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void strbuf_free</definition>
        <argsstring>(strbuf_t *b)</argsstring>
        <name>strbuf_free</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" kindref="member">strbuf_t</ref> *</type>
          <declname>b</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="713" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="713" bodyend="717"/>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <referencedby refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" compoundref="tokenizer__gptoss_8c" startline="1818" endline="1889">ie_tok_gptoss_decode</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" compoundref="tokenizer__gptoss_8c" startline="1478" endline="1550">pretokenize_basic</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void bytearena_free</definition>
        <argsstring>(bytearena_t *a)</argsstring>
        <name>bytearena_free</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" kindref="member">bytearena_t</ref> *</type>
          <declname>a</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="733" column="13" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="733" bodyend="741"/>
        <references refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" compoundref="tokenizer__gptoss_8c" startline="724">bytearena_s::blocks</references>
        <references refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" compoundref="tokenizer__gptoss_8c" startline="726">bytearena_s::nblocks</references>
        <references refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" compoundref="tokenizer__gptoss_8c" startline="725">bytearena_s::sizes</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ad4b875bec514bb9c1de945944e1596de" compoundref="tokenizer__gptoss_8c" startline="1795" endline="1811">ie_tok_gptoss_close</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" compoundref="tokenizer__gptoss_8c" startline="1669" endline="1734">tt_bpe_encode_segment</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aca6fa634dfd54327a309632325436dc4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bytearena_new_block</definition>
        <argsstring>(bytearena_t *a, size_t need)</argsstring>
        <name>bytearena_new_block</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" kindref="member">bytearena_t</ref> *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>need</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="743" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="743" bodyend="767"/>
        <references refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" compoundref="tokenizer__gptoss_8c" startline="724">bytearena_s::blocks</references>
        <references refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" compoundref="tokenizer__gptoss_8c" startline="727">bytearena_s::cap</references>
        <references refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" compoundref="tokenizer__gptoss_8c" startline="728">bytearena_s::cur</references>
        <references refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" compoundref="tokenizer__gptoss_8c" startline="729">bytearena_s::cur_sz</references>
        <references refid="structbytearena__s_1a80c132193614bacc875483589592663a" compoundref="tokenizer__gptoss_8c" startline="730">bytearena_s::cur_used</references>
        <references refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" compoundref="tokenizer__gptoss_8c" startline="726">bytearena_s::nblocks</references>
        <references refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" compoundref="tokenizer__gptoss_8c" startline="725">bytearena_s::sizes</references>
        <referencedby refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" compoundref="tokenizer__gptoss_8c" startline="769" endline="778">bytearena_alloc</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint8_t *</type>
        <definition>static uint8_t * bytearena_alloc</definition>
        <argsstring>(bytearena_t *a, size_t n)</argsstring>
        <name>bytearena_alloc</name>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" kindref="member">bytearena_t</ref> *</type>
          <declname>a</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="769" column="16" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="769" bodyend="778"/>
        <references refid="tokenizer__gptoss_8c_1aca6fa634dfd54327a309632325436dc4" compoundref="tokenizer__gptoss_8c" startline="743" endline="767">bytearena_new_block</references>
        <references refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" compoundref="tokenizer__gptoss_8c" startline="728">bytearena_s::cur</references>
        <references refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" compoundref="tokenizer__gptoss_8c" startline="729">bytearena_s::cur_sz</references>
        <references refid="structbytearena__s_1a80c132193614bacc875483589592663a" compoundref="tokenizer__gptoss_8c" startline="730">bytearena_s::cur_used</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" compoundref="tokenizer__gptoss_8c" startline="1669" endline="1734">tt_bpe_encode_segment</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_vocab_object</definition>
        <argsstring>(const char *json, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_vocab_object</name>
        <param>
          <type>const char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="820" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="820" bodyend="874"/>
        <references refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" compoundref="tokenizer__gptoss_8c" startline="269" endline="284">find_key_in_object</references>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" compoundref="tokenizer__gptoss_8c" startline="212" endline="251">json_unescape_inplace</references>
        <references refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" compoundref="tokenizer__gptoss_8c" startline="253" endline="267">scan_json_int</references>
        <references refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</references>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <references refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" compoundref="tokenizer__gptoss_8c" startline="373" endline="380">strid_map_init</references>
        <references refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" compoundref="tokenizer__gptoss_8c" startline="382" endline="399">strid_map_put</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" compoundref="tokenizer__gptoss_8c" startline="801">ie_tok_gptoss_s::tok_to_id_cap</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" compoundref="tokenizer__gptoss_8c" startline="1149" endline="1163">parse_tokenizer_json</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int rebuild_tok_to_id</definition>
        <argsstring>(ie_tok_gptoss_t *tok)</argsstring>
        <name>rebuild_tok_to_id</name>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="876" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="876" bodyend="891"/>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" compoundref="tokenizer__gptoss_8c" startline="373" endline="380">strid_map_init</references>
        <references refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" compoundref="tokenizer__gptoss_8c" startline="382" endline="399">strid_map_put</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" compoundref="tokenizer__gptoss_8c" startline="801">ie_tok_gptoss_s::tok_to_id_cap</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_added_tokens_array</definition>
        <argsstring>(const char *json, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_added_tokens_array</name>
        <param>
          <type>const char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="893" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="893" bodyend="1027"/>
        <references refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" compoundref="tokenizer__gptoss_8c" startline="269" endline="284">find_key_in_object</references>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" compoundref="tokenizer__gptoss_8c" startline="212" endline="251">json_unescape_inplace</references>
        <references refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" compoundref="tokenizer__gptoss_8c" startline="876" endline="891">rebuild_tok_to_id</references>
        <references refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" compoundref="tokenizer__gptoss_8c" startline="253" endline="267">scan_json_int</references>
        <references refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</references>
        <references refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" compoundref="tokenizer__gptoss_8c" startline="286" endline="348">skip_json_value</references>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <references refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" compoundref="tokenizer__gptoss_8c" startline="382" endline="399">strid_map_put</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" compoundref="tokenizer__gptoss_8c" startline="801">ie_tok_gptoss_s::tok_to_id_cap</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" compoundref="tokenizer__gptoss_8c" startline="1149" endline="1163">parse_tokenizer_json</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int scan_merge_entry</definition>
        <argsstring>(const char **pp, char **a, char **b)</argsstring>
        <name>scan_merge_entry</name>
        <param>
          <type>const char **</type>
          <declname>pp</declname>
        </param>
        <param>
          <type>char **</type>
          <declname>a</declname>
        </param>
        <param>
          <type>char **</type>
          <declname>b</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1029" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1029" bodyend="1086"/>
        <references refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" compoundref="tokenizer__gptoss_8c" startline="212" endline="251">json_unescape_inplace</references>
        <references refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" compoundref="tokenizer__gptoss_8c" startline="187" endline="210">scan_json_string</references>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <references refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" compoundref="tokenizer__gptoss_8c" startline="79" endline="85">xstrdup_n</references>
        <referencedby refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_merges_array</definition>
        <argsstring>(const char *json, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_merges_array</name>
        <param>
          <type>const char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1088" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1088" bodyend="1147"/>
        <references refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" compoundref="tokenizer__gptoss_8c" startline="269" endline="284">find_key_in_object</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" compoundref="tokenizer__gptoss_8c" startline="804">ie_tok_gptoss_s::intern</references>
        <references refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" compoundref="tokenizer__gptoss_8c" startline="602" endline="623">intern_get_or_add</references>
        <references refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" compoundref="tokenizer__gptoss_8c" startline="551" endline="563">intern_init</references>
        <references refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" compoundref="tokenizer__gptoss_8c" startline="802">ie_tok_gptoss_s::pair_to_rank</references>
        <references refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" compoundref="tokenizer__gptoss_8c" startline="803">ie_tok_gptoss_s::pair_to_rank_cap</references>
        <references refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" compoundref="tokenizer__gptoss_8c" startline="414" endline="421">pairrank_map_init</references>
        <references refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" compoundref="tokenizer__gptoss_8c" startline="423" endline="433">pairrank_map_put</references>
        <references refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" compoundref="tokenizer__gptoss_8c" startline="1029" endline="1086">scan_merge_entry</references>
        <references refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" compoundref="tokenizer__gptoss_8c" startline="182" endline="185">skip_ws</references>
        <referencedby refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" compoundref="tokenizer__gptoss_8c" startline="1149" endline="1163">parse_tokenizer_json</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_tokenizer_json</definition>
        <argsstring>(const char *json, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_tokenizer_json</name>
        <param>
          <type>const char *</type>
          <declname>json</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1149" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1149" bodyend="1163"/>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" compoundref="tokenizer__gptoss_8c" startline="785">IE_TOK_MODE_GPT2</references>
        <references refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" compoundref="tokenizer__gptoss_8c" startline="795">ie_tok_gptoss_s::mode</references>
        <references refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" compoundref="tokenizer__gptoss_8c" startline="893" endline="1027">parse_added_tokens_array</references>
        <references refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" compoundref="tokenizer__gptoss_8c" startline="1088" endline="1147">parse_merges_array</references>
        <references refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" compoundref="tokenizer__gptoss_8c" startline="820" endline="874">parse_vocab_object</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int rd_u32le</definition>
        <argsstring>(const unsigned char *buf, size_t n, size_t *io_off, uint32_t *out)</argsstring>
        <name>rd_u32le</name>
        <param>
          <type>const unsigned char *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>io_off</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1169" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1169" bodyend="1181"/>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
        <referencedby refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" compoundref="tokenizer__gptoss_8c" startline="1195" endline="1208">rd_lp_string</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a56ace11b01ce1af52ab0ad0b43a143e8" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int rd_u16le</definition>
        <argsstring>(const unsigned char *buf, size_t n, size_t *io_off, uint16_t *out)</argsstring>
        <name>rd_u16le</name>
        <param>
          <type>const unsigned char *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>io_off</declname>
        </param>
        <param>
          <type>uint16_t *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1183" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1183" bodyend="1193"/>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int rd_lp_string</definition>
        <argsstring>(const unsigned char *buf, size_t n, size_t *io_off, char **out_s)</argsstring>
        <name>rd_lp_string</name>
        <param>
          <type>const unsigned char *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>io_off</declname>
        </param>
        <param>
          <type>char **</type>
          <declname>out_s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1195" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1195" bodyend="1208"/>
        <references refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" compoundref="tokenizer__gptoss_8c" startline="1169" endline="1181">rd_u32le</references>
        <referencedby refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_tokenizer_packed</definition>
        <argsstring>(const unsigned char *buf, size_t n, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_tokenizer_packed</name>
        <param>
          <type>const unsigned char *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1210" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1210" bodyend="1274"/>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" compoundref="tokenizer__gptoss_8c" startline="785">IE_TOK_MODE_GPT2</references>
        <references refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" compoundref="tokenizer__gptoss_8c" startline="804">ie_tok_gptoss_s::intern</references>
        <references refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" compoundref="tokenizer__gptoss_8c" startline="602" endline="623">intern_get_or_add</references>
        <references refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" compoundref="tokenizer__gptoss_8c" startline="551" endline="563">intern_init</references>
        <references refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" compoundref="tokenizer__gptoss_8c" startline="795">ie_tok_gptoss_s::mode</references>
        <references refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" compoundref="tokenizer__gptoss_8c" startline="802">ie_tok_gptoss_s::pair_to_rank</references>
        <references refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" compoundref="tokenizer__gptoss_8c" startline="803">ie_tok_gptoss_s::pair_to_rank_cap</references>
        <references refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" compoundref="tokenizer__gptoss_8c" startline="414" endline="421">pairrank_map_init</references>
        <references refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" compoundref="tokenizer__gptoss_8c" startline="423" endline="433">pairrank_map_put</references>
        <references refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" compoundref="tokenizer__gptoss_8c" startline="1195" endline="1208">rd_lp_string</references>
        <references refid="tokenizer__gptoss_8c_1a56ace11b01ce1af52ab0ad0b43a143e8" compoundref="tokenizer__gptoss_8c" startline="1183" endline="1193">rd_u16le</references>
        <references refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" compoundref="tokenizer__gptoss_8c" startline="1169" endline="1181">rd_u32le</references>
        <references refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" compoundref="tokenizer__gptoss_8c" startline="373" endline="380">strid_map_init</references>
        <references refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" compoundref="tokenizer__gptoss_8c" startline="382" endline="399">strid_map_put</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" compoundref="tokenizer__gptoss_8c" startline="801">ie_tok_gptoss_s::tok_to_id_cap</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ab46d669ba9cff8f9da6f83855783db7b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int is_packed_tokenizer</definition>
        <argsstring>(const unsigned char *buf, size_t n)</argsstring>
        <name>is_packed_tokenizer</name>
        <param>
          <type>const unsigned char *</type>
          <declname>buf</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1276" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1276" bodyend="1279"/>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ac06fcc2954706950518627e10d7380ae" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int b64_val</definition>
        <argsstring>(int c)</argsstring>
        <name>b64_val</name>
        <param>
          <type>int</type>
          <declname>c</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1285" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1285" bodyend="1294"/>
        <referencedby refid="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" compoundref="tokenizer__gptoss_8c" startline="1296" endline="1340">b64_decode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int b64_decode</definition>
        <argsstring>(const char *s, size_t n, uint8_t **out, size_t *out_n)</argsstring>
        <name>b64_decode</name>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type>uint8_t **</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1296" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1296" bodyend="1340"/>
        <references refid="tokenizer__gptoss_8c_1ac06fcc2954706950518627e10d7380ae" compoundref="tokenizer__gptoss_8c" startline="1285" endline="1294">b64_val</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a71d6f4c29421de37e49a491bfc093abc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_uint32_str</definition>
        <argsstring>(const char *s, const char *e, uint32_t *out)</argsstring>
        <name>parse_uint32_str</name>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>e</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1342" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1342" bodyend="1354"/>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a14abd5d14b520ef7064cd5f55e5ca72f" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int ensure_id_to_bytes</definition>
        <argsstring>(ie_tok_gptoss_t *tok, uint32_t need)</argsstring>
        <name>ensure_id_to_bytes</name>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>need</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1356" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1356" bodyend="1373"/>
        <references refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" compoundref="tokenizer__gptoss_8c" startline="808">ie_tok_gptoss_s::id_to_bytes</references>
        <references refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" compoundref="tokenizer__gptoss_8c" startline="791">bytes_view_s::n</references>
        <references refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" compoundref="tokenizer__gptoss_8c" startline="790">bytes_view_s::p</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1aaf871077f9a480203cb6ab0d73f1df5c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int finalize_tt_vocab_size</definition>
        <argsstring>(ie_tok_gptoss_t *tok, uint32_t max_id_plus1)</argsstring>
        <name>finalize_tt_vocab_size</name>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>max_id_plus1</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1375" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1375" bodyend="1383"/>
        <references refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" compoundref="tokenizer__gptoss_8c" startline="808">ie_tok_gptoss_s::id_to_bytes</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int parse_tokenizer_tiktoken</definition>
        <argsstring>(const char *text, size_t len, ie_tok_gptoss_t *tok)</argsstring>
        <name>parse_tokenizer_tiktoken</name>
        <param>
          <type>const char *</type>
          <declname>text</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>len</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1385" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1385" bodyend="1459"/>
        <references refid="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" compoundref="tokenizer__gptoss_8c" startline="1296" endline="1340">b64_decode</references>
        <references refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" compoundref="tokenizer__gptoss_8c" startline="769" endline="778">bytearena_alloc</references>
        <references refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" compoundref="tokenizer__gptoss_8c" startline="809">ie_tok_gptoss_s::bytes_to_id</references>
        <references refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" compoundref="tokenizer__gptoss_8c" startline="810">ie_tok_gptoss_s::bytes_to_id_cap</references>
        <references refid="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" compoundref="tokenizer__gptoss_8c" startline="492" endline="503">bytesid_map_get</references>
        <references refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" compoundref="tokenizer__gptoss_8c" startline="459" endline="466">bytesid_map_init</references>
        <references refid="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" compoundref="tokenizer__gptoss_8c" startline="468" endline="490">bytesid_map_put</references>
        <references refid="tokenizer__gptoss_8c_1a14abd5d14b520ef7064cd5f55e5ca72f" compoundref="tokenizer__gptoss_8c" startline="1356" endline="1373">ensure_id_to_bytes</references>
        <references refid="tokenizer__gptoss_8c_1aaf871077f9a480203cb6ab0d73f1df5c" compoundref="tokenizer__gptoss_8c" startline="1375" endline="1383">finalize_tt_vocab_size</references>
        <references refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" compoundref="tokenizer__gptoss_8c" startline="808">ie_tok_gptoss_s::id_to_bytes</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" compoundref="tokenizer__gptoss_8c" startline="786">IE_TOK_MODE_TIKTOKEN</references>
        <references refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" compoundref="tokenizer__gptoss_8c" startline="795">ie_tok_gptoss_s::mode</references>
        <references refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" compoundref="tokenizer__gptoss_8c" startline="791">bytes_view_s::n</references>
        <references refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" compoundref="tokenizer__gptoss_8c" startline="790">bytes_view_s::p</references>
        <references refid="tokenizer__gptoss_8c_1a71d6f4c29421de37e49a491bfc093abc" compoundref="tokenizer__gptoss_8c" startline="1342" endline="1354">parse_uint32_str</references>
        <references refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" compoundref="tokenizer__gptoss_8c" startline="811">ie_tok_gptoss_s::tt_arena</references>
        <references refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" compoundref="tokenizer__gptoss_8c" startline="812">ie_tok_gptoss_s::tt_byte_id</references>
        <references refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" compoundref="tokenizer__gptoss_8c" startline="813">ie_tok_gptoss_s::tt_have_byte_id</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int to_bytelevel_unicode</definition>
        <argsstring>(const byteunicode_t *bu, const char *s, size_t n, strbuf_t *out)</argsstring>
        <name>to_bytelevel_unicode</name>
        <param>
          <type>const <ref refid="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" kindref="member">byteunicode_t</ref> *</type>
          <declname>bu</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>s</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>n</declname>
        </param>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" kindref="member">strbuf_t</ref> *</type>
          <declname>out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1465" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1465" bodyend="1476"/>
        <references refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" compoundref="tokenizer__gptoss_8c" startline="630">byteunicode_s::byte_to_cp</references>
        <references refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" compoundref="tokenizer__gptoss_8c" startline="705" endline="711">strbuf_append_bytes</references>
        <references refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" compoundref="tokenizer__gptoss_8c" startline="151" endline="176">utf8_put_cp</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int pretokenize_basic</definition>
        <argsstring>(const char *text, char ***out_parts, size_t *out_n)</argsstring>
        <name>pretokenize_basic</name>
        <param>
          <type>const char *</type>
          <declname>text</declname>
        </param>
        <param>
          <type>char ***</type>
          <declname>out_parts</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>out_n</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1478" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1478" bodyend="1550"/>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" compoundref="tokenizer__gptoss_8c" startline="705" endline="711">strbuf_append_bytes</references>
        <references refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" compoundref="tokenizer__gptoss_8c" startline="713" endline="717">strbuf_free</references>
        <references refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <references refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" compoundref="tokenizer__gptoss_8c" startline="79" endline="85">xstrdup_n</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int bpe_encode_to_ids_gpt2</definition>
        <argsstring>(const ie_tok_gptoss_t *tok, const char *in, u32buf_t *out_ids)</argsstring>
        <name>bpe_encode_to_ids_gpt2</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>in</declname>
        </param>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" kindref="member">u32buf_t</ref> *</type>
          <declname>out_ids</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1553" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1553" bodyend="1660"/>
        <references refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" compoundref="tokenizer__gptoss_8c" startline="804">ie_tok_gptoss_s::intern</references>
        <references refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" compoundref="tokenizer__gptoss_8c" startline="589" endline="600">intern_get</references>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" compoundref="tokenizer__gptoss_8c" startline="802">ie_tok_gptoss_s::pair_to_rank</references>
        <references refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" compoundref="tokenizer__gptoss_8c" startline="803">ie_tok_gptoss_s::pair_to_rank_cap</references>
        <references refid="tokenizer__gptoss_8c_1a569d2debd0e21610e58723b64b065a8d" compoundref="tokenizer__gptoss_8c" startline="435" endline="445">pairrank_map_get</references>
        <references refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" compoundref="tokenizer__gptoss_8c" startline="713" endline="717">strbuf_free</references>
        <references refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</references>
        <references refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" compoundref="tokenizer__gptoss_8c" startline="401" endline="412">strid_map_get</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" compoundref="tokenizer__gptoss_8c" startline="801">ie_tok_gptoss_s::tok_to_id_cap</references>
        <references refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" compoundref="tokenizer__gptoss_8c" startline="674" endline="685">u32buf_push</references>
        <references refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" compoundref="tokenizer__gptoss_8c" startline="124" endline="149">utf8_next_cp</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <references refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" compoundref="tokenizer__gptoss_8c" startline="79" endline="85">xstrdup_n</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int tt_bpe_encode_segment</definition>
        <argsstring>(const ie_tok_gptoss_t *tok, const uint8_t *seg, uint32_t seg_n, u32buf_t *out_ids)</argsstring>
        <name>tt_bpe_encode_segment</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const uint8_t *</type>
          <declname>seg</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>seg_n</declname>
        </param>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" kindref="member">u32buf_t</ref> *</type>
          <declname>out_ids</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1669" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1669" bodyend="1734"/>
        <references refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" compoundref="tokenizer__gptoss_8c" startline="769" endline="778">bytearena_alloc</references>
        <references refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" compoundref="tokenizer__gptoss_8c" startline="733" endline="741">bytearena_free</references>
        <references refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" compoundref="tokenizer__gptoss_8c" startline="809">ie_tok_gptoss_s::bytes_to_id</references>
        <references refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" compoundref="tokenizer__gptoss_8c" startline="810">ie_tok_gptoss_s::bytes_to_id_cap</references>
        <references refid="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" compoundref="tokenizer__gptoss_8c" startline="505" endline="529">bytesid_map_get_concat</references>
        <references refid="structttpiece__s_1aa374fbab840a10d3cdfb347e15ec0671" compoundref="tokenizer__gptoss_8c" startline="1666">ttpiece_s::id</references>
        <references refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" compoundref="tokenizer__gptoss_8c" startline="1665">ttpiece_s::n</references>
        <references refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" compoundref="tokenizer__gptoss_8c" startline="1664">ttpiece_s::p</references>
        <references refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" compoundref="tokenizer__gptoss_8c" startline="812">ie_tok_gptoss_s::tt_byte_id</references>
        <references refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" compoundref="tokenizer__gptoss_8c" startline="674" endline="685">u32buf_push</references>
        <referencedby refid="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" compoundref="tokenizer__gptoss_8c" startline="1736" endline="1755">tt_encode_text</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>static int tt_encode_text</definition>
        <argsstring>(const ie_tok_gptoss_t *tok, const char *text, u32buf_t *out_ids)</argsstring>
        <name>tt_encode_text</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>text</declname>
        </param>
        <param>
          <type><ref refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" kindref="member">u32buf_t</ref> *</type>
          <declname>out_ids</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1736" column="12" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1736" bodyend="1755"/>
        <references refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" compoundref="tokenizer__gptoss_8c" startline="1669" endline="1734">tt_bpe_encode_segment</references>
        <referencedby refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" compoundref="tokenizer__gptoss_8c" startline="1891" endline="1946">ie_tok_gptoss_encode</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ae5c55dc1502414c60d1a99fa9fbdf1bc" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_tok_gptoss_open</definition>
        <argsstring>(const char *tokenizer_path, ie_tok_gptoss_t **out_tok)</argsstring>
        <name>ie_tok_gptoss_open</name>
        <param>
          <type>const char *</type>
          <declname>tokenizer_path</declname>
        </param>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> **</type>
          <declname>out_tok</declname>
        </param>
        <briefdescription>
<para>Open a tokenizer from: </para>
        </briefdescription>
        <detaileddescription>
<para><itemizedlist>
<listitem><para>tokenizer.json</para>
</listitem><listitem><para>tokenizer.tiktoken</para>
</listitem><listitem><para>packed IETOK1 file</para>
</listitem></itemizedlist>
</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">tokenizer_path</parametername>
</parameternamelist>
<parameterdescription>
<para>Path to tokenizer file. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="out">out_tok</parametername>
</parameternamelist>
<parameterdescription>
<para>Tokenizer handle. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>IE_TOK_GPTOSS_OK on success, negative error otherwise. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1761" column="5" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1761" bodyend="1793"/>
        <references refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" compoundref="tokenizer__gptoss_8c" startline="805">ie_tok_gptoss_s::bu</references>
        <references refid="tokenizer__gptoss_8c_1ad4c1b8d22b27793678d951b45034176d" compoundref="tokenizer__gptoss_8c" startline="635" endline="656">byteunicode_init</references>
        <references refid="tokenizer__gptoss_8c_1ad4b875bec514bb9c1de945944e1596de" compoundref="tokenizer__gptoss_8c" startline="1795" endline="1811">ie_tok_gptoss_close</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a7635c982b781a8ef569aded5c8cbcef7" compoundref="ie__tokenizer__gptoss_8h" startline="40">IE_TOK_GPTOSS_ERR_IO</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" compoundref="ie__tokenizer__gptoss_8h" startline="41">IE_TOK_GPTOSS_ERR_JSON</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1ab46d669ba9cff8f9da6f83855783db7b" compoundref="tokenizer__gptoss_8c" startline="1276" endline="1279">is_packed_tokenizer</references>
        <references refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" compoundref="tokenizer__gptoss_8c" startline="1149" endline="1163">parse_tokenizer_json</references>
        <references refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" compoundref="tokenizer__gptoss_8c" startline="1210" endline="1274">parse_tokenizer_packed</references>
        <references refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" compoundref="tokenizer__gptoss_8c" startline="1385" endline="1459">parse_tokenizer_tiktoken</references>
        <references refid="tokenizer__gptoss_8c_1aa12e2f8ade90f9aefa8f1562d02965b8" compoundref="tokenizer__gptoss_8c" startline="112" endline="118">path_ends_with</references>
        <references refid="tokenizer__gptoss_8c_1a84e8a603fef81b42cc1913caf9216f13" compoundref="tokenizer__gptoss_8c" startline="87" endline="110">read_all_bytes</references>
        <references refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" compoundref="tokenizer__gptoss_8c" startline="68" endline="72">xcalloc</references>
        <referencedby refid="main__infer_8c_1a4e30eb4737647a78c4dbebb5b008a5bd" compoundref="main__infer_8c" startline="866" endline="965">decode_tokens_best_effort</referencedby>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
        <referencedby refid="main__chat_8c_1a3c04138a5bfe5d72780bb7e82a18e627" compoundref="main__chat_8c" startline="185" endline="231">main</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ad4b875bec514bb9c1de945944e1596de" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ie_tok_gptoss_close</definition>
        <argsstring>(ie_tok_gptoss_t *tok)</argsstring>
        <name>ie_tok_gptoss_close</name>
        <param>
          <type><ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1795" column="6" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1795" bodyend="1811"/>
        <references refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" compoundref="tokenizer__gptoss_8c" startline="733" endline="741">bytearena_free</references>
        <references refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" compoundref="tokenizer__gptoss_8c" startline="809">ie_tok_gptoss_s::bytes_to_id</references>
        <references refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" compoundref="tokenizer__gptoss_8c" startline="808">ie_tok_gptoss_s::id_to_bytes</references>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" compoundref="tokenizer__gptoss_8c" startline="804">ie_tok_gptoss_s::intern</references>
        <references refid="tokenizer__gptoss_8c_1a118bc90519292f54b3513029942a3867" compoundref="tokenizer__gptoss_8c" startline="565" endline="570">intern_free</references>
        <references refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" compoundref="tokenizer__gptoss_8c" startline="802">ie_tok_gptoss_s::pair_to_rank</references>
        <references refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" compoundref="tokenizer__gptoss_8c" startline="800">ie_tok_gptoss_s::tok_to_id</references>
        <references refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" compoundref="tokenizer__gptoss_8c" startline="811">ie_tok_gptoss_s::tt_arena</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="main__infer_8c_1a4e30eb4737647a78c4dbebb5b008a5bd" compoundref="main__infer_8c" startline="866" endline="965">decode_tokens_best_effort</referencedby>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
        <referencedby refid="ie__api_8h_1a5a9a30f05ef6183f6a75811c616b3a0a" compoundref="ie__api_8c" startline="788" endline="816">ie_engine_destroy</referencedby>
        <referencedby refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" compoundref="tokenizer__gptoss_8c" startline="1761" endline="1793">ie_tok_gptoss_open</referencedby>
        <referencedby refid="main__chat_8c_1a3c04138a5bfe5d72780bb7e82a18e627" compoundref="main__chat_8c" startline="185" endline="231">main</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a0a4146017408baa0a07ffa747dfae870" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>uint32_t</type>
        <definition>uint32_t ie_tok_gptoss_vocab_size</definition>
        <argsstring>(const ie_tok_gptoss_t *tok)</argsstring>
        <name>ie_tok_gptoss_vocab_size</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1813" column="10" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1813" bodyend="1816"/>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="ie__api_8h_1a84bd87043352946e9d53b0f8a5c4abe0" compoundref="ie__api_8c" startline="535" endline="786">ie_engine_create</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1ae372932b3912864351defd6ce553ed88" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_tok_gptoss_decode</definition>
        <argsstring>(const ie_tok_gptoss_t *tok, const uint32_t *ids, uint32_t count, char *out, size_t *inout_bytes)</argsstring>
        <name>ie_tok_gptoss_decode</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const uint32_t *</type>
          <declname>ids</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>count</declname>
        </param>
        <param>
          <type>char *</type>
          <declname>out</declname>
        </param>
        <param>
          <type>size_t *</type>
          <declname>inout_bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1818" column="5" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1818" bodyend="1889"/>
        <references refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" compoundref="tokenizer__gptoss_8c" startline="805">ie_tok_gptoss_s::bu</references>
        <references refid="tokenizer__gptoss_8c_1a501bba302f86962f8c5332144c6271a8" compoundref="tokenizer__gptoss_8c" startline="658" endline="662">byteunicode_cp_to_byte</references>
        <references refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" compoundref="tokenizer__gptoss_8c" startline="808">ie_tok_gptoss_s::id_to_bytes</references>
        <references refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" compoundref="tokenizer__gptoss_8c" startline="799">ie_tok_gptoss_s::id_to_tok</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" compoundref="ie__tokenizer__gptoss_8h" startline="44">IE_TOK_GPTOSS_ERR_INTERNAL</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" compoundref="ie__tokenizer__gptoss_8h" startline="42">IE_TOK_GPTOSS_ERR_NOMEM</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" compoundref="ie__tokenizer__gptoss_8h" startline="43">IE_TOK_GPTOSS_ERR_RANGE</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" compoundref="tokenizer__gptoss_8c" startline="786">IE_TOK_MODE_TIKTOKEN</references>
        <references refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" compoundref="tokenizer__gptoss_8c" startline="795">ie_tok_gptoss_s::mode</references>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" compoundref="tokenizer__gptoss_8c" startline="791">bytes_view_s::n</references>
        <references refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" compoundref="tokenizer__gptoss_8c" startline="790">bytes_view_s::p</references>
        <references refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" compoundref="tokenizer__gptoss_8c" startline="705" endline="711">strbuf_append_bytes</references>
        <references refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" compoundref="tokenizer__gptoss_8c" startline="713" endline="717">strbuf_free</references>
        <references refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</references>
        <references refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" compoundref="tokenizer__gptoss_8c" startline="124" endline="149">utf8_next_cp</references>
        <references refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" compoundref="tokenizer__gptoss_8c" startline="151" endline="176">utf8_put_cp</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <references refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" compoundref="tokenizer__gptoss_8c" startline="796">ie_tok_gptoss_s::vocab_size</references>
        <referencedby refid="main__chat_8c_1ae896159f978561c1c42b20fbd05559e4" compoundref="main__chat_8c" startline="73" endline="108">cmd_decode</referencedby>
        <referencedby refid="main__chat_8c_1ac47c278fe62ce7ee4c6901d302bb155f" compoundref="main__chat_8c" startline="141" endline="183">cmd_roundtrip</referencedby>
        <referencedby refid="ie__api_8c_1af4b6edd2486afdb267a858511e63c42f" compoundref="ie__api_8c" startline="453" endline="490">decode_piece_preview_</referencedby>
        <referencedby refid="main__infer_8c_1a4e30eb4737647a78c4dbebb5b008a5bd" compoundref="main__infer_8c" startline="866" endline="965">decode_tokens_best_effort</referencedby>
        <referencedby refid="ie__api_8h_1a950ac9a0efe5a4fe068a288e57099c4a" compoundref="ie__api_8c" startline="826" endline="1109">ie_engine_generate_ex</referencedby>
      </memberdef>
      <memberdef kind="function" id="tokenizer__gptoss_8c_1a171cd54148a22d4fd7c1c8d1e9f010de" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ie_tok_gptoss_encode</definition>
        <argsstring>(const ie_tok_gptoss_t *tok, const char *text, uint32_t *ids, uint32_t *inout_count)</argsstring>
        <name>ie_tok_gptoss_encode</name>
        <param>
          <type>const <ref refid="ie__tokenizer__gptoss_8h_1ae1b205a897f0ece89cc8f2899acc0543" kindref="member">ie_tok_gptoss_t</ref> *</type>
          <declname>tok</declname>
        </param>
        <param>
          <type>const char *</type>
          <declname>text</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>ids</declname>
        </param>
        <param>
          <type>uint32_t *</type>
          <declname>inout_count</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="engine/src/io/tokenizer_gptoss.c" line="1891" column="5" bodyfile="engine/src/io/tokenizer_gptoss.c" bodystart="1891" bodyend="1946"/>
        <references refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" compoundref="tokenizer__gptoss_8c" startline="1553" endline="1660">bpe_encode_to_ids_gpt2</references>
        <references refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" compoundref="tokenizer__gptoss_8c" startline="805">ie_tok_gptoss_s::bu</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" compoundref="ie__tokenizer__gptoss_8h" startline="39">IE_TOK_GPTOSS_ERR_ARGS</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" compoundref="ie__tokenizer__gptoss_8h" startline="44">IE_TOK_GPTOSS_ERR_INTERNAL</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" compoundref="ie__tokenizer__gptoss_8h" startline="43">IE_TOK_GPTOSS_ERR_RANGE</references>
        <references refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" compoundref="ie__tokenizer__gptoss_8h" startline="38">IE_TOK_GPTOSS_OK</references>
        <references refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" compoundref="tokenizer__gptoss_8c" startline="786">IE_TOK_MODE_TIKTOKEN</references>
        <references refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" compoundref="tokenizer__gptoss_8c" startline="795">ie_tok_gptoss_s::mode</references>
        <references refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" compoundref="tokenizer__gptoss_8c" startline="670">u32buf_s::n</references>
        <references refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" compoundref="tokenizer__gptoss_8c" startline="689">strbuf_s::n</references>
        <references refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" compoundref="tokenizer__gptoss_8c" startline="1478" endline="1550">pretokenize_basic</references>
        <references refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" compoundref="tokenizer__gptoss_8c" startline="713" endline="717">strbuf_free</references>
        <references refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" compoundref="tokenizer__gptoss_8c" startline="693" endline="703">strbuf_reserve</references>
        <references refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" compoundref="tokenizer__gptoss_8c" startline="1465" endline="1476">to_bytelevel_unicode</references>
        <references refid="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" compoundref="tokenizer__gptoss_8c" startline="1736" endline="1755">tt_encode_text</references>
        <references refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" compoundref="tokenizer__gptoss_8c" startline="669">u32buf_s::v</references>
        <references refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" compoundref="tokenizer__gptoss_8c" startline="688">strbuf_s::v</references>
        <referencedby refid="main__chat_8c_1a85977bfad7ce939338220eda76285abd" compoundref="main__chat_8c" startline="110" endline="139">cmd_encode</referencedby>
        <referencedby refid="main__chat_8c_1ac47c278fe62ce7ee4c6901d302bb155f" compoundref="main__chat_8c" startline="141" endline="183">cmd_roundtrip</referencedby>
        <referencedby refid="ie__api_8h_1a950ac9a0efe5a4fe068a288e57099c4a" compoundref="ie__api_8c" startline="826" endline="1109">ie_engine_generate_ex</referencedby>
        <referencedby refid="generate__gptoss_8h_1ae2b49a4109c69ec3ff996adea490690d" compoundref="generate__gptoss_8c" startline="38" endline="213">ie_generate_gptoss</referencedby>
      </memberdef>
    </sectiondef>
    <briefdescription>
<para>GPT-OSS tokenizer supporting: </para>
    </briefdescription>
    <detaileddescription>
<para><itemizedlist>
<listitem><para>HuggingFace <computeroutput>tokenizer.json</computeroutput> (GPT-2 byte-level BPE)</para>
</listitem><listitem><para>Packed <computeroutput>IETOK1</computeroutput> (recommended)</para>
</listitem><listitem><para>OpenAI-style <computeroutput>.tiktoken</computeroutput> ranks (base64 token bytes + rank)</para>
</listitem></itemizedlist>
</para>
<para>Notes:<itemizedlist>
<listitem><para>Correctness is prioritized over speed.</para>
</listitem><listitem><para><computeroutput>.tiktoken</computeroutput> tokens are binary-safe and stored as raw bytes.</para>
</listitem><listitem><para><computeroutput>.tiktoken</computeroutput> encode uses byte-level BPE per conservative segments: runs of whitespace and runs of non-whitespace. </para>
</listitem></itemizedlist>
</para>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/*<sp/>==========================================================================</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>File:<sp/>engine/src/io/tokenizer_gptoss.c</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>==========================================================================</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*/</highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ie__tokenizer__gptoss_8h" kindref="compound">ie_tokenizer_gptoss.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ctype.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;errno.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;limits.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdint.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdio.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdlib.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="30"><highlight class="comment"><sp/>*<sp/>Small<sp/>utilities</highlight></codeline>
<codeline lineno="31"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33" refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/><ref refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" kindref="member">fnv1a64</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)data;</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/>1469598103934665603ull;</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>^=<sp/>(uint64_t)p[i];</highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>*=<sp/>1099511628211ull;</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>h;</highlight></codeline>
<codeline lineno="41"><highlight class="normal">}</highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight></codeline>
<codeline lineno="43" refid="tokenizer__gptoss_8c_1a2e1ab240e638d9d6bb9f6ffd8451d8ef" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint64_t<sp/><ref refid="tokenizer__gptoss_8c_1a2e1ab240e638d9d6bb9f6ffd8451d8ef" kindref="member">fnv1a64_two</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*a,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>an,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*b,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bn)<sp/>{</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)a;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/>1469598103934665603ull;</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>an;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>^=<sp/>(uint64_t)p[i];</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>*=<sp/>1099511628211ull;</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/>p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)b;</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>bn;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>^=<sp/>(uint64_t)p[i];</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>*=<sp/>1099511628211ull;</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>h;</highlight></codeline>
<codeline lineno="56"><highlight class="normal">}</highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight></codeline>
<codeline lineno="58" refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint32_t<sp/><ref refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" kindref="member">fnv1a32</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*data,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)data;</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/>uint32_t<sp/>h<sp/>=<sp/>2166136261u;</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>^=<sp/>(uint32_t)p[i];</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/>h<sp/>*=<sp/>16777619u;</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>h;</highlight></codeline>
<codeline lineno="66"><highlight class="normal">}</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68" refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>sz)<sp/>{</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0<sp/>||<sp/>sz<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&gt;<sp/>(SIZE_MAX<sp/>/<sp/>sz))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>calloc(n,<sp/>sz);</highlight></codeline>
<codeline lineno="72"><highlight class="normal">}</highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight></codeline>
<codeline lineno="74" refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" kindref="member">xrealloc</ref>(</highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*p,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>realloc(p,<sp/>n);</highlight></codeline>
<codeline lineno="77"><highlight class="normal">}</highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight></codeline>
<codeline lineno="79" refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(n<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/>memcpy(p,<sp/>s,<sp/>n);</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/>p[n]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>p;</highlight></codeline>
<codeline lineno="85"><highlight class="normal">}</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="87" refid="tokenizer__gptoss_8c_1a84e8a603fef81b42cc1913caf9216f13" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a84e8a603fef81b42cc1913caf9216f13" kindref="member">read_all_bytes</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**out_buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_len)<sp/>{</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!path<sp/>||<sp/>!out_buf<sp/>||<sp/>!out_len)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/>*out_buf<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/>*out_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/>FILE<sp/>*f<sp/>=<sp/>fopen(path,<sp/></highlight><highlight class="stringliteral">&quot;rb&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!f)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fseek(f,<sp/>0,<sp/>SEEK_END)<sp/>!=<sp/>0)<sp/>{<sp/>fclose(f);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>sz<sp/>=<sp/>ftell(f);</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sz<sp/>&lt;<sp/>0)<sp/>{<sp/>fclose(f);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fseek(f,<sp/>0,<sp/>SEEK_SET)<sp/>!=<sp/>0)<sp/>{<sp/>fclose(f);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="98"><highlight class="normal"></highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)sz<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf)<sp/>{<sp/>fclose(f);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>rd<sp/>=<sp/>fread(buf,<sp/>1,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)sz,<sp/>f);</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/>fclose(f);</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rd<sp/>!=<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)sz)<sp/>{<sp/>free(buf);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/>buf[sz]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/>*out_buf<sp/>=<sp/>buf;</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/>*out_len<sp/>=<sp/>(size_t)sz;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="110"><highlight class="normal">}</highlight></codeline>
<codeline lineno="111"><highlight class="normal"></highlight></codeline>
<codeline lineno="112" refid="tokenizer__gptoss_8c_1aa12e2f8ade90f9aefa8f1562d02965b8" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1aa12e2f8ade90f9aefa8f1562d02965b8" kindref="member">path_ends_with</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*path,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*suf)<sp/>{</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!path<sp/>||<sp/>!suf)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>a<sp/>=<sp/>strlen(path);</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>strlen(suf);</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b<sp/>&gt;<sp/>a)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>memcmp(path<sp/>+<sp/>(a<sp/>-<sp/>b),<sp/>suf,<sp/>b)<sp/>==<sp/>0;</highlight></codeline>
<codeline lineno="118"><highlight class="normal">}</highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="121"><highlight class="comment"><sp/>*<sp/>Minimal<sp/>UTF-8<sp/>decode/encode</highlight></codeline>
<codeline lineno="122"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight></codeline>
<codeline lineno="124" refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" kindref="member">utf8_next_cp</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*io_i,<sp/>uint32_t<sp/>*out_cp)<sp/>{</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!io_i<sp/>||<sp/>!out_cp)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>*io_i;</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;=<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c0<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/>char)s[i++];</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c0<sp/>&lt;<sp/>0x80)<sp/>{<sp/>*out_cp<sp/>=<sp/>(uint32_t)c0;<sp/>*io_i<sp/>=<sp/>i;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>need<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((c0<sp/>&amp;<sp/>0xE0)<sp/>==<sp/>0xC0)<sp/>{<sp/>need<sp/>=<sp/>1;<sp/>cp<sp/>=<sp/>(uint32_t)(c0<sp/>&amp;<sp/>0x1F);<sp/>}</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((c0<sp/>&amp;<sp/>0xF0)<sp/>==<sp/>0xE0)<sp/>{<sp/>need<sp/>=<sp/>2;<sp/>cp<sp/>=<sp/>(uint32_t)(c0<sp/>&amp;<sp/>0x0F);<sp/>}</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((c0<sp/>&amp;<sp/>0xF8)<sp/>==<sp/>0xF0)<sp/>{<sp/>need<sp/>=<sp/>3;<sp/>cp<sp/>=<sp/>(uint32_t)(c0<sp/>&amp;<sp/>0x07);<sp/>}</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>+<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)need<sp/>&gt;<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>k<sp/>=<sp/>0;<sp/>k<sp/>&lt;<sp/>need;<sp/>++k)<sp/>{</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>cx<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/>char)s[i++];</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cx<sp/>&amp;<sp/>0xC0)<sp/>!=<sp/>0x80)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>cp<sp/>=<sp/>(cp<sp/>&lt;&lt;<sp/>6)<sp/>|<sp/>(uint32_t)(cx<sp/>&amp;<sp/>0x3F);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/>*out_cp<sp/>=<sp/>cp;</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/>*io_i<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="149"><highlight class="normal">}</highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151" refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" kindref="member">utf8_put_cp</ref>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dst,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/>uint32_t<sp/>cp)<sp/>{</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!dst<sp/>||<sp/>cap<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cp<sp/>&lt;<sp/>0x80)<sp/>{</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cap<sp/>&lt;<sp/>1)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[0]<sp/>=<sp/>(char)cp;</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cp<sp/>&lt;<sp/>0x800)<sp/>{</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cap<sp/>&lt;<sp/>2)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[0]<sp/>=<sp/>(char)(0xC0<sp/>|<sp/>(cp<sp/>&gt;&gt;<sp/>6));</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[1]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>(cp<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>2;</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cp<sp/>&lt;<sp/>0x10000)<sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cap<sp/>&lt;<sp/>3)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[0]<sp/>=<sp/>(char)(0xE0<sp/>|<sp/>(cp<sp/>&gt;&gt;<sp/>12));</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[1]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>((cp<sp/>&gt;&gt;<sp/>6)<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[2]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>(cp<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>3;</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cap<sp/>&lt;<sp/>4)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[0]<sp/>=<sp/>(char)(0xF0<sp/>|<sp/>(cp<sp/>&gt;&gt;<sp/>18));</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[1]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>((cp<sp/>&gt;&gt;<sp/>12)<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[2]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>((cp<sp/>&gt;&gt;<sp/>6)<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[3]<sp/>=<sp/>(char)(0x80<sp/>|<sp/>(cp<sp/>&amp;<sp/>0x3F));</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>4;</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="176"><highlight class="normal">}</highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="179"><highlight class="comment"><sp/>*<sp/>JSON<sp/>scanner<sp/>tailored<sp/>for<sp/>tokenizer.json</highlight></codeline>
<codeline lineno="180"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="182" refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p)<sp/>{</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p<sp/>&amp;&amp;<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p<sp/>&lt;=<sp/>0x20)<sp/>++p;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>p;</highlight></codeline>
<codeline lineno="185"><highlight class="normal">}</highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight></codeline>
<codeline lineno="187" refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**pp,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**out_s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_n)<sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(*pp);</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*start<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p)<sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">)<sp/>{<sp/>++p;<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!*p)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>++p;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*end<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*raw<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(start,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)(end<sp/>-<sp/>start));</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!raw)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/>*out_s<sp/>=<sp/>raw;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(out_n)<sp/>*out_n<sp/>=<sp/>(size_t)(end<sp/>-<sp/>start);</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="210"><highlight class="normal">}</highlight></codeline>
<codeline lineno="211"><highlight class="normal"></highlight></codeline>
<codeline lineno="212" refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s)<sp/>{</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*w<sp/>=<sp/>s;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*r<sp/>=<sp/>s;<sp/>*r;<sp/>++r)<sp/>{</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*r<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">)<sp/>{<sp/>*w++<sp/>=<sp/>*r;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/>++r;</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!*r)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(*r)<sp/>{</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;b&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\b&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;f&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\f&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;n&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\r&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;t&apos;</highlight><highlight class="normal">:<sp/>*w++<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal">;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/></highlight><highlight class="charliteral">&apos;u&apos;</highlight><highlight class="normal">:<sp/>{</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>k<sp/>=<sp/>0;<sp/>k<sp/>&lt;<sp/>4;<sp/>++k)<sp/>{</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++r;</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>*r;</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!c)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v<sp/>&lt;&lt;=<sp/>4;</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">)<sp/>v<sp/>|=<sp/>(uint32_t)(c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;f&apos;</highlight><highlight class="normal">)<sp/>v<sp/>|=<sp/>(uint32_t)(10<sp/>+<sp/>(c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;F&apos;</highlight><highlight class="normal">)<sp/>v<sp/>|=<sp/>(uint32_t)(10<sp/>+<sp/>(c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tmp[4];</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" kindref="member">utf8_put_cp</ref>(tmp,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmp),<sp/>v);</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>*w++<sp/>=<sp/>tmp[i];</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/>*w<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="251"><highlight class="normal">}</highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight></codeline>
<codeline lineno="253" refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" kindref="member">scan_json_int</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**pp,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>*out_val)<sp/>{</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(*pp);</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>neg<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal">)<sp/>{<sp/>neg<sp/>=<sp/>1;<sp/>++p;<sp/>}</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!isdigit((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(isdigit((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p))<sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/>v<sp/>=<sp/>v<sp/>*<sp/>10<sp/>+<sp/>(long)(*p<sp/>-<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>INT_MAX)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/>*out_val<sp/>=<sp/>neg<sp/>?<sp/>-(int)v<sp/>:<sp/>(int)v;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="267"><highlight class="normal">}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"></highlight></codeline>
<codeline lineno="269" refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" kindref="member">find_key_in_object</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*key)<sp/>{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!json<sp/>||<sp/>!key)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>klen<sp/>=<sp/>strlen(key);</highlight></codeline>
<codeline lineno="272"><highlight class="normal"></highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>json;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>((p<sp/>=<sp/>strstr(p,<sp/></highlight><highlight class="stringliteral">&quot;\&quot;&quot;</highlight><highlight class="normal">))<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strncmp(p,<sp/>key,<sp/>klen)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>p[klen]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*q<sp/>=<sp/>p<sp/>+<sp/>klen<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>q<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="284"><highlight class="normal">}</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="286" refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" kindref="member">skip_json_value</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**pp)<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(*pp);</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tmp<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;p,<sp/>&amp;tmp,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/>free(tmp);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>depth<sp/>=<sp/>0,<sp/>in_str<sp/>=<sp/>0,<sp/>esc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>*p;<sp/>p++)<sp/>{</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>*p;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(in_str)<sp/>{</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(esc)<sp/>esc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">)<sp/>esc<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>in_str<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>{<sp/>in_str<sp/>=<sp/>1;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">)<sp/>depth++;</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{<sp/>depth--;<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depth<sp/>==<sp/>0)<sp/>{<sp/>p++;<sp/>*pp<sp/>=<sp/>p;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}<sp/>}</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>depth<sp/>=<sp/>0,<sp/>in_str<sp/>=<sp/>0,<sp/>esc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>*p;<sp/>p++)<sp/>{</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>*p;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(in_str)<sp/>{</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(esc)<sp/>esc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\\&apos;</highlight><highlight class="normal">)<sp/>esc<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>in_str<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>{<sp/>in_str<sp/>=<sp/>1;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">)<sp/>depth++;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/>{<sp/>depth--;<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depth<sp/>==<sp/>0)<sp/>{<sp/>p++;<sp/>*pp<sp/>=<sp/>p;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}<sp/>}</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="331"><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal"><sp/>||<sp/>(*p<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>*p<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/>p++;</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p)<sp/>{</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>*p;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">)<sp/>||<sp/>c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;.&apos;</highlight><highlight class="normal"><sp/>||<sp/>c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;e&apos;</highlight><highlight class="normal"><sp/>||<sp/>c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;E&apos;</highlight><highlight class="normal"><sp/>||<sp/>c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;+&apos;</highlight><highlight class="normal"><sp/>||<sp/>c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal">)<sp/>{<sp/>p++;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strncmp(p,<sp/></highlight><highlight class="stringliteral">&quot;true&quot;</highlight><highlight class="normal">,<sp/>4)<sp/>==<sp/>0)<sp/>{<sp/>*pp<sp/>=<sp/>p<sp/>+<sp/>4;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strncmp(p,<sp/></highlight><highlight class="stringliteral">&quot;false&quot;</highlight><highlight class="normal">,<sp/>5)<sp/>==<sp/>0)<sp/>{<sp/>*pp<sp/>=<sp/>p<sp/>+<sp/>5;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strncmp(p,<sp/></highlight><highlight class="stringliteral">&quot;null&quot;</highlight><highlight class="normal">,<sp/>4)<sp/>==<sp/>0)<sp/>{<sp/>*pp<sp/>=<sp/>p<sp/>+<sp/>4;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="348"><highlight class="normal">}</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="351"><highlight class="comment"><sp/>*<sp/>Hash<sp/>maps:<sp/>string-&gt;id<sp/>and<sp/>pair-&gt;rank<sp/>(GPT-2<sp/>JSON<sp/>backend)</highlight></codeline>
<codeline lineno="352"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight></codeline>
<codeline lineno="354" refid="structstrid__ent__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structstrid__ent__s" kindref="compound">strid_ent_s</ref><sp/>{</highlight></codeline>
<codeline lineno="355" refid="structstrid__ent__s_1a5f3df0b00441dac3055759e3a4bcf374" refkind="member"><highlight class="normal"><sp/><sp/>uint64_t<sp/><ref refid="structstrid__ent__s_1a5f3df0b00441dac3055759e3a4bcf374" kindref="member">h</ref>;</highlight></codeline>
<codeline lineno="356" refid="structstrid__ent__s_1a0b543267355bc6923c4002d3c6c89085" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structstrid__ent__s_1a0b543267355bc6923c4002d3c6c89085" kindref="member">k</ref>;</highlight></codeline>
<codeline lineno="357" refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="358" refid="structstrid__ent__s_1ae945d8681c6f020855d30510af9d353a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structstrid__ent__s_1ae945d8681c6f020855d30510af9d353a" kindref="member">used</ref>;</highlight></codeline>
<codeline lineno="359" refid="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1aa2a7c18d10fbd293034d3e7c7cebaf6b" kindref="member">strid_ent_t</ref>;</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="361" refid="structpairrank__ent__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_s</ref><sp/>{</highlight></codeline>
<codeline lineno="362" refid="structpairrank__ent__s_1acea1c2054af374964f786a022e55574b" refkind="member"><highlight class="normal"><sp/><sp/>uint64_t<sp/><ref refid="structpairrank__ent__s_1acea1c2054af374964f786a022e55574b" kindref="member">key</ref>;</highlight></codeline>
<codeline lineno="363" refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" kindref="member">rank</ref>;</highlight></codeline>
<codeline lineno="364" refid="structpairrank__ent__s_1a8f3db1a245bdd15b98cd40208f238cb9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structpairrank__ent__s_1a8f3db1a245bdd15b98cd40208f238cb9" kindref="member">used</ref>;</highlight></codeline>
<codeline lineno="365" refid="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1af7c4a80f20fc4a520a5be67e810c0ebc" kindref="member">pairrank_ent_t</ref>;</highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367" refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" kindref="member">next_pow2</ref>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>x)<sp/>{</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>p<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(p<sp/>&lt;<sp/>x)<sp/>p<sp/>&lt;&lt;=<sp/>1;</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>p;</highlight></codeline>
<codeline lineno="371"><highlight class="normal">}</highlight></codeline>
<codeline lineno="372"><highlight class="normal"></highlight></codeline>
<codeline lineno="373" refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" kindref="member">strid_map_init</ref>(<ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>**out,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_cap,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>want)<sp/>{</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" kindref="member">next_pow2</ref>(want<sp/>*<sp/>2<sp/>+<sp/>64);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>*m<sp/>=<sp/>(<ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>*)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(cap,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*m));</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>m;</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/>*out_cap<sp/>=<sp/>cap;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="380"><highlight class="normal">}</highlight></codeline>
<codeline lineno="381"><highlight class="normal"></highlight></codeline>
<codeline lineno="382" refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" kindref="member">strid_map_put</ref>(<ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*k,<sp/>uint32_t<sp/>v)<sp/>{</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>!k)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" kindref="member">fnv1a64</ref>(k,<sp/>strlen(k));</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/>{</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structstrid__ent__s_1ae945d8681c6f020855d30510af9d353a" kindref="member">used</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structstrid__ent__s_1a5f3df0b00441dac3055759e3a4bcf374" kindref="member">h</ref><sp/>=<sp/>h;</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structstrid__ent__s_1a0b543267355bc6923c4002d3c6c89085" kindref="member">k</ref><sp/>=<sp/>k;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" kindref="member">v</ref><sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].h<sp/>==<sp/>h<sp/>&amp;&amp;<sp/>strcmp(m[i].k,<sp/>k)<sp/>==<sp/>0)<sp/>{<sp/>m[i].<ref refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" kindref="member">v</ref><sp/>=<sp/>v;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="399"><highlight class="normal">}</highlight></codeline>
<codeline lineno="400"><highlight class="normal"></highlight></codeline>
<codeline lineno="401" refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" kindref="member">strid_map_get</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*k,<sp/>uint32_t<sp/>*out_v)<sp/>{</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>!k<sp/>||<sp/>!out_v)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" kindref="member">fnv1a64</ref>(k,<sp/>strlen(k));</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].h<sp/>==<sp/>h<sp/>&amp;&amp;<sp/>strcmp(m[i].k,<sp/>k)<sp/>==<sp/>0)<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structstrid__ent__s_1ac0490ebcead6e3a8fa28753d3b7360c7" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="412"><highlight class="normal">}</highlight></codeline>
<codeline lineno="413"><highlight class="normal"></highlight></codeline>
<codeline lineno="414" refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" kindref="member">pairrank_map_init</ref>(<ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>**out,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_cap,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>want)<sp/>{</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" kindref="member">next_pow2</ref>(want<sp/>*<sp/>2<sp/>+<sp/>64);</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>*m<sp/>=<sp/>(<ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>*)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(cap,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*m));</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>m;</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/>*out_cap<sp/>=<sp/>cap;</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="421"><highlight class="normal">}</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423" refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" kindref="member">pairrank_map_put</ref>(<ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/>uint64_t<sp/>key,<sp/>uint32_t<sp/>rank)<sp/>{</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)key<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/>{<sp/>m[i].<ref refid="structpairrank__ent__s_1a8f3db1a245bdd15b98cd40208f238cb9" kindref="member">used</ref><sp/>=<sp/>1;<sp/>m[i].<ref refid="structpairrank__ent__s_1acea1c2054af374964f786a022e55574b" kindref="member">key</ref><sp/>=<sp/>key;<sp/>m[i].<ref refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" kindref="member">rank</ref><sp/>=<sp/>rank;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].key<sp/>==<sp/>key)<sp/>{<sp/>m[i].<ref refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" kindref="member">rank</ref><sp/>=<sp/>rank;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="433"><highlight class="normal">}</highlight></codeline>
<codeline lineno="434"><highlight class="normal"></highlight></codeline>
<codeline lineno="435" refid="tokenizer__gptoss_8c_1a569d2debd0e21610e58723b64b065a8d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a569d2debd0e21610e58723b64b065a8d" kindref="member">pairrank_map_get</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/>uint64_t<sp/>key,<sp/>uint32_t<sp/>*out_rank)<sp/>{</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>!out_rank)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)key<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].key<sp/>==<sp/>key)<sp/>{<sp/>*out_rank<sp/>=<sp/>m[i].<ref refid="structpairrank__ent__s_1abe4ad8b00f6854fe36428677218dac5d" kindref="member">rank</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="445"><highlight class="normal">}</highlight></codeline>
<codeline lineno="446"><highlight class="normal"></highlight></codeline>
<codeline lineno="447"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="448"><highlight class="comment"><sp/>*<sp/>Binary<sp/>hash<sp/>map:<sp/>(bytes,len)-&gt;id<sp/>for<sp/>.tiktoken<sp/>backend</highlight></codeline>
<codeline lineno="449"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"></highlight></codeline>
<codeline lineno="451" refid="structbytesid__ent__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_s</ref><sp/>{</highlight></codeline>
<codeline lineno="452" refid="structbytesid__ent__s_1ad53717b7ddfcdd5562570805b8b3a711" refkind="member"><highlight class="normal"><sp/><sp/>uint64_t<sp/><ref refid="structbytesid__ent__s_1ad53717b7ddfcdd5562570805b8b3a711" kindref="member">h</ref>;</highlight></codeline>
<codeline lineno="453" refid="structbytesid__ent__s_1a03ff56c76f4b153f09067bac401de6ee" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structbytesid__ent__s_1a03ff56c76f4b153f09067bac401de6ee" kindref="member">p</ref>;</highlight></codeline>
<codeline lineno="454" refid="structbytesid__ent__s_1a482da673ac3595aee9fe7388fb22499e" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structbytesid__ent__s_1a482da673ac3595aee9fe7388fb22499e" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="455" refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="456" refid="structbytesid__ent__s_1ac8b34aad1cb571742c43c014cf731aea" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structbytesid__ent__s_1ac8b34aad1cb571742c43c014cf731aea" kindref="member">used</ref>;</highlight></codeline>
<codeline lineno="457" refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a9b1adedfb87c89004f36d5b7b269d92f" kindref="member">bytesid_ent_t</ref>;</highlight></codeline>
<codeline lineno="458"><highlight class="normal"></highlight></codeline>
<codeline lineno="459" refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" kindref="member">bytesid_map_init</ref>(<ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>**out,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_cap,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>want)<sp/>{</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" kindref="member">next_pow2</ref>(want<sp/>*<sp/>2<sp/>+<sp/>64);</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*m<sp/>=<sp/>(<ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(cap,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*m));</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>m;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/>*out_cap<sp/>=<sp/>cap;</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="466"><highlight class="normal">}</highlight></codeline>
<codeline lineno="467"><highlight class="normal"></highlight></codeline>
<codeline lineno="468" refid="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" kindref="member">bytesid_map_put</ref>(<ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*p,<sp/>uint32_t<sp/>n,<sp/>uint32_t<sp/>v)<sp/>{</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>(!p<sp/>&amp;&amp;<sp/>n))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" kindref="member">fnv1a64</ref>(p,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n);</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/>{</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1ac8b34aad1cb571742c43c014cf731aea" kindref="member">used</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1ad53717b7ddfcdd5562570805b8b3a711" kindref="member">h</ref><sp/>=<sp/>h;</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1a03ff56c76f4b153f09067bac401de6ee" kindref="member">p</ref><sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1a482da673ac3595aee9fe7388fb22499e" kindref="member">n</ref><sp/>=<sp/>n;</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref><sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].h<sp/>==<sp/>h<sp/>&amp;&amp;<sp/>m[i].n<sp/>==<sp/>n<sp/>&amp;&amp;<sp/>(n<sp/>==<sp/>0<sp/>||<sp/>memcmp(m[i].p,<sp/>p,<sp/>n)<sp/>==<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1a03ff56c76f4b153f09067bac401de6ee" kindref="member">p</ref><sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref><sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="490"><highlight class="normal">}</highlight></codeline>
<codeline lineno="491"><highlight class="normal"></highlight></codeline>
<codeline lineno="492" refid="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" kindref="member">bytesid_map_get</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*p,<sp/>uint32_t<sp/>n,<sp/>uint32_t<sp/>*out_v)<sp/>{</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>(!p<sp/>&amp;&amp;<sp/>n)<sp/>||<sp/>!out_v)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a898969f3cc64c9a343bcfddfbc9a731f" kindref="member">fnv1a64</ref>(p,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n);</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].h<sp/>==<sp/>h<sp/>&amp;&amp;<sp/>m[i].n<sp/>==<sp/>n<sp/>&amp;&amp;<sp/>(n<sp/>==<sp/>0<sp/>||<sp/>memcmp(m[i].p,<sp/>p,<sp/>n)<sp/>==<sp/>0))<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="503"><highlight class="normal">}</highlight></codeline>
<codeline lineno="504"><highlight class="normal"></highlight></codeline>
<codeline lineno="505" refid="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" kindref="member">bytesid_map_get_concat</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*m,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap,</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*a,<sp/>uint32_t<sp/>an,</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*b,<sp/>uint32_t<sp/>bn,</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*out_v)<sp/>{</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>cap<sp/>==<sp/>0<sp/>||<sp/>(!a<sp/>&amp;&amp;<sp/>an)<sp/>||<sp/>(!b<sp/>&amp;&amp;<sp/>bn)<sp/>||<sp/>!out_v)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/>uint32_t<sp/>n<sp/>=<sp/>an<sp/>+<sp/>bn;</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/>uint64_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a2e1ab240e638d9d6bb9f6ffd8451d8ef" kindref="member">fnv1a64_two</ref>(a,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)an,<sp/>b,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)bn);</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>cap<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>cap;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m[i].used)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m[i].h<sp/>==<sp/>h<sp/>&amp;&amp;<sp/>m[i].n<sp/>==<sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0)<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(an<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(m[i].p,<sp/>b,<sp/>bn)<sp/>==<sp/>0)<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bn<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(m[i].p,<sp/>a,<sp/>an)<sp/>==<sp/>0)<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(m[i].p,<sp/>a,<sp/>an)<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>memcmp(m[i].p<sp/>+<sp/>an,<sp/>b,<sp/>bn)<sp/>==<sp/>0)<sp/>{<sp/>*out_v<sp/>=<sp/>m[i].<ref refid="structbytesid__ent__s_1ad1d2d58bda33b6405c50c18ac1e56ba1" kindref="member">v</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="529"><highlight class="normal">}</highlight></codeline>
<codeline lineno="530"><highlight class="normal"></highlight></codeline>
<codeline lineno="531"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="532"><highlight class="comment"><sp/>*<sp/>String<sp/>interning<sp/>for<sp/>GPT-2<sp/>merges</highlight></codeline>
<codeline lineno="533"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="534"><highlight class="normal"></highlight></codeline>
<codeline lineno="535" refid="structintern__ent__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structintern__ent__s" kindref="compound">intern_ent_s</ref><sp/>{</highlight></codeline>
<codeline lineno="536" refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" kindref="member">h</ref>;</highlight></codeline>
<codeline lineno="537" refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" kindref="member">s</ref>;</highlight></codeline>
<codeline lineno="538" refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" kindref="member">id</ref>;</highlight></codeline>
<codeline lineno="539" refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" kindref="member">used</ref>;</highlight></codeline>
<codeline lineno="540" refid="tokenizer__gptoss_8c_1aa7766b67a47b1eafd83f27a64a475feb" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1aa7766b67a47b1eafd83f27a64a475feb" kindref="member">intern_ent_t</ref>;</highlight></codeline>
<codeline lineno="541"><highlight class="normal"></highlight></codeline>
<codeline lineno="542" refid="structintern__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structintern__s" kindref="compound">intern_s</ref><sp/>{</highlight></codeline>
<codeline lineno="543" refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structintern__ent__s" kindref="compound">intern_ent_t</ref><sp/>*<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>;</highlight></codeline>
<codeline lineno="544" refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref>;</highlight></codeline>
<codeline lineno="545" refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref>;</highlight></codeline>
<codeline lineno="546" refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref>;</highlight></codeline>
<codeline lineno="547" refid="structintern__s_1aad00748399fd7074aa910c96593d1519" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structintern__s_1aad00748399fd7074aa910c96593d1519" kindref="member">arena_used</ref>;</highlight></codeline>
<codeline lineno="548" refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" kindref="member">next_id</ref>;</highlight></codeline>
<codeline lineno="549" refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a23d83e849fb85fbcc42900aa2ee50a66" kindref="member">intern_t</ref>;</highlight></codeline>
<codeline lineno="550"><highlight class="normal"></highlight></codeline>
<codeline lineno="551" refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" kindref="member">intern_init</ref>(<ref refid="structintern__s" kindref="compound">intern_t</ref><sp/>*in,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>want_syms,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>arena_hint)<sp/>{</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/>memset(in,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*in));</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref><sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a8c1a135d3fef83b2c8a2ce0e84e95c85" kindref="member">next_pow2</ref>(want_syms<sp/>*<sp/>2<sp/>+<sp/>64);</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref><sp/>=<sp/>(<ref refid="structintern__ent__s" kindref="compound">intern_ent_t</ref><sp/>*)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref>,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>));</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref><sp/>=<sp/>(arena_hint<sp/>?<sp/>arena_hint<sp/>:<sp/>(1u<sp/>&lt;&lt;<sp/>20));</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc(in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref>);</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref>)<sp/>{<sp/>free(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>);<sp/>memset(in,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*in));<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1aad00748399fd7074aa910c96593d1519" kindref="member">arena_used</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" kindref="member">next_id</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="563"><highlight class="normal">}</highlight></codeline>
<codeline lineno="564"><highlight class="normal"></highlight></codeline>
<codeline lineno="565" refid="tokenizer__gptoss_8c_1a118bc90519292f54b3513029942a3867" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a118bc90519292f54b3513029942a3867" kindref="member">intern_free</ref>(<ref refid="structintern__s" kindref="compound">intern_t</ref><sp/>*in)<sp/>{</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/>free(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>);</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/>free(in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref>);</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/>memset(in,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*in));</highlight></codeline>
<codeline lineno="570"><highlight class="normal">}</highlight></codeline>
<codeline lineno="571"><highlight class="normal"></highlight></codeline>
<codeline lineno="572" refid="tokenizer__gptoss_8c_1a7149c5ac8540bb92b6357a38aa2bd404" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="tokenizer__gptoss_8c_1a7149c5ac8540bb92b6357a38aa2bd404" kindref="member">intern_store</ref>(<ref refid="structintern__s" kindref="compound">intern_t</ref><sp/>*in,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in<sp/>||<sp/>!s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>+<sp/>1<sp/>&gt;<sp/>in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref><sp/>-<sp/>in-&gt;<ref refid="structintern__s_1aad00748399fd7074aa910c96593d1519" kindref="member">arena_used</ref>)<sp/>{</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>new_sz<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref><sp/>?<sp/>in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref><sp/>*<sp/>2<sp/>:<sp/>(1u<sp/>&lt;&lt;<sp/>20);</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(new_sz<sp/>&lt;<sp/>in-&gt;arena_used<sp/>+<sp/>n<sp/>+<sp/>1)<sp/>new_sz<sp/>*=<sp/>2;</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*na<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)realloc(in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref>,<sp/>new_sz);</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!na)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref><sp/>=<sp/>na;</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1a95b29e7227da9455fdda515193c0e4bd" kindref="member">arena_sz</ref><sp/>=<sp/>new_sz;</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dst<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1aa10231c9ecb86b149dc948afdc811fa9" kindref="member">arena</ref><sp/>+<sp/>in-&gt;<ref refid="structintern__s_1aad00748399fd7074aa910c96593d1519" kindref="member">arena_used</ref>;</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/>memcpy(dst,<sp/>s,<sp/>n);</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/>dst[n]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/>in-&gt;<ref refid="structintern__s_1aad00748399fd7074aa910c96593d1519" kindref="member">arena_used</ref><sp/>+=<sp/>n<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>dst;</highlight></codeline>
<codeline lineno="587"><highlight class="normal">}</highlight></codeline>
<codeline lineno="588"><highlight class="normal"></highlight></codeline>
<codeline lineno="589" refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" kindref="member">intern_get</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structintern__s" kindref="compound">intern_t</ref><sp/>*in,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/>uint32_t<sp/>*out_id)<sp/>{</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in<sp/>||<sp/>!s<sp/>||<sp/>!out_id<sp/>||<sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref><sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/>uint32_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" kindref="member">fnv1a32</ref>(s,<sp/>strlen(s));</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref><sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref>;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" kindref="member">used</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" kindref="member">h</ref><sp/>==<sp/>h<sp/>&amp;&amp;<sp/>strcmp(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" kindref="member">s</ref>,<sp/>s)<sp/>==<sp/>0)<sp/>{<sp/>*out_id<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" kindref="member">id</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="600"><highlight class="normal">}</highlight></codeline>
<codeline lineno="601"><highlight class="normal"></highlight></codeline>
<codeline lineno="602" refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" kindref="member">intern_get_or_add</ref>(<ref refid="structintern__s" kindref="compound">intern_t</ref><sp/>*in,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/>uint32_t<sp/>*out_id)<sp/>{</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in<sp/>||<sp/>!s<sp/>||<sp/>!out_id)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/>uint32_t<sp/>h<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a85473ee7f43e8ee8d8e75160328afa3d" kindref="member">fnv1a32</ref>(s,<sp/>strlen(s));</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref><sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>(size_t)h<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>step<sp/>=<sp/>0;<sp/>step<sp/>&lt;<sp/>in-&gt;<ref refid="structintern__s_1ad1ae07ef1120072bda9486982f0c3c99" kindref="member">cap</ref>;<sp/>++step)<sp/>{</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" kindref="member">used</ref>)<sp/>{</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*st<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a7149c5ac8540bb92b6357a38aa2bd404" kindref="member">intern_store</ref>(in,<sp/>s,<sp/>strlen(s));</highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!st)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>in-&gt;<ref refid="structintern__s_1a110f1a885421735e8f09a35c4cfdeda0" kindref="member">next_id</ref>++;</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a077426090bb264b1d400715a276065eb" kindref="member">used</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" kindref="member">h</ref><sp/>=<sp/>h;</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" kindref="member">s</ref><sp/>=<sp/>st;</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" kindref="member">id</ref><sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>*out_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a1443384739eb65f3c62a3a20895e84df" kindref="member">h</ref><sp/>==<sp/>h<sp/>&amp;&amp;<sp/>strcmp(in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1a9c8e8ab96edc5109d7f89d96f7981d5f" kindref="member">s</ref>,<sp/>s)<sp/>==<sp/>0)<sp/>{<sp/>*out_id<sp/>=<sp/>in-&gt;<ref refid="structintern__s_1afd99300a162ebfb00cec0715a8c8d57d" kindref="member">m</ref>[i].<ref refid="structintern__ent__s_1ab30a5e127c00f6d9bf648b8353c851d9" kindref="member">id</ref>;<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>&amp;<sp/>mask;</highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="623"><highlight class="normal">}</highlight></codeline>
<codeline lineno="624"><highlight class="normal"></highlight></codeline>
<codeline lineno="625"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="626"><highlight class="comment"><sp/>*<sp/>GPT-2<sp/>bytes_to_unicode<sp/>mapping<sp/>(byte-level<sp/>BPE)</highlight></codeline>
<codeline lineno="627"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="628"><highlight class="normal"></highlight></codeline>
<codeline lineno="629" refid="structbyteunicode__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structbyteunicode__s" kindref="compound">byteunicode_s</ref><sp/>{</highlight></codeline>
<codeline lineno="630" refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[256];</highlight></codeline>
<codeline lineno="631" refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" refkind="member"><highlight class="normal"><sp/><sp/>int32_t<sp/><ref refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" kindref="member">cp_to_byte</ref>[2048];</highlight></codeline>
<codeline lineno="632" refid="structbyteunicode__s_1ab59da0198a7ba098340763a6387be857" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structbyteunicode__s_1ab59da0198a7ba098340763a6387be857" kindref="member">cp_to_byte_cap</ref>;</highlight></codeline>
<codeline lineno="633" refid="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a76fab5e7831e6840d4ff5c91498a7129" kindref="member">byteunicode_t</ref>;</highlight></codeline>
<codeline lineno="634"><highlight class="normal"></highlight></codeline>
<codeline lineno="635" refid="tokenizer__gptoss_8c_1ad4c1b8d22b27793678d951b45034176d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ad4c1b8d22b27793678d951b45034176d" kindref="member">byteunicode_init</ref>(<ref refid="structbyteunicode__s" kindref="compound">byteunicode_t</ref><sp/>*m)<sp/>{</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/>memset(m,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*m));</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>2048;<sp/>++i)<sp/>m-&gt;<ref refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" kindref="member">cp_to_byte</ref>[i]<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/>m-&gt;<ref refid="structbyteunicode__s_1ab59da0198a7ba098340763a6387be857" kindref="member">cp_to_byte_cap</ref><sp/>=<sp/>2048;</highlight></codeline>
<codeline lineno="639"><highlight class="normal"></highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>used[256];</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>256;<sp/>++i)<sp/>used[i]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="642"><highlight class="normal"></highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>33;<sp/>b<sp/>&lt;=<sp/>126;<sp/>++b)<sp/>{<sp/>m-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b]<sp/>=<sp/>(uint32_t)b;<sp/>used[b]<sp/>=<sp/>1;<sp/>}</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>161;<sp/>b<sp/>&lt;=<sp/>172;<sp/>++b)<sp/>{<sp/>m-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b]<sp/>=<sp/>(uint32_t)b;<sp/>used[b]<sp/>=<sp/>1;<sp/>}</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>174;<sp/>b<sp/>&lt;=<sp/>255;<sp/>++b)<sp/>{<sp/>m-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b]<sp/>=<sp/>(uint32_t)b;<sp/>used[b]<sp/>=<sp/>1;<sp/>}</highlight></codeline>
<codeline lineno="646"><highlight class="normal"></highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>extra<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>0;<sp/>b<sp/>&lt;<sp/>256;<sp/>++b)<sp/>{</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!used[b])<sp/>{<sp/>m-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b]<sp/>=<sp/>(uint32_t)(256<sp/>+<sp/>extra);<sp/>extra++;<sp/>}</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="651"><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>0;<sp/>b<sp/>&lt;<sp/>256;<sp/>++b)<sp/>{</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>m-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b];</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cp<sp/>&lt;<sp/>m-&gt;cp_to_byte_cap)<sp/>m-&gt;<ref refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" kindref="member">cp_to_byte</ref>[cp]<sp/>=<sp/>b;</highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="656"><highlight class="normal">}</highlight></codeline>
<codeline lineno="657"><highlight class="normal"></highlight></codeline>
<codeline lineno="658" refid="tokenizer__gptoss_8c_1a501bba302f86962f8c5332144c6271a8" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a501bba302f86962f8c5332144c6271a8" kindref="member">byteunicode_cp_to_byte</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structbyteunicode__s" kindref="compound">byteunicode_t</ref><sp/>*m,<sp/>uint32_t<sp/>cp,<sp/>uint8_t<sp/>*out_b)<sp/>{</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m<sp/>||<sp/>!out_b)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cp<sp/>&lt;<sp/>m-&gt;cp_to_byte_cap<sp/>&amp;&amp;<sp/>m-&gt;<ref refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" kindref="member">cp_to_byte</ref>[cp]<sp/>&gt;=<sp/>0)<sp/>{<sp/>*out_b<sp/>=<sp/>(uint8_t)m-&gt;<ref refid="structbyteunicode__s_1a7de6fe7ad89b1005327b078c338835cf" kindref="member">cp_to_byte</ref>[cp];<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="662"><highlight class="normal">}</highlight></codeline>
<codeline lineno="663"><highlight class="normal"></highlight></codeline>
<codeline lineno="664"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="665"><highlight class="comment"><sp/>*<sp/>Buffers</highlight></codeline>
<codeline lineno="666"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="667"><highlight class="normal"></highlight></codeline>
<codeline lineno="668" refid="structu32buf__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structu32buf__s" kindref="compound">u32buf_s</ref><sp/>{</highlight></codeline>
<codeline lineno="669" refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/>*<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="670" refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="671" refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" kindref="member">cap</ref>;</highlight></codeline>
<codeline lineno="672" refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a9b7243e744df6cc3ed80f170fe20f178" kindref="member">u32buf_t</ref>;</highlight></codeline>
<codeline lineno="673"><highlight class="normal"></highlight></codeline>
<codeline lineno="674" refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" kindref="member">u32buf_push</ref>(<ref refid="structu32buf__s" kindref="compound">u32buf_t</ref><sp/>*b,<sp/>uint32_t<sp/>x)<sp/>{</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!b)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b-&gt;<ref refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" kindref="member">n</ref><sp/>==<sp/>b-&gt;<ref refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" kindref="member">cap</ref>)<sp/>{</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>(b-&gt;<ref refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" kindref="member">cap</ref><sp/>?<sp/>b-&gt;<ref refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" kindref="member">cap</ref><sp/>*<sp/>2<sp/>:<sp/>64);</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>*nv<sp/>=<sp/>(uint32_t<sp/>*)<ref refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" kindref="member">xrealloc</ref>(b-&gt;<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(uint32_t));</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nv)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/>b-&gt;<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref><sp/>=<sp/>nv;</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/>b-&gt;<ref refid="structu32buf__s_1a366fb7aeca4067d389d87c9cd30fd7c8" kindref="member">cap</ref><sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/>b-&gt;<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>[b-&gt;<ref refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" kindref="member">n</ref>++]<sp/>=<sp/>x;</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="685"><highlight class="normal">}</highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight></codeline>
<codeline lineno="687" refid="structstrbuf__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structstrbuf__s" kindref="compound">strbuf_s</ref><sp/>{</highlight></codeline>
<codeline lineno="688" refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="689" refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="690" refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" kindref="member">cap</ref>;</highlight></codeline>
<codeline lineno="691" refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1abbe359c7eaaafd9b982478c3914e94e5" kindref="member">strbuf_t</ref>;</highlight></codeline>
<codeline lineno="692"><highlight class="normal"></highlight></codeline>
<codeline lineno="693" refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(<ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>*b,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>add)<sp/>{</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!b)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(b-&gt;<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+<sp/>add<sp/>&lt;=<sp/>b-&gt;cap)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>(b-&gt;<ref refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" kindref="member">cap</ref><sp/>?<sp/>b-&gt;<ref refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" kindref="member">cap</ref><sp/>*<sp/>2<sp/>:<sp/>256);</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(nc<sp/>&lt;<sp/>b-&gt;n<sp/>+<sp/>add)<sp/>nc<sp/>*=<sp/>2;</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*nv<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)<ref refid="tokenizer__gptoss_8c_1aaf675a9c68e3173d0fd53dbbdc9a57a7" kindref="member">xrealloc</ref>(b-&gt;<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>,<sp/>nc);</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nv)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/>b-&gt;<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref><sp/>=<sp/>nv;</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/>b-&gt;<ref refid="structstrbuf__s_1aac922b3d7afe390e32496be9036879c6" kindref="member">cap</ref><sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="703"><highlight class="normal">}</highlight></codeline>
<codeline lineno="704"><highlight class="normal"></highlight></codeline>
<codeline lineno="705" refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(<ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>*b,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!b<sp/>||<sp/>(!s<sp/>&amp;&amp;<sp/>n))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(b,<sp/>n)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/>memcpy(b-&gt;<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref><sp/>+<sp/>b-&gt;<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>,<sp/>s,<sp/>n);</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/>b-&gt;<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+=<sp/>n;</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="711"><highlight class="normal">}</highlight></codeline>
<codeline lineno="712"><highlight class="normal"></highlight></codeline>
<codeline lineno="713" refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(<ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>*b)<sp/>{</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!b)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/>free(b-&gt;<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/>memset(b,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*b));</highlight></codeline>
<codeline lineno="717"><highlight class="normal">}</highlight></codeline>
<codeline lineno="718"><highlight class="normal"></highlight></codeline>
<codeline lineno="719"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="720"><highlight class="comment"><sp/>*<sp/>Byte<sp/>arenas<sp/>(stable<sp/>pointers)</highlight></codeline>
<codeline lineno="721"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="722"><highlight class="normal"></highlight></codeline>
<codeline lineno="723" refid="structbytearena__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structbytearena__s" kindref="compound">bytearena_s</ref><sp/>{</highlight></codeline>
<codeline lineno="724" refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/>**<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>;</highlight></codeline>
<codeline lineno="725" refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*<ref refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" kindref="member">sizes</ref>;</highlight></codeline>
<codeline lineno="726" refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref>;</highlight></codeline>
<codeline lineno="727" refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" kindref="member">cap</ref>;</highlight></codeline>
<codeline lineno="728" refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" refkind="member"><highlight class="normal"><sp/><sp/>uint8_t<sp/>*<ref refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" kindref="member">cur</ref>;</highlight></codeline>
<codeline lineno="729" refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" kindref="member">cur_sz</ref>;</highlight></codeline>
<codeline lineno="730" refid="structbytearena__s_1a80c132193614bacc875483589592663a" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structbytearena__s_1a80c132193614bacc875483589592663a" kindref="member">cur_used</ref>;</highlight></codeline>
<codeline lineno="731" refid="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a069009ad7d7505cf7a9f73bf679a82cc" kindref="member">bytearena_t</ref>;</highlight></codeline>
<codeline lineno="732"><highlight class="normal"></highlight></codeline>
<codeline lineno="733" refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" kindref="member">bytearena_free</ref>(<ref refid="structbytearena__s" kindref="compound">bytearena_t</ref><sp/>*a)<sp/>{</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!a)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>)<sp/>{</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>a-&gt;<ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref>;<sp/>++i)<sp/>free(a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>[i]);</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/>free(a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>);</highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/>free(a-&gt;<ref refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" kindref="member">sizes</ref>);</highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/>memset(a,<sp/>0,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*a));</highlight></codeline>
<codeline lineno="741"><highlight class="normal">}</highlight></codeline>
<codeline lineno="742"><highlight class="normal"></highlight></codeline>
<codeline lineno="743" refid="tokenizer__gptoss_8c_1aca6fa634dfd54327a309632325436dc4" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1aca6fa634dfd54327a309632325436dc4" kindref="member">bytearena_new_block</ref>(<ref refid="structbytearena__s" kindref="compound">bytearena_t</ref><sp/>*a,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>need)<sp/>{</highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>blk<sp/>=<sp/>(a-&gt;<ref refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" kindref="member">cur_sz</ref><sp/>?<sp/>a-&gt;<ref refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" kindref="member">cur_sz</ref><sp/>*<sp/>2<sp/>:<sp/>(1u<sp/>&lt;&lt;<sp/>20));</highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blk<sp/>&lt;<sp/>need)<sp/>blk<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/>uint8_t<sp/>*mem<sp/>=<sp/>(uint8_t<sp/>*)malloc(blk);</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!mem)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="748"><highlight class="normal"></highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(a-&gt;<ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref><sp/>==<sp/>a-&gt;<ref refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" kindref="member">cap</ref>)<sp/>{</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>a-&gt;<ref refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" kindref="member">cap</ref><sp/>?<sp/>a-&gt;<ref refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" kindref="member">cap</ref><sp/>*<sp/>2<sp/>:<sp/>8;</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>**nb<sp/>=<sp/>(uint8_t<sp/>**)realloc(a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*nb));</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*ns<sp/>=<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*)realloc(a-&gt;<ref refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" kindref="member">sizes</ref>,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*ns));</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nb<sp/>||<sp/>!ns)<sp/>{<sp/>free(mem);<sp/>free(nb);<sp/>free(ns);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref><sp/>=<sp/>nb;</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" kindref="member">sizes</ref><sp/>=<sp/>ns;</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a31ca9bd92b8f248773866d5d690fee4c" kindref="member">cap</ref><sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="758"><highlight class="normal"></highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1aa26a6e2cd1566d08bbed9842a54dba7f" kindref="member">blocks</ref>[a-&gt;<ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref>]<sp/>=<sp/>mem;</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1ad9d0454356eeb5a5aed0bc40db9db468" kindref="member">sizes</ref>[a-&gt;<ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref>]<sp/>=<sp/>blk;</highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a4701649b702283a216cfe246bbe02492" kindref="member">nblocks</ref>++;</highlight></codeline>
<codeline lineno="762"><highlight class="normal"></highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" kindref="member">cur</ref><sp/>=<sp/>mem;</highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" kindref="member">cur_sz</ref><sp/>=<sp/>blk;</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a80c132193614bacc875483589592663a" kindref="member">cur_used</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="767"><highlight class="normal">}</highlight></codeline>
<codeline lineno="768"><highlight class="normal"></highlight></codeline>
<codeline lineno="769" refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" kindref="member">bytearena_alloc</ref>(<ref refid="structbytearena__s" kindref="compound">bytearena_t</ref><sp/>*a,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!a)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(uint8_t<sp/>*)</highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!a-&gt;<ref refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" kindref="member">cur</ref><sp/>||<sp/>a-&gt;<ref refid="structbytearena__s_1a80c132193614bacc875483589592663a" kindref="member">cur_used</ref><sp/>+<sp/>n<sp/>&gt;<sp/>a-&gt;<ref refid="structbytearena__s_1a560f0c2f0a74b03bac77f1facb949e73" kindref="member">cur_sz</ref>)<sp/>{</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1aca6fa634dfd54327a309632325436dc4" kindref="member">bytearena_new_block</ref>(a,<sp/>n)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/>uint8_t<sp/>*p<sp/>=<sp/>a-&gt;<ref refid="structbytearena__s_1a6d8d4d84a8241cc4dd90fea0c720e052" kindref="member">cur</ref><sp/>+<sp/>a-&gt;<ref refid="structbytearena__s_1a80c132193614bacc875483589592663a" kindref="member">cur_used</ref>;</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/>a-&gt;<ref refid="structbytearena__s_1a80c132193614bacc875483589592663a" kindref="member">cur_used</ref><sp/>+=<sp/>n;</highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>p;</highlight></codeline>
<codeline lineno="778"><highlight class="normal">}</highlight></codeline>
<codeline lineno="779"><highlight class="normal"></highlight></codeline>
<codeline lineno="780"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="781"><highlight class="comment"><sp/>*<sp/>Tokenizer<sp/>state</highlight></codeline>
<codeline lineno="782"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="783"><highlight class="normal"></highlight></codeline>
<codeline lineno="784" refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">enum</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0" kindref="member">ie_tok_mode_e</ref><sp/>{</highlight></codeline>
<codeline lineno="785" refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" kindref="member">IE_TOK_MODE_GPT2</ref><sp/>=<sp/>0,</highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" kindref="member">IE_TOK_MODE_TIKTOKEN</ref><sp/>=<sp/>1</highlight></codeline>
<codeline lineno="787" refid="tokenizer__gptoss_8c_1a358edfb70ec3436f50e909b5874b906c" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a358edfb70ec3436f50e909b5874b906c" kindref="member">ie_tok_mode_t</ref>;</highlight></codeline>
<codeline lineno="788"><highlight class="normal"></highlight></codeline>
<codeline lineno="789" refid="structbytes__view__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structbytes__view__s" kindref="compound">bytes_view_s</ref><sp/>{</highlight></codeline>
<codeline lineno="790" refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" kindref="member">p</ref>;</highlight></codeline>
<codeline lineno="791" refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="792" refid="tokenizer__gptoss_8c_1a3711041218ffb2a4002ae5aeb3e47f6a" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a3711041218ffb2a4002ae5aeb3e47f6a" kindref="member">bytes_view_t</ref>;</highlight></codeline>
<codeline lineno="793"><highlight class="normal"></highlight></codeline>
<codeline lineno="794" refid="structie__tok__gptoss__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_s</ref><sp/>{</highlight></codeline>
<codeline lineno="795" refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1a358edfb70ec3436f50e909b5874b906c" kindref="member">ie_tok_mode_t</ref><sp/><ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref>;</highlight></codeline>
<codeline lineno="796" refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="797"><highlight class="normal"></highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>GPT-2<sp/>JSON<sp/>/<sp/>packed<sp/>backend<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="799" refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>;</highlight></codeline>
<codeline lineno="800" refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structstrid__ent__s" kindref="compound">strid_ent_t</ref><sp/>*<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>;</highlight></codeline>
<codeline lineno="801" refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>;</highlight></codeline>
<codeline lineno="802" refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structpairrank__ent__s" kindref="compound">pairrank_ent_t</ref><sp/>*<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>;</highlight></codeline>
<codeline lineno="803" refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>;</highlight></codeline>
<codeline lineno="804" refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structintern__s" kindref="compound">intern_t</ref><sp/><ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>;</highlight></codeline>
<codeline lineno="805" refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structbyteunicode__s" kindref="compound">byteunicode_t</ref><sp/><ref refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" kindref="member">bu</ref>;</highlight></codeline>
<codeline lineno="806"><highlight class="normal"></highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">/*<sp/>.tiktoken<sp/>backend<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="808" refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structbytes__view__s" kindref="compound">bytes_view_t</ref><sp/>*<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>;</highlight></codeline>
<codeline lineno="809" refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structbytesid__ent__s" kindref="compound">bytesid_ent_t</ref><sp/>*<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>;</highlight></codeline>
<codeline lineno="810" refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" kindref="member">bytes_to_id_cap</ref>;</highlight></codeline>
<codeline lineno="811" refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" refkind="member"><highlight class="normal"><sp/><sp/><ref refid="structbytearena__s" kindref="compound">bytearena_t</ref><sp/><ref refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" kindref="member">tt_arena</ref>;</highlight></codeline>
<codeline lineno="812" refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" kindref="member">tt_byte_id</ref>[256];</highlight></codeline>
<codeline lineno="813" refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" kindref="member">tt_have_byte_id</ref>;</highlight></codeline>
<codeline lineno="814"><highlight class="normal">};</highlight></codeline>
<codeline lineno="815"><highlight class="normal"></highlight></codeline>
<codeline lineno="816"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="817"><highlight class="comment"><sp/>*<sp/>tokenizer.json<sp/>parsing<sp/>(GPT-2<sp/>backend)</highlight></codeline>
<codeline lineno="818"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="819"><highlight class="normal"></highlight></codeline>
<codeline lineno="820" refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" kindref="member">parse_vocab_object</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" kindref="member">find_key_in_object</ref>(json,<sp/></highlight><highlight class="stringliteral">&quot;vocab&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="823"><highlight class="normal"></highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="827"><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/>uint32_t<sp/>max_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*q)<sp/>{</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*kraw<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;q,<sp/>&amp;kraw,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(kraw)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/>++q;</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" kindref="member">scan_json_int</ref>(&amp;q,<sp/>&amp;</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0<sp/>||<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&lt;<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((uint32_t)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;<sp/>max_id)<sp/>max_id<sp/>=<sp/>(uint32_t)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/>free(kraw);</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>++q;</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="846"><highlight class="normal"></highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>max_id<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*));</highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="850"><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" kindref="member">strid_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="852"><highlight class="normal"></highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/>q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*q)<sp/>{</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*kraw<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;q,<sp/>&amp;kraw,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(kraw)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="862"><highlight class="normal"><sp/><sp/><sp/><sp/>++q;</highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" kindref="member">scan_json_int</ref>(&amp;q,<sp/>&amp;</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0<sp/>||<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&lt;<sp/>0<sp/>||<sp/>(uint32_t)</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="865"><highlight class="normal"></highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[id]<sp/>=<sp/>kraw;</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/>(void)<ref refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" kindref="member">strid_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">],<sp/>(uint32_t)id);</highlight></codeline>
<codeline lineno="868"><highlight class="normal"></highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>++q;</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="872"><highlight class="normal"></highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="874"><highlight class="normal">}</highlight></codeline>
<codeline lineno="875"><highlight class="normal"></highlight></codeline>
<codeline lineno="876" refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" kindref="member">rebuild_tok_to_id</ref>(<ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="878"><highlight class="normal"></highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>);</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="882"><highlight class="normal"></highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" kindref="member">strid_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="884"><highlight class="normal"></highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[i];</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" kindref="member">strid_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>s,<sp/>(uint32_t)i)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="891"><highlight class="normal">}</highlight></codeline>
<codeline lineno="892"><highlight class="normal"></highlight></codeline>
<codeline lineno="893" refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" kindref="member">parse_added_tokens_array</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" kindref="member">find_key_in_object</ref>(json,<sp/></highlight><highlight class="stringliteral">&quot;added_tokens&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="896"><highlight class="normal"></highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/>p++;</highlight></codeline>
<codeline lineno="900"><highlight class="normal"></highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/>uint32_t<sp/>max_id<sp/>=<sp/>(tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>&gt;<sp/>0)<sp/>?<sp/>(uint32_t)(tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>-<sp/>1)<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="902"><highlight class="normal"></highlight></codeline>
<codeline lineno="903"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="906"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="908"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/><sp/><sp/>q++;</highlight></codeline>
<codeline lineno="910"><highlight class="normal"></highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>got_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="913"><highlight class="normal"></highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="918"><highlight class="normal"></highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*kraw<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;q,<sp/>&amp;kraw,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(kraw)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="922"><highlight class="normal"></highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q<sp/>||<sp/>*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q++;</highlight></codeline>
<codeline lineno="926"><highlight class="normal"></highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(kraw,<sp/></highlight><highlight class="stringliteral">&quot;id&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" kindref="member">scan_json_int</ref>(&amp;q,<sp/>&amp;v)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>(uint32_t)v;</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>got_id<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" kindref="member">skip_json_value</ref>(&amp;q)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="936"><highlight class="normal"></highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(kraw);</highlight></codeline>
<codeline lineno="938"><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="944"><highlight class="normal"></highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(got_id<sp/>&amp;&amp;<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;<sp/>max_id)<sp/>max_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="946"><highlight class="normal"></highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="952"><highlight class="normal"></highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>need<sp/>=<sp/>(size_t)max_id<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(need<sp/>&gt;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>{</highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>old<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**nt<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**)realloc(tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>,<sp/>need<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*));</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nt)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref><sp/>=<sp/>nt;</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>old;<sp/>i<sp/>&lt;<sp/>need;<sp/>i++)<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[i]<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>(uint32_t)need;</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1abc281f08f2314e69467c6594098d20c1" kindref="member">rebuild_tok_to_id</ref>(tok)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="963"><highlight class="normal"></highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/>q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;{&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/>q++;</highlight></codeline>
<codeline lineno="971"><highlight class="normal"></highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>got_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*content<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="975"><highlight class="normal"></highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/>{<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="980"><highlight class="normal"></highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*kraw<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;q,<sp/>&amp;kraw,<sp/>NULL)<sp/>!=<sp/>0)<sp/>{<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(kraw)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="984"><highlight class="normal"></highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q<sp/>||<sp/>*q<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;:&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q++;</highlight></codeline>
<codeline lineno="988"><highlight class="normal"></highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(kraw,<sp/></highlight><highlight class="stringliteral">&quot;id&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a77dfe156099f4a2fe3c034d721c171bf" kindref="member">scan_json_int</ref>(&amp;q,<sp/>&amp;v)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>(uint32_t)v;</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>got_id<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strcmp(kraw,<sp/></highlight><highlight class="stringliteral">&quot;content&quot;</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>{<sp/>free(content);<sp/>content<sp/>=<sp/>NULL;<sp/>}</highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;q,<sp/>&amp;content,<sp/>NULL)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(content)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a980bcd3591e59cc09116c9bd4e020c83" kindref="member">skip_json_value</ref>(&amp;q)<sp/>!=<sp/>0)<sp/>{<sp/>free(kraw);<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"></highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(kraw);</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"></highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/>{<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;}&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1010"><highlight class="normal"></highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(got_id<sp/>&amp;&amp;<sp/>content)<sp/>{</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>{<sp/>free(content);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">]<sp/>==<sp/>NULL)<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[id]<sp/>=<sp/>content;</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>free(content);</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" kindref="member">strid_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">],<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content)<sp/>{</highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(content);</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"></highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>{<sp/>q++;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1027"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"></highlight></codeline>
<codeline lineno="1029" refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" kindref="member">scan_merge_entry</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**pp,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**a,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**b)<sp/>{</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(*pp);</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"></highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/>*a<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/>*b<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"></highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;&quot;&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sraw<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;p,<sp/>&amp;sraw,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(sraw)<sp/>!=<sp/>0)<sp/>{<sp/>free(sraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"></highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sp<sp/>=<sp/>strchr(sraw,<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sp)<sp/>{<sp/>free(sraw);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/>*sp<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"></highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*lhs<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(sraw,<sp/>strlen(sraw));</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rhs<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(sp<sp/>+<sp/>1,<sp/>strlen(sp<sp/>+<sp/>1));</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/>free(sraw);</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"></highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!lhs<sp/>||<sp/>!rhs)<sp/>{<sp/>free(lhs);<sp/>free(rhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"></highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/>*a<sp/>=<sp/>lhs;</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/>*b<sp/>=<sp/>rhs;</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"></highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>==<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/>p++;</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"></highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*lhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"></highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;p,<sp/>&amp;lhs,<sp/>NULL)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(lhs)<sp/>!=<sp/>0)<sp/>{<sp/>free(lhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(lhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/>p++;</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"></highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab242e082284c0ac5ff662bfa0cfd84dc" kindref="member">scan_json_string</ref>(&amp;p,<sp/>&amp;rhs,<sp/>NULL)<sp/>!=<sp/>0)<sp/>{<sp/>free(lhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a99739f21528ae3e43fb88c9d251394d1" kindref="member">json_unescape_inplace</ref>(rhs)<sp/>!=<sp/>0)<sp/>{<sp/>free(lhs);<sp/>free(rhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(lhs);<sp/>free(rhs);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"><sp/><sp/><sp/><sp/>p++;</highlight></codeline>
<codeline lineno="1078"><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/>*a<sp/>=<sp/>lhs;</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/>*b<sp/>=<sp/>rhs;</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/>*pp<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"></highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1086"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"></highlight></codeline>
<codeline lineno="1088" refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" kindref="member">parse_merges_array</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a39a3b5b367505de4553f6ba7c603a5c2" kindref="member">find_key_in_object</ref>(json,<sp/></highlight><highlight class="stringliteral">&quot;merges&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"></highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/>p<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(p);</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!p<sp/>||<sp/>*p<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;[&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/>++p;</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"></highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>merges<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*q)<sp/>{</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"></highlight></codeline>
<codeline lineno="1103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*lhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" kindref="member">scan_merge_entry</ref>(&amp;q,<sp/>&amp;lhs,<sp/>&amp;rhs)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/>free(lhs);</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/>free(rhs);</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><sp/><sp/>merges++;</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"></highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>++q;</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"></highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" kindref="member">intern_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>merges<sp/>*<sp/>4<sp/>+<sp/>1024,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)(1u<sp/>&lt;&lt;<sp/>20))<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" kindref="member">pairrank_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>,<sp/>merges)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"></highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/>q<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/>uint32_t<sp/>rank<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*q)<sp/>{</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;]&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"></highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*lhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*rhs<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ad18f476a9a39002bf1c5ada2401ab199" kindref="member">scan_merge_entry</ref>(&amp;q,<sp/>&amp;lhs,<sp/>&amp;rhs)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"></highlight></codeline>
<codeline lineno="1129"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>ida<sp/>=<sp/>0,<sp/>idb<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" kindref="member">intern_get_or_add</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>lhs,<sp/>&amp;ida)<sp/>!=<sp/>0<sp/>||<sp/><ref refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" kindref="member">intern_get_or_add</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>rhs,<sp/>&amp;idb)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(lhs);<sp/>free(rhs);</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"></highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>key<sp/>=<sp/>((uint64_t)ida<sp/>&lt;&lt;<sp/>32)<sp/>|<sp/>(uint64_t)idb;</highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/>(void)<ref refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" kindref="member">pairrank_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>,<sp/>key,<sp/>rank++);</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"></highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/>free(lhs);</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/>free(rhs);</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"></highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ae19e0ad12742fe7fdff22f60436aadc7" kindref="member">skip_ws</ref>(q);</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!q)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*q<sp/>==<sp/></highlight><highlight class="charliteral">&apos;,&apos;</highlight><highlight class="normal">)<sp/>++q;</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"></highlight></codeline>
<codeline lineno="1146"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1147"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"></highlight></codeline>
<codeline lineno="1149" refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" kindref="member">parse_tokenizer_json</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*json,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!json<sp/>||<sp/>!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1151"><highlight class="normal"></highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ad2c9cada9e429a8cce855d8353ef51ac" kindref="member">parse_vocab_object</ref>(json,<sp/>tok);</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"></highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a2624f29c0f1a6d4a9a910c536ff5ba55" kindref="member">parse_added_tokens_array</ref>(json,<sp/>tok);</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"></highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><sp/><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a7960af14a83152c311c5deaac18e904d" kindref="member">parse_merges_array</ref>(json,<sp/>tok);</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"></highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref><sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" kindref="member">IE_TOK_MODE_GPT2</ref>;</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1163"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"></highlight></codeline>
<codeline lineno="1165"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="1166"><highlight class="comment"><sp/>*<sp/>Packed<sp/>tokenizer<sp/>format<sp/>(IETOK1)</highlight></codeline>
<codeline lineno="1167"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1168"><highlight class="normal"></highlight></codeline>
<codeline lineno="1169" refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*io_off,<sp/>uint32_t<sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf<sp/>||<sp/>!io_off<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>off<sp/>=<sp/>*io_off;</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(off<sp/>+<sp/>4<sp/>&gt;<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/>uint32_t<sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint32_t)buf[off<sp/>+<sp/>0];</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint32_t)buf[off<sp/>+<sp/>1]<sp/>&lt;&lt;<sp/>8;</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint32_t)buf[off<sp/>+<sp/>2]<sp/>&lt;&lt;<sp/>16;</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint32_t)buf[off<sp/>+<sp/>3]<sp/>&lt;&lt;<sp/>24;</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/>*io_off<sp/>=<sp/>off<sp/>+<sp/>4;</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1181"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"></highlight></codeline>
<codeline lineno="1183" refid="tokenizer__gptoss_8c_1a56ace11b01ce1af52ab0ad0b43a143e8" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a56ace11b01ce1af52ab0ad0b43a143e8" kindref="member">rd_u16le</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*io_off,<sp/>uint16_t<sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf<sp/>||<sp/>!io_off<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>off<sp/>=<sp/>*io_off;</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(off<sp/>+<sp/>2<sp/>&gt;<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/>uint16_t<sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint16_t)buf[off<sp/>+<sp/>0];</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/>v<sp/>|=<sp/>(uint16_t)buf[off<sp/>+<sp/>1]<sp/>&lt;&lt;<sp/>8;</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/>*io_off<sp/>=<sp/>off<sp/>+<sp/>2;</highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1193"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"></highlight></codeline>
<codeline lineno="1195" refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" kindref="member">rd_lp_string</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*io_off,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**out_s)<sp/>{</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf<sp/>||<sp/>!io_off<sp/>||<sp/>!out_s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/>uint32_t<sp/>len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>io_off,<sp/>&amp;len)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>off<sp/>=<sp/>*io_off;</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(off<sp/>+<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)len<sp/>&gt;<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)len<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/>memcpy(s,<sp/>buf<sp/>+<sp/>off,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)len);</highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/>s[len]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/>*io_off<sp/>=<sp/>off<sp/>+<sp/>(size_t)len;</highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/>*out_s<sp/>=<sp/>s;</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1208"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1209"><highlight class="normal"></highlight></codeline>
<codeline lineno="1210" refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" kindref="member">parse_tokenizer_packed</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf<sp/>||<sp/>n<sp/>&lt;<sp/>32<sp/>||<sp/>!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"></highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>off<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&lt;<sp/>6)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(buf,<sp/></highlight><highlight class="stringliteral">&quot;IETOK1&quot;</highlight><highlight class="normal">,<sp/>6)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/>off<sp/>+=<sp/>6;</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"></highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/>uint16_t<sp/>version<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a56ace11b01ce1af52ab0ad0b43a143e8" kindref="member">rd_u16le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;version)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(version<sp/>!=<sp/>1u)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"></highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/>uint32_t<sp/>vocab_size<sp/>=<sp/>0,<sp/>merges_count<sp/>=<sp/>0,<sp/>off_vocab<sp/>=<sp/>0,<sp/>off_merges<sp/>=<sp/>0,<sp/>off_special<sp/>=<sp/>0,<sp/>reserved<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;vocab_size)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;merges_count)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;off_vocab)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;off_merges)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;off_special)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1affd1a2af0fe1175b0cbafc7b0826c40b" kindref="member">rd_u32le</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;reserved)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/>(void)reserved;</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"></highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vocab_size<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(off_vocab<sp/>&gt;=<sp/>n<sp/>||<sp/>off_merges<sp/>&gt;<sp/>n<sp/>||<sp/>off_special<sp/>&gt;<sp/>n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(off_vocab<sp/>&lt;=<sp/>off_merges<sp/>&amp;&amp;<sp/>off_merges<sp/>&lt;=<sp/>off_special<sp/>&amp;&amp;<sp/>off_special<sp/>&lt;=<sp/>n))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"></highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>vocab_size;</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref><sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*));</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1238"><highlight class="normal"></highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a1393889083bc199630a3fcf45ea66107" kindref="member">strid_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"></highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/>off<sp/>=<sp/>(size_t)off_vocab;</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" kindref="member">rd_lp_string</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;s)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[i]<sp/>=<sp/>s;</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/>(void)<ref refid="tokenizer__gptoss_8c_1a43d88cfe315bf473164317b0155d43df" kindref="member">strid_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[i],<sp/>i);</highlight></codeline>
<codeline lineno="1247"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"></highlight></codeline>
<codeline lineno="1249"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a56d1ee4f2ad6ca215ed9831fae18a1fe" kindref="member">intern_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)merges_count<sp/>*<sp/>4<sp/>+<sp/>1024,<sp/>(size_t)(1u<sp/>&lt;&lt;<sp/>20))<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a4b591022aa71e144a2072d0705294b2e" kindref="member">pairrank_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)merges_count)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"></highlight></codeline>
<codeline lineno="1252"><highlight class="normal"><sp/><sp/>off<sp/>=<sp/>(size_t)off_merges;</highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>r<sp/>=<sp/>0;<sp/>r<sp/>&lt;<sp/>merges_count;<sp/>++r)<sp/>{</highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*a<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*b<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" kindref="member">rd_lp_string</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;a)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a50915933e51be32d11461fe6f4f7149a" kindref="member">rd_lp_string</ref>(buf,<sp/>n,<sp/>&amp;off,<sp/>&amp;b)<sp/>!=<sp/>0)<sp/>{<sp/>free(a);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1258"><highlight class="normal"></highlight></codeline>
<codeline lineno="1259"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>ida<sp/>=<sp/>0,<sp/>idb<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" kindref="member">intern_get_or_add</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>a,<sp/>&amp;ida)<sp/>!=<sp/>0<sp/>||<sp/><ref refid="tokenizer__gptoss_8c_1aa30ad18cccba8312a6b41c8804b88b51" kindref="member">intern_get_or_add</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>b,<sp/>&amp;idb)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(a);<sp/>free(b);</highlight></codeline>
<codeline lineno="1262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1263"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1264"><highlight class="normal"></highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>key<sp/>=<sp/>((uint64_t)ida<sp/>&lt;&lt;<sp/>32)<sp/>|<sp/>(uint64_t)idb;</highlight></codeline>
<codeline lineno="1266"><highlight class="normal"><sp/><sp/><sp/><sp/>(void)<ref refid="tokenizer__gptoss_8c_1aa38db2e8788c0f18a877aa00aa3c800d" kindref="member">pairrank_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>,<sp/>key,<sp/>r);</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"></highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/><sp/><sp/>free(a);</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/><sp/><sp/>free(b);</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"></highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref><sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0a7e8f26aa1a08de270458bc9c3e49963e" kindref="member">IE_TOK_MODE_GPT2</ref>;</highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1274"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"></highlight></codeline>
<codeline lineno="1276" refid="tokenizer__gptoss_8c_1ab46d669ba9cff8f9da6f83855783db7b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ab46d669ba9cff8f9da6f83855783db7b" kindref="member">is_packed_tokenizer</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="1277"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf<sp/>||<sp/>n<sp/>&lt;<sp/>6)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>memcmp(buf,<sp/></highlight><highlight class="stringliteral">&quot;IETOK1&quot;</highlight><highlight class="normal">,<sp/>6)<sp/>==<sp/>0;</highlight></codeline>
<codeline lineno="1279"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1280"><highlight class="normal"></highlight></codeline>
<codeline lineno="1281"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="1282"><highlight class="comment"><sp/>*<sp/>.tiktoken<sp/>parsing</highlight></codeline>
<codeline lineno="1283"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1284"><highlight class="normal"></highlight></codeline>
<codeline lineno="1285" refid="tokenizer__gptoss_8c_1ac06fcc2954706950518627e10d7380ae" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ac06fcc2954706950518627e10d7380ae" kindref="member">b64_val</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>c)<sp/>{</highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;Z&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;A&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;z&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>26<sp/>+<sp/>(c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;a&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1288"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>&gt;=<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>c<sp/>&lt;=<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>52<sp/>+<sp/>(c<sp/>-<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1289"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;+&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>62;</highlight></codeline>
<codeline lineno="1290"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;/&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>63;</highlight></codeline>
<codeline lineno="1291"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>62;</highlight></codeline>
<codeline lineno="1292"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;_&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>63;</highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1294"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1295"><highlight class="normal"></highlight></codeline>
<codeline lineno="1296" refid="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" kindref="member">b64_decode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/>uint8_t<sp/>**out,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_n)<sp/>{</highlight></codeline>
<codeline lineno="1297"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!out<sp/>||<sp/>!out_n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1298"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/>*out_n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"></highlight></codeline>
<codeline lineno="1301"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>max_out<sp/>=<sp/>(n<sp/>/<sp/>4<sp/>+<sp/>1)<sp/>*<sp/>3;</highlight></codeline>
<codeline lineno="1302"><highlight class="normal"><sp/><sp/>uint8_t<sp/>*buf<sp/>=<sp/>(uint8_t<sp/>*)malloc(max_out<sp/>?<sp/>max_out<sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="1303"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!buf)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1304"><highlight class="normal"></highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wi<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1306"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>quad[4];</highlight></codeline>
<codeline lineno="1307"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>qn<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1308"><highlight class="normal"></highlight></codeline>
<codeline lineno="1309"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/>char)s[i];</highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c<sp/>==<sp/></highlight><highlight class="charliteral">&apos;=&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>quad[qn++]<sp/>=<sp/>-2;</highlight></codeline>
<codeline lineno="1313"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>v<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1ac06fcc2954706950518627e10d7380ae" kindref="member">b64_val</ref>((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)c);</highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&lt;<sp/>0)<sp/>{<sp/>free(buf);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>quad[qn++]<sp/>=<sp/>v;</highlight></codeline>
<codeline lineno="1317"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"></highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(qn<sp/>==<sp/>4)<sp/>{</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(quad[0]<sp/>&lt;<sp/>0<sp/>||<sp/>quad[1]<sp/>&lt;<sp/>0)<sp/>{<sp/>free(buf);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"></highlight></codeline>
<codeline lineno="1322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>x<sp/>=<sp/>((uint32_t)quad[0]<sp/>&lt;&lt;<sp/>18)<sp/>|<sp/>((uint32_t)quad[1]<sp/>&lt;&lt;<sp/>12);</highlight></codeline>
<codeline lineno="1323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>b2<sp/>=<sp/>(quad[2]<sp/>&gt;=<sp/>0)<sp/>?<sp/>(uint32_t)quad[2]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>b3<sp/>=<sp/>(quad[3]<sp/>&gt;=<sp/>0)<sp/>?<sp/>(uint32_t)quad[3]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>x<sp/>|=<sp/>(b2<sp/>&lt;&lt;<sp/>6)<sp/>|<sp/>b3;</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"></highlight></codeline>
<codeline lineno="1327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>buf[wi++]<sp/>=<sp/>(uint8_t)((x<sp/>&gt;&gt;<sp/>16)<sp/>&amp;<sp/>0xFF);</highlight></codeline>
<codeline lineno="1328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(quad[2]<sp/>!=<sp/>-2)<sp/>buf[wi++]<sp/>=<sp/>(uint8_t)((x<sp/>&gt;&gt;<sp/>8)<sp/>&amp;<sp/>0xFF);</highlight></codeline>
<codeline lineno="1329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(quad[3]<sp/>!=<sp/>-2)<sp/>buf[wi++]<sp/>=<sp/>(uint8_t)(x<sp/>&amp;<sp/>0xFF);</highlight></codeline>
<codeline lineno="1330"><highlight class="normal"></highlight></codeline>
<codeline lineno="1331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>qn<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1332"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1333"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1334"><highlight class="normal"></highlight></codeline>
<codeline lineno="1335"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(qn<sp/>!=<sp/>0)<sp/>{<sp/>free(buf);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1336"><highlight class="normal"></highlight></codeline>
<codeline lineno="1337"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>buf;</highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/>*out_n<sp/>=<sp/>wi;</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1340"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1341"><highlight class="normal"></highlight></codeline>
<codeline lineno="1342" refid="tokenizer__gptoss_8c_1a71d6f4c29421de37e49a491bfc093abc" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a71d6f4c29421de37e49a491bfc093abc" kindref="member">parse_uint32_str</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*e,<sp/>uint32_t<sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!s<sp/>||<sp/>!e<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(s<sp/>&lt;<sp/>e<sp/>&amp;&amp;<sp/>(*s<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>||<sp/>*s<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal"><sp/>||<sp/>*s<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\r&apos;</highlight><highlight class="normal">))<sp/>s++;</highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>&gt;=<sp/>e)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/>uint64_t<sp/>v<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>s;<sp/>p<sp/>&lt;<sp/>e;<sp/>++p)<sp/>{</highlight></codeline>
<codeline lineno="1348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*p<sp/>&lt;<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal"><sp/>||<sp/>*p<sp/>&gt;<sp/></highlight><highlight class="charliteral">&apos;9&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1349"><highlight class="normal"><sp/><sp/><sp/><sp/>v<sp/>=<sp/>v<sp/>*<sp/>10<sp/>+<sp/>(uint64_t)(*p<sp/>-<sp/></highlight><highlight class="charliteral">&apos;0&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v<sp/>&gt;<sp/>0xFFFFFFFFu)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1351"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1352"><highlight class="normal"><sp/><sp/>*out<sp/>=<sp/>(uint32_t)v;</highlight></codeline>
<codeline lineno="1353"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1354"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1355"><highlight class="normal"></highlight></codeline>
<codeline lineno="1356" refid="tokenizer__gptoss_8c_1a14abd5d14b520ef7064cd5f55e5ca72f" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a14abd5d14b520ef7064cd5f55e5ca72f" kindref="member">ensure_id_to_bytes</ref>(<ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,<sp/>uint32_t<sp/>need)<sp/>{</highlight></codeline>
<codeline lineno="1357"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1358"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(need<sp/>&lt;=<sp/>tok-&gt;vocab_size<sp/>&amp;&amp;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1359"><highlight class="normal"></highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/>uint32_t<sp/>old<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/>uint32_t<sp/>nv<sp/>=<sp/>(old<sp/>?<sp/>old<sp/>:<sp/>1024);</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(nv<sp/>&lt;<sp/>need)<sp/>nv<sp/>*=<sp/>2;</highlight></codeline>
<codeline lineno="1363"><highlight class="normal"></highlight></codeline>
<codeline lineno="1364"><highlight class="normal"><sp/><sp/><ref refid="structbytes__view__s" kindref="compound">bytes_view_t</ref><sp/>*nb<sp/>=<sp/>(<ref refid="structbytes__view__s" kindref="compound">bytes_view_t</ref><sp/>*)realloc(tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)nv<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*nb));</highlight></codeline>
<codeline lineno="1365"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nb)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1366"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref><sp/>=<sp/>nb;</highlight></codeline>
<codeline lineno="1367"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>old;<sp/>i<sp/>&lt;<sp/>nv;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1368"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[i].<ref refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" kindref="member">p</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1369"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[i].<ref refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" kindref="member">n</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1370"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1371"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>nv;</highlight></codeline>
<codeline lineno="1372"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1373"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1374"><highlight class="normal"></highlight></codeline>
<codeline lineno="1375" refid="tokenizer__gptoss_8c_1aaf871077f9a480203cb6ab0d73f1df5c" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1aaf871077f9a480203cb6ab0d73f1df5c" kindref="member">finalize_tt_vocab_size</ref>(<ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,<sp/>uint32_t<sp/>max_id_plus1)<sp/>{</highlight></codeline>
<codeline lineno="1376"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(max_id_plus1<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"><sp/><sp/><ref refid="structbytes__view__s" kindref="compound">bytes_view_t</ref><sp/>*nb<sp/>=<sp/>(<ref refid="structbytes__view__s" kindref="compound">bytes_view_t</ref><sp/>*)realloc(tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)max_id_plus1<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*nb));</highlight></codeline>
<codeline lineno="1379"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nb)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1380"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref><sp/>=<sp/>nb;</highlight></codeline>
<codeline lineno="1381"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>max_id_plus1;</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1383"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1384"><highlight class="normal"></highlight></codeline>
<codeline lineno="1385" refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" kindref="member">parse_tokenizer_tiktoken</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*text,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!text<sp/>||<sp/>!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"></highlight></codeline>
<codeline lineno="1388"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>lines<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>len;<sp/>++i)<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(text[i]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">)<sp/>lines++;</highlight></codeline>
<codeline lineno="1390"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lines<sp/>&lt;<sp/>128)<sp/>lines<sp/>=<sp/>128;</highlight></codeline>
<codeline lineno="1391"><highlight class="normal"></highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a8f508dd131287f64316baa988609528e" kindref="member">bytesid_map_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>,<sp/>&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" kindref="member">bytes_to_id_cap</ref>,<sp/>lines)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"></highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref><sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"></highlight></codeline>
<codeline lineno="1397"><highlight class="normal"><sp/><sp/>uint32_t<sp/>max_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>pos<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"></highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pos<sp/>&lt;<sp/>len)<sp/>{</highlight></codeline>
<codeline lineno="1401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>line_start<sp/>=<sp/>pos;</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pos<sp/>&lt;<sp/>len<sp/>&amp;&amp;<sp/>text[pos]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">)<sp/>pos++;</highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>line_end<sp/>=<sp/>pos;</highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pos<sp/>&lt;<sp/>len<sp/>&amp;&amp;<sp/>text[pos]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\n&apos;</highlight><highlight class="normal">)<sp/>pos++;</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"></highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(line_start<sp/>&lt;<sp/>line_end<sp/>&amp;&amp;<sp/>(text[line_start]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>||<sp/>text[line_start]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal"><sp/>||<sp/>text[line_start]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\r&apos;</highlight><highlight class="normal">))<sp/>line_start++;</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(line_end<sp/>&gt;<sp/>line_start<sp/>&amp;&amp;<sp/>(text[line_end<sp/>-<sp/>1]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>||<sp/>text[line_end<sp/>-<sp/>1]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal"><sp/>||<sp/>text[line_end<sp/>-<sp/>1]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\r&apos;</highlight><highlight class="normal">))<sp/>line_end--;</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"></highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(line_end<sp/>&lt;=<sp/>line_start)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(text[line_start]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;#&apos;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1411"><highlight class="normal"></highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>sp<sp/>=<sp/>line_start;</highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(sp<sp/>&lt;<sp/>line_end<sp/>&amp;&amp;<sp/>text[sp]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>text[sp]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal">)<sp/>sp++;</highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sp<sp/>==<sp/>line_start<sp/>||<sp/>sp<sp/>&gt;=<sp/>line_end)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1415"><highlight class="normal"></highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>b64_start<sp/>=<sp/>line_start;</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>b64_end<sp/>=<sp/>sp;</highlight></codeline>
<codeline lineno="1418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(sp<sp/>&lt;<sp/>line_end<sp/>&amp;&amp;<sp/>(text[sp]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal"><sp/>||<sp/>text[sp]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\t&apos;</highlight><highlight class="normal">))<sp/>sp++;</highlight></codeline>
<codeline lineno="1419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sp<sp/>&gt;=<sp/>line_end)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1420"><highlight class="normal"></highlight></codeline>
<codeline lineno="1421"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a71d6f4c29421de37e49a491bfc093abc" kindref="member">parse_uint32_str</ref>(text<sp/>+<sp/>sp,<sp/>text<sp/>+<sp/>line_end,<sp/>&amp;</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"></highlight></codeline>
<codeline lineno="1424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a14abd5d14b520ef7064cd5f55e5ca72f" kindref="member">ensure_id_to_bytes</ref>(tok,<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>+<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;<sp/>max_id)<sp/>max_id<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"></highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>*decoded<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>decoded_n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a9c8c8f5b338e260150e00fe59108fcdc" kindref="member">b64_decode</ref>(text<sp/>+<sp/>b64_start,<sp/>b64_end<sp/>-<sp/>b64_start,<sp/>&amp;decoded,<sp/>&amp;decoded_n)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"></highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>*dst<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" kindref="member">bytearena_alloc</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" kindref="member">tt_arena</ref>,<sp/>decoded_n<sp/>?<sp/>decoded_n<sp/>:<sp/>1);</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!dst)<sp/>{<sp/>free(decoded);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(decoded_n)<sp/>memcpy(dst,<sp/>decoded,<sp/>decoded_n);</highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/>free(decoded);</highlight></codeline>
<codeline lineno="1435"><highlight class="normal"></highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[id].<ref refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" kindref="member">p</ref><sp/>=<sp/>dst;</highlight></codeline>
<codeline lineno="1437"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[id].<ref refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" kindref="member">n</ref><sp/>=<sp/>(uint32_t)decoded_n;</highlight></codeline>
<codeline lineno="1438"><highlight class="normal"></highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a27308a93ab46bbc9cca6c0f8d35045ba" kindref="member">bytesid_map_put</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" kindref="member">bytes_to_id_cap</ref>,<sp/>dst,<sp/>(uint32_t)decoded_n,<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1440"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1441"><highlight class="normal"></highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1aaf871077f9a480203cb6ab0d73f1df5c" kindref="member">finalize_tt_vocab_size</ref>(tok,<sp/>max_id<sp/>+<sp/>1)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"></highlight></codeline>
<codeline lineno="1444"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[i].<ref refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" kindref="member">p</ref><sp/>&amp;&amp;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[i].<ref refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" kindref="member">n</ref><sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1446"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"></highlight></codeline>
<codeline lineno="1448"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" kindref="member">tt_have_byte_id</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="1449"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>b<sp/>=<sp/>0;<sp/>b<sp/>&lt;<sp/>256;<sp/>++b)<sp/>{</highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>bb<sp/>=<sp/>(uint8_t)b;</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1afdc7d355e9e786329c442dd5716291c9" kindref="member">bytesid_map_get</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" kindref="member">bytes_to_id_cap</ref>,<sp/>&amp;bb,<sp/>1,<sp/>&amp;</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>{<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" kindref="member">tt_have_byte_id</ref><sp/>=<sp/>0;<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1453"><highlight class="normal"><sp/><sp/><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" kindref="member">tt_byte_id</ref>[b]<sp/>=<sp/>id;</highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok-&gt;<ref refid="structie__tok__gptoss__s_1a15082374c65c57a90a3f1339ad1dd39c" kindref="member">tt_have_byte_id</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1456"><highlight class="normal"></highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref><sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" kindref="member">IE_TOK_MODE_TIKTOKEN</ref>;</highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1459"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"></highlight></codeline>
<codeline lineno="1461"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="1462"><highlight class="comment"><sp/>*<sp/>BPE<sp/>encode<sp/>helpers</highlight></codeline>
<codeline lineno="1463"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1464"><highlight class="normal"></highlight></codeline>
<codeline lineno="1465" refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" kindref="member">to_bytelevel_unicode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structbyteunicode__s" kindref="compound">byteunicode_t</ref><sp/>*bu,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n,<sp/><ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>*out)<sp/>{</highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!bu<sp/>||<sp/>(!s<sp/>&amp;&amp;<sp/>n)<sp/>||<sp/>!out)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>b<sp/>=<sp/>(uint8_t)(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)s[i];</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>bu-&gt;<ref refid="structbyteunicode__s_1a86b3d907704d2054d872515bdb9ed4f7" kindref="member">byte_to_cp</ref>[b];</highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tmp[4];</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wn<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" kindref="member">utf8_put_cp</ref>(tmp,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmp),<sp/>cp);</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(wn<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(out,<sp/>tmp,<sp/>wn)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1476"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"></highlight></codeline>
<codeline lineno="1478" refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" kindref="member">pretokenize_basic</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*text,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>***out_parts,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*out_n)<sp/>{</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!text<sp/>||<sp/>!out_parts<sp/>||<sp/>!out_n)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/>*out_parts<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/>*out_n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"></highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cap<sp/>=<sp/>0,<sp/>n<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**parts<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p<sp/>=<sp/>text;</highlight></codeline>
<codeline lineno="1486"><highlight class="normal"></highlight></codeline>
<codeline lineno="1487"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p)<sp/>{</highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(isspace((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p))<sp/>{</highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p<sp/>&amp;&amp;<sp/>isspace((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p))<sp/>++p;</highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len<sp/>=<sp/>(size_t)(p<sp/>-<sp/>s);</highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*seg<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(s,<sp/>len);</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!seg)<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>cap)<sp/>{</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>cap<sp/>?<sp/>cap<sp/>*<sp/>2<sp/>:<sp/>64;</highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**np<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**)realloc(parts,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*np));</highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!np)<sp/>{<sp/>free(seg);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;<sp/>}</highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>parts<sp/>=<sp/>np;<sp/>cap<sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>parts[n++]<sp/>=<sp/>seg;</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"></highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s<sp/>=<sp/>p;</highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(*p<sp/>&amp;&amp;<sp/>!isspace((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)*p))<sp/>++p;</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len<sp/>=<sp/>(size_t)(p<sp/>-<sp/>s);</highlight></codeline>
<codeline lineno="1507"><highlight class="normal"></highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>have_lead_space<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>parts[n<sp/>-<sp/>1]<sp/>&amp;&amp;<sp/>parts[n<sp/>-<sp/>1][0]<sp/>!=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*w<sp/>=<sp/>parts[n<sp/>-<sp/>1];</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wl<sp/>=<sp/>strlen(w);</highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(wl<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>w[wl<sp/>-<sp/>1]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">)<sp/>{<sp/>w[wl<sp/>-<sp/>1]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;<sp/>have_lead_space<sp/>=<sp/>1;<sp/>}</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"></highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>sb<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(have_lead_space)<sp/>{</highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>sp<sp/>=<sp/></highlight><highlight class="charliteral">&apos;<sp/>&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(&amp;sb,<sp/>&amp;sp,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;sb);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;<sp/>}</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(&amp;sb,<sp/>s,<sp/>len)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;sb);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;<sp/>}</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;sb,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;sb);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;<sp/>}</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"><sp/><sp/><sp/><sp/>sb.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>[sb.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1523"><highlight class="normal"></highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>==<sp/>cap)<sp/>{</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>cap<sp/>?<sp/>cap<sp/>*<sp/>2<sp/>:<sp/>64;</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**np<sp/>=<sp/>(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**)realloc(parts,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*np));</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!np)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;sb);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail;<sp/>}</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>parts<sp/>=<sp/>np;<sp/>cap<sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"><sp/><sp/><sp/><sp/>parts[n++]<sp/>=<sp/>sb.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>;</highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"></highlight></codeline>
<codeline lineno="1533"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>w<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1534"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(parts[i]<sp/>&amp;&amp;<sp/>parts[i][0]<sp/>==<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">)<sp/>{<sp/>free(parts[i]);<sp/>parts[i]<sp/>=<sp/>NULL;<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1536"><highlight class="normal"><sp/><sp/><sp/><sp/>parts[w++]<sp/>=<sp/>parts[i];</highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/>n<sp/>=<sp/>w;</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"></highlight></codeline>
<codeline lineno="1540"><highlight class="normal"><sp/><sp/>*out_parts<sp/>=<sp/>parts;</highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/>*out_n<sp/>=<sp/>n;</highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"></highlight></codeline>
<codeline lineno="1544"><highlight class="normal">fail:</highlight></codeline>
<codeline lineno="1545"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(parts)<sp/>{</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>n;<sp/>++i)<sp/>free(parts[i]);</highlight></codeline>
<codeline lineno="1547"><highlight class="normal"><sp/><sp/><sp/><sp/>free(parts);</highlight></codeline>
<codeline lineno="1548"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1550"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"></highlight></codeline>
<codeline lineno="1552"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>GPT-2:<sp/>BPE<sp/>over<sp/>interned<sp/>unicode<sp/>symbols<sp/>(existing<sp/>behavior)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1553" refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" kindref="member">bpe_encode_to_ids_gpt2</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*in,<sp/><ref refid="structu32buf__s" kindref="compound">u32buf_t</ref><sp/>*out_ids)<sp/>{</highlight></codeline>
<codeline lineno="1554"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok<sp/>||<sp/>!in<sp/>||<sp/>!out_ids)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1555"><highlight class="normal"></highlight></codeline>
<codeline lineno="1556"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sym_s<sp/>{<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*s;<sp/>uint32_t<sp/>id;<sp/>}<sp/>sym_t;</highlight></codeline>
<codeline lineno="1557"><highlight class="normal"></highlight></codeline>
<codeline lineno="1558"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>in_len<sp/>=<sp/>strlen(in);</highlight></codeline>
<codeline lineno="1559"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"></highlight></codeline>
<codeline lineno="1561"><highlight class="normal"><sp/><sp/>sym_t<sp/>*syms<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nsyms<sp/>=<sp/>0,<sp/>cap<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1563"><highlight class="normal"><sp/><sp/><ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>scratch<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1564"><highlight class="normal"></highlight></codeline>
<codeline lineno="1565"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>in_len)<sp/>{</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1567"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>old<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" kindref="member">utf8_next_cp</ref>(in,<sp/>in_len,<sp/>&amp;i,<sp/>&amp;cp)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1569"><highlight class="normal"></highlight></codeline>
<codeline lineno="1570"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*slice<sp/>=<sp/>in<sp/>+<sp/>old;</highlight></codeline>
<codeline lineno="1571"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>slen<sp/>=<sp/>i<sp/>-<sp/>old;</highlight></codeline>
<codeline lineno="1572"><highlight class="normal"></highlight></codeline>
<codeline lineno="1573"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;scratch,<sp/>slen<sp/>+<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1574"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dst<sp/>=<sp/>scratch.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref><sp/>+<sp/>scratch.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1575"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(dst,<sp/>slice,<sp/>slen);</highlight></codeline>
<codeline lineno="1576"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[slen]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"><sp/><sp/><sp/><sp/>scratch.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+=<sp/>slen<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="1578"><highlight class="normal"></highlight></codeline>
<codeline lineno="1579"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nsyms<sp/>==<sp/>cap)<sp/>{</highlight></codeline>
<codeline lineno="1580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nc<sp/>=<sp/>cap<sp/>?<sp/>cap<sp/>*<sp/>2<sp/>:<sp/>64;</highlight></codeline>
<codeline lineno="1581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>sym_t<sp/>*ns<sp/>=<sp/>(sym_t<sp/>*)realloc(syms,<sp/>nc<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*ns));</highlight></codeline>
<codeline lineno="1582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ns)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>syms<sp/>=<sp/>ns;</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>cap<sp/>=<sp/>nc;</highlight></codeline>
<codeline lineno="1585"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1586"><highlight class="normal"></highlight></codeline>
<codeline lineno="1587"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>sid<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" kindref="member">intern_get</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>dst,<sp/>&amp;sid)<sp/>!=<sp/>0)<sp/>sid<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1589"><highlight class="normal"><sp/><sp/><sp/><sp/>syms[nsyms].s<sp/>=<sp/>dst;</highlight></codeline>
<codeline lineno="1590"><highlight class="normal"><sp/><sp/><sp/><sp/>syms[nsyms].id<sp/>=<sp/>sid;</highlight></codeline>
<codeline lineno="1591"><highlight class="normal"><sp/><sp/><sp/><sp/>nsyms++;</highlight></codeline>
<codeline lineno="1592"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1593"><highlight class="normal"></highlight></codeline>
<codeline lineno="1594"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nsyms<sp/>==<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="1595"><highlight class="normal"></highlight></codeline>
<codeline lineno="1596"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;;)<sp/>{</highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>best_rank<sp/>=<sp/>UINT32_MAX;</highlight></codeline>
<codeline lineno="1598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>best_i<sp/>=<sp/>(size_t)-1;</highlight></codeline>
<codeline lineno="1599"><highlight class="normal"></highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k<sp/>=<sp/>0;<sp/>k<sp/>+<sp/>1<sp/>&lt;<sp/>nsyms;<sp/>++k)<sp/>{</highlight></codeline>
<codeline lineno="1601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(syms[k].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>==<sp/>0<sp/>||<sp/>syms[k<sp/>+<sp/>1].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>key<sp/>=<sp/>((uint64_t)syms[k].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&lt;&lt;<sp/>32)<sp/>|<sp/>(uint64_t)syms[k<sp/>+<sp/>1].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>r<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a569d2debd0e21610e58723b64b065a8d" kindref="member">pairrank_map_get</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a286020dfdb1ef420cdad12554bcd38a9" kindref="member">pair_to_rank_cap</ref>,<sp/>key,<sp/>&amp;r)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(r<sp/>&lt;<sp/>best_rank)<sp/>{<sp/>best_rank<sp/>=<sp/>r;<sp/>best_i<sp/>=<sp/>k;<sp/>}</highlight></codeline>
<codeline lineno="1606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1607"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1608"><highlight class="normal"></highlight></codeline>
<codeline lineno="1609"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_i<sp/>==<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)-1)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1610"><highlight class="normal"></highlight></codeline>
<codeline lineno="1611"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*a<sp/>=<sp/>syms[best_i].s;</highlight></codeline>
<codeline lineno="1612"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*b<sp/>=<sp/>syms[best_i<sp/>+<sp/>1].s;</highlight></codeline>
<codeline lineno="1613"><highlight class="normal"></highlight></codeline>
<codeline lineno="1614"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>al<sp/>=<sp/>strlen(a),<sp/>bl<sp/>=<sp/>strlen(b);</highlight></codeline>
<codeline lineno="1615"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;scratch,<sp/>al<sp/>+<sp/>bl<sp/>+<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*dst<sp/>=<sp/>scratch.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref><sp/>+<sp/>scratch.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1617"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(dst,<sp/>a,<sp/>al);</highlight></codeline>
<codeline lineno="1618"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(dst<sp/>+<sp/>al,<sp/>b,<sp/>bl);</highlight></codeline>
<codeline lineno="1619"><highlight class="normal"><sp/><sp/><sp/><sp/>dst[al<sp/>+<sp/>bl]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1620"><highlight class="normal"><sp/><sp/><sp/><sp/>scratch.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+=<sp/>al<sp/>+<sp/>bl<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="1621"><highlight class="normal"></highlight></codeline>
<codeline lineno="1622"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>sid<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1623"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ae97e99701aea26e4707cc0d72e2a5982" kindref="member">intern_get</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>,<sp/>dst,<sp/>&amp;sid)<sp/>!=<sp/>0)<sp/>sid<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1624"><highlight class="normal"></highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/>syms[best_i].s<sp/>=<sp/>dst;</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/>syms[best_i].id<sp/>=<sp/>sid;</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"></highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k<sp/>=<sp/>best_i<sp/>+<sp/>1;<sp/>k<sp/>+<sp/>1<sp/>&lt;<sp/>nsyms;<sp/>++k)<sp/>syms[k]<sp/>=<sp/>syms[k<sp/>+<sp/>1];</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"><sp/><sp/><sp/><sp/>nsyms--;</highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1631"><highlight class="normal"></highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k<sp/>=<sp/>0;<sp/>k<sp/>&lt;<sp/>nsyms;<sp/>++k)<sp/>{</highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*sym<sp/>=<sp/>syms[k].s;</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" kindref="member">strid_map_get</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>sym,<sp/>&amp;</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" kindref="member">u32buf_push</ref>(out_ids,<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1638"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1639"><highlight class="normal"></highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>slen<sp/>=<sp/>strlen(sym);</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>pos<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pos<sp/>&lt;<sp/>slen)<sp/>{</highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>old<sp/>=<sp/>pos;</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" kindref="member">utf8_next_cp</ref>(sym,<sp/>slen,<sp/>&amp;pos,<sp/>&amp;cp)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(void)cp;</highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*one<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1af21165822fceeffbb8b9f215ea7a7efa" kindref="member">xstrdup_n</ref>(sym<sp/>+<sp/>old,<sp/>pos<sp/>-<sp/>old);</highlight></codeline>
<codeline lineno="1648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!one)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>tid<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ok<sp/>=<sp/>(<ref refid="tokenizer__gptoss_8c_1a2e285f35abd8883ee80de384d4dd9938" kindref="member">strid_map_get</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a6d224225a48ad7e389cec4be4dc4e74c" kindref="member">tok_to_id_cap</ref>,<sp/>one,<sp/>&amp;tid)<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(one);</highlight></codeline>
<codeline lineno="1652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ok)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" kindref="member">u32buf_push</ref>(out_ids,<sp/>tid)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);<sp/>free(syms);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1654"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1655"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1656"><highlight class="normal"></highlight></codeline>
<codeline lineno="1657"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;scratch);</highlight></codeline>
<codeline lineno="1658"><highlight class="normal"><sp/><sp/>free(syms);</highlight></codeline>
<codeline lineno="1659"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1660"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1661"><highlight class="normal"></highlight></codeline>
<codeline lineno="1662"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>.tiktoken:<sp/>byte-level<sp/>BPE<sp/>over<sp/>raw<sp/>bytes<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1663" refid="structttpiece__s" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="structttpiece__s" kindref="compound">ttpiece_s</ref><sp/>{</highlight></codeline>
<codeline lineno="1664" refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" refkind="member"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*<ref refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" kindref="member">p</ref>;</highlight></codeline>
<codeline lineno="1665" refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1666" refid="structttpiece__s_1aa374fbab840a10d3cdfb347e15ec0671" refkind="member"><highlight class="normal"><sp/><sp/>uint32_t<sp/><ref refid="structttpiece__s_1aa374fbab840a10d3cdfb347e15ec0671" kindref="member">id</ref>;</highlight></codeline>
<codeline lineno="1667" refid="tokenizer__gptoss_8c_1a17df6e83da40ef362b2839e4da8c3692" refkind="member"><highlight class="normal">}<sp/><ref refid="tokenizer__gptoss_8c_1a17df6e83da40ef362b2839e4da8c3692" kindref="member">ttpiece_t</ref>;</highlight></codeline>
<codeline lineno="1668"><highlight class="normal"></highlight></codeline>
<codeline lineno="1669" refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" kindref="member">tt_bpe_encode_segment</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,</highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*seg,<sp/>uint32_t<sp/>seg_n,</highlight></codeline>
<codeline lineno="1671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structu32buf__s" kindref="compound">u32buf_t</ref><sp/>*out_ids)<sp/>{</highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok<sp/>||<sp/>!out_ids)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(seg_n<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1674"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!seg)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1675"><highlight class="normal"></highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/><ref refid="structttpiece__s" kindref="compound">ttpiece_t</ref><sp/>*pieces<sp/>=<sp/>(<ref refid="structttpiece__s" kindref="compound">ttpiece_t</ref><sp/>*)malloc((</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)seg_n<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*pieces));</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pieces)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1678"><highlight class="normal"></highlight></codeline>
<codeline lineno="1679"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>seg_n;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1680"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[i].<ref refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" kindref="member">p</ref><sp/>=<sp/>seg<sp/>+<sp/>i;</highlight></codeline>
<codeline lineno="1681"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[i].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref><sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="1682"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[i].<ref refid="structttpiece__s_1aa374fbab840a10d3cdfb347e15ec0671" kindref="member">id</ref><sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a3028ee4fef3de01ae06eefc79879982d" kindref="member">tt_byte_id</ref>[seg[i]];</highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1684"><highlight class="normal"></highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/>uint32_t<sp/>np<sp/>=<sp/>seg_n;</highlight></codeline>
<codeline lineno="1686"><highlight class="normal"><sp/><sp/><ref refid="structbytearena__s" kindref="compound">bytearena_t</ref><sp/>tmp<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1687"><highlight class="normal"></highlight></codeline>
<codeline lineno="1688"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(np<sp/>&gt;=<sp/>2)<sp/>{</highlight></codeline>
<codeline lineno="1689"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>best_rank<sp/>=<sp/>UINT32_MAX;</highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>best_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>best_i<sp/>=<sp/>UINT32_MAX;</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"></highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>+<sp/>1<sp/>&lt;<sp/>np;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>cand_id<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5573c4412ff6deb6a3f65a8fd1a835fa" kindref="member">bytesid_map_get_concat</ref>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>,<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1aae811555952c513b61134650114701f3" kindref="member">bytes_to_id_cap</ref>,</highlight></codeline>
<codeline lineno="1696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pieces[i].<ref refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" kindref="member">p</ref>,<sp/>pieces[i].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref>,</highlight></codeline>
<codeline lineno="1697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pieces[i<sp/>+<sp/>1].<ref refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" kindref="member">p</ref>,<sp/>pieces[i<sp/>+<sp/>1].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref>,</highlight></codeline>
<codeline lineno="1698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;cand_id)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>cand_rank<sp/>=<sp/>cand_id;</highlight></codeline>
<codeline lineno="1700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cand_rank<sp/>&lt;<sp/>best_rank)<sp/>{</highlight></codeline>
<codeline lineno="1701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_rank<sp/>=<sp/>cand_rank;</highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_id<sp/>=<sp/>cand_id;</highlight></codeline>
<codeline lineno="1703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_i<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1706"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1707"><highlight class="normal"></highlight></codeline>
<codeline lineno="1708"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_i<sp/>==<sp/>UINT32_MAX)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1709"><highlight class="normal"></highlight></codeline>
<codeline lineno="1710"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>an<sp/>=<sp/>pieces[best_i].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1711"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>bn<sp/>=<sp/>pieces[best_i<sp/>+<sp/>1].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1712"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>mn<sp/>=<sp/>an<sp/>+<sp/>bn;</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"></highlight></codeline>
<codeline lineno="1714"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>*dst<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a87f859fe5eee4c2844946ae6b9442542" kindref="member">bytearena_alloc</ref>(&amp;tmp,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)mn);</highlight></codeline>
<codeline lineno="1715"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!dst)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" kindref="member">bytearena_free</ref>(&amp;tmp);<sp/>free(pieces);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1716"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(dst,<sp/>pieces[best_i].p,<sp/>an);</highlight></codeline>
<codeline lineno="1717"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(dst<sp/>+<sp/>an,<sp/>pieces[best_i<sp/>+<sp/>1].p,<sp/>bn);</highlight></codeline>
<codeline lineno="1718"><highlight class="normal"></highlight></codeline>
<codeline lineno="1719"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[best_i].<ref refid="structttpiece__s_1ab35a4ff53165404bc7ef0a193bfabd66" kindref="member">p</ref><sp/>=<sp/>dst;</highlight></codeline>
<codeline lineno="1720"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[best_i].<ref refid="structttpiece__s_1ac4eaf3b1983cbeed60aecb81a70fc0dc" kindref="member">n</ref><sp/>=<sp/>mn;</highlight></codeline>
<codeline lineno="1721"><highlight class="normal"><sp/><sp/><sp/><sp/>pieces[best_i].<ref refid="structttpiece__s_1aa374fbab840a10d3cdfb347e15ec0671" kindref="member">id</ref><sp/>=<sp/>best_id;</highlight></codeline>
<codeline lineno="1722"><highlight class="normal"></highlight></codeline>
<codeline lineno="1723"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>j<sp/>=<sp/>best_i<sp/>+<sp/>1;<sp/>j<sp/>+<sp/>1<sp/>&lt;<sp/>np;<sp/>++j)<sp/>pieces[j]<sp/>=<sp/>pieces[j<sp/>+<sp/>1];</highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><sp/><sp/><sp/><sp/>np--;</highlight></codeline>
<codeline lineno="1725"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1726"><highlight class="normal"></highlight></codeline>
<codeline lineno="1727"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>np;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1728"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ac254f2e576e8ee207a7f12ec3bbd05f9" kindref="member">u32buf_push</ref>(out_ids,<sp/>pieces[i].</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" kindref="member">bytearena_free</ref>(&amp;tmp);<sp/>free(pieces);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;<sp/>}</highlight></codeline>
<codeline lineno="1729"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1730"><highlight class="normal"></highlight></codeline>
<codeline lineno="1731"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" kindref="member">bytearena_free</ref>(&amp;tmp);</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/>free(pieces);</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1734"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1735"><highlight class="normal"></highlight></codeline>
<codeline lineno="1736" refid="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" kindref="member">tt_encode_text</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*text,<sp/><ref refid="structu32buf__s" kindref="compound">u32buf_t</ref><sp/>*out_ids)<sp/>{</highlight></codeline>
<codeline lineno="1737"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok<sp/>||<sp/>!text<sp/>||<sp/>!out_ids)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1738"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*p<sp/>=<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*)text;</highlight></codeline>
<codeline lineno="1739"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>strlen(text);</highlight></codeline>
<codeline lineno="1740"><highlight class="normal"></highlight></codeline>
<codeline lineno="1741"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1742"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(i<sp/>&lt;<sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="1743"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="1744"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ws<sp/>=<sp/>isspace((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)p[i])<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1745"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(j<sp/>&lt;<sp/>n)<sp/>{</highlight></codeline>
<codeline lineno="1746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ws2<sp/>=<sp/>isspace((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)p[j])<sp/>?<sp/>1<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="1747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ws2<sp/>!=<sp/>ws)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>j++;</highlight></codeline>
<codeline lineno="1749"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1750"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>seg_n<sp/>=<sp/>(uint32_t)(j<sp/>-<sp/>i);</highlight></codeline>
<codeline lineno="1751"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a1fcd2a4988288a26594b4b641897257b" kindref="member">tt_bpe_encode_segment</ref>(tok,<sp/>p<sp/>+<sp/>i,<sp/>seg_n,<sp/>out_ids)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>-1;</highlight></codeline>
<codeline lineno="1752"><highlight class="normal"><sp/><sp/><sp/><sp/>i<sp/>=<sp/>j;</highlight></codeline>
<codeline lineno="1753"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1754"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1755"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1756"><highlight class="normal"></highlight></codeline>
<codeline lineno="1757"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="1758"><highlight class="comment"><sp/>*<sp/>Public<sp/>API</highlight></codeline>
<codeline lineno="1759"><highlight class="comment"><sp/>*<sp/>==========================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1760"><highlight class="normal"></highlight></codeline>
<codeline lineno="1761" refid="ie__tokenizer__gptoss_8h_1ae5c55dc1502414c60d1a99fa9fbdf1bc" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ae5c55dc1502414c60d1a99fa9fbdf1bc" kindref="member">ie_tok_gptoss_open</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*tokenizer_path,<sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>**out_tok)<sp/>{</highlight></codeline>
<codeline lineno="1762"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tokenizer_path<sp/>||<sp/>!out_tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1763"><highlight class="normal"><sp/><sp/>*out_tok<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1764"><highlight class="normal"></highlight></codeline>
<codeline lineno="1765"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*buf<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1766"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1767"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a84e8a603fef81b42cc1913caf9216f13" kindref="member">read_all_bytes</ref>(tokenizer_path,<sp/>&amp;buf,<sp/>&amp;len)<sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a7635c982b781a8ef569aded5c8cbcef7" kindref="member">IE_TOK_GPTOSS_ERR_IO</ref>;</highlight></codeline>
<codeline lineno="1768"><highlight class="normal"></highlight></codeline>
<codeline lineno="1769"><highlight class="normal"><sp/><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok<sp/>=<sp/>(<ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*)<ref refid="tokenizer__gptoss_8c_1a981c4f4b5894b549eb0b2f0358810c67" kindref="member">xcalloc</ref>(1,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(*tok));</highlight></codeline>
<codeline lineno="1770"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/>{<sp/>free(buf);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1771"><highlight class="normal"></highlight></codeline>
<codeline lineno="1772"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ad4c1b8d22b27793678d951b45034176d" kindref="member">byteunicode_init</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" kindref="member">bu</ref>);</highlight></codeline>
<codeline lineno="1773"><highlight class="normal"></highlight></codeline>
<codeline lineno="1774"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>rc<sp/>=<sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a5b6eb590f3790b4e61df67c181dbf6e6" kindref="member">IE_TOK_GPTOSS_ERR_JSON</ref>;</highlight></codeline>
<codeline lineno="1775"><highlight class="normal"></highlight></codeline>
<codeline lineno="1776"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1ab46d669ba9cff8f9da6f83855783db7b" kindref="member">is_packed_tokenizer</ref>((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)buf,<sp/>len))<sp/>{</highlight></codeline>
<codeline lineno="1777"><highlight class="normal"><sp/><sp/><sp/><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1adf511a811d96d1b3b8892529ed1088d1" kindref="member">parse_tokenizer_packed</ref>((</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)buf,<sp/>len,<sp/>tok);</highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1aa12e2f8ade90f9aefa8f1562d02965b8" kindref="member">path_ends_with</ref>(tokenizer_path,<sp/></highlight><highlight class="stringliteral">&quot;.tiktoken&quot;</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="1779"><highlight class="normal"><sp/><sp/><sp/><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a32e83b198fce9015f852f307d2bf2953" kindref="member">parse_tokenizer_tiktoken</ref>(buf,<sp/>len,<sp/>tok);</highlight></codeline>
<codeline lineno="1780"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1781"><highlight class="normal"><sp/><sp/><sp/><sp/>rc<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a232e17961642239dec21aad8eb19b287" kindref="member">parse_tokenizer_json</ref>(buf,<sp/>tok);</highlight></codeline>
<codeline lineno="1782"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1783"><highlight class="normal"></highlight></codeline>
<codeline lineno="1784"><highlight class="normal"><sp/><sp/>free(buf);</highlight></codeline>
<codeline lineno="1785"><highlight class="normal"></highlight></codeline>
<codeline lineno="1786"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rc<sp/>!=<sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1787"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ad4b875bec514bb9c1de945944e1596de" kindref="member">ie_tok_gptoss_close</ref>(tok);</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>rc;</highlight></codeline>
<codeline lineno="1789"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1790"><highlight class="normal"></highlight></codeline>
<codeline lineno="1791"><highlight class="normal"><sp/><sp/>*out_tok<sp/>=<sp/>tok;</highlight></codeline>
<codeline lineno="1792"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1793"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1794"><highlight class="normal"></highlight></codeline>
<codeline lineno="1795" refid="ie__tokenizer__gptoss_8h_1ad4b875bec514bb9c1de945944e1596de" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ad4b875bec514bb9c1de945944e1596de" kindref="member">ie_tok_gptoss_close</ref>(<ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1796"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1797"><highlight class="normal"></highlight></codeline>
<codeline lineno="1798"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1799"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;<sp/>++i)<sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[i]);</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"><sp/><sp/><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>);</highlight></codeline>
<codeline lineno="1801"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1802"><highlight class="normal"><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1afb1bc0375c07e79a7b248163a17f6251" kindref="member">tok_to_id</ref>);</highlight></codeline>
<codeline lineno="1803"><highlight class="normal"><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1a2ecbb2af5975a3422496474dc46bee28" kindref="member">pair_to_rank</ref>);</highlight></codeline>
<codeline lineno="1804"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1a118bc90519292f54b3513029942a3867" kindref="member">intern_free</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ac8e89185a8724c5fc8ba846dd3ce7ca1" kindref="member">intern</ref>);</highlight></codeline>
<codeline lineno="1805"><highlight class="normal"></highlight></codeline>
<codeline lineno="1806"><highlight class="normal"><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>);</highlight></codeline>
<codeline lineno="1807"><highlight class="normal"><sp/><sp/>free(tok-&gt;<ref refid="structie__tok__gptoss__s_1a52cb1e3de301055d8bd236415e78d897" kindref="member">bytes_to_id</ref>);</highlight></codeline>
<codeline lineno="1808"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ab8470327b8dacfc6949303c5b052a402" kindref="member">bytearena_free</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1ade8b0a7e2551f0bf21afd715f5ac108c" kindref="member">tt_arena</ref>);</highlight></codeline>
<codeline lineno="1809"><highlight class="normal"></highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/>free(tok);</highlight></codeline>
<codeline lineno="1811"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"></highlight></codeline>
<codeline lineno="1813" refid="ie__tokenizer__gptoss_8h_1a0a4146017408baa0a07ffa747dfae870" refkind="member"><highlight class="normal">uint32_t<sp/><ref refid="tokenizer__gptoss_8c_1a0a4146017408baa0a07ffa747dfae870" kindref="member">ie_tok_gptoss_vocab_size</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok)<sp/>{</highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>;</highlight></codeline>
<codeline lineno="1816"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1817"><highlight class="normal"></highlight></codeline>
<codeline lineno="1818" refid="ie__tokenizer__gptoss_8h_1ae372932b3912864351defd6ce553ed88" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1ae372932b3912864351defd6ce553ed88" kindref="member">ie_tok_gptoss_decode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,</highlight></codeline>
<codeline lineno="1819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint32_t<sp/>*ids,</highlight></codeline>
<codeline lineno="1820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>count,</highlight></codeline>
<codeline lineno="1821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*out,</highlight></codeline>
<codeline lineno="1822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>*inout_bytes)<sp/>{</highlight></codeline>
<codeline lineno="1823"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok<sp/>||<sp/>(!ids<sp/>&amp;&amp;<sp/>count)<sp/>||<sp/>!inout_bytes)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1824"><highlight class="normal"></highlight></codeline>
<codeline lineno="1825"><highlight class="normal"><sp/><sp/><ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>bytes<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1826"><highlight class="normal"></highlight></codeline>
<codeline lineno="1827"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref><sp/>==<sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" kindref="member">IE_TOK_MODE_TIKTOKEN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1828"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>ids[i];</highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" kindref="member">IE_TOK_GPTOSS_ERR_RANGE</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint8_t<sp/>*p<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[id].<ref refid="structbytes__view__s_1a1a3cb300987ca32a9fe4adf6423d9db5" kindref="member">p</ref>;</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>n<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a276274c2cba2e0c82defdcf87bd2231a" kindref="member">id_to_bytes</ref>[id].<ref refid="structbytes__view__s_1a7563d683f8aebfd7c45a11e8ee386d98" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&amp;&amp;<sp/>(!p))<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n)<sp/>{</highlight></codeline>
<codeline lineno="1835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(&amp;bytes,<sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)p,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)n)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1837"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"></highlight></codeline>
<codeline lineno="1839"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;bytes,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1840"><highlight class="normal"><sp/><sp/><sp/><sp/>bytes.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>[bytes.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1841"><highlight class="normal"></highlight></codeline>
<codeline lineno="1842"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>need<sp/>=<sp/>bytes.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="1843"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out<sp/>||<sp/>*inout_bytes<sp/>==<sp/>0)<sp/>{<sp/>*inout_bytes<sp/>=<sp/>need;<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*inout_bytes<sp/>&lt;<sp/>need)<sp/>{<sp/>*inout_bytes<sp/>=<sp/>need;<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" kindref="member">IE_TOK_GPTOSS_ERR_RANGE</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1845"><highlight class="normal"></highlight></codeline>
<codeline lineno="1846"><highlight class="normal"><sp/><sp/><sp/><sp/>memcpy(out,<sp/>bytes.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>,<sp/>need);</highlight></codeline>
<codeline lineno="1847"><highlight class="normal"><sp/><sp/><sp/><sp/>*inout_bytes<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="1848"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);</highlight></codeline>
<codeline lineno="1849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"></highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint32_t<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>count;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1853"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>=<sp/>ids[i];</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>&gt;=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1ae859adc2daece05fc5bd98b3f8cb913e" kindref="member">vocab_size</ref>)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" kindref="member">IE_TOK_GPTOSS_ERR_RANGE</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1855"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*t<sp/>=<sp/>tok-&gt;<ref refid="structie__tok__gptoss__s_1a4417459614f97a9b31de9fc980450595" kindref="member">id_to_tok</ref>[id];</highlight></codeline>
<codeline lineno="1856"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!t)<sp/>t<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1857"><highlight class="normal"></highlight></codeline>
<codeline lineno="1858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>tlen<sp/>=<sp/>strlen(t);</highlight></codeline>
<codeline lineno="1859"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>pos<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1860"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pos<sp/>&lt;<sp/>tlen)<sp/>{</highlight></codeline>
<codeline lineno="1861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>cp<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>st<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a65dda7706f1a61f0bb0affe18aae7e87" kindref="member">utf8_next_cp</ref>(t,<sp/>tlen,<sp/>&amp;pos,<sp/>&amp;cp);</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(st<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1864"><highlight class="normal"></highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>b<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a501bba302f86962f8c5332144c6271a8" kindref="member">byteunicode_cp_to_byte</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" kindref="member">bu</ref>,<sp/>cp,<sp/>&amp;b)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>c<sp/>=<sp/>(char)b;</highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(&amp;bytes,<sp/>&amp;c,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>tmp[4];</highlight></codeline>
<codeline lineno="1871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wn<sp/>=<sp/><ref refid="tokenizer__gptoss_8c_1a76ab1829431e0d4b5530c5a262de3d95" kindref="member">utf8_put_cp</ref>(tmp,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(tmp),<sp/>cp);</highlight></codeline>
<codeline lineno="1872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(wn<sp/>==<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a7c972b84c8f4ce52042d97c576c1485b" kindref="member">strbuf_append_bytes</ref>(&amp;bytes,<sp/>tmp,<sp/>wn)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1875"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1876"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1877"><highlight class="normal"></highlight></codeline>
<codeline lineno="1878"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;bytes,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2aa85c45ba03e4d24b20dd6c893b7e5c66" kindref="member">IE_TOK_GPTOSS_ERR_NOMEM</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/>bytes.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>[bytes.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"></highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>need<sp/>=<sp/>bytes.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="1882"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out<sp/>||<sp/>*inout_bytes<sp/>==<sp/>0)<sp/>{<sp/>*inout_bytes<sp/>=<sp/>need;<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*inout_bytes<sp/>&lt;<sp/>need)<sp/>{<sp/>*inout_bytes<sp/>=<sp/>need;<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" kindref="member">IE_TOK_GPTOSS_ERR_RANGE</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1884"><highlight class="normal"></highlight></codeline>
<codeline lineno="1885"><highlight class="normal"><sp/><sp/>memcpy(out,<sp/>bytes.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>,<sp/>need);</highlight></codeline>
<codeline lineno="1886"><highlight class="normal"><sp/><sp/>*inout_bytes<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="1887"><highlight class="normal"><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bytes);</highlight></codeline>
<codeline lineno="1888"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1889"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1890"><highlight class="normal"></highlight></codeline>
<codeline lineno="1891" refid="ie__tokenizer__gptoss_8h_1a171cd54148a22d4fd7c1c8d1e9f010de" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="tokenizer__gptoss_8c_1a171cd54148a22d4fd7c1c8d1e9f010de" kindref="member">ie_tok_gptoss_encode</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structie__tok__gptoss__s" kindref="compound">ie_tok_gptoss_t</ref><sp/>*tok,</highlight></codeline>
<codeline lineno="1892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*text,</highlight></codeline>
<codeline lineno="1893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*ids,</highlight></codeline>
<codeline lineno="1894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>*inout_count)<sp/>{</highlight></codeline>
<codeline lineno="1895"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tok<sp/>||<sp/>!text<sp/>||<sp/>!inout_count)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a2bf73548c30949834b4c282d79ef32d4" kindref="member">IE_TOK_GPTOSS_ERR_ARGS</ref>;</highlight></codeline>
<codeline lineno="1896"><highlight class="normal"></highlight></codeline>
<codeline lineno="1897"><highlight class="normal"><sp/><sp/><ref refid="structu32buf__s" kindref="compound">u32buf_t</ref><sp/>out_ids<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1898"><highlight class="normal"></highlight></codeline>
<codeline lineno="1899"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tok-&gt;<ref refid="structie__tok__gptoss__s_1a41e8b48ef7e4d9c2ac9b53c06681efba" kindref="member">mode</ref><sp/>==<sp/><ref refid="tokenizer__gptoss_8c_1a4929967a6058f8fd4514406367d533c0acf2aa74fdd5fb42dd8757c120defadca" kindref="member">IE_TOK_MODE_TIKTOKEN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1900"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a316196e2c96c525919801e2cdd715806" kindref="member">tt_encode_text</ref>(tok,<sp/>text,<sp/>&amp;out_ids)<sp/>!=<sp/>0)<sp/>{<sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1901"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1902"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>**parts<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1903"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nparts<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1904"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a2d0b020d093299557c89f6753c85ddf2" kindref="member">pretokenize_basic</ref>(text,<sp/>&amp;parts,<sp/>&amp;nparts)<sp/>!=<sp/>0)<sp/>{<sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;<sp/>}</highlight></codeline>
<codeline lineno="1905"><highlight class="normal"></highlight></codeline>
<codeline lineno="1906"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nparts;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*seg<sp/>=<sp/>parts[i];</highlight></codeline>
<codeline lineno="1908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!seg<sp/>||<sp/>!*seg)<sp/>{<sp/>free(parts[i]);<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="1909"><highlight class="normal"></highlight></codeline>
<codeline lineno="1910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structstrbuf__s" kindref="compound">strbuf_t</ref><sp/>bl<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="1911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1af25b623505fecd332b0925d6c5c1dea2" kindref="member">to_bytelevel_unicode</ref>(&amp;tok-&gt;<ref refid="structie__tok__gptoss__s_1a7a6cf311089944345634de611a756678" kindref="member">bu</ref>,<sp/>seg,<sp/>strlen(seg),<sp/>&amp;bl)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bl);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail_gpt2;<sp/>}</highlight></codeline>
<codeline lineno="1912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a5f7b595a9a9d4bd08b783020e9a6b637" kindref="member">strbuf_reserve</ref>(&amp;bl,<sp/>1)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bl);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail_gpt2;<sp/>}</highlight></codeline>
<codeline lineno="1913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>bl.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>[bl.<ref refid="structstrbuf__s_1a96ac4933915be79e2d62aaf6d0a757cf" kindref="member">n</ref>]<sp/>=<sp/></highlight><highlight class="charliteral">&apos;\0&apos;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1914"><highlight class="normal"></highlight></codeline>
<codeline lineno="1915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="tokenizer__gptoss_8c_1a25fb92de16ca991b41ddb7448780cd1d" kindref="member">bpe_encode_to_ids_gpt2</ref>(tok,<sp/>bl.<ref refid="structstrbuf__s_1a4e51c5e374bc46c553e4d80459d0c56b" kindref="member">v</ref>,<sp/>&amp;out_ids)<sp/>!=<sp/>0)<sp/>{<sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bl);<sp/></highlight><highlight class="keywordflow">goto</highlight><highlight class="normal"><sp/>fail_gpt2;<sp/>}</highlight></codeline>
<codeline lineno="1916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tokenizer__gptoss_8c_1ae1e8b4fd77be0253a87c488246992c63" kindref="member">strbuf_free</ref>(&amp;bl);</highlight></codeline>
<codeline lineno="1917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>free(parts[i]);</highlight></codeline>
<codeline lineno="1918"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1919"><highlight class="normal"></highlight></codeline>
<codeline lineno="1920"><highlight class="normal"><sp/><sp/><sp/><sp/>free(parts);</highlight></codeline>
<codeline lineno="1921"><highlight class="normal"><sp/><sp/><sp/><sp/>parts<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="1922"><highlight class="normal"><sp/><sp/><sp/><sp/>nparts<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1923"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1924"><highlight class="normal"></highlight></codeline>
<codeline lineno="1925"><highlight class="normal"><sp/><sp/>uint32_t<sp/>need<sp/>=<sp/>(uint32_t)out_ids.<ref refid="structu32buf__s_1a69bb223dbff5f86425d029f71f2e800b" kindref="member">n</ref>;</highlight></codeline>
<codeline lineno="1926"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ids<sp/>||<sp/>*inout_count<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1927"><highlight class="normal"><sp/><sp/><sp/><sp/>*inout_count<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="1928"><highlight class="normal"><sp/><sp/><sp/><sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="1929"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1930"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1931"><highlight class="normal"></highlight></codeline>
<codeline lineno="1932"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*inout_count<sp/>&lt;<sp/>need)<sp/>{</highlight></codeline>
<codeline lineno="1933"><highlight class="normal"><sp/><sp/><sp/><sp/>*inout_count<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="1934"><highlight class="normal"><sp/><sp/><sp/><sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="1935"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2afeff254edf6b97edc55beca818a7dea9" kindref="member">IE_TOK_GPTOSS_ERR_RANGE</ref>;</highlight></codeline>
<codeline lineno="1936"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="1937"><highlight class="normal"></highlight></codeline>
<codeline lineno="1938"><highlight class="normal"><sp/><sp/>memcpy(ids,<sp/>out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>,<sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">)need<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(uint32_t));</highlight></codeline>
<codeline lineno="1939"><highlight class="normal"><sp/><sp/>*inout_count<sp/>=<sp/>need;</highlight></codeline>
<codeline lineno="1940"><highlight class="normal"><sp/><sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="1941"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a6e804d975236c9745c44c1db1baed259" kindref="member">IE_TOK_GPTOSS_OK</ref>;</highlight></codeline>
<codeline lineno="1942"><highlight class="normal"></highlight></codeline>
<codeline lineno="1943"><highlight class="normal">fail_gpt2:</highlight></codeline>
<codeline lineno="1944"><highlight class="normal"><sp/><sp/>free(out_ids.<ref refid="structu32buf__s_1a63ffad1f267a58867d21cc7b6b6f81ee" kindref="member">v</ref>);</highlight></codeline>
<codeline lineno="1945"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="ie__tokenizer__gptoss_8h_1a1305696bd5b44e9ad4e2b624ce1b59f2a12ba28164c55026e3f7e5301a6ac0189" kindref="member">IE_TOK_GPTOSS_ERR_INTERNAL</ref>;</highlight></codeline>
<codeline lineno="1946"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="engine/src/io/tokenizer_gptoss.c"/>
  </compounddef>
</doxygen>
