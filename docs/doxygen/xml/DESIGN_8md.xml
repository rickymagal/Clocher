<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="DESIGN_8md" kind="file" language="Markdown">
    <compoundname>DESIGN.md</compoundname>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline><highlight class="normal">#<sp/>Design<sp/>(CPU<sp/>baseline<sp/>+<sp/>INT4<sp/>path)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>document<sp/>describes<sp/>the<sp/>hot<sp/>path,<sp/>API<sp/>boundaries,<sp/>and<sp/>precision<sp/>modes.<sp/><sp/></highlight></codeline>
<codeline><highlight class="normal">**Last<sp/>updated:**<sp/>2025-10-24<sp/>21:00:48<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Process<sp/>and<sp/>boundaries</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Single<sp/>binary<sp/>`inference-engine`:<sp/>create<sp/>→<sp/>generate<sp/>→<sp/>collect<sp/>metrics<sp/>→<sp/>destroy.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>CLI<sp/>prints<sp/>exactly<sp/>one<sp/>JSON<sp/>line<sp/>per<sp/>run<sp/>so<sp/>the<sp/>Python<sp/>harness<sp/>can<sp/>ingest<sp/>results.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>No<sp/>third‑party<sp/>runtime<sp/>dependencies;<sp/>only<sp/>`pthread`<sp/>and<sp/>`libm`<sp/>(and<sp/>CUDA<sp/>for<sp/>the<sp/>GPU<sp/>build).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>API<sp/>surface<sp/>(high<sp/>level)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`ie_engine_create(cfg)`<sp/>→<sp/>initializes<sp/>state<sp/>(weights,<sp/>buffers,<sp/>thread‑pool).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`ie_engine_generate(prompt,<sp/>max_new,<sp/>params)`<sp/>→<sp/>produces<sp/>tokens<sp/>and<sp/>updates<sp/>metrics<sp/>rings.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`ie_engine_metrics(out)`<sp/>→<sp/>returns<sp/>latency<sp/>p50/p95,<sp/>true<sp/>TPS,<sp/>**RSS<sp/>peak**,<sp/>KV<sp/>hits/misses.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`ie_engine_destroy()`<sp/>→<sp/>frees<sp/>all<sp/>resources.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Hot<sp/>path<sp/>layout</highlight></codeline>
<codeline><highlight class="normal">-<sp/>GEMV<sp/>microkernel:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Generic<sp/>scalar<sp/>reference<sp/>implementation.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>AVX2/FMA<sp/>path<sp/>with<sp/>light<sp/>prefetch<sp/>and<sp/>blocked‑K<sp/>packing.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Activation:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`tanh`<sp/>fast<sp/>path<sp/>with<sp/>clamp<sp/>(accuracy‑bounded),<sp/>vector<sp/>helper.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Optional<sp/>fused<sp/>bias<sp/>+<sp/>activation<sp/>to<sp/>reduce<sp/>memory<sp/>traffic.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Precision<sp/>modes</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Floating<sp/>point</highlight></codeline>
<codeline><highlight class="normal">-<sp/>FP32<sp/>baseline,<sp/>optional<sp/>BF16/FP16<sp/>round‑trip<sp/>(accumulate<sp/>FP32).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>INT8<sp/>PTQ<sp/>(reference)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Per‑tensor/per‑row<sp/>scales<sp/>(min‑max);<sp/>(de)quant<sp/>helpers;<sp/>task<sp/>gate<sp/>in<sp/>scripts.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>**NEW<sp/>—<sp/>INT4<sp/>PTQ<sp/>(weight‑only)**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Format**:<sp/>weights<sp/>are<sp/>**nibble‑packed**<sp/>(2<sp/>values<sp/>per<sp/>byte).<sp/>Each<sp/>row<sp/>(or<sp/>group)<sp/>carries<sp/>a<sp/>scale<sp/>(and<sp/>optional<sp/>zero‑point<sp/>if<sp/>affine).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Packing**:<sp/>INT4<sp/>packing<sp/>integrates<sp/>with<sp/>the<sp/>existing<sp/>**pretranspose<sp/>/<sp/>blocked‑K**<sp/>pipeline.<sp/>Packing<sp/>order:<sp/>float<sp/>→<sp/>(optional)<sp/>pretranspose<sp/>→<sp/>quantize<sp/>to<sp/>int4<sp/>→<sp/>pack.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Dequantization**:<sp/>fused<sp/>in<sp/>the<sp/>matmul<sp/>path;<sp/>scale<sp/>is<sp/>broadcast<sp/>per<sp/>row<sp/>(or<sp/>group)<sp/>to<sp/>recover<sp/>FP32<sp/>accumulators.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Manifests**:<sp/>a<sp/>`q4_manifest.json`<sp/>enumerates<sp/>which<sp/>tensors<sp/>use<sp/>INT4<sp/>and<sp/>their<sp/>scale<sp/>metadata.<sp/>`scripts/hf_to_iebin.py`<sp/>consumes<sp/>this<sp/>manifest<sp/>via<sp/>`--q4-map`<sp/>to<sp/>emit<sp/>`model.ie.bin`/`.json`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Selection**:<sp/>at<sp/>runtime<sp/>choose<sp/>`IE_PRECISION=int4w`<sp/>(or<sp/>`--precision<sp/>int4w`),<sp/>leaving<sp/>activations<sp/>in<sp/>float.<sp/>This<sp/>is<sp/>**bandwidth‑oriented**<sp/>and<sp/>preserves<sp/>compute<sp/>simplicity.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Threading<sp/>model</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Fixed<sp/>thread‑pool<sp/>over<sp/>`pthread`,<sp/>contiguous<sp/>sharding,<sp/>grainsize<sp/>control.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Affinity<sp/>(Linux):<sp/>`IE_TP_USE_AFFINITY=1`<sp/>enables<sp/>`auto|compact|scatter`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>NUMA:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`scripts/set_numa.sh`<sp/>can<sp/>set<sp/>OS<sp/>policy<sp/>(`interleave|node:X|strict`).</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>In‑repo<sp/>probe<sp/>reads<sp/>`/sys/devices/system/node/online`<sp/>to<sp/>annotate<sp/>reports.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Layout<sp/>and<sp/>caching</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Blocked‑K<sp/>packing<sp/>with<sp/>optional<sp/>on‑disk<sp/>caching<sp/>(content‑addressed<sp/>by<sp/>shape<sp/>+<sp/>block<sp/>size).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>CLI<sp/>flag<sp/>`--pretranspose`<sp/>controls<sp/>packing<sp/>scope<sp/>(`none|woh|wxh|all`).<sp/>INT4<sp/>can<sp/>be<sp/>cached<sp/>per<sp/>layout<sp/>variant.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Metrics</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Per‑token<sp/>latency<sp/>ring<sp/>(p50/p95).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>True<sp/>TPS<sp/>(`generated_tokens<sp/>/<sp/>wall_time_s`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Peak<sp/>RSS**<sp/>(Linux<sp/>`/proc/self/status:VmHWM`<sp/>→<sp/>MiB;<sp/>fallback<sp/>`getrusage`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>KV<sp/>hits/misses<sp/>counter<sp/>stubs<sp/>aggregated<sp/>per<sp/>round.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>GPU<sp/>integration<sp/>(CUDA<sp/>path)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Device<sp/>layer:<sp/>`engine/src/devices/ie_device_cuda.cu`,<sp/>kernels<sp/>in<sp/>`engine/src/kernels/ie_kernels_cuda.cu`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Build:<sp/>`make<sp/>build-cuda`<sp/>→<sp/>`build/inference-engine.cuda`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>INT4<sp/>weight‑only<sp/>support<sp/>mirrors<sp/>the<sp/>CPU<sp/>path;<sp/>packing<sp/>and<sp/>scales<sp/>are<sp/>shared<sp/>in<sp/>`model.ie.json`.</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">##<sp/>INT4<sp/>Weight-Only<sp/>Path<sp/>—<sp/>Design<sp/>Addendum<sp/>(2025-10-24<sp/>21:04:23<sp/>UTC)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Goals</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Introduce<sp/>an<sp/>**optional**<sp/>path<sp/>for<sp/>*weight-only*<sp/>INT4<sp/>(`int4w`)<sp/>that:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>1)<sp/>Packs<sp/>HF<sp/>weights<sp/>into<sp/>IEBIN<sp/>using<sp/>a<sp/>**manifest-driven**<sp/>policy.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>2)<sp/>Leaves<sp/>tokenization,<sp/>shapes,<sp/>and<sp/>scheduling<sp/>untouched.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>3)<sp/>Preserves<sp/>benchmark<sp/>comparability<sp/>via<sp/>*work-touch*<sp/>instrumentation.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Design<sp/>Choices</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Manifest-driven<sp/>packing**:<sp/>`--q4-map`<sp/>lets<sp/>us<sp/>target<sp/>only<sp/>GEMV-heavy<sp/>matrices<sp/>(attn/MLP<sp/>projections)<sp/>and<sp/>keep<sp/>sensitive<sp/>tensors<sp/>(embeddings,<sp/>layernorms)<sp/>in<sp/>FP<sp/>formats.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Separation<sp/>of<sp/>concerns**:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Storage<sp/>precision<sp/>(`IE_PRECISION`)<sp/>is<sp/>passed<sp/>through<sp/>`ie_engine_params_t::precision`<sp/>untouched.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Host<sp/>math<sp/>precision<sp/>(FP32/BF16/FP16)<sp/>remains<sp/>a<sp/>separate<sp/>selection.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Compat<sp/>with<sp/>harness**:<sp/>The<sp/>CLI<sp/>accepts<sp/>soft<sp/>hints<sp/>(`--device`,<sp/>`--model-dir`,<sp/>`--rounds`)<sp/>so<sp/>existing<sp/>scripts<sp/>don’t<sp/>break.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Data<sp/>Flow<sp/>(INT4<sp/>path)</highlight></codeline>
<codeline><highlight class="normal">HF<sp/>shards<sp/>→<sp/>`hf_to_iebin.py<sp/>--q4-map`<sp/>→<sp/>IEBIN<sp/>(`model.ie.json`<sp/>+<sp/>`model.ie.bin`<sp/>with<sp/>INT4-packed<sp/>tensors)<sp/>→<sp/>Runtime<sp/>`IE_PRECISION=int4w`<sp/>→<sp/>GEMV<sp/>kernels<sp/>read<sp/>packed<sp/>weights<sp/>(or<sp/>dequant<sp/>on<sp/>load),<sp/>semantics<sp/>unchanged.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Metrics<sp/>Integrity</highlight></codeline>
<codeline><highlight class="normal">-<sp/>The<sp/>timed<sp/>window<sp/>is<sp/>**only**:<sp/>`ie_engine_generate(...)`<sp/>+<sp/>optional<sp/>*work-touch*<sp/>loop.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>RSS<sp/>peak<sp/>and<sp/>KV<sp/>counters<sp/>are<sp/>sampled<sp/>**after**<sp/>the<sp/>window<sp/>to<sp/>avoid<sp/>skewing<sp/>TPS.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Appendix<sp/>—<sp/>INT4<sp/>(Weight‑Only)<sp/>Step<sp/>(Summary)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Convert<sp/>HF<sp/>shards<sp/>→<sp/>IEBIN<sp/>with<sp/>an<sp/>INT4<sp/>manifest:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>python3<sp/>scripts/hf_to_iebin.py<sp/><sp/><sp/><sp/><sp/>--hf-dir<sp/>models/gpt-oss-20b/hf<sp/><sp/><sp/><sp/><sp/>--out-dir<sp/>models/gpt-oss-20b<sp/><sp/><sp/><sp/><sp/>--q4-map<sp/>quant/q4_manifest.json</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Run<sp/>benchmarks<sp/>in<sp/>strict<sp/>mode<sp/>with<sp/>a<sp/>**64<sp/>MB/token**<sp/>work‑touch:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>PROMPTS=benchmarks/prompts_10..txt<sp/><sp/><sp/>IE_PRECISION=int4w<sp/>IE_REQUIRE_MODEL=1<sp/><sp/><sp/>IE_BYTES_PER_TOKEN=64000000<sp/>IE_STRIDE_BYTES=256<sp/>RUNS=3<sp/><sp/><sp/>make<sp/>bench<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>or:<sp/>make<sp/>bench-cuda</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Precision<sp/>hints:<sp/>`PRECISION=fp32`<sp/>(activates<sp/>float<sp/>path)<sp/>and<sp/>`IE_PRECISION=int4w`<sp/>(weight‑only<sp/>path).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">##<sp/>Updates<sp/>—<sp/>2025-11-10</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>NUMA‑aware<sp/>topology<sp/>(`ie_topology`)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Discovers<sp/>sockets<sp/>and<sp/>CPUs<sp/>from<sp/>Linux<sp/>sysfs<sp/>and<sp/>exposes<sp/>a<sp/>compact<sp/>API:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`ie_topology_init/destroy`<sp/>—<sp/>lifetime.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`ie_topology_sockets()`<sp/>—<sp/>number<sp/>of<sp/>sockets.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`ie_topology_first_cpu_on_socket(s)`<sp/>—<sp/>first<sp/>CPU<sp/>index<sp/>on<sp/>socket<sp/>`s`<sp/>(for<sp/>pinning).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Integration:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Thread‑pool<sp/>honors<sp/>`IE_TP_USE_AFFINITY=1`<sp/>with<sp/>`AFFINITY=auto|compact|scatter`.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`ie_hot_replicate_by_socket(...)`<sp/>uses<sp/>topology<sp/>for<sp/>binding.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Hot<sp/>weights<sp/>replication</highlight></codeline>
<codeline><highlight class="normal">-<sp/>For<sp/>“hot”<sp/>tensors<sp/>(frequently<sp/>touched),<sp/>we<sp/>can<sp/>replicate<sp/>pages<sp/>**per<sp/>socket**<sp/>to<sp/>reduce<sp/>remote<sp/>memory<sp/>hits.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Implementation<sp/>sketch:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`mmap`<sp/>replica<sp/>per<sp/>socket<sp/>→<sp/>optional<sp/>`madvise(...,<sp/>MADV_WILLNEED)`<sp/>→<sp/>worker<sp/>binding<sp/>→<sp/>socket‑local<sp/>access.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Controlled<sp/>by<sp/>`IE_HOT_REPLICATE=1`<sp/>and<sp/>an<sp/>optional<sp/>cap<sp/>`IE_HOT_REPL_LIMIT_MB`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Trade‑offs:<sp/>additional<sp/>memory;<sp/>on<sp/>single‑socket<sp/>machines,<sp/>the<sp/>feature<sp/>is<sp/>a<sp/>no‑op<sp/>with<sp/>negligible<sp/>overhead.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Activation<sp/>precision<sp/>hint</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Runtime<sp/>hint<sp/>`IE_ACT_PREC=int8|fp8|fp16|bf16|fp32`<sp/>allows<sp/>experimenting<sp/>with<sp/>lower‑precision<sp/>activations<sp/>while<sp/>**keeping<sp/>FP32<sp/>accumulators**.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Weight<sp/>precision<sp/>remains<sp/>independent<sp/>(e.g.,<sp/>`IE_PRECISION=int4w`<sp/>for<sp/>nibble‑packed<sp/>weights).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Timing<sp/>discipline<sp/>(unchanged<sp/>semantics)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>The<sp/>benchmark<sp/>**measured<sp/>window**<sp/>contains<sp/>only<sp/>`ie_engine_generate(...)`<sp/>+<sp/>optional<sp/>work‑touch<sp/>loop.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>All<sp/>metrics<sp/>collection<sp/>(RSS,<sp/>KV,<sp/>JSON<sp/>print)<sp/>happens<sp/>**after**<sp/>the<sp/>window.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Example<sp/>configurations</highlight></codeline>
<codeline><highlight class="normal">-<sp/>INT4<sp/>weights,<sp/>FP8<sp/>activations,<sp/>NUMA‑aware<sp/>with<sp/>hot<sp/>replication<sp/>(CPU):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>export<sp/>IE_REQUIRE_MODEL=1<sp/>IE_PRECISION=int4w<sp/>IE_ACT_PREC=fp8</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>export<sp/>IE_BYTES_PER_TOKEN=$((64*1024*1024))<sp/>IE_STRIDE_BYTES=256<sp/>IE_VERIFY_TOUCH=1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>export<sp/>IE_TP_USE_AFFINITY=1<sp/>AFFINITY=compact<sp/>IE_HOT_REPLICATE=1</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>PROMPTS=benchmarks/prompts_10..txt<sp/>RUNS=3<sp/>make<sp/>bench</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Same<sp/>with<sp/>CUDA:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>PROMPTS=benchmarks/prompts_10..txt<sp/>RUNS=3<sp/>make<sp/>bench-cuda</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">#<sp/>Memory<sp/>Phase<sp/>Design<sp/>Addendum<sp/>(updated<sp/>2025-11-12<sp/>18:01:19<sp/>UTC)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Goals</highlight></codeline>
<codeline><highlight class="normal">1.<sp/>Reduce<sp/>**DRAM<sp/>traffic**<sp/>on<sp/>weight<sp/>fetch<sp/>via<sp/>layout<sp/>(`blocked‑K`),<sp/>NUMA<sp/>locality,<sp/>and<sp/>selective<sp/>non‑temporal<sp/>loads.</highlight></codeline>
<codeline><highlight class="normal">2.<sp/>Enable<sp/>**activation<sp/>down‑precision**<sp/>(INT8/FP8)<sp/>orthogonally<sp/>to<sp/>weight<sp/>storage<sp/>(e.g.,<sp/>INT4<sp/>weight‑only).</highlight></codeline>
<codeline><highlight class="normal">3.<sp/>Measure<sp/>and<sp/>visualize<sp/>**spatial<sp/>metrics**<sp/>alongside<sp/>TPS:<sp/>MB/token,<sp/>bytes<sp/>touched,<sp/>model<sp/>coverage,<sp/>effective<sp/>bandwidth.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Components</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Topology<sp/>&amp;<sp/>Binding<sp/>(`ie_topology`)**:<sp/>discovers<sp/>sockets/CPUs<sp/>from<sp/>Linux<sp/>sysfs.<sp/>Exposes<sp/>helpers<sp/>for<sp/>pinning<sp/>(compact/scatter).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Hot<sp/>replication<sp/>(`replicate_hot.c`)**:<sp/>optional<sp/>per‑socket<sp/>replicas<sp/>for<sp/>frequently‑touched<sp/>weights;<sp/>uses<sp/>`mmap`<sp/>+<sp/>`madvise`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Blocked‑K<sp/>Pretranspose**:<sp/>builds<sp/>and<sp/>caches<sp/>a<sp/>row‑major,<sp/>**K‑blocked**<sp/>layout;<sp/>improves<sp/>sequentiality<sp/>and<sp/>prefetch<sp/>efficacy.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Streaming<sp/>heuristics**:<sp/>`IE_PREFETCH_DISTANCE`,<sp/>`IE_NT_LOADS`,<sp/>and<sp/>`IE_NT_RATIO`<sp/>drive<sp/>prefetch<sp/>and<sp/>non‑temporal<sp/>load<sp/>decisions.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Activation<sp/>precision**:<sp/>runtime<sp/>hint<sp/>`IE_ACT_PREC`<sp/>selects<sp/>decode<sp/>path<sp/>(INT8<sp/>per‑tensor/per‑group,<sp/>FP8<sp/>E4M3/E5M2).<sp/>Accumulation<sp/>is<sp/>FP32.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Measurement</highlight></codeline>
<codeline><highlight class="normal">The<sp/>benchmark<sp/>window<sp/>includes<sp/>**generation**<sp/>and<sp/>the<sp/>**work‑touch**<sp/>loop<sp/>(controlled<sp/>by<sp/>`IE_BYTES_PER_TOKEN`,<sp/>`IE_STRIDE_BYTES`).</highlight></codeline>
<codeline><highlight class="normal">After<sp/>the<sp/>window,<sp/>the<sp/>engine<sp/>samples<sp/>**peak<sp/>RSS<sp/>(VmHWM)**.<sp/>The<sp/>docs<sp/>generator<sp/>now<sp/>derives:</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**MB/token**<sp/>from<sp/>`IE_BYTES_PER_TOKEN`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Total<sp/>bytes<sp/>touched**<sp/>=<sp/>`tokens_sum<sp/>*<sp/>bytes_per_token`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Coverage**<sp/>=<sp/>`bytes_per_token<sp/>/<sp/>size(model.ie.bin)`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Effective<sp/>bandwidth**<sp/>=<sp/>`bytes_touched<sp/>/<sp/>wall_time`<sp/>(GB/s)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Backward<sp/>Compatibility<sp/>&amp;<sp/>Fallbacks</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Single‑socket<sp/>hosts:<sp/>topology<sp/>collapses<sp/>to<sp/>one<sp/>socket;<sp/>binding<sp/>is<sp/>a<sp/>no‑op.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Unsupported<sp/>backends<sp/>ignore<sp/>`IE_ACT_PREC`,<sp/>`IE_NT_LOADS`,<sp/>etc.,<sp/>without<sp/>failing.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>When<sp/>`IE_REQUIRE_MODEL`<sp/>is<sp/>unset,<sp/>CI<sp/>stub<sp/>mode<sp/>continues<sp/>to<sp/>work<sp/>(no<sp/>mmap<sp/>or<sp/>spatial<sp/>metrics).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Risks<sp/>&amp;<sp/>Mitigations</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Over‑eager<sp/>NT<sp/>loads**<sp/>can<sp/>hurt<sp/>on<sp/>small<sp/>working<sp/>sets<sp/>→<sp/>guard<sp/>via<sp/>`auto`<sp/>heuristics<sp/>and<sp/>`IE_NT_RATIO`<sp/>throttle.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**Replica<sp/>memory<sp/>cost**<sp/>on<sp/>multi‑socket<sp/>servers<sp/>→<sp/>gate<sp/>with<sp/>`IE_HOT_REPLICATE`<sp/>and<sp/>`IE_HOT_REPL_LIMIT_MB`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">#<sp/>Block‑sparse<sp/>weights<sp/>(Phase<sp/>2,<sp/>CPU<sp/>only)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>chapter<sp/>describes<sp/>the<sp/>**block‑sparse<sp/>weights<sp/>prototype**<sp/>implemented<sp/>in<sp/>the</highlight></codeline>
<codeline><highlight class="normal">second<sp/>phase<sp/>of<sp/>the<sp/>memory<sp/>work.<sp/>The<sp/>goal<sp/>is<sp/>to<sp/>make<sp/>*algorithmic<sp/>sparsity*</highlight></codeline>
<codeline><highlight class="normal">concrete<sp/>and<sp/>measurable<sp/>while<sp/>keeping<sp/>the<sp/>dense<sp/>engine<sp/>and<sp/>IEBIN<sp/>format<sp/>intact.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">At<sp/>this<sp/>stage<sp/>the<sp/>implementation<sp/>is<sp/>**CPU‑only**,<sp/>FP32‑only,<sp/>and<sp/>is<sp/>exercised</highlight></codeline>
<codeline><highlight class="normal">through<sp/>C<sp/>unit<sp/>tests<sp/>and<sp/>a<sp/>dedicated<sp/>microbenchmark.<sp/>It<sp/>is<sp/>deliberately<sp/>small</highlight></codeline>
<codeline><highlight class="normal">and<sp/>self‑contained<sp/>so<sp/>that<sp/>we<sp/>can<sp/>iterate<sp/>on<sp/>formats<sp/>and<sp/>policies<sp/>without</highlight></codeline>
<codeline><highlight class="normal">destabilizing<sp/>the<sp/>main<sp/>inference<sp/>path.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Goals</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Provide<sp/>a<sp/>**well‑defined<sp/>in‑memory<sp/>descriptor**<sp/>for<sp/>block‑sparse<sp/>matrices</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>(`ie_block_sparse_matrix_t`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Define<sp/>a<sp/>**compact<sp/>on‑disk<sp/>format**<sp/>that<sp/>can<sp/>be<sp/>produced<sp/>by<sp/>a<sp/>simple<sp/>C<sp/>tool</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>(`tools/convert_to_block_sparse.c`)<sp/>and<sp/>loaded<sp/>by<sp/>the<sp/>engine.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Implement<sp/>a<sp/>**reference<sp/>GEMV<sp/>kernel**<sp/>for<sp/>block‑sparse<sp/>matrices<sp/>on<sp/>CPU:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>numerically<sp/>equivalent<sp/>to<sp/>dense<sp/>GEMV<sp/>(modulo<sp/>FP<sp/>roundoff).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Wire<sp/>this<sp/>into<sp/>the<sp/>device<sp/>abstraction<sp/>so<sp/>that:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>the<sp/>CPU<sp/>backend<sp/>can<sp/>execute<sp/>block‑sparse<sp/>GEMV;<sp/>and</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>other<sp/>backends<sp/>can<sp/>safely<sp/>report<sp/>“unimplemented”<sp/>and<sp/>trigger<sp/>a<sp/>CPU</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>fallback.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Keep<sp/>the<sp/>feature<sp/>fully<sp/>**opt‑in**:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>No<sp/>changes<sp/>to<sp/>`model.ie.bin`<sp/>or<sp/>the<sp/>CLI.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>No<sp/>new<sp/>runtime<sp/>flags<sp/>required<sp/>for<sp/>existing<sp/>workflows.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>In‑memory<sp/>layout:<sp/>`ie_block_sparse_matrix_t`</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>new<sp/>public<sp/>descriptor<sp/>lives<sp/>in<sp/>`engine/include/sparse_format.h`:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Global<sp/>dimensions:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`rows`,<sp/>`cols`<sp/>—<sp/>dense<sp/>matrix<sp/>shape.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`block_rows`,<sp/>`block_cols`<sp/>—<sp/>tile<sp/>shape<sp/>(same<sp/>for<sp/>all<sp/>blocks).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Block‑row<sp/>CSR<sp/>(BSR)<sp/>structure:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`n_block_rows`<sp/>—<sp/>number<sp/>of<sp/>block<sp/>rows<sp/>(typically</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>`ceil(rows<sp/>/<sp/>block_rows)`).</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`row_ptr`<sp/>—<sp/>length<sp/>`n_block_rows<sp/>+<sp/>1`;<sp/>`row_ptr[br]..row_ptr[br+1]-1`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>indexes<sp/>the<sp/>non‑zero<sp/>blocks<sp/>(`nnzb`<sp/>total).</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`col_idx`<sp/>—<sp/>length<sp/>`nnzb`;<sp/>column<sp/>index<sp/>in<sp/>block<sp/>coordinates</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>(`0..ceil(cols<sp/>/<sp/>block_cols)-1`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Values:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`values`<sp/>—<sp/>contiguous<sp/>FP32<sp/>array<sp/>of<sp/>length</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>`nnzb<sp/>*<sp/>block_rows<sp/>*<sp/>block_cols`,<sp/>stored<sp/>in<sp/>row‑major<sp/>order<sp/>*within*</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>each<sp/>block.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Semantics:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Conceptually<sp/>the<sp/>matrix<sp/>is<sp/>partitioned<sp/>into<sp/>`block_rows<sp/>x<sp/>block_cols`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>tiles.<sp/>For<sp/>each<sp/>block<sp/>row<sp/>`br`<sp/>we<sp/>list<sp/>all<sp/>non‑zero<sp/>tiles<sp/>in<sp/>ascending</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>block<sp/>column<sp/>order.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>The<sp/>actual<sp/>dense<sp/>dimensions<sp/>are<sp/>always<sp/>taken<sp/>from<sp/>`rows`<sp/>/<sp/>`cols`.<sp/>Tail</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>blocks<sp/>near<sp/>the<sp/>bottom/right<sp/>edges<sp/>are<sp/>automatically<sp/>clipped<sp/>in<sp/>the</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>GEMV<sp/>kernel.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>helpers<sp/>in<sp/>`sparse_format.h`<sp/>cover:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>sanity<sp/>checks<sp/>for<sp/>header<sp/>fields;</highlight></codeline>
<codeline><highlight class="normal">-<sp/>allocation/free<sp/>helpers;<sp/>and</highlight></codeline>
<codeline><highlight class="normal">-<sp/>small<sp/>utilities<sp/>to<sp/>compute<sp/>block<sp/>counts<sp/>and<sp/>strides.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>On‑disk<sp/>format<sp/>and<sp/>loader<sp/>(`engine/src/sparse_io.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">To<sp/>keep<sp/>experiments<sp/>reproducible<sp/>without<sp/>touching<sp/>the<sp/>IEBIN<sp/>format,<sp/>we<sp/>use<sp/>a</highlight></codeline>
<codeline><highlight class="normal">separate,<sp/>compact<sp/>binary<sp/>format<sp/>for<sp/>block‑sparse<sp/>matrices:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>A<sp/>fixed‑size<sp/>header<sp/>that<sp/>records:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>magic<sp/>/<sp/>version;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`rows`,<sp/>`cols`,<sp/>`block_rows`,<sp/>`block_cols`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`n_block_rows`,<sp/>`nnzb`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>sizes<sp/>of<sp/>the<sp/>three<sp/>payload<sp/>arrays<sp/>(`row_ptr`,<sp/>`col_idx`,<sp/>`values`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Payload<sp/>sections,<sp/>tightly<sp/>packed:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>1.<sp/>`row_ptr`<sp/>(`uint32_t`<sp/>×<sp/>`n_block_rows<sp/>+<sp/>1`);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>2.<sp/>`col_idx`<sp/>(`uint32_t`<sp/>×<sp/>`nnzb`);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>3.<sp/>`values`<sp/>(`float`<sp/>×<sp/>`nnzb<sp/>*<sp/>block_rows<sp/>*<sp/>block_cols`).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>loader<sp/>`ie_block_sparse_load(const<sp/>char<sp/>*path,<sp/>ie_block_sparse_matrix_t<sp/>*out)`</highlight></codeline>
<codeline><highlight class="normal">performs:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">1.<sp/>open<sp/>+<sp/>read<sp/>header;</highlight></codeline>
<codeline><highlight class="normal">2.<sp/>validate<sp/>fields<sp/>(non‑zero<sp/>dimensions,<sp/>monotonically<sp/>increasing</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>`row_ptr`,<sp/>etc.);</highlight></codeline>
<codeline><highlight class="normal">3.<sp/>allocate<sp/>arrays<sp/>for<sp/>`row_ptr`,<sp/>`col_idx`,<sp/>`values`;</highlight></codeline>
<codeline><highlight class="normal">4.<sp/>read<sp/>the<sp/>three<sp/>payload<sp/>sections;<sp/>and</highlight></codeline>
<codeline><highlight class="normal">5.<sp/>on<sp/>success,<sp/>fill<sp/>`out`<sp/>with<sp/>owned<sp/>pointers<sp/>and<sp/>return<sp/>`IE_SPARSE_OK`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Error<sp/>paths:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Any<sp/>structural<sp/>or<sp/>I/O<sp/>error<sp/>returns<sp/>a<sp/>specific<sp/>`ie_sparse_status_t`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>(e.g.<sp/>`IE_SPARSE_ERR_IO`,<sp/>`IE_SPARSE_ERR_FORMAT`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>On<sp/>error,<sp/>partially<sp/>allocated<sp/>buffers<sp/>are<sp/>freed<sp/>and<sp/>`out`<sp/>is<sp/>zeroed.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>CPU<sp/>kernel<sp/>(`engine/src/gemm_block_sparse.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>reference<sp/>GEMV<sp/>implementation:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```c</highlight></codeline>
<codeline><highlight class="normal">void<sp/>ie_gemv_block_sparse_f32(const<sp/>ie_block_sparse_matrix_t<sp/>*m,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>float<sp/>*x,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>*y,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>float<sp/>*bias);</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Design:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Single‑threaded,<sp/>straightforward<sp/>loop<sp/>structure:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>iterate<sp/>over<sp/>block<sp/>rows<sp/>(`br`);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>for<sp/>each<sp/>local<sp/>row<sp/>in<sp/>the<sp/>block<sp/>(`local_r`),<sp/>compute<sp/>the<sp/>dense<sp/>row</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>index<sp/>`row<sp/>=<sp/>br<sp/>*<sp/>block_rows<sp/>+<sp/>local_r`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>iterate<sp/>over<sp/>non‑zero<sp/>blocks<sp/>in<sp/>that<sp/>block<sp/>row<sp/>using</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>`row_ptr[br]..row_ptr[br+1]`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>for<sp/>each<sp/>block,<sp/>compute<sp/>the<sp/>starting<sp/>column<sp/>and<sp/>take<sp/>an<sp/>inner</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>product<sp/>between<sp/>the<sp/>block<sp/>row<sp/>and<sp/>the<sp/>corresponding<sp/>slice<sp/>of<sp/>`x`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Tail<sp/>safety:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>rows<sp/>with<sp/>`row<sp/>&gt;=<sp/>rows`<sp/>are<sp/>skipped;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>columns<sp/>with<sp/>`col<sp/>&gt;=<sp/>cols`<sp/>are<sp/>skipped<sp/>inside<sp/>the<sp/>innermost<sp/>loop.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Bias:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`bias<sp/>==<sp/>NULL`<sp/>is<sp/>allowed;<sp/>in<sp/>that<sp/>case<sp/>the<sp/>accumulator<sp/>starts<sp/>at</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>`0.0f`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>otherwise<sp/>we<sp/>seed<sp/>`acc`<sp/>with<sp/>`bias[row]`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>function<sp/>is<sp/>small<sp/>and<sp/>easy<sp/>to<sp/>inspect,<sp/>prioritizing<sp/>correctness<sp/>and</highlight></codeline>
<codeline><highlight class="normal">debuggability<sp/>over<sp/>clever<sp/>micro‑optimizations.<sp/>Higher‑level<sp/>code<sp/>can<sp/>decide</highlight></codeline>
<codeline><highlight class="normal">whether<sp/>and<sp/>how<sp/>to<sp/>shard<sp/>block<sp/>rows<sp/>across<sp/>threads.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Device<sp/>abstraction<sp/>(`engine/src/devices/ie_device_common.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>`ie_device`<sp/>vtable<sp/>gains<sp/>a<sp/>new<sp/>entry:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```c</highlight></codeline>
<codeline><highlight class="normal">int<sp/><sp/>(*gemv_block_sparse_f32)(void<sp/>*self,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>ie_block_sparse_matrix_t<sp/>*m,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>float<sp/>*x,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>float<sp/>*y,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>float<sp/>*bias);</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Backend<sp/>implementations:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>**CPU:**</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`cpu_gemv_block_sparse_f32`<sp/>simply<sp/>forwards<sp/>to</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>`ie_gemv_block_sparse_f32`.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`ie_device_gemv_block_sparse_f32`<sp/>(public<sp/>helper)<sp/>routes<sp/>through<sp/>the</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>vtable<sp/>and,<sp/>on<sp/>failure,<sp/>can<sp/>fall<sp/>back<sp/>to<sp/>a<sp/>CPU<sp/>device<sp/>if<sp/>the<sp/>current</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>device<sp/>is<sp/>not<sp/>already<sp/>CPU.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**CUDA<sp/>/<sp/>Level<sp/>Zero:**</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>for<sp/>this<sp/>phase<sp/>they<sp/>return<sp/>an<sp/>“unimplemented”<sp/>error<sp/>code;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>callers<sp/>that<sp/>use<sp/>`ie_device_gemv_block_sparse_f32`<sp/>will<sp/>see<sp/>the<sp/>error</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>and<sp/>can<sp/>choose<sp/>to<sp/>fall<sp/>back<sp/>to<sp/>CPU.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>No<sp/>GPU<sp/>kernels<sp/>are<sp/>required<sp/>for<sp/>tests<sp/>to<sp/>pass.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>layout<sp/>keeps<sp/>the<sp/>public<sp/>API<sp/>stable<sp/>while<sp/>allowing<sp/>future<sp/>ADRs<sp/>to<sp/>add</highlight></codeline>
<codeline><highlight class="normal">true<sp/>GPU<sp/>implementations<sp/>under<sp/>the<sp/>same<sp/>method.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Tools<sp/>and<sp/>tests</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Offline<sp/>converter<sp/>(`tools/convert_to_block_sparse.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>converter<sp/>takes<sp/>a<sp/>dense,<sp/>row‑major<sp/>FP32<sp/>matrix<sp/>and<sp/>produces<sp/>the</highlight></codeline>
<codeline><highlight class="normal">block‑sparse<sp/>binary<sp/>format:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Inputs:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>path<sp/>to<sp/>a<sp/>dense<sp/>`.bin`<sp/>(raw<sp/>`float`<sp/>array<sp/>of<sp/>shape<sp/>`rows<sp/>×<sp/>cols`);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`rows`,<sp/>`cols`,<sp/>`block_rows`,<sp/>`block_cols`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>optional<sp/>threshold<sp/>/<sp/>sparsification<sp/>policy<sp/>(for<sp/>now,<sp/>the<sp/>prototype</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>typically<sp/>uses<sp/>*exact*<sp/>sparsity<sp/>patterns<sp/>produced<sp/>upstream).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Steps:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>1.<sp/>read<sp/>dense<sp/>matrix<sp/>into<sp/>memory;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>2.<sp/>scan<sp/>it<sp/>by<sp/>blocks,<sp/>classify<sp/>non‑zero<sp/>blocks;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>3.<sp/>build<sp/>`row_ptr`<sp/>/<sp/>`col_idx`;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>4.<sp/>emit<sp/>the<sp/>header<sp/>+<sp/>payload<sp/>to<sp/>an<sp/>output<sp/>path.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>keeps<sp/>sparsification<sp/>an<sp/>explicit,<sp/>offline<sp/>step:<sp/>the<sp/>engine<sp/>never</highlight></codeline>
<codeline><highlight class="normal">modifies<sp/>weights<sp/>at<sp/>load<sp/>time.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>C<sp/>unit<sp/>tests<sp/>(`tests/c/test_block_sparse.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>tests<sp/>validate<sp/>both<sp/>the<sp/>loader<sp/>and<sp/>the<sp/>GEMV<sp/>kernel:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Small<sp/>4×4<sp/>and<sp/>8×8<sp/>matrices<sp/>with<sp/>hand‑written<sp/>dense<sp/>values<sp/>and<sp/>known</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>products.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Construction<sp/>of<sp/>the<sp/>corresponding<sp/>block‑sparse<sp/>structures<sp/>in<sp/>memory,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>followed<sp/>by<sp/>calls<sp/>to<sp/>`ie_gemv_block_sparse_f32`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Round‑trip<sp/>tests<sp/>for<sp/>the<sp/>on‑disk<sp/>format:<sp/>write<sp/>block‑sparse<sp/>payloads,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>load<sp/>via<sp/>`ie_block_sparse_load`,<sp/>compare<sp/>against<sp/>the<sp/>in‑memory</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>structures,<sp/>and<sp/>re‑run<sp/>GEMV.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>test<sp/>target<sp/>is<sp/>wired<sp/>into<sp/>`make<sp/>test`<sp/>alongside<sp/>the<sp/>existing<sp/>C<sp/>unit</highlight></codeline>
<codeline><highlight class="normal">tests<sp/>so<sp/>regressions<sp/>are<sp/>caught<sp/>early.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Microbenchmark<sp/>(`benchmarks/src/microbench_gemv_block_sparse.c`)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">A<sp/>dedicated<sp/>microbenchmark<sp/>compares<sp/>dense<sp/>vs<sp/>block‑sparse<sp/>GEMV<sp/>on<sp/>CPU:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>Synthesizes<sp/>a<sp/>dense<sp/>matrix<sp/>and<sp/>a<sp/>block‑sparse<sp/>version<sp/>with<sp/>a<sp/>chosen</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>sparsity<sp/>pattern.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Runs<sp/>timed<sp/>loops<sp/>for<sp/>both<sp/>kernels<sp/>and<sp/>prints:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>runtime,<sp/>ns/element,<sp/>and<sp/>effective<sp/>GB/s;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>any<sp/>basic<sp/>correctness<sp/>statistics<sp/>(e.g.<sp/>max<sp/>absolute<sp/>difference).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Built<sp/>and<sp/>run<sp/>via<sp/>`make<sp/>microbench-block-sparse`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>is<sp/>a<sp/>**local**<sp/>measurement<sp/>tool;<sp/>it<sp/>does<sp/>not<sp/>depend<sp/>on<sp/>real<sp/>model</highlight></codeline>
<codeline><highlight class="normal">weights<sp/>or<sp/>the<sp/>CLI.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Integration<sp/>strategy<sp/>and<sp/>future<sp/>work</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>phase<sp/>intentionally<sp/>stops<sp/>short<sp/>of<sp/>wiring<sp/>block‑sparse<sp/>weights<sp/>into</highlight></codeline>
<codeline><highlight class="normal">`model.ie.bin`<sp/>and<sp/>the<sp/>inference<sp/>CLI:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>existing<sp/>users<sp/>see<sp/>no<sp/>change<sp/>in<sp/>behavior;</highlight></codeline>
<codeline><highlight class="normal">-<sp/>sparsity<sp/>experiments<sp/>use<sp/>their<sp/>own<sp/>binaries<sp/>and<sp/>scripts;<sp/>and</highlight></codeline>
<codeline><highlight class="normal">-<sp/>the<sp/>code<sp/>paths<sp/>remain<sp/>small<sp/>enough<sp/>to<sp/>refactor<sp/>without<sp/>churn.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Follow‑up<sp/>work<sp/>(future<sp/>ADRs)<sp/>may<sp/>cover:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>extending<sp/>the<sp/>IEBIN<sp/>format<sp/>(or<sp/>adding<sp/>a<sp/>sidecar)<sp/>to<sp/>carry<sp/>block‑sparse</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>weights<sp/>for<sp/>specific<sp/>layers;</highlight></codeline>
<codeline><highlight class="normal">-<sp/>heuristics<sp/>for<sp/>which<sp/>layers<sp/>to<sp/>sparsify<sp/>(e.g.<sp/>MLP<sp/>vs<sp/>attention);</highlight></codeline>
<codeline><highlight class="normal">-<sp/>GPU<sp/>kernels<sp/>for<sp/>popular<sp/>architectures;<sp/>and</highlight></codeline>
<codeline><highlight class="normal">-<sp/>interaction<sp/>with<sp/>quantization<sp/>and<sp/>activation<sp/>formats.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">For<sp/>now,<sp/>the<sp/>block‑sparse<sp/>prototype<sp/>gives<sp/>us<sp/>a<sp/>solid,<sp/>CPU‑only<sp/>baseline<sp/>to</highlight></codeline>
<codeline><highlight class="normal">reason<sp/>about<sp/>algorithmic<sp/>sparsity<sp/>independently<sp/>of<sp/>lower‑level<sp/>memory<sp/>and</highlight></codeline>
<codeline><highlight class="normal">topology<sp/>tricks<sp/>introduced<sp/>in<sp/>the<sp/>first<sp/>phase.</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Lossless<sp/>Deduplication<sp/>(Schema2):<sp/>defaults<sp/>+<sp/>masks<sp/>+<sp/>exceptions</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">This<sp/>project<sp/>includes<sp/>a<sp/>**lossless**<sp/>dedup<sp/>path<sp/>that<sp/>reduces<sp/>DRAM<sp/>reads<sp/>by<sp/>reusing<sp/>repeated<sp/>weight<sp/>content.</highlight></codeline>
<codeline><highlight class="normal">The<sp/>runtime<sp/>reconstructs<sp/>bytes<sp/>exactly<sp/>(bit-for-bit)<sp/>by<sp/>applying<sp/>a<sp/>sparse<sp/>patch<sp/>stream<sp/>over<sp/>shared<sp/>defaults.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Artifacts</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>runtime<sp/>loader<sp/>expects<sp/>these<sp/>files<sp/>in<sp/>the<sp/>model<sp/>directory<sp/>(next<sp/>to<sp/>`model.ie.json`<sp/>/<sp/>`model.ie.bin`):</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>`model.defaults.bin`<sp/>—<sp/>concatenated<sp/>default<sp/>payload<sp/>bytes</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`model.masks.bin`<sp/>—<sp/>exception<sp/>mask<sp/>bits/bytes<sp/>(identifies<sp/>where<sp/>defaults<sp/>differ)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`model.exceptions.bin`<sp/>—<sp/>exception<sp/>bytes<sp/>(dense<sp/>list<sp/>of<sp/>the<sp/>differing<sp/>bytes)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">In<sp/>the<sp/>current<sp/>workflow,<sp/>these<sp/>are<sp/>typically<sp/>generated<sp/>into<sp/>`models/&lt;MODEL&gt;/dedup_out/`<sp/>and<sp/>then<sp/>symlinked.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Offline<sp/>generation:<sp/>extract<sp/>defaults/masks/exceptions</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>extractor<sp/>takes:</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`tensor_map.json`<sp/>(maps<sp/>tensor<sp/>names<sp/>to<sp/>on-disk<sp/>byte<sp/>ranges<sp/>/<sp/>sources)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`groups.indices.json`<sp/>(dedup<sp/>grouping<sp/>and<sp/>indices)</highlight></codeline>
<codeline><highlight class="normal">and<sp/>produces<sp/>the<sp/>three<sp/>binary<sp/>blobs:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```bash</highlight></codeline>
<codeline><highlight class="normal">python3<sp/>tools/dedup_extract_int4.py<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>--model-dir<sp/>&quot;models/gpt-oss-20b&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>--tensor-map<sp/>&quot;models/gpt-oss-20b/dedup_out/tensor_map.json&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>--groups<sp/>&quot;models/gpt-oss-20b/dedup_out/groups.indices.json&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>--out-prefix<sp/>&quot;models/gpt-oss-20b/dedup_out/model&quot;</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Then<sp/>link<sp/>them<sp/>into<sp/>the<sp/>model<sp/>root:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```bash</highlight></codeline>
<codeline><highlight class="normal">cd<sp/>models/gpt-oss-20b</highlight></codeline>
<codeline><highlight class="normal">ln<sp/>-sf<sp/>dedup_out/model.defaults.bin<sp/><sp/><sp/>model.defaults.bin</highlight></codeline>
<codeline><highlight class="normal">ln<sp/>-sf<sp/>dedup_out/model.masks.bin<sp/><sp/><sp/><sp/><sp/><sp/>model.masks.bin</highlight></codeline>
<codeline><highlight class="normal">ln<sp/>-sf<sp/>dedup_out/model.exceptions.bin<sp/>model.exceptions.bin</highlight></codeline>
<codeline><highlight class="normal">cd<sp/>../..</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Runtime<sp/>controls</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>`IE_DEDUP=1`<sp/>enables<sp/>the<sp/>dedup<sp/>loader.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_DEDUP_STRICT=1`<sp/>fails<sp/>fast<sp/>if<sp/>dedup<sp/>artifacts<sp/>are<sp/>missing<sp/>or<sp/>malformed.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_DEDUP_POLICY=lossless`<sp/>selects<sp/>the<sp/>exact<sp/>reconstruction<sp/>policy<sp/>(no<sp/>approximations).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_DEDUP_CACHE_MB=&lt;N&gt;`<sp/>configures<sp/>the<sp/>in-memory<sp/>cache<sp/>used<sp/>by<sp/>the<sp/>dedup<sp/>loader.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_DEDUP_DEBUG=1`<sp/>enables<sp/>verbose<sp/>parsing/debug<sp/>logs.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Strict<sp/>runs<sp/>should<sp/>also<sp/>enforce<sp/>real<sp/>IEBIN<sp/>loading<sp/>and<sp/>anti-optimization<sp/>work-touch:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>`IE_REQUIRE_MODEL=1`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_VERIFY_TOUCH=1`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_BYTES_PER_TOKEN=&lt;nonzero&gt;`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>`IE_STRIDE_BYTES=256`<sp/>(default<sp/>baseline)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Schema2<sp/>JSON<sp/>compatibility<sp/>notes<sp/>(model.ie.json)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>schema2<sp/>parser<sp/>is<sp/>strict<sp/>about<sp/>per-tensor<sp/>metadata.<sp/>When<sp/>ingesting<sp/>IEBIN<sp/>metadata<sp/>derived<sp/>from<sp/>HF<sp/>shards,</highlight></codeline>
<codeline><highlight class="normal">ensure<sp/>the<sp/>following<sp/>are<sp/>true<sp/>for<sp/>each<sp/>tensor<sp/>entry:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>`dtype`<sp/>is<sp/>lowercase<sp/>(`bf16`,<sp/>`f16`,<sp/>`f32`,<sp/>`u8`,<sp/>...)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>file<sp/>metadata<sp/>uses<sp/>the<sp/>schema2<sp/>keys:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`file`<sp/>(the<sp/>backing<sp/>shard<sp/>filename)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`file_data_offset`<sp/>(byte<sp/>offset<sp/>inside<sp/>that<sp/>shard)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">If<sp/>your<sp/>`model.ie.json`<sp/>uses<sp/>`shard`<sp/>/<sp/>`shard_data_offset`<sp/>instead,<sp/>you<sp/>can<sp/>add<sp/>aliases:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```bash</highlight></codeline>
<codeline><highlight class="normal">python3<sp/>-<sp/>&lt;&lt;&apos;PY&apos;</highlight></codeline>
<codeline><highlight class="normal">import<sp/>json</highlight></codeline>
<codeline><highlight class="normal">from<sp/>pathlib<sp/>import<sp/>Path</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">p<sp/>=<sp/>Path(&quot;models/gpt-oss-20b/model.ie.json&quot;)</highlight></codeline>
<codeline><highlight class="normal">j<sp/>=<sp/>json.loads(p.read_text(encoding=&quot;utf-8&quot;))</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">t<sp/>=<sp/>j.get(&quot;tensors&quot;)</highlight></codeline>
<codeline><highlight class="normal">if<sp/>not<sp/>isinstance(t,<sp/>list):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>raise<sp/>SystemExit(&quot;ERROR:<sp/>tensors<sp/>is<sp/>not<sp/>a<sp/>list&quot;)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">for<sp/>e<sp/>in<sp/>t:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>not<sp/>isinstance(e,<sp/>dict):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>d<sp/>=<sp/>e.get(&quot;dtype&quot;)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>isinstance(d,<sp/>str):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>e[&quot;dtype&quot;]<sp/>=<sp/>d.lower()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>&quot;file&quot;<sp/>not<sp/>in<sp/>e<sp/>and<sp/>&quot;shard&quot;<sp/>in<sp/>e<sp/>and<sp/>isinstance(e[&quot;shard&quot;],<sp/>str):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>e[&quot;file&quot;]<sp/>=<sp/>e[&quot;shard&quot;]</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>if<sp/>&quot;file_data_offset&quot;<sp/>not<sp/>in<sp/>e<sp/>and<sp/>&quot;shard_data_offset&quot;<sp/>in<sp/>e<sp/>and<sp/>isinstance(e[&quot;shard_data_offset&quot;],<sp/>int):</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>e[&quot;file_data_offset&quot;]<sp/>=<sp/>e[&quot;shard_data_offset&quot;]</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">p.write_text(json.dumps(j,<sp/>ensure_ascii=False,<sp/>separators=(&quot;,&quot;,<sp/>&quot;:&quot;),<sp/>sort_keys=True)<sp/>+<sp/>&quot;\n&quot;,<sp/>encoding=&quot;utf-8&quot;)</highlight></codeline>
<codeline><highlight class="normal">print(&quot;OK:<sp/>tensors<sp/>=&quot;,<sp/>len(t))</highlight></codeline>
<codeline><highlight class="normal">PY</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">You<sp/>may<sp/>see<sp/>warnings<sp/>like<sp/>`unknown<sp/>dtype=u8<sp/>...<sp/>(continuing)`<sp/>for<sp/>quantized<sp/>auxiliary<sp/>tensors<sp/>(blocks/scales);</highlight></codeline>
<codeline><highlight class="normal">these<sp/>are<sp/>expected<sp/>as<sp/>long<sp/>as<sp/>the<sp/>loader<sp/>is<sp/>configured<sp/>to<sp/>ignore/skip<sp/>unknown<sp/>storage<sp/>dtypes<sp/>where<sp/>safe.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Example<sp/>strict<sp/>run<sp/>(CPU)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">```bash</highlight></codeline>
<codeline><highlight class="normal">env<sp/>-i<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_REQUIRE_MODEL=1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_VERIFY_TOUCH=1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_BYTES_PER_TOKEN=67108864<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_STRIDE_BYTES=256<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_DEDUP=1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_DEDUP_STRICT=1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_DEDUP_POLICY=lossless<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_DEDUP_CACHE_MB=512<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>IE_DEDUP_DEBUG=1<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>PRECISION=int4w<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>./build/inference-engine<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>--device<sp/>cpu<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>--model-dir<sp/>&quot;$(pwd)/models/gpt-oss-20b&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>--prompts-file<sp/>&quot;$(pwd)/benchmarks/prompts_10.txt&quot;<sp/>\</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>--max-new<sp/>8<sp/>--rounds<sp/>1</highlight></codeline>
<codeline><highlight class="normal">```</highlight></codeline>
    </programlisting>
    <location file="docs/DESIGN.md"/>
  </compounddef>
</doxygen>
