<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="DECISIONS_8md" kind="file" language="Markdown">
    <compoundname>DECISIONS.md</compoundname>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline><highlight class="normal">#<sp/>Architectural<sp/>Decision<sp/>Records</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Last<sp/>updated:**<sp/>2025-10-24<sp/>21:00:48<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0001<sp/>(2025-10-13)**:<sp/>Core<sp/>in<sp/>C11,<sp/>zero<sp/>third-party<sp/>runtime;<sp/>Python<sp/>stdlib<sp/>harness.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0002<sp/>(2025-10-13)**:<sp/>IEBIN<sp/>v1<sp/>weights:<sp/>`model.ie.json`<sp/>+<sp/>`model.ie.bin`<sp/>+<sp/>`vocab.json`<sp/>(mmap-friendly).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0003<sp/>(2025-10-13)**:<sp/>Baseline<sp/>=<sp/>FP32<sp/>naive<sp/>path;<sp/>TPS<sp/>=<sp/>generated_tokens<sp/>/<sp/>wall_time.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0006<sp/>(2025-10-14)**:<sp/>Optimization<sp/>path<sp/>selection<sp/>(CPU<sp/>baseline)<sp/>—<sp/>AVX2<sp/>microkernels,<sp/>thread-pool<sp/>with<sp/>affinity,<sp/>fast<sp/>math,<sp/>layout<sp/>packing.<sp/>See<sp/>`adr-00060-optimization-path.md`.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0010<sp/>(2025-10-16)**:<sp/>INT8<sp/>PTQ<sp/>min-max<sp/>(per-tensor/per-row)<sp/>with<sp/>calibration<sp/>script<sp/>and<sp/>accuracy<sp/>budget<sp/>gate<sp/>(cosine<sp/>≥<sp/>threshold).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0011<sp/>(2025-10-24)**:<sp/>Drop<sp/>Level<sp/>Zero<sp/>from<sp/>default<sp/>benchmarking;<sp/>GPU<sp/>bench<sp/>is<sp/>CUDA-only;<sp/>CPU/GPU<sp/>share<sp/>a<sp/>unified<sp/>reporting<sp/>pipeline.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>**ADR-0013<sp/>(2025-10-24):<sp/>Adopt<sp/>INT4<sp/>weight-only<sp/>PTQ<sp/>&amp;<sp/>manifest-guided<sp/>packing**</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**<sp/>The<sp/>engine<sp/>is<sp/>primarily<sp/>**memory-bandwidth<sp/>bound**<sp/>at<sp/>inference<sp/>time.<sp/>Even<sp/>with<sp/>blocked‑K<sp/>packing<sp/>and<sp/>prefetch,<sp/>large<sp/>models<sp/>remain<sp/>limited<sp/>by<sp/>weight<sp/>fetch.<sp/>INT8<sp/>provided<sp/>a<sp/>2×<sp/>compression;<sp/>we<sp/>want<sp/>a<sp/>**denser<sp/>format**<sp/>while<sp/>preserving<sp/>a<sp/>simple<sp/>compute<sp/>path.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Introduce<sp/>**INT4<sp/>weight‑only**<sp/>quantization<sp/>with:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Nibble<sp/>packing**<sp/>(2<sp/>weights/byte)<sp/>and<sp/>**per‑row<sp/>(or<sp/>group)<sp/>scales**.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>A<sp/>repository‑wide<sp/>**manifest**<sp/>(`q4_manifest.json`)<sp/>describing<sp/>which<sp/>tensors<sp/>are<sp/>INT4<sp/>and<sp/>how<sp/>to<sp/>dequantize<sp/>them.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>CLI/runtime<sp/>selection<sp/>via<sp/>`IE_PRECISION=int4w`<sp/>(or<sp/>`--precision<sp/>int4w`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Keep<sp/>activations<sp/>in<sp/>floating<sp/>point;<sp/>accumulation<sp/>stays<sp/>FP32<sp/>for<sp/>numerical<sp/>stability.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>**4×<sp/>smaller<sp/>weights**<sp/>→<sp/>lower<sp/>bandwidth<sp/>→<sp/>higher<sp/>effective<sp/>TPS<sp/>under<sp/>work‑touch<sp/>or<sp/>real<sp/>inference.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Slight<sp/>accuracy<sp/>cost,<sp/>controlled<sp/>by<sp/>calibration.<sp/>PTQ<sp/>scripts<sp/>expose<sp/>gates<sp/>(cosine/task‑level)<sp/>to<sp/>accept/reject<sp/>a<sp/>manifest.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Kernel<sp/>changes<sp/>are<sp/>incremental:<sp/>dequant<sp/>scale<sp/>application<sp/>in<sp/>the<sp/>matmul<sp/>inner<sp/>loop;<sp/>packing<sp/>integrates<sp/>with<sp/>existing<sp/>pretranspose<sp/>caches.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**<sp/>Accepted.<sp/>Implemented<sp/>across<sp/>CPU<sp/>and<sp/>CUDA<sp/>builds;<sp/>scripts<sp/>support<sp/>end‑to‑end<sp/>HF→IEBIN<sp/>packing<sp/>with<sp/>`--q4-map`.</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">##<sp/>Decision:<sp/>Add<sp/>INT4<sp/>(Weight-Only)<sp/>Optional<sp/>Pipeline<sp/>(2025-10-24<sp/>21:04:23<sp/>UTC)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**<sp/>We<sp/>already<sp/>ship<sp/>FP32/BF16/FP16<sp/>flows.<sp/>We<sp/>add<sp/>a<sp/>*weight-only*<sp/>INT4<sp/>path<sp/>to<sp/>reduce<sp/>bandwidth<sp/>and<sp/>model<sp/>footprint<sp/>while<sp/>keeping<sp/>API<sp/>stability.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Introduce<sp/>a<sp/>manifest-driven<sp/>INT4<sp/>packing<sp/>step<sp/>in<sp/>export<sp/>(`--q4-map`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Expose<sp/>runtime<sp/>selection<sp/>via<sp/>`IE_PRECISION=int4w`<sp/>(or<sp/>`--precision<sp/>int4w`).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Keep<sp/>timing<sp/>discipline:<sp/>measure<sp/>generation<sp/>+<sp/>work-touch<sp/>only;<sp/>sample<sp/>metrics<sp/>after.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Lower<sp/>I/O<sp/>pressure<sp/>when<sp/>`IE_BYTES_PER_TOKEN`<sp/>simulates<sp/>large<sp/>working<sp/>sets.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Slight<sp/>decode<sp/>overhead<sp/>for<sp/>dequantization<sp/>(amortized<sp/>in<sp/>GEMV<sp/>paths).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>No<sp/>change<sp/>to<sp/>tokenization<sp/>or<sp/>batching<sp/>semantics.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**<sp/>Accepted<sp/>and<sp/>implemented.<sp/>Backward-compatible<sp/>(FP<sp/>paths<sp/>unaffected).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Appendix<sp/>—<sp/>INT4<sp/>(Weight‑Only)<sp/>Step<sp/>(Summary)</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Convert<sp/>HF<sp/>shards<sp/>→<sp/>IEBIN<sp/>with<sp/>an<sp/>INT4<sp/>manifest:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>python3<sp/>scripts/hf_to_iebin.py<sp/><sp/><sp/><sp/><sp/>--hf-dir<sp/>models/gpt-oss-20b/hf<sp/><sp/><sp/><sp/><sp/>--out-dir<sp/>models/gpt-oss-20b<sp/><sp/><sp/><sp/><sp/>--q4-map<sp/>quant/q4_manifest.json</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Run<sp/>benchmarks<sp/>in<sp/>strict<sp/>mode<sp/>with<sp/>a<sp/>**64<sp/>MB/token**<sp/>work‑touch:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```bash</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>PROMPTS=benchmarks/prompts_10..txt<sp/><sp/><sp/>IE_PRECISION=int4w<sp/>IE_REQUIRE_MODEL=1<sp/><sp/><sp/>IE_BYTES_PER_TOKEN=64000000<sp/>IE_STRIDE_BYTES=256<sp/>RUNS=3<sp/><sp/><sp/>make<sp/>bench<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>or:<sp/>make<sp/>bench-cuda</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>```</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Precision<sp/>hints:<sp/>`PRECISION=fp32`<sp/>(activates<sp/>float<sp/>path)<sp/>and<sp/>`IE_PRECISION=int4w`<sp/>(weight‑only<sp/>path).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">**Last<sp/>updated:**<sp/>2025-11-10<sp/>21:46:36<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0014<sp/>(2025-11-10)**:<sp/>NUMA‑aware<sp/>topology<sp/>and<sp/>thread<sp/>binding</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Context:**<sp/>We<sp/>need<sp/>consistent<sp/>socket<sp/>awareness<sp/>to<sp/>reduce<sp/>cross‑socket<sp/>traffic<sp/>and<sp/>stabilize<sp/>TPS.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Decision:**<sp/>Introduce<sp/>`ie_topology`<sp/>(sysfs‑backed)<sp/>to<sp/>detect<sp/>sockets<sp/>and<sp/>map<sp/>threads→CPUs<sp/>with<sp/>`AFFINITY`<sp/>hints.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Consequences:**<sp/>Lower<sp/>LLC<sp/>misses<sp/>and<sp/>cross‑node<sp/>memory,<sp/>improved<sp/>repeatability;<sp/>graceful<sp/>single‑socket<sp/>fallback.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Status:**<sp/>Accepted.<sp/>Implemented<sp/>in<sp/>`engine/include/ie_topology.h`<sp/>and<sp/>`engine/src/opt/topology.c`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0015<sp/>(2025-11-10)**:<sp/>Replicate<sp/>“hot”<sp/>weights<sp/>per<sp/>socket<sp/>and<sp/>bind<sp/>workers</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Context:**<sp/>For<sp/>bandwidth‑bound<sp/>models,<sp/>remote‑node<sp/>page<sp/>faults<sp/>throttle<sp/>TPS.<sp/>Replicating<sp/>hot<sp/>tensors<sp/>near<sp/>compute<sp/>reduces<sp/>latency.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Decision:**<sp/>Add<sp/>`replicate_hot.c`<sp/>to<sp/>create<sp/>per‑socket<sp/>replicas<sp/>(mmap‑based),<sp/>then<sp/>bind<sp/>per‑socket<sp/>workers<sp/>to<sp/>CPUs<sp/>on<sp/>that<sp/>socket.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Consequences:**<sp/>Higher<sp/>memory<sp/>footprint<sp/>when<sp/>enabled,<sp/>but<sp/>improved<sp/>locality<sp/>and<sp/>throughput<sp/>on<sp/>multi‑socket<sp/>hosts.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Status:**<sp/>Accepted.<sp/>Guarded<sp/>by<sp/>`IE_HOT_REPLICATE=1`;<sp/>optional<sp/>`MADV_WILLNEED`<sp/>prefetch.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">-<sp/>**ADR-0016<sp/>(2025-11-10)**:<sp/>Activation<sp/>precision<sp/>soft<sp/>hint<sp/>(INT8/FP8)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Context:**<sp/>Allow<sp/>experimenting<sp/>with<sp/>lower‑precision<sp/>activations<sp/>without<sp/>entangling<sp/>storage<sp/>precision<sp/>for<sp/>weights.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Decision:**<sp/>Add<sp/>`IE_ACT_PREC`<sp/>(values:<sp/>`int8|fp8|fp16|bf16|fp32`).<sp/>Host<sp/>accumulators<sp/>remain<sp/>FP32;<sp/>backends<sp/>may<sp/>ignore<sp/>unsupported<sp/>hints.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Consequences:**<sp/>Decouples<sp/>storage<sp/>(e.g.,<sp/>`int4w`)<sp/>from<sp/>activation<sp/>math,<sp/>enabling<sp/>orthogonal<sp/>tuning.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**Status:**<sp/>Accepted.<sp/>Backward‑compatible;<sp/>default<sp/>remains<sp/>FP32<sp/>if<sp/>unset.</highlight></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">##<sp/>ADR‑0017<sp/>(Memory<sp/>Streaming<sp/>Heuristics):<sp/>Prefetch<sp/>&amp;<sp/>Non‑Temporal<sp/>Loads<sp/>—<sp/>2025-11-12<sp/>18:01:19<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**<sp/>GEMV<sp/>paths<sp/>are<sp/>bandwidth‑bound.<sp/>Sequential<sp/>blocked‑K<sp/>layouts<sp/>help,<sp/>but<sp/>cache<sp/>pollution<sp/>and<sp/>late<sp/>prefetch<sp/>still<sp/>cap<sp/>TPS.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Adopt<sp/>tunables<sp/>`IE_PREFETCH_DISTANCE`,<sp/>`IE_NT_LOADS`,<sp/>`IE_NT_RATIO`,<sp/>and<sp/>`IE_L3_BYTES`<sp/>to<sp/>steer<sp/>prefetch<sp/>distance,<sp/>streaming<sp/>loads,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>and<sp/>an<sp/>approximate<sp/>L3<sp/>budget<sp/>for<sp/>“hot”<sp/>slices.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Default<sp/>is<sp/>**conservative**<sp/>(`auto`)<sp/>with<sp/>architecture<sp/>checks;<sp/>explicit<sp/>values<sp/>override.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Wins<sp/>on<sp/>large<sp/>models/long<sp/>K<sp/>with<sp/>single‑touch<sp/>patterns.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Small<sp/>rows<sp/>or<sp/>re‑use‑heavy<sp/>layers<sp/>may<sp/>regress<sp/>if<sp/>NT<sp/>is<sp/>forced<sp/>→<sp/>keep<sp/>`auto`<sp/>as<sp/>default<sp/>and<sp/>expose<sp/>per‑run<sp/>sweeps<sp/>in<sp/>the<sp/>harness.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**<sp/>Accepted.<sp/>Implemented<sp/>in<sp/>CPU<sp/>AVX2<sp/>and<sp/>CUDA<sp/>pack/GEMV<sp/>call<sp/>sites<sp/>with<sp/>guarded<sp/>paths.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline><highlight class="normal">##<sp/>ADR‑0018<sp/>(Metrics<sp/>&amp;<sp/>Reporting):<sp/>Spatial<sp/>Metrics<sp/>in<sp/>PERFORMANCE.md<sp/>—<sp/>2025-11-12<sp/>18:01:19<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**<sp/>Throughput<sp/>alone<sp/>hides<sp/>memory<sp/>behavior.<sp/>We<sp/>need<sp/>bytes/token,<sp/>coverage<sp/>vs<sp/>model,<sp/>RSS<sp/>peak,<sp/>and<sp/>effective<sp/>bandwidth.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Extend<sp/>the<sp/>JSON<sp/>summary<sp/>and<sp/>the<sp/>Markdown<sp/>generator<sp/>to<sp/>compute<sp/>spatial<sp/>fields<sp/>from<sp/>`IE_BYTES_PER_TOKEN`,<sp/>run<sp/>totals,<sp/>and<sp/>model<sp/>size.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Update<sp/>Prometheus<sp/>exporter<sp/>with<sp/>a<sp/>`ie_build_info`<sp/>gauge<sp/>(labels)<sp/>and<sp/>RSS<sp/>gauges.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Comparable<sp/>runs<sp/>across<sp/>machines<sp/>now<sp/>capture<sp/>memory<sp/>pressure<sp/>explicitly.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Grafana<sp/>dashboards<sp/>can<sp/>plot<sp/>GB/s<sp/>alongside<sp/>TPS<sp/>for<sp/>stability<sp/>analysis.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**<sp/>Accepted.<sp/>Shipped<sp/>with<sp/>`monitoring/metrics_memory.toml`,<sp/>updated<sp/>`scripts/metrics_exporter.py`,</highlight></codeline>
<codeline><highlight class="normal">and<sp/>harness<sp/>sweep<sp/>labels<sp/>for<sp/>memory<sp/>knobs.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>ADR‑0019<sp/>(Sparsity):<sp/>Block‑sparse<sp/>weights,<sp/>CPU‑only<sp/>prototype<sp/>—<sp/>2025‑11‑14<sp/>23:00:00<sp/>UTC</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Phase<sp/>1<sp/>of<sp/>the<sp/>memory<sp/>work<sp/>focused<sp/>on<sp/>*dense*<sp/>optimizations:<sp/>INT4/INT8<sp/>activations,<sp/>NUMA‑aware<sp/>topology,<sp/>hot‑weights<sp/>replication,<sp/>and<sp/>streaming<sp/>loads.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>The<sp/>next<sp/>natural<sp/>axis<sp/>is<sp/>**algorithmic<sp/>sparsity**:<sp/>skip<sp/>zero<sp/>blocks<sp/>instead<sp/>of<sp/>streaming<sp/>everything.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>We<sp/>want<sp/>a<sp/>conservative,<sp/>inspectable<sp/>prototype<sp/>that:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>lives<sp/>entirely<sp/>on<sp/>the<sp/>CPU<sp/>path;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>does<sp/>**not**<sp/>disturb<sp/>the<sp/>existing<sp/>dense<sp/>loading/CLI;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>is<sp/>testable<sp/>in<sp/>isolation<sp/>(C<sp/>unit<sp/>tests<sp/>+<sp/>microbench).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Introduce<sp/>a<sp/>small,<sp/>self‑contained<sp/>**block‑sparse<sp/>format**<sp/>and<sp/>CPU<sp/>kernel:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>New<sp/>descriptor<sp/>type<sp/>`ie_block_sparse_matrix_t`<sp/>in<sp/>`engine/include/sparse_format.h`.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Loader<sp/>in<sp/>`engine/src/sparse_io.c`<sp/>that<sp/>reads<sp/>a<sp/>compact<sp/>binary<sp/>header<sp/>and<sp/>BSR<sp/>payload.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Reference<sp/>GEMV<sp/>in<sp/>`engine/src/gemm_block_sparse.c`<sp/>operating<sp/>on<sp/>FP32<sp/>weights.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Extend<sp/>the<sp/>device<sp/>abstraction:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Add<sp/>`gemv_block_sparse_f32`<sp/>to<sp/>the<sp/>`ie_device`<sp/>vtable.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Provide<sp/>a<sp/>CPU<sp/>implementation<sp/>wired<sp/>to<sp/>`ie_gemv_block_sparse_f32`.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Keep<sp/>CUDA/Level‑Zero<sp/>entries<sp/>as<sp/>stubs<sp/>that<sp/>return<sp/>“unimplemented”;<sp/>the<sp/>public<sp/>helpers<sp/>fall<sp/>back<sp/>to<sp/>CPU.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Add<sp/>offline<sp/>and<sp/>benchmarking<sp/>tools:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`tools/convert_to_block_sparse.c`<sp/>to<sp/>convert<sp/>dense<sp/>row‑major<sp/>weights<sp/>into<sp/>the<sp/>on‑disk<sp/>BSR<sp/>format.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`tests/c/test_block_sparse.c`<sp/>with<sp/>small<sp/>hand‑built<sp/>matrices<sp/>to<sp/>validate<sp/>loader<sp/>+<sp/>GEMV.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`benchmarks/src/microbench_gemv_block_sparse.c`<sp/>to<sp/>compare<sp/>dense<sp/>vs<sp/>block‑sparse<sp/>GEMV<sp/>on<sp/>CPU.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Restrict<sp/>scope<sp/>explicitly:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**CPU<sp/>only**<sp/>for<sp/>this<sp/>ADR;<sp/>no<sp/>GPU<sp/>kernels<sp/>are<sp/>required<sp/>to<sp/>pass<sp/>tests.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>**FP32<sp/>weights<sp/>only**;<sp/>quantized/specialized<sp/>paths<sp/>remain<sp/>dense.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>We<sp/>have<sp/>a<sp/>**concrete,<sp/>repeatable**<sp/>sparsity<sp/>experiment:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Same<sp/>repository,<sp/>same<sp/>Makefile;<sp/>add<sp/>a<sp/>dense<sp/>`.bin`,<sp/>run<sp/>the<sp/>converter,<sp/>microbench<sp/>the<sp/>result.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Unit<sp/>tests<sp/>ensure<sp/>correctness<sp/>on<sp/>small<sp/>matrices.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>The<sp/>device<sp/>layer<sp/>remains<sp/>forward‑compatible:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Future<sp/>GPU<sp/>support<sp/>can<sp/>fill<sp/>in<sp/>the<sp/>existing<sp/>vtable<sp/>slot<sp/>without<sp/>touching<sp/>the<sp/>public<sp/>API.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>Callers<sp/>can<sp/>ask<sp/>for<sp/>block‑sparse<sp/>GEMV<sp/>and<sp/>still<sp/>get<sp/>a<sp/>correct<sp/>CPU<sp/>fallback<sp/>today.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>No<sp/>risk<sp/>to<sp/>existing<sp/>users:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>CLI<sp/>behavior<sp/>and<sp/>`model.ie.bin`<sp/>format<sp/>are<sp/>unchanged.</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>All<sp/>new<sp/>code<sp/>is<sp/>opt‑in<sp/>and<sp/>exercised<sp/>only<sp/>by<sp/>tests/microbench/scripts<sp/>introduced<sp/>in<sp/>this<sp/>phase.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Accepted.<sp/>Implemented<sp/>as<sp/>a<sp/>**CPU‑only<sp/>prototype**;<sp/>further<sp/>ADRs<sp/>will<sp/>cover<sp/>wiring<sp/>full‑model<sp/>weights<sp/>and<sp/>any<sp/>GPU/quantized<sp/>variants.</highlight></codeline>
<codeline></codeline>
<codeline></codeline>
<codeline><highlight class="normal">---</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>ADR-0020<sp/>(2025-12-22):<sp/>Adopt<sp/>lossless<sp/>dedup<sp/>artifacts<sp/>and<sp/>schema2<sp/>runtime<sp/>loader</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Context.**<sp/>The<sp/>engine<sp/>is<sp/>primarily<sp/>memory-bandwidth<sp/>bound<sp/>at<sp/>inference<sp/>time.<sp/>We<sp/>already<sp/>attack<sp/>the<sp/>problem</highlight></codeline>
<codeline><highlight class="normal">via<sp/>INT4<sp/>weight-only<sp/>storage<sp/>and<sp/>streaming<sp/>heuristics,<sp/>but<sp/>dense<sp/>IEBIN<sp/>still<sp/>requires<sp/>reading<sp/>large<sp/>swaths<sp/>of</highlight></codeline>
<codeline><highlight class="normal">the<sp/>weight<sp/>blob<sp/>repeatedly.<sp/>We<sp/>need<sp/>a<sp/>**lossless**<sp/>dedup<sp/>scheme<sp/>that<sp/>can<sp/>reduce<sp/>DRAM<sp/>traffic<sp/>without<sp/>changing</highlight></codeline>
<codeline><highlight class="normal">model<sp/>outputs.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Decision.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Adopt<sp/>a<sp/>three-blob<sp/>dedup<sp/>artifact<sp/>set<sp/>alongside<sp/>IEBIN:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`model.defaults.bin`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`model.masks.bin`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`model.exceptions.bin`</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Enable<sp/>the<sp/>loader<sp/>behind<sp/>runtime<sp/>flags:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`IE_DEDUP=1`,<sp/>`IE_DEDUP_POLICY=lossless`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`IE_DEDUP_STRICT=1`<sp/>for<sp/>“fail<sp/>fast”<sp/>correctness<sp/>runs</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`IE_DEDUP_CACHE_MB`<sp/>to<sp/>cap<sp/>reconstruction<sp/>cache<sp/>memory</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>`IE_DEDUP_DEBUG=1`<sp/>for<sp/>verbose<sp/>diagnostics</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Keep<sp/>schema2<sp/>metadata<sp/>parsing<sp/>strict,<sp/>but<sp/>allow<sp/>compatibility<sp/>with<sp/>HF-derived<sp/>metadata<sp/>by:</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>requiring<sp/>lowercase<sp/>`dtype`</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>-<sp/>supporting<sp/>`file`/`file_data_offset`<sp/>(and<sp/>generating<sp/>aliases<sp/>from<sp/>`shard`/`shard_data_offset`<sp/>in<sp/>the<sp/>metadata<sp/>pipeline<sp/>when<sp/>needed)</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Consequences.**</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Offline<sp/>extraction<sp/>time<sp/>increases<sp/>(diffing<sp/>defaults<sp/>vs<sp/>targets),<sp/>but<sp/>runtime<sp/>is<sp/>simplified<sp/>to<sp/>patch-apply.</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Production<sp/>runs<sp/>must<sp/>ship<sp/>three<sp/>additional<sp/>binary<sp/>files<sp/>next<sp/>to<sp/>`model.ie.json`<sp/>/<sp/>`model.ie.bin`<sp/>(or<sp/>symlink<sp/>them).</highlight></codeline>
<codeline><highlight class="normal">-<sp/>Benchmarks<sp/>can<sp/>now<sp/>report<sp/>meaningful<sp/>“dedup<sp/>on/off”<sp/>TPS<sp/>deltas<sp/>under<sp/>strict<sp/>work-touch<sp/>conditions.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">**Status.**<sp/>Accepted.<sp/>Implemented<sp/>(CPU<sp/>path)<sp/>and<sp/>integrated<sp/>in<sp/>strict<sp/>harness<sp/>runs.<sp/>CUDA<sp/>path<sp/>uses<sp/>the<sp/>same</highlight></codeline>
<codeline><highlight class="normal">artifact<sp/>layout<sp/>and<sp/>flags<sp/>where<sp/>supported.</highlight></codeline>
    </programlisting>
    <location file="docs/DECISIONS.md"/>
  </compounddef>
</doxygen>
