<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.13.2" xml:lang="en-US">
  <compounddef id="md_docs_2DESIGN" kind="page">
    <compoundname>md_docs_2DESIGN</compoundname>
    <title>Design (CPU baseline + INT4 path)</title>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
<para><anchor id="md_docs_2DESIGN_1autotoc_md1"/></para>
<para>This document describes the hot path, API boundaries, and precision modes. <linebreak/>
 <bold>Last updated:</bold> 2025-10-24 21:00:48 UTC</para>
<sect1 id="md_docs_2DESIGN_1autotoc_md14">
<title>Process and boundaries</title><para><itemizedlist>
<listitem><para>Single binary <computeroutput>inference-engine</computeroutput>: create → generate → collect metrics → destroy.</para>
</listitem><listitem><para>CLI prints exactly one JSON line per run so the Python harness can ingest results.</para>
</listitem><listitem><para>No third‑party runtime dependencies; only <computeroutput>pthread</computeroutput> and <computeroutput>libm</computeroutput> (and CUDA for the GPU build).</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md15">
<title>API surface (high level)</title><para><itemizedlist>
<listitem><para><computeroutput>ie_engine_create(cfg)</computeroutput> → initializes state (weights, buffers, thread‑pool).</para>
</listitem><listitem><para><computeroutput>ie_engine_generate(prompt, max_new, params)</computeroutput> → produces tokens and updates metrics rings.</para>
</listitem><listitem><para><computeroutput>ie_engine_metrics(out)</computeroutput> → returns latency p50/p95, true TPS, <bold>RSS peak</bold>, KV hits/misses.</para>
</listitem><listitem><para><computeroutput><ref refid="ie__api_8h_1a8a724f7097b3e19da8d7dd97fba4415e" kindref="member">ie_engine_destroy()</ref></computeroutput> → frees all resources.</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md16">
<title>Hot path layout</title><para><itemizedlist>
<listitem><para>GEMV microkernel:<itemizedlist>
<listitem><para>Generic scalar reference implementation.</para>
</listitem><listitem><para>AVX2/FMA path with light prefetch and blocked‑K packing.</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>Activation:<itemizedlist>
<listitem><para><computeroutput>tanh</computeroutput> fast path with clamp (accuracy‑bounded), vector helper.</para>
</listitem><listitem><para>Optional fused bias + activation to reduce memory traffic.</para>
</listitem></itemizedlist>
</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md17">
<title>Precision modes</title><sect2 id="md_docs_2DESIGN_1autotoc_md18">
<title>Floating point</title><para><itemizedlist>
<listitem><para>FP32 baseline, optional BF16/FP16 round‑trip (accumulate FP32).</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md19">
<title>INT8 PTQ (reference)</title><para><itemizedlist>
<listitem><para>Per‑tensor/per‑row scales (min‑max); (de)quant helpers; task gate in scripts.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md20">
<title><bold>NEW — INT4 PTQ (weight‑only)</bold></title><para><itemizedlist>
<listitem><para><bold>Format</bold>: weights are <bold>nibble‑packed</bold> (2 values per byte). Each row (or group) carries a scale (and optional zero‑point if affine).</para>
</listitem><listitem><para><bold>Packing</bold>: INT4 packing integrates with the existing <bold>pretranspose / blocked‑K</bold> pipeline. Packing order: float → (optional) pretranspose → quantize to int4 → pack.</para>
</listitem><listitem><para><bold>Dequantization</bold>: fused in the matmul path; scale is broadcast per row (or group) to recover FP32 accumulators.</para>
</listitem><listitem><para><bold>Manifests</bold>: a <computeroutput>q4_manifest.json</computeroutput> enumerates which tensors use INT4 and their scale metadata. <computeroutput><ref refid="hf__to__iebin_8py" kindref="compound">scripts/hf_to_iebin.py</ref></computeroutput> consumes this manifest via <computeroutput>--q4-map</computeroutput> to emit <computeroutput>model.ie.bin</computeroutput>/<computeroutput>.json</computeroutput>.</para>
</listitem><listitem><para><bold>Selection</bold>: at runtime choose <computeroutput>IE_PRECISION=int4w</computeroutput> (or <computeroutput>--precision int4w</computeroutput>), leaving activations in float. This is <bold>bandwidth‑oriented</bold> and preserves compute simplicity.</para>
</listitem></itemizedlist>
</para>
</sect2>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md21">
<title>Threading model</title><para><itemizedlist>
<listitem><para>Fixed thread‑pool over <computeroutput>pthread</computeroutput>, contiguous sharding, grainsize control.</para>
</listitem><listitem><para>Affinity (Linux): <computeroutput>IE_TP_USE_AFFINITY=1</computeroutput> enables <computeroutput>auto|compact|scatter</computeroutput>.</para>
</listitem><listitem><para>NUMA:<itemizedlist>
<listitem><para><computeroutput><ref refid="set__numa_8sh" kindref="compound">scripts/set_numa.sh</ref></computeroutput> can set OS policy (<computeroutput>interleave|node:X|strict</computeroutput>).</para>
</listitem><listitem><para>In‑repo probe reads <computeroutput>/sys/devices/system/node/online</computeroutput> to annotate reports.</para>
</listitem></itemizedlist>
</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md22">
<title>Layout and caching</title><para><itemizedlist>
<listitem><para>Blocked‑K packing with optional on‑disk caching (content‑addressed by shape + block size).</para>
</listitem><listitem><para>CLI flag <computeroutput>--pretranspose</computeroutput> controls packing scope (<computeroutput>none|woh|wxh|all</computeroutput>). INT4 can be cached per layout variant.</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md23">
<title>Metrics</title><para><itemizedlist>
<listitem><para>Per‑token latency ring (p50/p95).</para>
</listitem><listitem><para>True TPS (<computeroutput>generated_tokens / wall_time_s</computeroutput>).</para>
</listitem><listitem><para><bold>Peak RSS</bold> (Linux <computeroutput>/proc/self/status:VmHWM</computeroutput> → MiB; fallback <computeroutput>getrusage</computeroutput>).</para>
</listitem><listitem><para>KV hits/misses counter stubs aggregated per round.</para>
</listitem></itemizedlist>
</para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md24">
<title>GPU integration (CUDA path)</title><para><itemizedlist>
<listitem><para>Device layer: <computeroutput><ref refid="ie__device__cuda_8cu" kindref="compound">engine/src/devices/ie_device_cuda.cu</ref></computeroutput>, kernels in <computeroutput><ref refid="ie__kernels__cuda_8cu" kindref="compound">engine/src/kernels/ie_kernels_cuda.cu</ref></computeroutput>.</para>
</listitem><listitem><para>Build: <computeroutput>make build-cuda</computeroutput> → <computeroutput>build/inference-engine.cuda</computeroutput>.</para>
</listitem><listitem><para>INT4 weight‑only support mirrors the CPU path; packing and scales are shared in <computeroutput>model.ie.json</computeroutput>.</para>
</listitem></itemizedlist>
</para>
<para><hruler/>
 </para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md26">
<title>INT4 Weight-Only Path — Design Addendum (2025-10-24 21:04:23 UTC)</title><sect2 id="md_docs_2DESIGN_1autotoc_md27">
<title>Goals</title><para><itemizedlist>
<listitem><para>Introduce an <bold>optional</bold> path for <emphasis>weight-only</emphasis> INT4 (<computeroutput>int4w</computeroutput>) that: 1) Packs HF weights into IEBIN using a <bold>manifest-driven</bold> policy. 2) Leaves tokenization, shapes, and scheduling untouched. 3) Preserves benchmark comparability via <emphasis>work-touch</emphasis> instrumentation.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md28">
<title>Design Choices</title><para><itemizedlist>
<listitem><para><bold>Manifest-driven packing</bold>: <computeroutput>--q4-map</computeroutput> lets us target only GEMV-heavy matrices (attn/MLP projections) and keep sensitive tensors (embeddings, layernorms) in FP formats.</para>
</listitem><listitem><para><bold>Separation of concerns</bold>:<itemizedlist>
<listitem><para>Storage precision (<computeroutput>IE_PRECISION</computeroutput>) is passed through <computeroutput><ref refid="structie__engine__params_1a92b02bad12cb4e8173728311c00960b7" kindref="member">ie_engine_params_t::precision</ref></computeroutput> untouched.</para>
</listitem><listitem><para>Host math precision (FP32/BF16/FP16) remains a separate selection.</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para><bold>Compat with harness</bold>: The CLI accepts soft hints (<computeroutput>--device</computeroutput>, <computeroutput>--model-dir</computeroutput>, <computeroutput>--rounds</computeroutput>) so existing scripts don’t break.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md29">
<title>Data Flow (INT4 path)</title><para>HF shards → <computeroutput><ref refid="hf__to__iebin_8py" kindref="compound">hf_to_iebin.py</ref> --q4-map</computeroutput> → IEBIN (<computeroutput>model.ie.json</computeroutput> + <computeroutput>model.ie.bin</computeroutput> with INT4-packed tensors) → Runtime <computeroutput>IE_PRECISION=int4w</computeroutput> → GEMV kernels read packed weights (or dequant on load), semantics unchanged.</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md30">
<title>Metrics Integrity</title><para><itemizedlist>
<listitem><para>The timed window is <bold>only</bold>: <computeroutput>ie_engine_generate(...)</computeroutput> + optional <emphasis>work-touch</emphasis> loop.</para>
</listitem><listitem><para>RSS peak and KV counters are sampled <bold>after</bold> the window to avoid skewing TPS.</para>
</listitem></itemizedlist>
</para>
<para><hruler/>
</para>
</sect2>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md32">
<title>Appendix — INT4 (Weight‑Only) Step (Summary)</title><para><itemizedlist>
<listitem><para>Convert HF shards → IEBIN with an INT4 manifest: <programlisting filename=".bash"><codeline><highlight class="normal">python3<sp/>scripts/hf_to_iebin.py<sp/><sp/><sp/><sp/><sp/>--hf-dir<sp/>models/gpt-oss-20b/hf<sp/><sp/><sp/><sp/><sp/>--out-dir<sp/>models/gpt-oss-20b<sp/><sp/><sp/><sp/><sp/>--q4-map<sp/>quant/q4_manifest.json</highlight></codeline>
</programlisting></para>
</listitem><listitem><para>Run benchmarks in strict mode with a <bold>64 MB/token</bold> work‑touch: <programlisting filename=".bash"><codeline><highlight class="normal">PROMPTS=benchmarks/prompts_10..txt<sp/><sp/><sp/>IE_PRECISION=int4w<sp/>IE_REQUIRE_MODEL=1<sp/><sp/><sp/>IE_BYTES_PER_TOKEN=64000000<sp/>IE_STRIDE_BYTES=256<sp/>RUNS=3<sp/><sp/><sp/>make<sp/>bench<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>or:<sp/>make<sp/>bench-cuda</highlight></codeline>
</programlisting></para>
</listitem><listitem><para>Precision hints: <computeroutput>PRECISION=fp32</computeroutput> (activates float path) and <computeroutput>IE_PRECISION=int4w</computeroutput> (weight‑only path).</para>
</listitem></itemizedlist>
</para>
<para><hruler/>
 </para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md34">
<title>Updates — 2025-11-10</title><sect2 id="md_docs_2DESIGN_1autotoc_md35">
<title>NUMA‑aware topology (<computeroutput>ie_topology</computeroutput>)</title><para><itemizedlist>
<listitem><para>Discovers sockets and CPUs from Linux sysfs and exposes a compact API:<itemizedlist>
<listitem><para><computeroutput>ie_topology_init/destroy</computeroutput> — lifetime.</para>
</listitem><listitem><para><computeroutput><ref refid="ie__topology_8h_1ae9fec2d245fb73d6c3e8e3cba38d4471" kindref="member">ie_topology_sockets()</ref></computeroutput> — number of sockets.</para>
</listitem><listitem><para><computeroutput>ie_topology_first_cpu_on_socket(s)</computeroutput> — first CPU index on socket <computeroutput>s</computeroutput> (for pinning).</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>Integration:<itemizedlist>
<listitem><para>Thread‑pool honors <computeroutput>IE_TP_USE_AFFINITY=1</computeroutput> with <computeroutput>AFFINITY=auto|compact|scatter</computeroutput>.</para>
</listitem><listitem><para><computeroutput>ie_hot_replicate_by_socket(...)</computeroutput> uses topology for binding.</para>
</listitem></itemizedlist>
</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md36">
<title>Hot weights replication</title><para><itemizedlist>
<listitem><para>For “hot” tensors (frequently touched), we can replicate pages <bold>per socket</bold> to reduce remote memory hits.</para>
</listitem><listitem><para>Implementation sketch:<itemizedlist>
<listitem><para><computeroutput>mmap</computeroutput> replica per socket → optional <computeroutput>madvise(..., MADV_WILLNEED)</computeroutput> → worker binding → socket‑local access.</para>
</listitem><listitem><para>Controlled by <computeroutput>IE_HOT_REPLICATE=1</computeroutput> and an optional cap <computeroutput>IE_HOT_REPL_LIMIT_MB</computeroutput>.</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>Trade‑offs: additional memory; on single‑socket machines, the feature is a no‑op with negligible overhead.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md37">
<title>Activation precision hint</title><para><itemizedlist>
<listitem><para>Runtime hint <computeroutput>IE_ACT_PREC=int8|fp8|fp16|bf16|fp32</computeroutput> allows experimenting with lower‑precision activations while <bold>keeping FP32 accumulators</bold>.</para>
</listitem><listitem><para>Weight precision remains independent (e.g., <computeroutput>IE_PRECISION=int4w</computeroutput> for nibble‑packed weights).</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md38">
<title>Timing discipline (unchanged semantics)</title><para><itemizedlist>
<listitem><para>The benchmark <bold>measured window</bold> contains only <computeroutput>ie_engine_generate(...)</computeroutput> + optional work‑touch loop.</para>
</listitem><listitem><para>All metrics collection (RSS, KV, JSON print) happens <bold>after</bold> the window.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md39">
<title>Example configurations</title><para><itemizedlist>
<listitem><para>INT4 weights, FP8 activations, NUMA‑aware with hot replication (CPU): <programlisting filename=".bash"><codeline><highlight class="normal">export<sp/>IE_REQUIRE_MODEL=1<sp/>IE_PRECISION=int4w<sp/>IE_ACT_PREC=fp8</highlight></codeline>
<codeline><highlight class="normal">export<sp/>IE_BYTES_PER_TOKEN=$((64*1024*1024))<sp/>IE_STRIDE_BYTES=256<sp/>IE_VERIFY_TOUCH=1</highlight></codeline>
<codeline><highlight class="normal">export<sp/>IE_TP_USE_AFFINITY=1<sp/>AFFINITY=compact<sp/>IE_HOT_REPLICATE=1</highlight></codeline>
<codeline><highlight class="normal">PROMPTS=benchmarks/prompts_10..txt<sp/>RUNS=3<sp/>make<sp/>bench</highlight></codeline>
</programlisting></para>
</listitem><listitem><para>Same with CUDA: </para>
</listitem></itemizedlist>
</para>
</sect2>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md40">
<title>autotoc_md40</title><para><programlisting filename=".bash"><codeline><highlight class="normal">PROMPTS=benchmarks/prompts_10..txt<sp/>RUNS=3<sp/>make<sp/>bench-cuda</highlight></codeline>
</programlisting></para>
</sect1>
<sect1 id="md_docs_2DESIGN_1autotoc_md41">
<title>Memory Phase Design Addendum (updated 2025-11-12 18:01:19 UTC)</title><sect2 id="md_docs_2DESIGN_1autotoc_md42">
<title>Goals</title><para><orderedlist>
<listitem><para>Reduce <bold>DRAM traffic</bold> on weight fetch via layout (<computeroutput>blocked‑K</computeroutput>), NUMA locality, and selective non‑temporal loads.</para>
</listitem><listitem><para>Enable <bold>activation down‑precision</bold> (INT8/FP8) orthogonally to weight storage (e.g., INT4 weight‑only).</para>
</listitem><listitem><para>Measure and visualize <bold>spatial metrics</bold> alongside TPS: MB/token, bytes touched, model coverage, effective bandwidth.</para>
</listitem></orderedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md43">
<title>Components</title><para><itemizedlist>
<listitem><para><bold>Topology &amp; Binding (<computeroutput><ref refid="structie__topology" kindref="compound">ie_topology</ref></computeroutput>)</bold>: discovers sockets/CPUs from Linux sysfs. Exposes helpers for pinning (compact/scatter).</para>
</listitem><listitem><para><bold>Hot replication (<computeroutput><ref refid="replicate__hot_8c" kindref="compound">replicate_hot.c</ref></computeroutput>)</bold>: optional per‑socket replicas for frequently‑touched weights; uses <computeroutput>mmap</computeroutput> + <computeroutput>madvise</computeroutput>.</para>
</listitem><listitem><para><bold>Blocked‑K Pretranspose</bold>: builds and caches a row‑major, <bold>K‑blocked</bold> layout; improves sequentiality and prefetch efficacy.</para>
</listitem><listitem><para><bold>Streaming heuristics</bold>: <computeroutput>IE_PREFETCH_DISTANCE</computeroutput>, <computeroutput>IE_NT_LOADS</computeroutput>, and <computeroutput>IE_NT_RATIO</computeroutput> drive prefetch and non‑temporal load decisions.</para>
</listitem><listitem><para><bold>Activation precision</bold>: runtime hint <computeroutput>IE_ACT_PREC</computeroutput> selects decode path (INT8 per‑tensor/per‑group, FP8 E4M3/E5M2). Accumulation is FP32.</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md44">
<title>Measurement</title><para>The benchmark window includes <bold>generation</bold> and the <bold>work‑touch</bold> loop (controlled by <computeroutput>IE_BYTES_PER_TOKEN</computeroutput>, <computeroutput>IE_STRIDE_BYTES</computeroutput>). After the window, the engine samples <bold>peak RSS (VmHWM)</bold>. The docs generator now derives:<itemizedlist>
<listitem><para><bold>MB/token</bold> from <computeroutput>IE_BYTES_PER_TOKEN</computeroutput></para>
</listitem><listitem><para><bold>Total bytes touched</bold> = <computeroutput>tokens_sum * bytes_per_token</computeroutput></para>
</listitem><listitem><para><bold>Coverage</bold> = <computeroutput>bytes_per_token / size(model.ie.bin)</computeroutput></para>
</listitem><listitem><para><bold>Effective bandwidth</bold> = <computeroutput>bytes_touched / wall_time</computeroutput> (GB/s)</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md45">
<title>Backward Compatibility &amp; Fallbacks</title><para><itemizedlist>
<listitem><para>Single‑socket hosts: topology collapses to one socket; binding is a no‑op.</para>
</listitem><listitem><para>Unsupported backends ignore <computeroutput>IE_ACT_PREC</computeroutput>, <computeroutput>IE_NT_LOADS</computeroutput>, etc., without failing.</para>
</listitem><listitem><para>When <computeroutput>IE_REQUIRE_MODEL</computeroutput> is unset, CI stub mode continues to work (no mmap or spatial metrics).</para>
</listitem></itemizedlist>
</para>
</sect2>
<sect2 id="md_docs_2DESIGN_1autotoc_md46">
<title>Risks &amp; Mitigations</title><para><itemizedlist>
<listitem><para><bold>Over‑eager NT loads</bold> can hurt on small working sets → guard via <computeroutput>auto</computeroutput> heuristics and <computeroutput>IE_NT_RATIO</computeroutput> throttle.</para>
</listitem><listitem><para><bold>Replica memory cost</bold> on multi‑socket servers → gate with <computeroutput>IE_HOT_REPLICATE</computeroutput> and <computeroutput>IE_HOT_REPL_LIMIT_MB</computeroutput>. </para>
</listitem></itemizedlist>
</para>
</sect2>
</sect1>
    </detaileddescription>
    <location file="docs/DESIGN.md"/>
  </compounddef>
</doxygen>
